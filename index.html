<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>الجالية الفلسطينية في روغالاند</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
<style>
/* ========== Modern Design System V2 ========== */
:root{
  /* الألوان الأساسية */
  --red:#E63946;
  --green:#00D26A;
  --black:#0a0a0a;
  --gold:#FFD166;
  --dark:#0d1117;
  --card:rgba(22,27,34,0.8);
  --card-solid:#161b22;
  --border:rgba(255,255,255,0.1);
  --border-hover:rgba(255,255,255,0.2);
  --text:#f0f6fc;
  --muted:rgba(255,255,255,0.5);
  
  /* تأثيرات */
  --glow-green:0 0 20px rgba(0,210,106,0.4);
  --glow-red:0 0 20px rgba(230,57,70,0.4);
  --glow-gold:0 0 20px rgba(255,209,102,0.4);
  --blur:blur(20px);
  --transition:0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --spring:0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  
  /* أحجام */
  --radius-sm:10px;
  --radius-md:16px;
  --radius-lg:24px;
  --sidebar-width:280px;
}

/* ========== Light Mode ========== */
body.light-mode{
  --black:#f0f2f5;
  --dark:#ffffff;
  --card:rgba(255,255,255,0.92);
  --card-solid:#ffffff;
  --border:rgba(0,0,0,0.08);
  --border-hover:rgba(0,0,0,0.15);
  --text:#1a1a2e;
  --muted:rgba(0,0,0,0.45);
  --glow-green:0 4px 15px rgba(0,150,57,0.15);
  --glow-red:0 4px 15px rgba(206,17,38,0.15);
  --glow-gold:0 4px 15px rgba(255,180,0,0.15);
  background:#f0f2f5;
}
body.light-mode .sidebar{background:rgba(255,255,255,0.97);border-left-color:rgba(0,0,0,0.08);backdrop-filter:blur(20px)}
body.light-mode .sidebar-header{background:linear-gradient(135deg,rgba(0,150,57,0.06),rgba(206,17,38,0.04))}
body.light-mode .nav-btn{color:rgba(0,0,0,0.45)}
body.light-mode .nav-btn:hover{background:rgba(0,150,57,0.08);color:#1a1a2e}
body.light-mode .nav-btn.active{background:linear-gradient(135deg,#009639,#006428);color:#fff}
body.light-mode .visitor-box{background:linear-gradient(135deg,#FFD166,#ffb800);color:#1a1a2e}
body.light-mode .form-input,body.light-mode .form-select,body.light-mode .form-textarea{background:#f8f9fa;border-color:rgba(0,0,0,0.12);color:#1a1a2e}
body.light-mode .form-input:focus,body.light-mode .form-textarea:focus{background:#fff;border-color:#009639}
body.light-mode .modal{background:#fff;border-color:rgba(0,0,0,0.08)}
body.light-mode .modal-head{background:linear-gradient(135deg,rgba(0,150,57,0.05),rgba(206,17,38,0.03))}
body.light-mode .modal-foot{background:#f8f9fa}
body.light-mode .toast{background:#fff;color:#1a1a2e;border-left:4px solid #009639;box-shadow:0 8px 30px rgba(0,0,0,0.12)}
body.light-mode .member-item,body.light-mode .toggle-row{background:#f8f9fa}
body.light-mode .conf-edit-item{background:#f8f9fa;border-color:rgba(0,0,0,0.08)}
body.light-mode .tx-item{border-bottom-color:rgba(0,0,0,0.06)}
body.light-mode .card{background:rgba(255,255,255,0.92);border-color:rgba(0,0,0,0.06);box-shadow:0 2px 12px rgba(0,0,0,0.04)}
body.light-mode .header{color:#1a1a2e}
body.light-mode .header p{color:rgba(0,0,0,0.5)}
body.light-mode .stat-card{background:rgba(255,255,255,0.9);border-color:rgba(0,0,0,0.06)}
body.light-mode .hero-section{background:linear-gradient(135deg,rgba(0,150,57,0.08),rgba(206,17,38,0.05));border-color:rgba(0,0,0,0.06)}
body.light-mode .quick-action-btn{background:rgba(255,255,255,0.9);border-color:rgba(0,0,0,0.06)}
body.light-mode .quick-label{color:rgba(0,0,0,0.5)}
body.light-mode .news-card-home{background:rgba(255,255,255,0.9);border-color:rgba(0,0,0,0.06)}
body.light-mode .card-title{color:#1a1a2e}
body.light-mode .section-title-home{color:#1a1a2e}
body.light-mode .about-section{background:linear-gradient(135deg,rgba(0,150,57,0.06),rgba(201,162,39,0.04));border-color:rgba(0,0,0,0.06)}
body.light-mode .checkbox-row label{color:#1a1a2e}

/* خلفية Light Mode - أقصى بنهار */
body.light-mode .animated-bg{
  background:linear-gradient(180deg, #87CEEB 0%, #B0E0E6 30%, #E0F0FF 60%, #f0f2f5 100%)!important;
}
body.light-mode .stars{display:none}
body.light-mode .moon{
  background:radial-gradient(circle at 35% 35%, #FFD700, #FFA500)!important;
  box-shadow:0 0 40px rgba(255,200,0,0.6), 0 0 80px rgba(255,165,0,0.3)!important;
  width:60px!important;height:60px!important;top:6%!important;
  animation:sunPulse 8s ease-in-out infinite!important;
}
@keyframes sunPulse{
  0%,100%{box-shadow:0 0 40px rgba(255,200,0,0.6),0 0 80px rgba(255,165,0,0.3);transform:scale(1)}
  50%{box-shadow:0 0 60px rgba(255,200,0,0.8),0 0 100px rgba(255,165,0,0.5);transform:scale(1.05)}
}
body.light-mode .dome{
  background:linear-gradient(180deg, #DAA520 0%, #C9A227 50%, #B8860B 100%)!important;
  box-shadow:0 0 40px rgba(218,165,32,0.5)!important;
}
body.light-mode .dome-base{
  background:linear-gradient(180deg, #D4C5A9 0%, #C2B280 100%)!important;
}
body.light-mode .walls{
  background:linear-gradient(180deg, #C2B280 0%, #A89968 100%)!important;
}
body.light-mode .window{
  background:linear-gradient(180deg, #4A90D9 0%, #357ABD 100%)!important;
}
body.light-mode .minaret{
  background:linear-gradient(180deg, #D4C5A9 0%, #C2B280 50%, #A89968 100%)!important;
}
body.light-mode .minaret-top{
  background:linear-gradient(180deg, #DAA520 0%, #C9A227 100%)!important;
}
body.light-mode .alaqsa-container{opacity:0.25!important}
body.light-mode .particle{background:rgba(218,165,32,0.4)!important}
body.light-mode .flag-decoration{opacity:0.4!important}
body.light-mode .crescent{color:#DAA520!important}

/* خلفية Light - غيوم متحركة */
body.light-mode .animated-bg::before{
  content:'';
  position:absolute;
  width:200%;height:100%;
  top:15%;
  background:
    radial-gradient(ellipse 120px 40px at 10% 0%, rgba(255,255,255,0.7), transparent),
    radial-gradient(ellipse 150px 50px at 30% 20%, rgba(255,255,255,0.5), transparent),
    radial-gradient(ellipse 100px 35px at 55% 10%, rgba(255,255,255,0.6), transparent),
    radial-gradient(ellipse 180px 45px at 75% 25%, rgba(255,255,255,0.4), transparent),
    radial-gradient(ellipse 130px 40px at 90% 5%, rgba(255,255,255,0.5), transparent);
  animation:cloudsMove 60s linear infinite;
}
@keyframes cloudsMove{
  from{transform:translateX(0)}
  to{transform:translateX(-50%)}
}

/* خلفية الشعر - Light */
body.light-mode .bg-poetry .poetry-line{
  color:rgba(0,100,40,0.12)!important;
  text-shadow:none!important;
}

/* زر تبديل الوضع */
.theme-toggle{
  position:fixed;
  bottom:80px;
  left:20px;
  width:46px;
  height:46px;
  border-radius:50%;
  border:2px solid var(--border);
  background:var(--card);
  color:var(--text);
  font-size:1.3rem;
  cursor:pointer;
  z-index:160;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:all 0.4s ease;
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
  backdrop-filter:blur(10px);
}
.theme-toggle:hover{transform:scale(1.15);border-color:var(--gold);box-shadow:var(--glow-gold)}
.theme-toggle:active{transform:scale(0.95)}
body.light-mode .theme-toggle{background:rgba(255,255,255,0.9);border-color:rgba(0,0,0,0.1);box-shadow:0 4px 20px rgba(0,0,0,0.1)}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{
  font-family:'Tajawal',sans-serif;
  background:var(--black);
  color:var(--text);
  min-height:100vh;
  min-height:100dvh;
  line-height:1.6;
  -webkit-font-smoothing:antialiased;
}

/* ========== خلفية المسجد الأقصى المتحركة ========== */
.animated-bg{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
z-index:-1;
overflow:hidden;
background:linear-gradient(135deg, #0a0a0a 0%, #0d1521 50%, #111827 100%);
display:none;
}

.animated-bg.active{
display:block;
}

/* النجوم المتلألئة */
.stars{
position:absolute;
width:100%;
height:100%;
background-image:
radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.8), transparent),
radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.6), transparent),
radial-gradient(1.5px 1.5px at 90px 40px, rgba(255,255,255,0.9), transparent),
radial-gradient(2px 2px at 160px 120px, rgba(255,255,255,0.7), transparent),
radial-gradient(1px 1px at 230px 80px, rgba(255,255,255,0.8), transparent),
radial-gradient(2px 2px at 300px 150px, rgba(255,255,255,0.6), transparent),
radial-gradient(1.5px 1.5px at 350px 60px, rgba(255,255,255,0.5), transparent),
radial-gradient(2px 2px at 420px 180px, rgba(255,255,255,0.7), transparent),
radial-gradient(1px 1px at 500px 90px, rgba(255,255,255,0.9), transparent),
radial-gradient(2px 2px at 580px 130px, rgba(255,255,255,0.6), transparent);
background-size:600px 200px;
animation:twinkle 4s ease-in-out infinite;
}

@keyframes twinkle{
0%,100%{opacity:0.6}
50%{opacity:1}
}

/* القمر */
.moon{
position:absolute;
top:8%;
left:15%;
width:50px;
height:50px;
background:radial-gradient(circle at 35% 35%, #fffacd, #f0e68c);
border-radius:50%;
box-shadow:0 0 30px rgba(255,250,205,0.5), 0 0 60px rgba(255,250,205,0.3);
animation:moonGlow 6s ease-in-out infinite;
}

@keyframes moonGlow{
0%,100%{box-shadow:0 0 30px rgba(255,250,205,0.5), 0 0 60px rgba(255,250,205,0.3)}
50%{box-shadow:0 0 50px rgba(255,250,205,0.7), 0 0 80px rgba(255,250,205,0.4)}
}

/* قبة الصخرة */
.alaqsa-container{
position:absolute;
bottom:0;
left:50%;
transform:translateX(-50%);
width:100%;
max-width:800px;
height:300px;
opacity:0.15;
}

/* القبة الذهبية */
.dome{
position:absolute;
bottom:120px;
left:50%;
transform:translateX(-50%);
width:180px;
height:100px;
background:linear-gradient(180deg, #C9A227 0%, #b8960f 50%, #a6850d 100%);
border-radius:100px 100px 0 0;
box-shadow:0 0 30px rgba(201,162,39,0.3);
animation:domeShine 6s ease-in-out infinite;
}

@keyframes domeShine{
0%,100%{filter:brightness(1)}
50%{filter:brightness(1.2)}
}

/* الهلال فوق القبة */
.crescent{
position:absolute;
bottom:215px;
left:50%;
transform:translateX(-50%);
width:20px;
height:30px;
color:#C9A227;
font-size:30px;
animation:crescentGlow 3s ease-in-out infinite;
}

@keyframes crescentGlow{
0%,100%{text-shadow:0 0 10px rgba(201,162,39,0.5)}
50%{text-shadow:0 0 20px rgba(201,162,39,0.8)}
}

/* قاعدة القبة */
.dome-base{
position:absolute;
bottom:80px;
left:50%;
transform:translateX(-50%);
width:220px;
height:50px;
background:linear-gradient(180deg, #4a6fa5 0%, #3d5a80 100%);
border-radius:10px 10px 0 0;
}

/* الجدران */
.walls{
position:absolute;
bottom:0;
left:50%;
transform:translateX(-50%);
width:400px;
height:80px;
background:linear-gradient(180deg, #3d5a80 0%, #2c3e50 100%);
}

/* النوافذ */
.windows{
position:absolute;
bottom:20px;
left:50%;
transform:translateX(-50%);
display:flex;
gap:30px;
}

.window{
width:15px;
height:25px;
background:linear-gradient(180deg, #ffeaa7 0%, #fdcb6e 100%);
border-radius:8px 8px 0 0;
animation:windowGlow 4s ease-in-out infinite;
}

.window:nth-child(2){animation-delay:0.5s}
.window:nth-child(3){animation-delay:1s}
.window:nth-child(4){animation-delay:1.5s}
.window:nth-child(5){animation-delay:2s}

@keyframes windowGlow{
0%,100%{opacity:0.6;box-shadow:0 0 5px rgba(253,203,110,0.3)}
50%{opacity:1;box-shadow:0 0 15px rgba(253,203,110,0.6)}
}

/* المآذن */
.minaret{
position:absolute;
bottom:0;
width:30px;
height:200px;
background:linear-gradient(180deg, #4a6fa5 0%, #3d5a80 50%, #2c3e50 100%);
}

.minaret-left{left:calc(50% - 180px)}
.minaret-right{left:calc(50% + 150px)}

.minaret-top{
position:absolute;
top:-20px;
left:50%;
transform:translateX(-50%);
width:20px;
height:30px;
background:linear-gradient(180deg, #C9A227 0%, #b8960f 100%);
border-radius:50% 50% 0 0;
}

/* الجسيمات المتطايرة */
.particles{
position:absolute;
width:100%;
height:100%;
overflow:hidden;
}

.particle{
position:absolute;
width:4px;
height:4px;
background:rgba(201,162,39,0.6);
border-radius:50%;
animation:float 15s infinite;
}

.particle:nth-child(1){left:10%;animation-delay:0s;animation-duration:12s}
.particle:nth-child(2){left:20%;animation-delay:2s;animation-duration:14s}
.particle:nth-child(3){left:30%;animation-delay:4s;animation-duration:11s}
.particle:nth-child(4){left:40%;animation-delay:1s;animation-duration:16s}
.particle:nth-child(5){left:50%;animation-delay:3s;animation-duration:13s}
.particle:nth-child(6){left:60%;animation-delay:5s;animation-duration:15s}
.particle:nth-child(7){left:70%;animation-delay:2s;animation-duration:12s}
.particle:nth-child(8){left:80%;animation-delay:4s;animation-duration:14s}
.particle:nth-child(9){left:90%;animation-delay:1s;animation-duration:11s}
.particle:nth-child(10){left:95%;animation-delay:3s;animation-duration:16s}

@keyframes float{
0%{transform:translateY(100vh) rotate(0deg);opacity:0}
10%{opacity:1}
90%{opacity:1}
100%{transform:translateY(-100vh) rotate(720deg);opacity:0}
}

/* العلم الفلسطيني المتحرك */
.flag-decoration{
position:absolute;
top:20%;
right:10%;
width:40px;
height:25px;
opacity:0.3;
animation:flagWave 3s ease-in-out infinite;
}

.flag-stripe{
height:33.33%;
}

.flag-black{background:#1a1a1a}
.flag-white{background:#ffffff}
.flag-green{background:#009639}

.flag-triangle{
position:absolute;
left:0;
top:0;
width:0;
height:0;
border-top:12.5px solid transparent;
border-bottom:12.5px solid transparent;
border-left:15px solid #CE1126;
}

@keyframes flagWave{
0%,100%{transform:rotate(-5deg)}
50%{transform:rotate(5deg)}
}

/* ========== الخلفية 2: أبيات الشعر ========== */
.bg-poetry{display:none}
.bg-poetry.active{display:block}

.poetry-container{
position:absolute;
width:100%;
height:100%;
overflow:hidden;
}

.poetry-line{
position:absolute;
font-size:1.5rem;
font-weight:600;
color:rgba(255,255,255,0.15);
white-space:nowrap;
text-shadow:0 0 30px rgba(201,162,39,0.3);
left:-100%;
animation:poetryFloatLTR 30s linear infinite;
opacity:0;
}

@keyframes poetryFloatLTR{
0%{left:-100%;opacity:0}
2%{opacity:1}
98%{opacity:1}
100%{left:100%;opacity:0}
}

.poetry-glow{
position:absolute;
width:300px;
height:300px;
border-radius:50%;
filter:blur(80px);
animation:glowMove 10s ease-in-out infinite;
}

.glow-gold{background:rgba(201,162,39,0.1);top:20%;left:10%}
.glow-green{background:rgba(0,150,57,0.1);top:50%;right:10%;animation-delay:3s}
.glow-red{background:rgba(206,17,38,0.1);bottom:10%;left:30%;animation-delay:6s}

@keyframes glowMove{
0%,100%{transform:translate(0,0) scale(1)}
50%{transform:translate(50px,30px) scale(1.2)}
}

/* ========== الخلفية 3: حمامة السلام ========== */
.bg-dove{display:none}
.bg-dove.active{display:block}

.dove{
position:absolute;
font-size:4rem;
opacity:0.15;
animation:dovefly 25s linear infinite;
}

.dove:nth-child(1){top:20%;animation-delay:0s;font-size:5rem}
.dove:nth-child(2){top:40%;animation-delay:5s;font-size:3.5rem}
.dove:nth-child(3){top:60%;animation-delay:10s;font-size:4.5rem}
.dove:nth-child(4){top:30%;animation-delay:15s;font-size:3rem}
.dove:nth-child(5){top:70%;animation-delay:20s;font-size:4rem}

@keyframes dovefly{
0%{transform:translateX(-100px) translateY(0) rotate(0deg);opacity:0}
10%{opacity:0.15}
50%{transform:translateX(50vw) translateY(-30px) rotate(5deg)}
90%{opacity:0.15}
100%{transform:translateX(100vw) translateY(0) rotate(0deg);opacity:0}
}

.olive-branch{
position:absolute;
font-size:2rem;
opacity:0.2;
animation:oliveFall 15s linear infinite;
}

.olive-branch:nth-child(1){left:10%;animation-delay:0s}
.olive-branch:nth-child(2){left:25%;animation-delay:2s}
.olive-branch:nth-child(3){left:40%;animation-delay:4s}
.olive-branch:nth-child(4){left:55%;animation-delay:6s}
.olive-branch:nth-child(5){left:70%;animation-delay:8s}
.olive-branch:nth-child(6){left:85%;animation-delay:10s}

@keyframes oliveFall{
0%{transform:translateY(-50px) rotate(0deg);opacity:0}
10%{opacity:0.2}
90%{opacity:0.2}
100%{transform:translateY(100vh) rotate(360deg);opacity:0}
}

.peace-text{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
font-size:3rem;
font-weight:700;
color:rgba(255,255,255,0.05);
text-align:center;
animation:peaceGlow 5s ease-in-out infinite;
}

@keyframes peaceGlow{
0%,100%{text-shadow:0 0 30px rgba(0,150,57,0.2)}
50%{text-shadow:0 0 60px rgba(0,150,57,0.4)}
}

/* زر تبديل الخلفية */
.bg-switcher{
position:fixed;
bottom:20px;
left:20px;
z-index:1000;
display:flex;
gap:8px;
background:rgba(22,27,34,0.9);
padding:10px;
border-radius:12px;
border:1px solid var(--border);
backdrop-filter:blur(10px);
}

.bg-btn{
width:35px;
height:35px;
border:2px solid var(--border);
border-radius:8px;
background:var(--card);
cursor:pointer;
font-size:1rem;
display:flex;
align-items:center;
justify-content:center;
transition:all 0.3s;
}

.bg-btn:hover{
border-color:var(--gold);
transform:scale(1.1);
}

.bg-btn.active{
border-color:var(--green);
background:rgba(0,150,57,0.2);
box-shadow:0 0 10px rgba(0,150,57,0.3);
}

.app{display:flex;min-height:100vh;min-height:100dvh;position:relative;z-index:1}

/* ========== Sidebar - محسّن ========== */
.sidebar{
  width:var(--sidebar-width);
  background:rgba(10,10,10,0.85);
  backdrop-filter:var(--blur);
  -webkit-backdrop-filter:var(--blur);
  border-left:1px solid var(--border);
  position:fixed;
  right:0;
  top:0;
  bottom:0;
  display:flex;
  flex-direction:column;
  z-index:100;
  transition:transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.sidebar-header{
  padding:24px 20px;
  text-align:center;
  border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,rgba(0,210,106,0.1),rgba(230,57,70,0.08));
}

.logo{
  width:85px;
  height:85px;
  border-radius:50%;
  border:3px solid var(--green);
  margin:0 auto 12px;
  background:linear-gradient(135deg,var(--green),var(--red));
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:2.2rem;
  overflow:hidden;
  box-shadow:var(--glow-green);
  transition:var(--spring);
}

.logo:hover{transform:scale(1.05)}
.logo img{width:100%;height:100%;object-fit:cover}
.org-name{font-size:1rem;font-weight:700;margin-bottom:2px}
.org-sub{font-size:0.75rem;color:var(--muted)}

.nav{flex:1;padding:16px;overflow-y:auto;scrollbar-width:none}
.nav::-webkit-scrollbar{display:none}

.nav-title{
  font-size:0.7rem;
  font-weight:700;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:1px;
  padding:12px 0 8px;
  border-bottom:1px solid var(--border);
  margin-bottom:8px;
}

.nav-btn{
  display:flex;
  align-items:center;
  gap:10px;
  width:100%;
  padding:14px 16px;
  margin-bottom:4px;
  background:transparent;
  border:none;
  border-radius:var(--radius-md);
  color:var(--muted);
  font-family:inherit;
  font-size:0.9rem;
  font-weight:500;
  cursor:pointer;
  text-align:right;
  transition:var(--transition);
}

.nav-btn:hover{
  background:rgba(255,255,255,0.05);
  color:var(--text);
  transform:translateX(-4px);
}

.nav-btn:active{transform:scale(0.98)}

.nav-btn.active{
  background:linear-gradient(135deg,var(--green),#00a854);
  color:white;
  box-shadow:var(--glow-green);
}

.nav-btn.hidden{display:none}
.hidden{display:none!important}

.sidebar-footer{
  padding:16px;
  border-top:1px solid var(--border);
  background:rgba(0,0,0,0.3);
}
.privacy-link{
  display:block;
  text-align:center;
  color:var(--muted);
  font-size:0.75rem;
  margin-top:10px;
  cursor:pointer;
  transition:color 0.2s;
}
.privacy-link:hover{color:var(--green);}

/* Cookie Consent Banner */
.cookie-banner{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:var(--card-solid);
  border-top:2px solid var(--green);
  padding:16px 24px;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:16px;
  flex-wrap:wrap;
  z-index:99999;
  box-shadow:0 -4px 20px rgba(0,0,0,0.4);
  animation:slideUp 0.4s ease;
}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.cookie-banner-text{
  color:var(--text);
  font-size:0.9rem;
  flex:1;
  min-width:200px;
}
.cookie-banner-text a{color:var(--green);text-decoration:underline;cursor:pointer;}
.cookie-banner-btns{display:flex;gap:10px;flex-wrap:wrap;}
.cookie-btn-accept{
  padding:10px 28px;
  background:var(--green);
  color:white;
  border:none;
  border-radius:var(--radius-sm);
  font-weight:700;
  cursor:pointer;
  font-family:inherit;
  font-size:0.9rem;
  transition:all 0.2s;
}
.cookie-btn-accept:hover{transform:scale(1.05);box-shadow:var(--glow-green);}

/* Privacy Policy Page */
.privacy-page{padding:20px;}
.privacy-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:30px;
  margin-bottom:20px;
}
.privacy-card h2{
  color:var(--green);
  font-size:1.3rem;
  margin-bottom:15px;
  padding-bottom:10px;
  border-bottom:2px solid var(--border);
}
.privacy-card h3{
  color:var(--gold);
  font-size:1.1rem;
  margin:15px 0 8px;
}
.privacy-card p,.privacy-card li{
  color:var(--text);
  line-height:1.8;
  font-size:0.95rem;
  margin-bottom:8px;
}
.privacy-card ul{
  padding-right:20px;
  margin:10px 0;
}
.privacy-card ul li{margin-bottom:6px;}
.privacy-tabs{display:flex;gap:10px;margin-bottom:20px;}
.privacy-tab{
  padding:10px 20px;
  border-radius:var(--radius-sm);
  border:1px solid var(--border);
  background:transparent;
  color:var(--muted);
  cursor:pointer;
  font-family:inherit;
  font-size:0.9rem;
  transition:all 0.2s;
}
.privacy-tab.active{background:var(--green);color:white;border-color:var(--green);}
.privacy-lang{display:none;}
.privacy-lang.active{display:block;}

/* ========== Photo Gallery ========== */
.gallery-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
  gap:16px;
}
.gallery-album{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  overflow:hidden;
  cursor:pointer;
  transition:var(--transition);
}
.gallery-album:hover{border-color:var(--green);transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,0.3);}
.gallery-album-cover{
  width:100%;height:180px;object-fit:cover;
  background:linear-gradient(135deg,var(--green),var(--red));
}
.gallery-album-info{padding:14px;}
.gallery-album-title{font-weight:700;margin-bottom:4px;}
.gallery-album-count{font-size:0.8rem;color:var(--muted);}
.gallery-album-date{font-size:0.75rem;color:var(--muted);}

.gallery-photos{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:10px;
}
.gallery-photo{
  width:100%;height:150px;object-fit:cover;
  border-radius:var(--radius-sm);
  cursor:pointer;transition:var(--transition);
}
.gallery-photo:hover{transform:scale(1.05);box-shadow:0 4px 20px rgba(0,0,0,0.3);}

/* Admin Gallery */
.gallery-upload-area{
  border:2px dashed var(--border);
  border-radius:var(--radius-md);
  padding:30px;text-align:center;
  cursor:pointer;transition:var(--transition);
  color:var(--muted);
}
.gallery-upload-area:hover{border-color:var(--green);color:var(--green);}
.gallery-thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.gallery-thumb{
  width:80px;height:80px;object-fit:cover;
  border-radius:var(--radius-sm);position:relative;
}
.gallery-thumb-wrap{position:relative;display:inline-block;}
.gallery-thumb-remove{
  position:absolute;top:-6px;right:-6px;
  width:22px;height:22px;border-radius:50%;
  background:var(--red);color:#fff;border:none;
  font-size:0.8rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}

/* ========== Upcoming Events Timeline ========== */
.upcoming-events-wrapper{margin-bottom:10px;}
.upcoming-event{
  display:flex;align-items:center;gap:14px;
  padding:12px 16px;background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  border-right:4px solid var(--gold);
  margin-bottom:8px;transition:var(--transition);
}
.upcoming-event:hover{border-color:var(--green);transform:translateX(-3px);}
.upcoming-event-date{
  text-align:center;min-width:55px;
  background:linear-gradient(135deg,rgba(201,162,39,0.15),rgba(201,162,39,0.05));
  padding:8px 10px;border-radius:var(--radius-sm);
}
.upcoming-event-day{font-size:1.4rem;font-weight:800;color:var(--gold);line-height:1;}
.upcoming-event-month{font-size:0.7rem;color:var(--muted);margin-top:2px;}
.upcoming-event-info{flex:1;}
.upcoming-event-title{font-weight:700;font-size:0.95rem;margin-bottom:2px;}
.upcoming-event-desc{font-size:0.8rem;color:var(--muted);}
.upcoming-event-countdown{
  font-size:0.7rem;color:var(--green);
  background:rgba(0,210,106,0.1);
  padding:3px 10px;border-radius:12px;
  white-space:nowrap;
}

/* ========== Voting Results Charts ========== */
.vote-result-chart{margin-top:15px;}
.vote-bar-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.vote-bar-label{min-width:100px;font-size:0.9rem;text-align:left;}
.vote-bar-track{flex:1;height:28px;background:rgba(255,255,255,0.08);border-radius:14px;overflow:hidden;position:relative;}
.vote-bar-fill{height:100%;border-radius:14px;transition:width 0.8s ease;display:flex;align-items:center;justify-content:flex-end;padding:0 10px;font-size:0.8rem;font-weight:700;color:#fff;min-width:fit-content;}
.vote-bar-count{font-size:0.85rem;color:var(--muted);min-width:50px;text-align:center;}

.visitor-box{
  background:linear-gradient(135deg,var(--gold),#e6c200);
  color:var(--black);
  padding:10px 12px;
  border-radius:var(--radius-sm);
  text-align:center;
  font-size:0.85rem;
  font-weight:700;
  margin-bottom:12px;
  box-shadow:var(--glow-gold);
}

.login-btn{
  display:block;
  width:100%;
  padding:14px;
  background:linear-gradient(135deg,var(--green),#00a854);
  color:white;
  border:none;
  border-radius:var(--radius-md);
  font-family:inherit;
  font-size:0.9rem;
  font-weight:700;
  cursor:pointer;
  transition:var(--spring);
}

.login-btn:hover{transform:translateY(-2px);box-shadow:var(--glow-green)}
.login-btn:active{transform:scale(0.98)}
.login-btn.logout{background:linear-gradient(135deg,var(--red),#c41e3a)}
.login-btn.logout:hover{box-shadow:var(--glow-red)}

/* ========== Main Content - محسّن ========== */
.main{
  flex:1;
  margin-right:var(--sidebar-width);
  padding:24px;
  transition:margin 0.4s ease;
}

.header{
  background:var(--card);
  backdrop-filter:var(--blur);
  border-radius:var(--radius-lg);
  padding:28px;
  margin-bottom:24px;
  border:1px solid var(--border);
  position:relative;
  overflow:hidden;
}

.header::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:3px;
  background:linear-gradient(90deg,var(--black),var(--green),white,var(--red));
}

.header h1{font-size:1.5rem;font-weight:800;margin-bottom:8px}
.header p{color:var(--muted);font-size:0.95rem}

.page{display:none;animation:fadeIn 0.4s ease}
.page.active{display:block}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* ========== Cards - محسّن ========== */
.card{
  background:var(--card);
  backdrop-filter:var(--blur);
  border-radius:var(--radius-lg);
  padding:24px;
  border:1px solid var(--border);
  margin-bottom:20px;
  transition:var(--transition);
}

.card:hover{border-color:var(--border-hover)}

.card-title{
  font-size:1.05rem;
  font-weight:700;
  margin-bottom:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:12px;
}

.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px}

/* ========== Forms - محسّن ========== */
.form-group{margin-bottom:18px}
.form-label{display:block;font-size:0.85rem;font-weight:600;color:var(--muted);margin-bottom:10px}

.form-input,.form-select,.form-textarea{
  width:100%;
  padding:14px 16px;
  background:rgba(0,0,0,0.4);
  border:2px solid var(--border);
  border-radius:var(--radius-md);
  color:var(--text);
  font-family:inherit;
  font-size:1rem;
  transition:var(--transition);
}

.form-input:focus,.form-select:focus,.form-textarea:focus{
  outline:none;
  border-color:var(--green);
  box-shadow:0 0 0 4px rgba(0,210,106,0.15);
}

.form-input::placeholder{color:var(--muted)}
.form-textarea{min-height:100px;resize:vertical}

/* ========== Buttons - محسّن ========== */
.btn{
  padding:12px 24px;
  border:none;
  border-radius:var(--radius-md);
  font-family:inherit;
  font-size:0.9rem;
  font-weight:700;
  cursor:pointer;
  margin-left:8px;
  margin-bottom:5px;
  transition:var(--spring);
  display:inline-flex;
  align-items:center;
  gap:8px;
}

.btn:active{transform:scale(0.96)}

.btn-green{
  background:linear-gradient(135deg,var(--green),#00a854);
  color:white;
  box-shadow:0 4px 15px rgba(0,210,106,0.3);
}
.btn-green:hover{transform:translateY(-2px);box-shadow:var(--glow-green)}

.btn-red{
  background:linear-gradient(135deg,var(--red),#c41e3a);
  color:white;
  box-shadow:0 4px 15px rgba(230,57,70,0.3);
}
.btn-red:hover{transform:translateY(-2px);box-shadow:var(--glow-red)}

.btn-gray{
  background:rgba(255,255,255,0.1);
  color:var(--text);
  border:1px solid var(--border);
}
.btn-gray:hover{background:rgba(255,255,255,0.15);border-color:var(--border-hover)}

.btn-gold{
  background:linear-gradient(135deg,var(--gold),#e6c200);
  color:var(--black);
  box-shadow:0 4px 15px rgba(255,209,102,0.3);
}
.btn-gold:hover{transform:translateY(-2px);box-shadow:var(--glow-gold)}

.btn-sm{padding:8px 16px;font-size:0.8rem}

/* ========== Modals - محسّن ========== */
.modal-bg{
  display:none;
  position:fixed;
  top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.9);
  backdrop-filter:var(--blur);
  z-index:200;
  justify-content:center;
  align-items:center;
  padding:20px;
  overflow-y:auto;
}

.modal-bg.show{display:flex}

.modal{
  background:var(--card-solid);
  border-radius:var(--radius-lg);
  width:100%;
  max-width:500px;
  border:1px solid var(--border);
  max-height:90vh;
  overflow-y:auto;
  animation:modalSlide 0.4s var(--spring);
}

@keyframes modalSlide{
  from{opacity:0;transform:scale(0.95) translateY(20px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}

.modal-head{
  padding:18px 24px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  background:var(--card-solid);
  z-index:1;
}

.modal-close{
  background:rgba(255,255,255,0.1);
  border:none;
  color:var(--text);
  font-size:1.2rem;
  cursor:pointer;
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:var(--transition);
}

.modal-close:hover{background:var(--red);color:white}

.modal-body{padding:24px}

.modal-foot{
  padding:18px 24px;
  border-top:1px solid var(--border);
  display:flex;
  gap:12px;
  justify-content:flex-end;
  position:sticky;
  bottom:0;
  background:var(--card-solid);
}

/* ========== Toast - محسّن ========== */
.toast{
  position:fixed;
  bottom:30px;
  left:50%;
  transform:translateX(-50%) translateY(100px);
  background:rgba(10,10,10,0.95);
  backdrop-filter:var(--blur);
  padding:14px 24px;
  border-radius:100px;
  border:2px solid var(--green);
  opacity:0;
  transition:var(--transition);
  z-index:300;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:10px;
}

.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.toast.error{border-color:var(--red)}

/* ========== Stats - محسّن ========== */
.stat-num{font-size:1.8rem;font-weight:900;margin-bottom:4px;background:linear-gradient(135deg,var(--text),var(--muted));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-label{font-size:0.85rem;color:var(--muted);font-weight:500}

/* ========== Transactions ========== */
.tx-item{display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;transition:var(--transition)}
.tx-item:hover{background:rgba(255,255,255,0.02);margin:0 -12px;padding:14px 12px;border-radius:var(--radius-sm)}
.tx-icon{width:42px;height:42px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.tx-icon.inc{background:rgba(0,210,106,0.15)}
.tx-icon.exp{background:rgba(230,57,70,0.15)}
.tx-info{flex:1;min-width:150px}
.tx-title{font-weight:600;font-size:0.95rem}
.tx-date{font-size:0.8rem;color:var(--muted)}
.tx-amount{font-weight:800;font-size:1rem}
.tx-amount.inc{color:var(--green)}
.tx-amount.exp{color:var(--red)}
.tx-actions{display:flex;gap:6px}
.tx-receipts{width:100%;margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}
.tx-receipt-img{width:65px;height:65px;border-radius:var(--radius-sm);object-fit:cover;cursor:pointer;border:2px solid var(--border);transition:var(--transition)}
.tx-receipt-img:hover{border-color:var(--green);transform:scale(1.05)}

#map{width:100%;height:400px;border-radius:var(--radius-md)}

.toggle-row{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:rgba(0,0,0,0.3);border-radius:var(--radius-sm);margin-bottom:10px;border:1px solid var(--border)}

/* ========== Members ========== */
.member-item{
  display:flex;
  align-items:center;
  gap:14px;
  padding:16px;
  background:rgba(0,0,0,0.3);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  margin-bottom:10px;
  transition:var(--transition);
  cursor:pointer;
}

.member-item:hover{border-color:var(--green);background:rgba(0,210,106,0.05)}
.member-item:active{transform:scale(0.99)}

.member-avatar{
  width:48px;
  height:48px;
  border-radius:50%;
  background:linear-gradient(135deg,var(--green),var(--gold));
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:1.3rem;
  overflow:hidden;
  flex-shrink:0;
}

.member-avatar img{width:100%;height:100%;object-fit:cover}
.member-info{flex:1;min-width:0}
.member-name{font-weight:700;font-size:0.95rem;margin-bottom:2px}
.member-city{font-size:0.8rem;color:var(--muted)}
.member-code{font-size:0.75rem;color:var(--muted);margin-top:4px;font-family:monospace}
.member-phone{font-size:0.85rem;color:var(--green);margin-top:4px}

.badge{display:inline-block;padding:4px 10px;border-radius:100px;font-size:0.7rem;font-weight:600}
.badge-green{background:rgba(0,210,106,0.15);color:var(--green)}
.badge-red{background:rgba(230,57,70,0.15);color:var(--red)}

.checkbox-row{display:flex;align-items:center;gap:10px;padding:8px 0}
.checkbox-row input{width:18px;height:18px;accent-color:var(--green);cursor:pointer}

.upload-box{
  border:2px dashed var(--border);
  border-radius:var(--radius-md);
  padding:24px;
  text-align:center;
  cursor:pointer;
  transition:var(--transition);
}

.upload-box:hover{border-color:var(--green);background:rgba(0,210,106,0.05)}

.editor-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
@media(max-width:900px){.editor-grid{grid-template-columns:1fr}}

/* Invitation Card */
.inv-card{width:100%;max-width:360px;background:white;box-shadow:0 20px 60px rgba(0,0,0,0.5);margin:0 auto;border-radius:var(--radius-md);overflow:hidden}
.flag-bar{height:6px;display:flex}.flag-bar .bk{background:#000;flex:1}.flag-bar .wh{background:#fff;flex:1}.flag-bar .gr{background:#009736;flex:1}
.inv-content{padding:24px;text-align:center;color:#1a1a1a}
.inv-logo{width:55px;height:55px;border-radius:50%;margin:0 auto 12px;background:linear-gradient(135deg,#009639,#CE1126);overflow:hidden}
.inv-logo img{width:100%;height:100%;object-fit:cover}
.inv-title{font-size:1.3rem;color:#009736;margin-bottom:8px;font-weight:800}
.inv-sub{color:#666;margin-bottom:12px;font-size:0.95rem}
.inv-text{font-size:0.9rem;line-height:1.7;margin-bottom:14px;white-space:pre-line}
.inv-details{background:#f5f5f5;padding:14px;border-radius:var(--radius-sm);margin-bottom:14px}
.inv-row{margin-bottom:6px;font-size:0.85rem}
.inv-welcome{color:#CE1126;font-weight:700;font-size:1rem}
/* Conference Invitation */
.conf-grid{display:grid;grid-template-columns:1fr 1fr;gap:25px}

/* ========== التقارير والإحصائيات ========== */
.report-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.report-tab{padding:10px 20px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--dark);color:var(--muted);cursor:pointer;font-family:inherit;font-size:0.85rem;font-weight:600;transition:var(--transition)}
.report-tab:hover{border-color:var(--green);color:var(--text)}
.report-tab.active{background:linear-gradient(135deg,var(--green),#007a2f);color:#fff;border-color:var(--green)}
.report-panel{display:none}
.report-panel.active{display:block}
.report-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px}
.report-stat{background:var(--dark);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;text-align:center}
.report-stat-num{font-size:2rem;font-weight:800;background:linear-gradient(135deg,var(--green),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.report-stat-label{font-size:0.75rem;color:var(--muted);margin-top:4px}
.chart-container{background:var(--dark);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;margin-bottom:16px}
.chart-title{font-weight:700;margin-bottom:15px;font-size:0.95rem}
.chart-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.chart-bar-label{width:100px;font-size:0.8rem;color:var(--muted);text-align:left;flex-shrink:0}
.chart-bar-track{flex:1;height:28px;background:rgba(255,255,255,0.05);border-radius:14px;overflow:hidden;position:relative}
.chart-bar-fill{height:100%;border-radius:14px;transition:width 1s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:10px;font-size:0.75rem;font-weight:700;color:#fff;min-width:30px}
.chart-bar-green{background:linear-gradient(90deg,#009639,#00D26A)}
.chart-bar-red{background:linear-gradient(90deg,#CE1126,#E63946)}
.chart-bar-gold{background:linear-gradient(90deg,#b8860b,#FFD166)}
.chart-bar-blue{background:linear-gradient(90deg,#1e3a5f,#4A90D9)}
.chart-donut{width:180px;height:180px;margin:0 auto 15px}
.report-table{width:100%;border-collapse:collapse;font-size:0.8rem}
.report-table th{background:var(--dark);color:var(--green);padding:10px 8px;text-align:right;border-bottom:2px solid var(--green);font-weight:700}
.report-table td{padding:10px 8px;border-bottom:1px solid var(--border);color:var(--text)}
.report-table tr:hover td{background:rgba(0,210,106,0.05)}
.report-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
.report-period{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
.report-period select,.report-period input{padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--dark);color:var(--text);font-family:inherit;font-size:0.85rem}
body.light-mode .report-stat{background:#f8f9fa;border-color:rgba(0,0,0,0.06)}
body.light-mode .chart-container{background:#f8f9fa;border-color:rgba(0,0,0,0.06)}
body.light-mode .chart-bar-track{background:rgba(0,0,0,0.05)}
body.light-mode .report-table th{background:#f8f9fa;border-bottom-color:#009639}
body.light-mode .report-table td{border-bottom-color:rgba(0,0,0,0.06)}
body.light-mode .report-tab{background:#f8f9fa;border-color:rgba(0,0,0,0.08)}
body.light-mode .report-period select,body.light-mode .report-period input{background:#f8f9fa;border-color:rgba(0,0,0,0.1);color:#1a1a2e}
@media(max-width:1000px){.conf-grid{grid-template-columns:1fr}}
.conf-card{background:#fff;max-width:480px;margin:0 auto;box-shadow:0 10px 40px rgba(0,0,0,0.3);border-radius:8px;overflow:hidden}
.conf-head{background:linear-gradient(135deg,#009639,#006428);padding:25px 20px 35px;text-align:center}
.conf-dome svg{filter:drop-shadow(0 4px 10px rgba(0,0,0,0.3))}
.conf-org-ar{color:#fff;font-size:1.3rem;font-weight:700;margin-top:10px;text-shadow:1px 1px 3px rgba(0,0,0,0.3)}
.conf-org-en{color:rgba(255,255,255,0.85);font-size:0.9rem;margin-top:3px}
.conf-verse-sec{background:#f5f5f5;padding:18px;text-align:center;border-bottom:3px solid #009639}
.conf-bism{color:#009639;font-weight:700;margin-bottom:6px}
.conf-verse{color:#333;font-size:0.9rem;line-height:1.7}
.conf-verse-ref{color:#777;font-size:0.8rem;margin-top:5px}
.conf-inv-txt{padding:18px;text-align:center;color:#333;font-size:0.9rem;line-height:1.6;background:#fff}
.conf-title-box{background:#CE1126;margin:0 25px;padding:14px;text-align:center}
.conf-title-box span{color:#fff;font-size:1.4rem;font-weight:800}
.conf-date{text-align:center;padding:12px;font-size:1.2rem;font-weight:700;color:#333}
.conf-agenda-sec{padding:18px;background:#fff}
.conf-agenda-head{text-align:center;font-weight:700;color:#333;margin-bottom:12px}
.conf-agenda-list{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.conf-agenda-row{display:flex;align-items:center;gap:8px;padding:8px;background:#f9f9f9;border-radius:6px}
.conf-agenda-n{width:26px;height:26px;background:#009639;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;flex-shrink:0}
.conf-agenda-t{color:#333;font-size:0.8rem;flex:1}
.conf-details-sec{background:linear-gradient(135deg,#009639,#006428);padding:18px;margin-top:12px}
.conf-det-row{color:#fff;padding:6px 0;font-size:0.85rem}
.conf-footer-txt{padding:18px;text-align:center;color:#333;font-size:0.85rem;background:#fff}
.conf-slogan{text-align:center;padding:8px;color:#CE1126;font-weight:700;background:#fff}
.conf-flag{display:flex;height:6px}
.conf-flag>div{flex:1}
.conf-flag-bk{background:#1a1a1a}
.conf-flag-wh{background:#fff}
.conf-flag-gr{background:#009639}
.conf-edit-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;padding:10px;background:var(--dark);border-radius:8px;border:1px solid var(--border)}
.conf-edit-item input{flex:1}
.conf-edit-num{width:26px;height:26px;background:var(--green);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0}

.visibility-select{padding:8px 12px;background:rgba(0,0,0,0.4);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:0.85rem}

.admin-stats{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px}
.admin-stat{background:rgba(0,0,0,0.3);padding:16px 24px;border-radius:var(--radius-md);text-align:center;border:1px solid var(--border)}
.admin-stat-num{font-size:1.6rem;font-weight:900;color:var(--gold)}
.admin-stat-label{font-size:0.8rem;color:var(--muted)}

.center-marker{background:linear-gradient(135deg,var(--gold),#e6c200);color:var(--black);padding:12px 18px;border-radius:var(--radius-sm);margin-top:12px;display:none;font-weight:600}
.center-marker.show{display:block}

/* ========== Home Customization Styles ========== */
.home-sections-grid{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.home-section-item{
  background:rgba(0,0,0,0.3);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  overflow:hidden;
  transition:var(--transition);
}

.home-section-item:hover{
  border-color:var(--border-hover);
}

.home-section-header{
  display:flex;
  align-items:center;
  gap:12px;
  padding:16px;
}

.home-section-title{
  flex:1;
  font-weight:600;
  font-size:0.95rem;
}

.home-section-edit{
  padding:0 16px 16px;
  border-top:1px solid var(--border);
  background:rgba(0,0,0,0.2);
  animation:slideDown 0.3s ease;
}

@keyframes slideDown{
  from{opacity:0;max-height:0}
  to{opacity:1;max-height:500px}
}

/* Toggle Switch */
.toggle-switch{
  position:relative;
  display:inline-block;
  width:50px;
  height:28px;
  flex-shrink:0;
}

.toggle-switch input{
  opacity:0;
  width:0;
  height:0;
}

.toggle-slider{
  position:absolute;
  cursor:pointer;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(255,255,255,0.1);
  border-radius:28px;
  transition:var(--transition);
  border:2px solid var(--border);
}

.toggle-slider::before{
  position:absolute;
  content:"";
  height:20px;
  width:20px;
  left:3px;
  bottom:2px;
  background:var(--muted);
  border-radius:50%;
  transition:var(--transition);
}

.toggle-switch input:checked + .toggle-slider{
  background:var(--green);
  border-color:var(--green);
}

.toggle-switch input:checked + .toggle-slider::before{
  transform:translateX(22px);
  background:white;
}

/* Event Item */
.event-item{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  background:rgba(0,0,0,0.2);
  border-radius:var(--radius-sm);
  margin-bottom:8px;
  border:1px solid var(--border);
}

.event-item input{
  flex:1;
}

.event-item .event-date{
  width:130px;
}

/* News Cards */
.news-card{
  background:var(--card);
  border-radius:var(--radius-lg);
  overflow:hidden;
  border:1px solid var(--border);
  transition:var(--transition);
  margin-bottom:20px;
}

.news-card:hover{border-color:var(--green);box-shadow:0 12px 40px rgba(0,0,0,0.3)}

.news-card-img{width:100%;height:160px;object-fit:cover;background:linear-gradient(135deg,var(--green),var(--red))}
.news-card-body{padding:20px}
.news-card-date{font-size:0.8rem;color:var(--muted);margin-bottom:8px}
.news-card-title{font-weight:700;margin-bottom:10px;font-size:1.1rem}

/* Facebook-style Image Gallery */
.news-gallery-wrapper{position:relative;overflow:hidden;background:#000;border-top:1px solid var(--border);}
.news-gallery-slider{display:flex;transition:transform 0.35s cubic-bezier(0.4,0,0.2,1);will-change:transform;}
.news-gallery-slide{min-width:100%;display:flex;align-items:center;justify-content:center;max-height:400px;}
.news-gallery-slide img{width:100%;max-height:400px;object-fit:contain;cursor:pointer;}
.news-gallery-btn{
  position:absolute;top:50%;transform:translateY(-50%);
  width:40px;height:40px;border-radius:50%;
  background:rgba(0,0,0,0.6);color:#fff;border:none;
  font-size:1.2rem;cursor:pointer;z-index:5;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;backdrop-filter:blur(4px);
}
.news-gallery-btn:hover{background:rgba(0,0,0,0.85);transform:translateY(-50%) scale(1.1);}
.news-gallery-prev{right:12px;}
.news-gallery-next{left:12px;}
.news-gallery-counter{
  position:absolute;bottom:10px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,0.65);color:#fff;
  padding:4px 14px;border-radius:20px;font-size:0.8rem;
  backdrop-filter:blur(4px);
}
.news-gallery-dots{
  display:flex;justify-content:center;gap:6px;padding:10px 0;
}
.news-gallery-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--muted);cursor:pointer;transition:all 0.2s;border:none;
}
.news-gallery-dot.active{background:var(--green);transform:scale(1.3);}

/* ========== Enhanced Home Page Styles ========== */
.hero-section{
  background:linear-gradient(135deg, rgba(0,210,106,0.15), rgba(230,57,70,0.1));
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:50px 30px;
  text-align:center;
  margin-bottom:24px;
  position:relative;
  overflow:hidden;
}

.hero-section::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  right:0;
  height:4px;
  background:linear-gradient(90deg, #000, var(--green), #fff, var(--red));
}

.hero-flag{
  font-size:4rem;
  margin-bottom:16px;
  animation:flagWave 3s ease-in-out infinite;
}

.hero-title{
  font-size:1.8rem;
  font-weight:900;
  margin-bottom:12px;
  background:linear-gradient(135deg, var(--text), var(--muted));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.hero-subtitle{
  font-size:1.1rem;
  color:var(--muted);
  margin-bottom:28px;
}

.hero-buttons{
  display:flex;
  gap:12px;
  justify-content:center;
  flex-wrap:wrap;
}

.btn-lg{
  padding:16px 32px;
  font-size:1rem;
}

/* Stats Section */
.stats-section{
  margin-bottom:24px;
}

.stats-grid-home{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:12px;
}

.stat-card-home{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:20px 16px;
  text-align:center;
  transition:var(--transition);
  position:relative;
  overflow:hidden;
}

.stat-card-home::after{
  content:'';
  position:absolute;
  bottom:0;
  left:0;
  right:0;
  height:3px;
  background:linear-gradient(90deg, var(--green), var(--gold));
  transform:scaleX(0);
  transition:var(--transition);
}

.stat-card-home:hover{
  transform:translateY(-4px);
  border-color:var(--green);
}

.stat-card-home:hover::after{
  transform:scaleX(1);
}

.stat-icon-home{
  font-size:2rem;
  margin-bottom:8px;
}

.stat-value-home{
  font-size:2rem;
  font-weight:900;
  color:var(--green);
  line-height:1;
  margin-bottom:4px;
}

.stat-label-home{
  font-size:0.85rem;
  color:var(--muted);
  font-weight:500;
}

/* Quick Actions */
.quick-actions-section{
  margin-bottom:24px;
}

.section-title-home{
  font-size:1rem;
  font-weight:700;
  margin-bottom:16px;
  color:var(--text);
}

.quick-actions-grid{
  display:grid;
  grid-template-columns:repeat(4, 1fr);
  gap:12px;
}

.quick-action-btn{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:20px 12px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
  cursor:pointer;
  transition:var(--spring);
  color:var(--text);
  font-family:inherit;
}

.quick-action-btn:hover{
  transform:translateY(-4px);
  border-color:var(--green);
  box-shadow:var(--glow-green);
}

.quick-action-btn:active{
  transform:scale(0.96);
}

.quick-icon{
  font-size:2rem;
}

.quick-label{
  font-size:0.8rem;
  font-weight:600;
  text-align:center;
  color:var(--muted);
}

/* Active Vote */
.active-vote-section{
  margin-bottom:24px;
}

.active-vote-card{
  background:linear-gradient(135deg, rgba(255,215,0,0.15), rgba(255,215,0,0.05));
  border:2px solid var(--gold);
  border-radius:var(--radius-lg);
  padding:24px;
  position:relative;
}

.vote-live-badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:rgba(230,57,70,0.2);
  color:var(--red);
  padding:6px 12px;
  border-radius:100px;
  font-size:0.8rem;
  font-weight:700;
  margin-bottom:12px;
  animation:pulse 2s infinite;
}

@keyframes pulse{
  0%,100%{opacity:1}
  50%{opacity:0.7}
}

.vote-title-home{
  font-size:1.2rem;
  font-weight:800;
  margin-bottom:8px;
}

.vote-desc-home{
  color:var(--muted);
  margin-bottom:16px;
}

/* News Section Home */
.news-section-home{
  margin-bottom:24px;
}

.section-header-home{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
}

.section-link{
  background:none;
  border:none;
  color:var(--green);
  font-family:inherit;
  font-size:0.9rem;
  font-weight:600;
  cursor:pointer;
  transition:var(--transition);
}

.section-link:hover{
  color:var(--gold);
}

.news-grid-home{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:16px;
}

.news-card-home{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  overflow:hidden;
  transition:var(--transition);
  cursor:pointer;
}

.news-card-home:hover{
  transform:translateY(-4px);
  border-color:var(--green);
}

.news-card-home-img{
  width:100%;
  height:120px;
  object-fit:cover;
  background:linear-gradient(135deg, var(--green), var(--red));
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:2.5rem;
}

.news-card-home-body{
  padding:16px;
}

.news-card-home-date{
  font-size:0.75rem;
  color:var(--muted);
  margin-bottom:6px;
}

.news-card-home-title{
  font-size:0.95rem;
  font-weight:700;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  overflow:hidden;
}

/* About Section */
.about-section{
  margin-bottom:24px;
}

.about-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:24px;
}

.about-text{
  font-size:1rem;
  color:var(--text-secondary);
  line-height:1.8;
  margin-bottom:24px;
}

.about-values{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}

.about-value{
  background:rgba(0,0,0,0.3);
  border-radius:var(--radius-md);
  padding:20px;
  text-align:center;
}

.about-value-icon{
  font-size:2rem;
  margin-bottom:8px;
}

.about-value-title{
  font-size:0.85rem;
  color:var(--gold);
  font-weight:700;
  margin-bottom:6px;
}

.about-value-text{
  font-size:0.9rem;
  color:var(--muted);
}

/* Events Section */
.events-section{
  margin-bottom:24px;
}

.events-list{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.event-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:16px;
  display:flex;
  align-items:center;
  gap:16px;
  border-right:4px solid var(--gold);
}

.event-date-box{
  background:var(--gold);
  color:var(--black);
  padding:12px 16px;
  border-radius:var(--radius-sm);
  text-align:center;
  font-weight:700;
  min-width:70px;
}

.event-date-day{
  font-size:1.5rem;
  line-height:1;
}

.event-date-month{
  font-size:0.75rem;
}

.event-info{
  flex:1;
}

.event-title{
  font-weight:700;
  margin-bottom:4px;
}

.event-desc{
  font-size:0.85rem;
  color:var(--muted);
}

/* Social Section */
.social-section{
  margin-bottom:24px;
}

.social-links{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}

.social-link{
  display:flex;
  align-items:center;
  gap:10px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:14px 20px;
  color:var(--text);
  text-decoration:none;
  font-weight:600;
  transition:var(--transition);
}

.social-link:hover{
  border-color:var(--green);
  transform:translateY(-2px);
}

.social-link-icon{
  font-size:1.5rem;
}

/* Mobile Responsive for Home */
@media(max-width:768px){
  .hero-section{
    padding:30px 20px;
  }
  
  .hero-flag{
    font-size:3rem;
  }
  
  .hero-title{
    font-size:1.4rem;
  }
  
  .hero-subtitle{
    font-size:0.95rem;
  }
  
  .hero-buttons{
    flex-direction:column;
  }
  
  .hero-buttons .btn{
    width:100%;
  }
  
  .stats-grid-home{
    grid-template-columns:repeat(2, 1fr);
  }
  
  .stat-card-home{
    padding:16px 12px;
  }
  
  .stat-value-home{
    font-size:1.6rem;
  }
  
  .quick-actions-grid{
    grid-template-columns:repeat(2, 1fr);
  }
  
  .news-grid-home{
    grid-template-columns:1fr;
  }
  
  .about-values{
    grid-template-columns:1fr;
  }
  
  .social-links{
    flex-direction:column;
  }
  
  .social-link{
    width:100%;
  }
}
.news-card-text{font-size:0.85rem;color:var(--muted);line-height:1.6}
.img-preview{width:100%;max-height:150px;object-fit:cover;border-radius:8px;margin-top:10px;display:none}
.imgs-preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.imgs-preview-item{position:relative}
.imgs-preview-item img{width:60px;height:60px;border-radius:8px;object-fit:cover}
.imgs-preview-item .remove-img{position:absolute;top:-5px;right:-5px;background:var(--red);color:white;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px}
.receipts-preview{display:flex;flex-wrap:wrap;margin-top:10px}
.receipt-preview-item{position:relative;margin:5px}
.receipt-preview-item img{width:60px;height:60px;border-radius:8px;object-fit:cover}
.receipt-preview-item .remove-receipt{position:absolute;top:-5px;right:-5px;background:var(--red);color:white;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px}
.lightbox{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:400;justify-content:center;align-items:center}
.lightbox.show{display:flex}
.lightbox img{max-width:90%;max-height:90%;border-radius:var(--radius-md)}
.lightbox-close{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.1);border:none;color:white;font-size:1.5rem;cursor:pointer;width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center}
.address-search{display:flex;gap:10px;margin-bottom:12px}
.address-search input{flex:1}
.location-result{background:rgba(0,0,0,0.4);padding:12px;border-radius:var(--radius-sm);margin-top:12px;font-size:0.9rem;display:none}
.location-result.show{display:block}

/* ========== Mobile Button ========== */
.mobile-btn{
  display:none;
  position:fixed;
  bottom:24px;
  right:24px;
  width:56px;
  height:56px;
  background:linear-gradient(135deg,var(--green),#00a854);
  border:none;
  border-radius:50%;
  color:white;
  font-size:1.5rem;
  cursor:pointer;
  z-index:150;
  box-shadow:var(--glow-green);
  transition:var(--spring);
}

.mobile-btn:active{transform:scale(0.9)}

/* ========== Mobile Responsive ========== */
@media(max-width:768px){
  :root{--sidebar-width:100%}
  
  .sidebar{
    transform:translateX(100%);
    width:85%;
    max-width:320px;
    box-shadow:-10px 0 40px rgba(0,0,0,0.5);
  }
  
  .sidebar.open{transform:translateX(0)}
  
  .main{
    margin-right:0;
    padding:16px;
    padding-bottom:100px;
  }
  
  .mobile-btn{display:flex;align-items:center;justify-content:center}
  
  .header{
    padding:20px;
    border-radius:var(--radius-md);
    margin-bottom:16px;
  }
  
  .header h1{font-size:1.25rem}
  .header p{font-size:0.85rem}
  
  .card{
    padding:18px;
    border-radius:var(--radius-md);
    margin-bottom:14px;
  }
  
  .grid{grid-template-columns:1fr;gap:14px}
  
  .stat-num{font-size:1.5rem}
  .stat-label{font-size:0.8rem}
  
  .btn{
    padding:12px 18px;
    font-size:0.85rem;
    width:100%;
    justify-content:center;
    margin-left:0;
    margin-bottom:8px;
  }
  
  .btn-sm{
    width:auto;
    padding:10px 14px;
  }
  
  .form-input,.form-select,.form-textarea{
    padding:14px;
    font-size:16px; /* يمنع الزوم على iOS */
  }
  
  .modal{
    border-radius:var(--radius-lg) var(--radius-lg) 0 0;
    max-height:85vh;
    margin-top:auto;
  }
  
  .modal-head{padding:16px 20px}
  .modal-body{padding:20px}
  .modal-foot{padding:16px 20px;flex-direction:column}
  .modal-foot .btn{width:100%;margin:0}
  
  .member-item{
    padding:14px;
    flex-wrap:wrap;
  }
  
  .member-avatar{width:44px;height:44px}
  .member-name{font-size:0.9rem}
  
  .tx-item{
    padding:12px 0;
    gap:12px;
  }
  
  .tx-icon{width:40px;height:40px}
  .tx-title{font-size:0.9rem}
  .tx-amount{font-size:0.95rem}
  
  #map{height:300px;border-radius:var(--radius-md)}
  
  .news-card{margin-bottom:14px}
  .news-card-img{height:140px}
  .news-card-body{padding:16px}
  .news-card-title{font-size:1rem}
  
  .toast{
    bottom:90px;
    padding:12px 20px;
    font-size:0.85rem;
    max-width:calc(100% - 40px);
  }
  
  .admin-stats{gap:10px}
  .admin-stat{padding:12px 16px;flex:1;min-width:calc(50% - 5px)}
  .admin-stat-num{font-size:1.3rem}
  
  /* Overlay عند فتح Sidebar */
  .sidebar-overlay{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    z-index:99;
  }
  
  .sidebar-overlay.show{display:block}
}
.reg-container{max-width:600px;margin:0 auto}
.reg-header{background:linear-gradient(135deg,var(--green),var(--red));padding:30px;border-radius:15px 15px 0 0;text-align:center;position:relative;overflow:hidden}
.reg-header::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#000,#fff,#009639)}
.reg-header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#000,#fff,#009639)}
.reg-flag{font-size:3rem;margin-bottom:10px}
.reg-title{font-size:1.5rem;font-weight:700;color:white;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
.reg-subtitle{color:rgba(255,255,255,0.9);font-size:0.9rem;margin-top:5px}
.reg-form{background:var(--card);padding:25px;border-radius:0 0 15px 15px;border:1px solid var(--border);border-top:none}
.reg-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border)}
.reg-section:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.reg-section-title{font-size:0.9rem;font-weight:700;color:var(--gold);margin-bottom:15px;display:flex;align-items:center;gap:8px}
.reg-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
@media(max-width:500px){.reg-row{grid-template-columns:1fr}}
.reg-privacy{background:var(--dark);padding:15px;border-radius:10px;margin-bottom:15px}
.reg-privacy-title{font-size:0.85rem;font-weight:600;margin-bottom:10px;color:var(--green)}
.reg-submit{width:100%;padding:15px;background:linear-gradient(135deg,var(--green),#007a2f);color:white;border:none;border-radius:10px;font-family:inherit;font-size:1rem;font-weight:700;cursor:pointer;margin-top:10px}
.reg-submit:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(0,150,57,0.4)}
.reg-success{display:none;text-align:center;padding:40px 20px}
.reg-success.show{display:block}
.reg-success-icon{font-size:4rem;margin-bottom:15px}
.reg-success-title{font-size:1.3rem;font-weight:700;color:var(--green);margin-bottom:10px}
.reg-success-text{color:var(--muted);margin-bottom:20px}
.pending-item{display:flex;align-items:center;gap:12px;padding:15px;background:var(--dark);border-radius:10px;margin-bottom:10px;border-right:4px solid var(--gold)}
.pending-info{flex:1}
.pending-name{font-weight:600;font-size:0.95rem}
.pending-details{font-size:0.8rem;color:var(--muted);margin-top:4px}
.pending-date{font-size:0.75rem;color:var(--gold)}
.pending-actions{display:flex;gap:8px}
.family-member-card{background:var(--dark);border:1px solid var(--border);border-radius:10px;padding:15px;margin-top:10px;position:relative}
.family-member-card .remove-family{position:absolute;top:10px;left:10px;background:var(--red);color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:14px}
.family-member-card .form-group{margin-bottom:10px}
.family-member-title{font-weight:600;color:var(--gold);margin-bottom:10px;font-size:0.9rem}
.pending-card{background:var(--dark);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:15px;border-right:4px solid var(--gold)}
.pending-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px}
.pending-card-info h3{margin:0;font-size:1.1rem;color:var(--text)}
.pending-card-info p{margin:5px 0 0;font-size:0.8rem;color:var(--muted)}
.pending-card-badge{background:var(--gold);color:var(--black);padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:600}
.pending-card-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px}
.pending-detail-item{background:rgba(255,255,255,0.05);padding:10px;border-radius:8px}
.pending-detail-item label{display:block;font-size:0.7rem;color:var(--muted);margin-bottom:3px}
.pending-detail-item span{font-size:0.9rem}
.pending-family-section{background:rgba(0,150,57,0.1);border:1px solid var(--green);border-radius:10px;padding:15px;margin-bottom:15px}
.pending-family-title{font-weight:600;color:var(--green);margin-bottom:10px;font-size:0.9rem}
.pending-family-member{background:var(--dark);padding:10px;border-radius:8px;margin-bottom:8px}
.pending-family-member:last-child{margin-bottom:0}
.pending-card-actions{display:flex;gap:10px;justify-content:flex-end;padding-top:15px;border-top:1px solid var(--border)}
.pending-privacy-options{background:rgba(0,150,57,0.1);border:1px solid rgba(0,150,57,0.3);border-radius:10px;padding:12px;margin-bottom:15px}
.pending-privacy-title{font-size:0.85rem;font-weight:600;color:var(--gold);margin-bottom:10px}
.pending-privacy-item{font-size:0.85rem;color:var(--text);padding:5px 0}
.approved-card{border-right-color:var(--green);opacity:0.8}
.family-card{background:var(--dark);border:1px solid var(--border);border-radius:12px;margin-bottom:15px;overflow:hidden}
.family-card-header{padding:15px 20px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-right:4px solid var(--green);transition:background 0.2s}
.family-card-header:hover{background:rgba(255,255,255,0.03)}
.family-card-header h3{margin:0;font-size:1rem;display:flex;align-items:center;gap:10px}
.family-card-header .family-count{background:var(--green);color:white;padding:3px 10px;border-radius:15px;font-size:0.75rem}
.family-card-header .family-date{font-size:0.75rem;color:var(--muted)}
.family-card-header .expand-icon{font-size:1.2rem;transition:transform 0.3s}
.family-card.open .expand-icon{transform:rotate(180deg)}
.family-card-body{display:none;padding:0 20px 20px;border-top:1px solid var(--border)}
.family-card.open .family-card-body{display:block}
.family-member-row{display:flex;align-items:center;gap:15px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-top:10px}
.family-member-row.head{background:rgba(0,150,57,0.15);border:1px solid var(--green)}
.family-member-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--green),var(--red));display:flex;align-items:center;justify-content:center;font-size:1.2rem}
.family-member-info{flex:1}
.family-member-info h4{margin:0;font-size:0.95rem}
.family-member-info p{margin:3px 0 0;font-size:0.8rem;color:var(--muted)}
.family-member-badge{font-size:0.7rem;padding:3px 8px;border-radius:10px;background:var(--gold);color:var(--black)}
.family-actions{display:flex;gap:8px;margin-top:15px;padding-top:15px;border-top:1px solid var(--border)}
.reg-sheet-container{background:white;border-radius:15px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.reg-sheet-header{background:linear-gradient(135deg,#009639,#CE1126);padding:20px;text-align:center;position:relative}
.reg-sheet-header::before{content:'';position:absolute;top:0;left:0;right:0;height:8px;background:linear-gradient(90deg,#000 33%,#fff 33%,#fff 66%,#009639 66%)}
.reg-sheet-header h2{color:white;margin:10px 0 5px;font-size:1.3rem}
.reg-sheet-header p{color:rgba(255,255,255,0.9);font-size:0.85rem;margin:0}
.reg-sheet-header .sheet-logo{font-size:2.5rem}
.reg-sheet-table-wrapper{overflow-x:auto;padding:15px}
.reg-sheet-table{width:100%;border-collapse:collapse;min-width:1200px;font-size:0.85rem}
.reg-sheet-table th{background:linear-gradient(135deg,#1a1a1a,#333);color:white;padding:10px 8px;text-align:center;font-weight:600;border:1px solid #444;white-space:nowrap}
.reg-sheet-table td{padding:8px;border:1px solid #ddd;text-align:center;background:white}
.reg-sheet-table tr:nth-child(even) td{background:#f9f9f9}
.reg-sheet-table input{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;text-align:center;font-family:inherit;font-size:0.85rem}
.reg-sheet-table input:focus{outline:none;border-color:#009639;background:#f0fff4}
.reg-sheet-table .row-num{background:#f0f0f0;font-weight:600;color:#333;width:40px}
.reg-sheet-table .paid-yes{background:#d4edda;color:#155724}
.reg-sheet-table .paid-no{background:#f8d7da;color:#721c24}
.reg-sheet-table select{padding:6px;border:1px solid #ddd;border-radius:4px;font-family:inherit;font-size:0.85rem;cursor:pointer}
.reg-sheet-footer{background:#f5f5f5;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;border-top:3px solid;border-image:linear-gradient(90deg,#000,#fff,#009639,#CE1126) 1}
.reg-sheet-stats{display:flex;gap:20px;flex-wrap:wrap}
.reg-sheet-stat{text-align:center}
.reg-sheet-stat-num{font-size:1.3rem;font-weight:700;color:#009639}
.reg-sheet-stat-label{font-size:0.75rem;color:#666}
.reg-sheet-actions{display:flex;gap:10px;flex-wrap:wrap}
.sheet-btn{padding:10px 20px;border:none;border-radius:8px;font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px}
.sheet-btn-green{background:#009639;color:white}
.sheet-btn-red{background:#CE1126;color:white}
.sheet-btn-gold{background:#C9A227;color:#1a1a1a}
.sheet-btn-gray{background:#666;color:white}
/* Bylaws Styles */
.bylaws-page{position:relative;min-height:600px}
.bylaws-container{position:relative;width:100%;height:600px;display:flex;justify-content:center;align-items:center}
.bylaws-lines-svg{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1}
.connection-line{stroke-width:2;fill:none;stroke-dasharray:8 4;animation:bylawsDash 20s linear infinite}
.connection-line.faded{opacity:0.15}
@keyframes bylawsDash{to{stroke-dashoffset:-240}}
.bylaws-center{position:absolute;width:150px;height:150px;border-radius:50%;background:linear-gradient(135deg,#ce1126 0%,#a00d1e 100%);display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;z-index:10;box-shadow:0 0 0 5px rgba(255,255,255,0.2),0 0 0 10px rgba(0,151,54,0.3),0 15px 50px rgba(0,0,0,0.5);transition:all 0.5s cubic-bezier(0.4,0,0.2,1)}
.bylaws-center h3{font-size:0.85rem;color:#fff;line-height:1.4;padding:12px}
.bylaws-center.shrink{transform:scale(0.5);opacity:0.4}
.bylaws-node{position:absolute;width:100px;height:100px;border-radius:50%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;cursor:pointer;z-index:5;transition:all 0.5s cubic-bezier(0.4,0,0.2,1);box-shadow:0 8px 30px rgba(0,0,0,0.4)}
.bylaws-node:hover{transform:scale(1.12);z-index:15}
.bylaws-node.shrink{transform:scale(0.4);opacity:0.25;pointer-events:none}
.bylaws-node .icon{font-size:1.8rem;margin-bottom:5px}
.bylaws-node .title{font-size:0.75rem;color:#fff;font-weight:700}
.node-green{background:linear-gradient(135deg,#009736,#006d28)}
.node-red{background:linear-gradient(135deg,#ce1126,#9a0d1e)}
.node-orange{background:linear-gradient(135deg,#e67e22,#d35400)}
.node-blue{background:linear-gradient(135deg,#3498db,#2980b9)}
.node-purple{background:linear-gradient(135deg,#9b59b6,#7d3c98)}
.node-teal{background:linear-gradient(135deg,#1abc9c,#16a085)}
.node-gold{background:linear-gradient(135deg,#f39c12,#d68910)}
.bylaws-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9998;opacity:0;visibility:hidden;transition:all 0.3s}
.bylaws-overlay.show{opacity:1;visibility:visible}
.bylaws-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);width:90%;max-width:450px;max-height:80vh;border-radius:25px;z-index:9999;opacity:0;transition:all 0.4s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;overflow:hidden}
.bylaws-panel.show{transform:translate(-50%,-50%) scale(1);opacity:1}
.bylaws-panel-header{padding:20px;display:flex;align-items:center;gap:15px;border-bottom:1px solid rgba(255,255,255,0.2)}
.bylaws-panel-close{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;color:#fff;font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
.bylaws-panel-close:hover{background:rgba(255,255,255,0.3);transform:rotate(90deg)}
.bylaws-panel-icon{font-size:2.5rem}
.bylaws-panel-title h3{color:#fff;font-size:1.3rem;margin:0}
.bylaws-panel-title p{color:rgba(255,255,255,0.8);font-size:0.85rem;margin-top:5px}
.bylaws-panel-body{padding:20px;overflow-y:auto;flex:1}
.bylaws-section{margin-bottom:20px}
.bylaws-section h4{color:#fff;font-size:1rem;margin-bottom:12px;display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.2)}
.bylaws-list{list-style:none;padding:0;margin:0}
.bylaws-list li{background:rgba(0,0,0,0.2);border-radius:12px;padding:12px 15px;margin-bottom:8px;display:flex;flex-direction:column;gap:8px;transition:all 0.3s;border-right:3px solid transparent;cursor:pointer}
.bylaws-list li:hover{background:rgba(0,0,0,0.3);border-right-color:#fff}
.bylaws-list li.expanded{background:rgba(0,0,0,0.35);border-right-color:#ffd700}
.bylaws-item-header{display:flex;align-items:center;gap:12px}
.bylaws-list .item-icon{font-size:1.2rem;flex-shrink:0}
.bylaws-list .item-text{color:#fff;font-size:0.9rem;line-height:1.5;flex:1}
.bylaws-item-arrow{font-size:0.8rem;transition:transform 0.3s;opacity:0.7}
.bylaws-list li.expanded .bylaws-item-arrow{transform:rotate(180deg)}
.bylaws-item-detail{display:none;padding:10px 15px;background:rgba(255,255,255,0.1);border-radius:8px;margin-top:5px;font-size:0.85rem;line-height:1.7;color:rgba(255,255,255,0.9)}
.bylaws-list li.expanded .bylaws-item-detail{display:block}
.bylaws-edit-section{margin-top:20px;padding:20px;background:var(--card);border-radius:15px;border:1px solid var(--gold);display:none}
.bylaws-edit-section.show{display:block}
/* Voting Styles */
.voting-card{background:var(--card);border-radius:15px;padding:20px;margin-bottom:20px;border:1px solid var(--border)}
.voting-card.active-vote{border-color:var(--green);box-shadow:0 0 20px rgba(0,150,57,0.2)}
.voting-card.closed-vote{opacity:0.7}
.voting-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.voting-title{font-size:1.1rem;font-weight:700;color:var(--text)}
.voting-status{padding:5px 12px;border-radius:20px;font-size:0.75rem;font-weight:600}
.voting-status.open{background:var(--green);color:white}
.voting-status.closed{background:var(--red);color:white}
.voting-question{font-size:1rem;color:var(--text);margin-bottom:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:10px;line-height:1.6}
.voting-options{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
.voting-option{display:flex;align-items:center;gap:12px;padding:15px;background:var(--dark);border-radius:10px;cursor:pointer;transition:all 0.3s;border:2px solid transparent}
.voting-option:hover{background:rgba(255,255,255,0.05);border-color:var(--green)}
.voting-option.selected{border-color:var(--green);background:rgba(0,150,57,0.25);box-shadow:0 0 15px rgba(0,150,57,0.3)}
.voting-option-radio{width:22px;height:22px;border-radius:50%;border:2px solid var(--muted);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.voting-option.selected .voting-option-radio{border-color:var(--green);background:var(--green)}
.voting-option.selected .voting-option-radio::after{content:'✓';color:white;font-size:0.8rem}
.voting-option.selected .voting-option-text{color:var(--green);font-weight:700}
.voting-option-text{flex:1;font-size:0.95rem;transition:all 0.3s}
.voting-code-input{display:flex;gap:10px;margin-bottom:15px}
.voting-code-input input{flex:1;padding:12px 15px;background:var(--dark);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:1rem;text-align:center;letter-spacing:3px}
.voting-submit{width:100%;padding:15px;background:linear-gradient(135deg,var(--green),#007a2f);color:white;border:none;border-radius:10px;font-family:inherit;font-size:1rem;font-weight:600;cursor:pointer}
.voting-submit:disabled{background:var(--muted);cursor:not-allowed}
.voting-results{margin-top:20px}
.voting-result-bar{margin-bottom:15px}
.voting-result-label{display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.9rem}
/* Multi-select voting styles */
.voting-option.multi-select{border:2px solid var(--border);position:relative}
.voting-option.multi-select.selected{border-color:var(--green);background:rgba(0,150,57,0.3);box-shadow:0 0 20px rgba(0,150,57,0.4)}
.voting-option.multi-select.selected .voting-option-text{color:#00ff55;font-weight:700;font-size:1rem}
.voting-option.multi-select .voting-option-radio{border-radius:4px}
.voting-option.multi-select.selected .voting-option-radio{background:var(--green);border-color:var(--green)}
.voting-option.multi-select.selected .voting-option-radio::after{content:'✓';color:white;font-size:0.9rem;font-weight:bold}
.voting-option.disabled{opacity:0.5;cursor:not-allowed;pointer-events:none}
.voting-selection-info{background:rgba(201,162,39,0.15);border:1px solid var(--gold);border-radius:8px;padding:10px 15px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}
.voting-selection-count{font-size:1.1rem;font-weight:700;color:var(--gold)}
.voting-selection-max{font-size:0.85rem;color:var(--muted)}
.vote-result-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--dark);border-radius:10px;margin-bottom:8px}
.vote-result-name{flex:1;font-weight:600}
.vote-result-count{font-size:1.2rem;font-weight:700;color:var(--green)}
.vote-result-bar-bg{flex:2;height:24px;background:var(--border);border-radius:12px;overflow:hidden}
.vote-result-bar-fill{height:100%;background:linear-gradient(90deg,var(--green),#007a2f);border-radius:12px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;color:white;font-size:0.75rem;font-weight:600;min-width:fit-content}
/* New voting styles */
.multi-opt-row{display:flex;align-items:center;gap:15px;padding:16px 20px;margin-bottom:10px;background:#2a2a3a;border:3px solid #444;border-radius:10px;cursor:pointer;transition:all 0.2s}
.multi-opt-row:hover{border-color:#666}
.multi-opt-row.selected{background:#1a4a2a;border-color:#00dd44}
.multi-opt-check{width:26px;height:26px;border:3px solid #666;border-radius:5px;background:#333;display:flex;align-items:center;justify-content:center}
.multi-opt-row.selected .multi-opt-check{background:#00aa33;border-color:#00dd44}
.multi-opt-row.selected .multi-opt-check::after{content:'✓';color:#fff;font-weight:bold}
.multi-opt-name{font-size:1.05rem;color:#eee}
.multi-opt-row.selected .multi-opt-name{color:#00ff55;font-weight:bold}
.yesno-options{display:flex;flex-direction:column;gap:10px;margin-bottom:15px}
.yesno-opt{display:flex;align-items:center;gap:12px;padding:15px;background:#2a2a3a;border:3px solid #444;border-radius:10px;cursor:pointer;transition:all 0.2s}
.yesno-opt:hover{border-color:#666}
.yesno-opt.selected{background:#1a4a2a;border-color:#00dd44}
.yesno-radio{width:22px;height:22px;border-radius:50%;border:3px solid #666;background:#333}
.yesno-opt.selected .yesno-radio{background:#00aa33;border-color:#00dd44}
.yesno-opt.selected span{color:#00ff55;font-weight:bold}
/* Multi-vote new styles */
.multi-vote-row{display:flex;align-items:center;gap:15px;padding:18px 20px;background:#252540;border-radius:12px;cursor:pointer;border:3px solid #555;margin-bottom:12px;transition:all 0.2s}
.multi-vote-row:hover{background:#2a2a50;border-color:#777}
.multi-vote-row.selected{background:#0f5f2f !important;border-color:#4f4 !important;box-shadow:0 0 20px rgba(68,255,68,0.4)}
.multi-vote-check{width:30px;height:30px;min-width:30px;border-radius:6px;border:3px solid #777;background:#333;display:flex;align-items:center;justify-content:center;font-size:20px;transition:all 0.2s}
.multi-vote-row.selected .multi-vote-check{background:#2a2 !important;border-color:#4f4 !important}
.multi-vote-row.selected .multi-vote-check::after{content:'✓';color:white;font-weight:bold}
.multi-vote-name{flex:1;font-size:1.1rem;color:#ddd;transition:all 0.2s}
.multi-vote-row.selected .multi-vote-name{color:#4f4 !important;font-weight:bold}
.voting-result-progress{height:35px;background:var(--dark);border-radius:8px;overflow:hidden;position:relative}
.voting-result-fill{height:100%;border-radius:8px;display:flex;align-items:center;padding:0 15px;color:white;font-weight:700;font-size:0.95rem;transition:width 0.5s;min-width:45px}
.voting-result-fill.yes{background:linear-gradient(135deg,var(--green),#007a2f);justify-content:flex-end}
.voting-result-fill.no{background:linear-gradient(135deg,var(--red),#a00d1e);justify-content:flex-end}
.voting-stats{display:flex;gap:20px;margin-top:15px;padding-top:15px;border-top:1px solid var(--border)}
.voting-stat{text-align:center}
.voting-stat-value{font-size:1.5rem;font-weight:700;color:var(--gold)}
.voting-stat-label{font-size:0.75rem;color:var(--muted)}
.voting-admin-panel{background:var(--card);border-radius:15px;padding:20px;margin-bottom:20px;border:1px solid var(--gold)}
.voting-codes-list{max-height:300px;overflow-y:auto;margin-top:15px}
.voting-code-item{display:flex;justify-content:space-between;align-items:center;padding:10px 15px;background:var(--dark);border-radius:8px;margin-bottom:8px}
.voting-code-item.used{opacity:0.5;text-decoration:line-through}
.voting-code-name{font-weight:600}
.voting-code-value{font-family:monospace;font-size:1.1rem;color:var(--gold);letter-spacing:2px}
.voting-code-status{font-size:0.75rem;padding:3px 8px;border-radius:10px}
.voting-code-status.available{background:var(--green);color:white}
.voting-code-status.used{background:var(--red);color:white}
.voting-empty{text-align:center;padding:40px;color:var(--muted)}
.voting-empty-icon{font-size:3rem;margin-bottom:15px}
.voting-voted-msg{text-align:center;padding:20px;background:rgba(0,150,57,0.1);border-radius:10px;color:var(--green);font-weight:600}
.sheet-controls{background:var(--card);border-radius:15px;padding:20px;margin-bottom:20px;border:1px solid var(--border)}
.sheet-controls-row{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px}
.sheet-stats-row{display:flex;flex-wrap:wrap;gap:20px;font-size:0.9rem;color:var(--muted)}
.sheet-stats-row strong{color:var(--gold)}
.reg-sheet-container{background:white;border-radius:15px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.reg-sheet-header{background:linear-gradient(135deg,#009639,#CE1126);padding:25px;text-align:center;position:relative}
.reg-sheet-header::before{content:'';position:absolute;top:0;left:0;right:0;height:10px;background:linear-gradient(90deg,#000 33%,#fff 33%,#fff 66%,#009639 66%)}
.reg-sheet-header h2{color:white;margin:10px 0 5px;font-size:1.4rem}
.reg-sheet-header p{color:rgba(255,255,255,0.9);font-size:0.9rem;margin:0}
.reg-sheet-header .sheet-logo{font-size:2.5rem}
.reg-sheet-header .sheet-year{font-size:1.2rem;font-weight:700;margin-top:10px;background:rgba(255,255,255,0.2);display:inline-block;padding:5px 20px;border-radius:20px}
.reg-sheet-table-wrapper{overflow-x:auto;padding:0}
.reg-sheet-table{width:100%;border-collapse:collapse;min-width:900px;font-size:0.85rem}
.reg-sheet-table th{background:#1a1a1a;color:white;padding:12px 8px;text-align:center;font-weight:600;border:1px solid #333;white-space:nowrap}
.reg-sheet-table td{padding:0;border:1px solid #ccc;text-align:center;background:white;height:35px}
.reg-sheet-table tr:nth-child(even) td{background:#f9f9f9}
.reg-sheet-table input{width:100%;height:100%;padding:8px;border:none;text-align:center;font-family:inherit;font-size:0.85rem;background:transparent}
.reg-sheet-table input:focus{outline:none;background:#fffde7}
.reg-sheet-table input::placeholder{color:#ccc}
.reg-sheet-table .row-num{background:#f0f0f0;font-weight:600;color:#333;width:40px;padding:8px}
.reg-sheet-footer-print{padding:15px 20px;text-align:center;border-top:3px solid;border-image:linear-gradient(90deg,#000,#009639,#fff,#CE1126,#000) 1}
.reg-sheet-footer-print .footer-line{height:2px;background:linear-gradient(90deg,transparent,#009639,#CE1126,transparent);margin-bottom:10px}
.reg-sheet-footer-print p{color:#333;font-size:0.9rem;margin:0}
.archive-section{margin-top:20px}
.archive-item{display:flex;justify-content:space-between;align-items:center;padding:15px;background:var(--dark);border-radius:10px;margin-bottom:10px;border-right:4px solid var(--gold)}
.archive-item-info h4{margin:0;font-size:0.95rem}
.archive-item-info p{margin:5px 0 0;font-size:0.8rem;color:var(--muted)}
.archive-item-actions{display:flex;gap:8px}
@media print{
.sidebar,.header,.sheet-controls,.archive-section,.mobile-btn,.toast{display:none!important}
.main{margin:0!important;padding:0!important}
.page{display:none!important}
#pageRegistrationSheet{display:block!important}
.reg-sheet-container{box-shadow:none;border-radius:0}
.reg-sheet-table{font-size:11pt}
.reg-sheet-table th{background:#000!important;color:#fff!important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
.reg-sheet-table input{border:none;background:transparent}
.reg-sheet-header{-webkit-print-color-adjust:exact;print-color-adjust:exact}
}
.reg-sheet-table th[contenteditable="true"]{cursor:text}
.reg-sheet-table th[contenteditable="true"]:focus{outline:2px solid #C9A227;background:#444}
.reg-sheet-header h2[contenteditable="true"],.reg-sheet-header p[contenteditable="true"]{cursor:text;padding:5px;border-radius:5px}
.reg-sheet-header h2[contenteditable="true"]:focus,.reg-sheet-header p[contenteditable="true"]:focus{outline:2px solid white;background:rgba(255,255,255,0.2)}
/* Language Switcher */
.lang-switcher{display:flex;gap:5px;margin-bottom:10px;justify-content:center}
.lang-btn{padding:8px 12px;border:2px solid var(--border);background:transparent;color:var(--muted);font-family:inherit;font-size:0.75rem;cursor:pointer;border-radius:8px;transition:all 0.3s}
.lang-btn:hover{border-color:var(--green);color:var(--text)}
.lang-btn.active{background:var(--green);border-color:var(--green);color:white}
.lang-btn .flag{font-size:1rem;margin-left:5px}
html[dir="ltr"] body{direction:ltr;text-align:left}
html[dir="ltr"] .sidebar{right:auto;left:0;border-left:none;border-right:1px solid var(--border)}
html[dir="ltr"] .main{margin-right:0;margin-left:260px}
html[dir="ltr"] .nav-btn{text-align:left}
html[dir="ltr"] .header::before{border-radius:15px 15px 0 0}
html[dir="ltr"] .pending-card{border-right:none;border-left:4px solid var(--gold)}
html[dir="ltr"] .family-card-header{border-right:none;border-left:4px solid var(--green)}
html[dir="ltr"] .archive-item{border-right:none;border-left:4px solid var(--gold)}
@media(max-width:768px){html[dir="ltr"] .sidebar{transform:translateX(-100%)}html[dir="ltr"] .sidebar.open{transform:translateX(0)}html[dir="ltr"] .main{margin-left:0}html[dir="ltr"] .mobile-btn{right:auto;left:20px}}
/* Inbox & Messages Styles */
.inbox-badge{background:var(--red);color:white;font-size:0.7rem;padding:2px 6px;border-radius:10px;margin-right:5px}
.message-card{background:var(--dark);border-radius:12px;padding:15px;margin-bottom:12px;border-right:4px solid var(--gold);cursor:pointer;transition:all 0.3s}
.message-card:hover{background:rgba(255,255,255,0.05)}
.message-card.unread{border-right-color:var(--green);background:rgba(0,150,57,0.1)}
.message-card.unread .message-subject{font-weight:700}
.message-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.message-sender{font-weight:600;font-size:0.95rem;color:var(--text)}
.message-date{font-size:0.75rem;color:var(--muted)}
.message-subject{font-size:0.9rem;color:var(--text);margin-bottom:8px}
.message-preview{font-size:0.85rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.message-status{display:inline-block;padding:3px 8px;border-radius:10px;font-size:0.7rem;font-weight:600}
.message-status.unread{background:var(--green);color:white}
.message-status.read{background:var(--border);color:var(--muted)}
.message-detail{background:var(--card);border-radius:15px;padding:20px;margin-bottom:20px;border:1px solid var(--border)}
.message-detail-header{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:15px;border-bottom:1px solid var(--border);margin-bottom:15px}
.message-detail-sender h3{margin:0;font-size:1.1rem;color:var(--gold)}
.message-detail-sender p{margin:5px 0 0;font-size:0.85rem;color:var(--muted)}
.message-detail-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:15px;padding:15px;background:var(--dark);border-radius:10px}
.message-info-item{display:flex;flex-direction:column;gap:3px}
.message-info-item label{font-size:0.75rem;color:var(--muted)}
.message-info-item span{font-size:0.9rem;color:var(--text)}
.message-info-item a{color:var(--green);text-decoration:none}
.message-body{line-height:1.8;font-size:0.95rem;padding:15px;background:var(--dark);border-radius:10px;white-space:pre-wrap}
.contact-form{max-width:600px;margin:0 auto}
.contact-success{display:none;text-align:center;padding:40px 20px}
.contact-success.show{display:block}
.contact-success-icon{font-size:4rem;margin-bottom:15px}
.inbox-stats{display:flex;gap:20px;margin-bottom:20px}
.inbox-stat{background:var(--dark);padding:15px 20px;border-radius:10px;text-align:center}
.inbox-stat-num{font-size:1.5rem;font-weight:700;color:var(--gold)}
.inbox-stat-label{font-size:0.8rem;color:var(--muted)}
.inbox-filters{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
/* Custom Marker Cluster Styles */
.marker-cluster-small,.marker-cluster-medium,.marker-cluster-large{background:rgba(0,150,57,0.6)!important}
.marker-cluster-small div,.marker-cluster-medium div,.marker-cluster-large div{background:var(--green)!important;color:white!important;font-weight:700;font-family:'Tajawal',sans-serif}
.marker-cluster-small{background:rgba(0,150,57,0.5)!important}
.marker-cluster-medium{background:rgba(206,17,38,0.5)!important}
.marker-cluster-medium div{background:var(--red)!important}
.marker-cluster-large{background:rgba(201,162,39,0.5)!important}
.marker-cluster-large div{background:var(--gold)!important;color:#1a1a1a!important}
.leaflet-popup-content{direction:rtl;text-align:right}
.spiderfy-popup{max-height:250px;overflow-y:auto}
.spiderfy-popup .member-item{padding:10px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.2s}
.spiderfy-popup .member-item:hover{background:rgba(0,150,57,0.1)}
.spiderfy-popup .member-item:last-child{border-bottom:none}
/* Live Stream Styles */
.live-container{display:grid;grid-template-columns:1fr 350px;gap:20px;margin-top:20px}
@media(max-width:900px){.live-container{grid-template-columns:1fr;}}
.live-video-section{background:var(--card);border-radius:15px;overflow:hidden;border:2px solid var(--red)}
.live-header{background:linear-gradient(135deg,var(--red),#8B0000);padding:15px 20px;display:flex;align-items:center;justify-content:space-between}
.live-indicator{display:flex;align-items:center;gap:10px;color:white;font-weight:700}
.live-dot{width:12px;height:12px;background:#ff0000;border-radius:50%;animation:livePulse 1s infinite}
@keyframes livePulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.5;transform:scale(1.2)}}
.live-title{color:white;font-size:1.1rem}
.live-viewers{color:rgba(255,255,255,0.8);font-size:0.85rem}
.live-video-wrapper{position:relative;padding-bottom:56.25%;height:0;background:#000}
.live-video-wrapper iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none}
.live-offline{position:absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#1a1a1a,#2d2d2d);color:var(--muted)}
.live-offline-icon{font-size:4rem;margin-bottom:15px;opacity:0.5}
.live-offline-text{font-size:1.1rem}
.live-voting-section{background:var(--card);border-radius:15px;padding:20px;border:1px solid var(--border);max-height:calc(56.25vw * 0.6 + 100px);overflow-y:auto}
.live-voting-header{text-align:center;padding-bottom:15px;border-bottom:2px solid var(--gold);margin-bottom:15px}
.live-voting-header h3{color:var(--gold);margin:0 0 5px}
.live-voting-header p{color:var(--muted);font-size:0.85rem;margin:0}
.live-vote-card{background:var(--dark);border-radius:10px;padding:15px;margin-bottom:15px;border-right:3px solid var(--green)}
.live-vote-title{font-weight:700;color:var(--text);margin-bottom:10px}
.live-vote-options{display:flex;flex-direction:column;gap:8px;margin:15px 0}
.live-vote-option{padding:12px;background:rgba(255,255,255,0.03);border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:10px}
.live-vote-option:hover{border-color:var(--green);background:rgba(0,150,57,0.1)}
.live-vote-option.selected{border-color:var(--green);background:rgba(0,150,57,0.2)}
.live-vote-option .radio{width:18px;height:18px;border:2px solid var(--border);border-radius:50%;transition:all 0.3s}
.live-vote-option.selected .radio{border-color:var(--green);background:var(--green)}
.live-code-input{display:flex;gap:10px;margin-top:15px}
.live-code-input input{flex:1;text-align:center;font-size:1.1rem;letter-spacing:3px;text-transform:uppercase}
.live-no-votes{text-align:center;padding:30px;color:var(--muted)}
.live-admin-panel{background:var(--card);border-radius:15px;padding:20px;margin-bottom:20px;border:2px solid var(--gold)}
.live-url-input{display:flex;gap:10px;margin:15px 0}
.live-url-input input{flex:1}
.live-status{display:flex;align-items:center;gap:15px;padding:15px;background:var(--dark);border-radius:10px;margin-top:15px}
.live-status.active{border:2px solid var(--green)}
.live-status.inactive{border:2px solid var(--red)}
</style>
</head>
<body>
<!-- ========== الخلفية 1: المسجد الأقصى ========== -->
<div class="animated-bg bg-aqsa active" id="bgAqsa" style="display:block;">
<div class="stars"></div>
<div class="moon"></div>
<div class="particles">
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
<div class="particle"></div>
</div>
<div class="alaqsa-container">
<div class="minaret minaret-left"><div class="minaret-top"></div></div>
<div class="minaret minaret-right"><div class="minaret-top"></div></div>
<div class="dome"></div>
<div class="crescent">☪</div>
<div class="dome-base"></div>
<div class="walls"></div>
<div class="windows">
<div class="window"></div>
<div class="window"></div>
<div class="window"></div>
<div class="window"></div>
<div class="window"></div>
</div>
</div>
<div class="flag-decoration">
<div class="flag-stripe flag-black"></div>
<div class="flag-stripe flag-white"></div>
<div class="flag-stripe flag-green"></div>
<div class="flag-triangle"></div>
</div>
</div>

<!-- ========== الخلفية 2: أبيات الشعر ========== -->
<div class="animated-bg bg-poetry" id="bgPoetry">
<div class="stars"></div>
<div class="poetry-glow glow-gold"></div>
<div class="poetry-glow glow-green"></div>
<div class="poetry-glow glow-red"></div>
<div class="poetry-container"></div>
</div>

<!-- ========== الخلفية 3: حمامة السلام ========== -->
<div class="animated-bg bg-dove" id="bgDove">
<div class="stars"></div>
<div class="dove">🕊️</div>
<div class="dove">🕊️</div>
<div class="dove">🕊️</div>
<div class="dove">🕊️</div>
<div class="dove">🕊️</div>
<div class="olive-branch">🌿</div>
<div class="olive-branch">🌿</div>
<div class="olive-branch">🌿</div>
<div class="olive-branch">🌿</div>
<div class="olive-branch">🌿</div>
<div class="olive-branch">🌿</div>
<div class="peace-text">فلسطين<br>🇵🇸<br>أرض السلام</div>
</div>

<!-- زر تبديل الخلفية (للمسؤول فقط) -->
<div class="bg-switcher" id="bgSwitcher" style="display:none;">
<button class="bg-btn active" data-bg="1" title="المسجد الأقصى">🕌</button>
<button class="bg-btn" data-bg="2" title="أبيات شعرية">📜</button>
<button class="bg-btn" data-bg="3" title="حمامة السلام">🕊️</button>
</div>

<div class="app">
<aside class="sidebar" id="sidebar">
<div class="sidebar-header">
<div class="logo" id="logoContainer">🇵🇸</div>
<div class="org-name">الجالية الفلسطينية في روغالاند</div>
<div class="org-sub">Det palestinske samfunn i Rogaland</div>
</div>
<nav class="nav">
<div class="nav-title" data-i18n="publicPages">الصفحات العامة</div>
<button class="nav-btn active" id="btnHome">🏠 <span data-i18n="home">الرئيسية</span></button>
<button class="nav-btn" id="btnBylaws">📜 <span data-i18n="bylaws">النظام الداخلي</span></button>
<button class="nav-btn" id="btnVoting">🗳️ <span data-i18n="voting">التصويت</span></button>
<button class="nav-btn" id="btnNews">📰 <span data-i18n="news">الأخبار</span></button>
<button class="nav-btn" id="btnFinance">💰 <span data-i18n="finance">المحاسبة</span></button>
<button class="nav-btn" id="btnMap">🗺️ <span data-i18n="map">خارطة المنتسبين</span></button>
<button class="nav-btn" id="btnRegister">📝 <span data-i18n="register">استمارة الانتساب</span></button>
<button class="nav-btn" id="btnInvitation">📨 <span data-i18n="invitations">محرر الدعوات</span></button>
<button class="nav-btn" id="btnConfInvite">🏛️ <span>دعوة المؤتمر</span></button>
<button class="nav-btn" id="btnReports">📊 <span>التقارير والإحصائيات</span></button>
<button class="nav-btn" id="btnContact">✉️ <span data-i18n="contactUs">تواصل معنا</span></button>
<button class="nav-btn" id="btnGallery">🖼️ <span>معرض الصور</span></button>
<button class="nav-btn hidden" id="btnLive">🔴 <span data-i18n="liveStream">البث المباشر</span></button>
<div class="nav-title hidden" id="adminTitle" data-i18n="adminPanel">لوحة الإدارة</div>
<button class="nav-btn hidden" id="btnAdmin">⚙️ <span data-i18n="settings">الإعدادات</span></button>
<button class="nav-btn hidden" id="btnMembers">👥 <span data-i18n="manageMembers">إدارة الأعضاء</span></button>
<button class="nav-btn hidden" id="btnPending">📋 <span data-i18n="pendingRequests">طلبات الانتساب</span></button>
<button class="nav-btn hidden" id="btnRegistrationSheet">📊 <span data-i18n="registrationSheet">استمارة التسجيل</span></button>
<button class="nav-btn hidden" id="btnManageTx">💳 <span data-i18n="manageTransactions">إدارة المعاملات</span></button>
<button class="nav-btn hidden" id="btnManageNews">📰 <span data-i18n="manageNews">إدارة الأخبار</span></button>
<button class="nav-btn hidden" id="btnManageVoting">🗳️ <span data-i18n="manageVoting">إدارة التصويت</span></button>
<button class="nav-btn hidden" id="btnInbox">📬 <span data-i18n="inbox">صندوق الرسائل</span> <span class="inbox-badge hidden" id="inboxBadge">0</span></button>
<button class="nav-btn hidden" id="btnManageLive">🎬 <span data-i18n="manageLive">إدارة البث المباشر</span></button>
<button class="nav-btn hidden" id="btnManageGallery">🖼️ <span>إدارة معرض الصور</span></button>
</nav>
<div class="sidebar-footer">
<div class="lang-switcher">
<button class="lang-btn active" data-lang="ar" onclick="setLanguage('ar')"><span class="flag">🇵🇸</span> عربي</button>
<button class="lang-btn" data-lang="en" onclick="setLanguage('en')"><span class="flag">🇬🇧</span> EN</button>
<button class="lang-btn" data-lang="no" onclick="setLanguage('no')"><span class="flag">🇳🇴</span> NO</button>
</div>
<div class="visitor-box hidden" id="visitorBox">👥 <span data-i18n="visitors">الزوار</span>: <span id="visitors">0</span></div>
<button class="login-btn" id="loginBtn">🔐 <span data-i18n="adminLogin">دخول المسؤول</span></button>
<a class="privacy-link" onclick="goTo('privacy')">🔒 سياسة الخصوصية | Personvern</a>
</div>
</aside>
<main class="main">
<div class="page active" id="pageHome">
<!-- Hero Section -->
<div class="hero-section" id="heroSection">
<div class="hero-content">
<div class="hero-flag">🇵🇸</div>
<h1 class="hero-title" id="heroTitleDisplay">مرحباً بكم في الجالية الفلسطينية</h1>
<p class="hero-subtitle" id="heroSubtitleDisplay">نجمع شملنا في روغالاند - النرويج</p>
<div class="hero-buttons">
<button class="btn btn-green btn-lg" onclick="goTo('register')" id="heroBtn1"><span id="heroBtn1Display">📝 انضم إلينا</span></button>
<button class="btn btn-gray btn-lg" onclick="goTo('contact')" id="heroBtn2"><span id="heroBtn2Display">✉️ تواصل معنا</span></button>
</div>
<button class="btn btn-gold" onclick="enablePushNotifications()" style="margin-top:12px;font-size:0.85rem;padding:8px 20px;" id="pushNotifBtn">🔔 فعّل الإشعارات</button>
</div>
</div>

<!-- Stats Section -->
<div class="stats-section" id="statsSection">
<div class="stats-grid-home">
<div class="stat-card-home">
<div class="stat-icon-home">👥</div>
<div class="stat-value-home" id="statMembersHome">0</div>
<div class="stat-label-home">عضو</div>
</div>
<div class="stat-card-home">
<div class="stat-icon-home">🏠</div>
<div class="stat-value-home" id="statFamiliesHome">0</div>
<div class="stat-label-home">عائلة</div>
</div>
<div class="stat-card-home">
<div class="stat-icon-home">📰</div>
<div class="stat-value-home" id="statNewsHome">0</div>
<div class="stat-label-home">خبر</div>
</div>
<div class="stat-card-home">
<div class="stat-icon-home">🗳️</div>
<div class="stat-value-home" id="statVotesHome">0</div>
<div class="stat-label-home">تصويت نشط</div>
</div>
</div>
</div>

<!-- Quick Actions -->
<div class="quick-actions-section" id="quickActionsSection">
<div class="section-title-home">⚡ الوصول السريع</div>
<div class="quick-actions-grid" id="quickActionsGrid">
</div>
</div>

<!-- Active Vote Section -->
<div class="active-vote-section" id="activeVoteSection" style="display:none;">
<div class="section-title-home">🗳️ تصويت نشط الآن!</div>
<div class="active-vote-card" id="activeVoteCard">
<div class="vote-live-badge">🔴 مفتوح</div>
<h3 class="vote-title-home" id="activeVoteTitle">انتخاب رئيس اللجنة</h3>
<p class="vote-desc-home" id="activeVoteDesc">شارك في التصويت الآن</p>
<button class="btn btn-gold" onclick="goTo('voting')">شارك في التصويت ←</button>
</div>
</div>

<!-- Latest News -->
<div class="news-section-home" id="newsSection">
<div class="section-header-home">
<div class="section-title-home">📰 آخر الأخبار</div>
<button class="section-link" onclick="goTo('news')">عرض الكل ←</button>
</div>
<div class="news-grid-home" id="homeNewsGrid">
<!-- يتم ملؤها ديناميكياً -->
</div>
</div>

<!-- About Section -->
<div class="about-section" id="aboutSection">
<div class="section-title-home">🏛️ عن الجالية</div>
<div class="about-card">
<p class="about-text" id="aboutTextDisplay">نحن مجموعة من أبناء فلسطين في روغالاند - النرويج، نسعى للحفاظ على هويتنا وتراثنا الفلسطيني وتقوية الروابط بين أبناء الجالية.</p>
<div class="about-values">
<div class="about-value">
<div class="about-value-icon">🎯</div>
<div class="about-value-title">رؤيتنا</div>
<div class="about-value-text" id="visionDisplay">جالية فلسطينية متماسكة ومؤثرة</div>
</div>
<div class="about-value">
<div class="about-value-icon">💡</div>
<div class="about-value-title">رسالتنا</div>
<div class="about-value-text" id="missionDisplay">خدمة أبناء الجالية والحفاظ على الهوية</div>
</div>
</div>
</div>
</div>

<!-- Events Section -->
<div class="events-section" id="eventsSection" style="display:none;">
<div class="section-title-home">📅 الفعاليات القادمة</div>
<div class="upcoming-events-wrapper" id="homeEventsList">
<!-- يتم ملؤها ديناميكياً -->
</div>
</div>

<!-- Social Section -->
<div class="social-section" id="socialSection" style="display:none;">
<div class="section-title-home">🔗 تابعونا</div>
<div class="social-links" id="socialLinksDisplay">
<!-- يتم ملؤها ديناميكياً -->
</div>
</div>

</div>
<div class="page" id="pageNews"><div class="header"><h1>📰 الأخبار</h1></div><div id="newsGrid" style="max-width:600px;margin:0 auto;"></div></div>
<div class="page" id="pageFinance">
<div class="header"><h1>💰 المحاسبة المالية</h1></div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
<label style="color:var(--muted);font-size:0.9rem;">📅 السنة المالية:</label>
<select class="form-select" id="financeYearFilter" onchange="loadFinance()" style="width:auto;min-width:120px;">
</select>
</div>
<div class="grid" style="margin-bottom:20px;">
<div class="card" style="text-align:center;"><div class="stat-num" id="statBalance" style="color:#009639;">0 NOK</div><div class="stat-label" id="finBalanceLabel">الرصيد</div></div>
<div class="card" style="text-align:center;"><div class="stat-num" id="statIncome" style="color:#C9A227;">0 NOK</div><div class="stat-label" id="finIncomeLabel">الإيرادات</div></div>
<div class="card" style="text-align:center;"><div class="stat-num" id="statExpense" style="color:#CE1126;">0 NOK</div><div class="stat-label" id="finExpenseLabel">المصروفات</div></div>
</div>
<div class="card"><div class="card-title">📋 المعاملات</div><div id="txList"></div></div>
</div>
<div class="page" id="pageBylaws">
<div class="header"><h1>📜 النظام الداخلي</h1><p>النظام الداخلي للجالية الفلسطينية</p></div>
<button class="btn btn-gold hidden" id="btnEditBylaws" onclick="toggleBylawsEdit()" style="margin-bottom:15px;">✏️ تعديل النظام</button>
<div class="bylaws-page">
<div class="bylaws-container" id="bylawsContainer">
<svg class="bylaws-lines-svg" id="bylawsSvg">
<defs>
<linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#009736"/></linearGradient>
<linearGradient id="grad2" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#ce1126"/></linearGradient>
<linearGradient id="grad3" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#e67e22"/></linearGradient>
<linearGradient id="grad4" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#3498db"/></linearGradient>
<linearGradient id="grad5" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#9b59b6"/></linearGradient>
<linearGradient id="grad6" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#e74c3c"/></linearGradient>
<linearGradient id="grad7" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#1abc9c"/></linearGradient>
<linearGradient id="grad8" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#ce1126"/><stop offset="100%" style="stop-color:#f39c12"/></linearGradient>
</defs>
</svg>
<div class="bylaws-center" id="bylawsCenter"><h3>النظام الداخلي<br>للجالية الفلسطينية<br>في روغالاند</h3></div>
<div class="bylaws-node node-green" id="node-goals" onclick="expandBylawNode('goals')"><div class="icon">🎯</div><div class="title">الأهداف</div></div>
<div class="bylaws-node node-red" id="node-membership" onclick="expandBylawNode('membership')"><div class="icon">👥</div><div class="title">العضوية</div></div>
<div class="bylaws-node node-orange" id="node-admin" onclick="expandBylawNode('admin')"><div class="icon">⚙️</div><div class="title">الهيئة الإدارية</div></div>
<div class="bylaws-node node-blue" id="node-elections" onclick="expandBylawNode('elections')"><div class="icon">🗳️</div><div class="title">الانتخابات</div></div>
<div class="bylaws-node node-purple" id="node-conferences" onclick="expandBylawNode('conferences')"><div class="icon">🏛️</div><div class="title">المؤتمرات</div></div>
<div class="bylaws-node node-teal" id="node-finance" onclick="expandBylawNode('finance')"><div class="icon">💰</div><div class="title">المالية</div></div>
<div class="bylaws-node node-teal" id="node-school" onclick="expandBylawNode('school')"><div class="icon">📚</div><div class="title">المدرسة</div></div>
<div class="bylaws-node node-gold" id="node-penalties" onclick="expandBylawNode('penalties')"><div class="icon">⚖️</div><div class="title">العقوبات</div></div>
</div>
<div class="bylaws-overlay" id="bylawsOverlay" onclick="closeBylawPanel()"></div>
<div class="bylaws-panel" id="bylawsPanel">
<div class="bylaws-panel-header">
<button class="bylaws-panel-close" onclick="closeBylawPanel()">✕</button>
<div class="bylaws-panel-icon" id="panelIcon">📋</div>
<div class="bylaws-panel-title"><h3 id="panelTitle">العنوان</h3><p id="panelSubtitle">الباب</p></div>
</div>
<div class="bylaws-panel-body" id="panelContent"></div>
</div>
</div>
<div class="bylaws-edit-section" id="bylawsEditSection">
<h3 style="color:var(--gold);margin-bottom:15px;">✏️ إدارة النظام الداخلي</h3>
<div class="form-group"><label class="form-label">اختر الباب</label><select class="form-select" id="editBylawChapter" onchange="loadBylawSections()"></select></div>
<div class="form-group"><label class="form-label">اختر القسم</label><select class="form-select" id="editBylawSection" onchange="loadBylawContent()"></select></div>
<div class="form-group"><label class="form-label">عنوان القسم</label><input class="form-input" id="editBylawSectionTitle"></div>
<div class="form-group"><label class="form-label">النقاط (كل سطر نقطة)</label><textarea class="form-textarea" id="editBylawContent" rows="8"></textarea></div>
<div style="display:flex;gap:10px;flex-wrap:wrap;">
<button class="btn btn-green" onclick="saveBylawEdit()">💾 حفظ</button>
<button class="btn btn-gold" onclick="addNewBylawSection()">➕ إضافة قسم</button>
<button class="btn btn-red" onclick="deleteBylawSection()">🗑️ حذف</button>
</div>
</div>
</div>

<!-- صفحة التصويت للأعضاء -->
<div class="page" id="pageVoting">
<div class="header"><h1>🗳️ <span data-i18n="voting">التصويت</span></h1><p data-i18n="voteDescription">شارك برأيك في قرارات الجالية</p></div>
<div id="votingList"></div>
<div class="voting-empty hidden" id="noVotingMsg">
<div class="voting-empty-icon">🗳️</div>
<p data-i18n="noActiveVotes">لا توجد تصويتات نشطة حالياً</p>
</div>
</div>

<!-- صفحة إدارة التصويت -->
<div class="page" id="pageManageVoting">
<div class="header"><h1>🗳️ <span data-i18n="manageVoting">إدارة التصويت</span></h1><p data-i18n="createManageVotes">إنشاء وإدارة التصويتات</p></div>
<div class="voting-admin-panel">
<h3 style="color:var(--gold);margin-bottom:15px;">➕ <span data-i18n="createNewVote">إنشاء تصويت جديد</span></h3>
<div class="form-group"><label class="form-label" data-i18n="voteTitle">عنوان التصويت</label><input class="form-input" id="newVoteTitle" data-placeholder="voteTitleExample"></div>
<div class="form-group"><label class="form-label" data-i18n="questionDescription">السؤال / الوصف</label><textarea class="form-textarea" id="newVoteQuestion" rows="2" data-placeholder="questionExample"></textarea></div>
<div class="form-group">
<label class="form-label">نوع التصويت</label>
<select class="form-select" id="newVoteType">
<option value="yesno">موافق / غير موافق</option>
<option value="multiple">خيارات متعددة (انتخابات)</option>
</select>
</div>
<div id="multiOptionsDiv" style="display:none;">
<div class="form-group">
<label class="form-label">المرشحين / الخيارات (كل سطر = خيار)</label>
<textarea class="form-textarea" id="newVoteOptions" rows="5" placeholder="أحمد محمد&#10;سارة علي&#10;محمود خالد"></textarea>
</div>
<div class="form-group">
<label class="form-label">كم صوت مسموح لكل عضو؟</label>
<input type="number" class="form-input" id="newVoteMaxSel" min="1" value="1" style="width:100px;">
</div>
</div>
<div style="display:flex;gap:10px;margin-top:15px;">
<button class="btn btn-green" onclick="createNewVote()">🗳️ <span data-i18n="createVote">إنشاء التصويت</span></button>
</div>
</div>
<h3 style="margin:20px 0 15px;">📋 <span data-i18n="currentVotes">التصويتات الحالية</span></h3>
<div id="adminVotingList"></div>
</div>

<div class="page" id="pageMap">
<div class="header"><h1>🗺️ <span data-i18n="map">خارطة المنتسبين</span></h1></div>
<div style="margin-bottom:15px;">
<button class="btn btn-green" id="btnResetMap">🌍 <span data-i18n="all">الكل</span></button>
<button class="btn btn-gray" id="btnMyLoc">📍 <span data-i18n="myLocation">موقعي</span></button>
<button class="btn btn-gold hidden" id="btnFindCenter">🎯 <span data-i18n="bestMeetingLocation">أفضل موقع للاجتماع</span></button>
</div>
<div class="admin-stats hidden" id="mapAdminStats">
<div class="admin-stat"><div class="admin-stat-num" id="mapMembersCount">0</div><div class="admin-stat-label" data-i18n="onMap">على الخريطة</div></div>
<div class="admin-stat"><div class="admin-stat-num" id="mapHiddenCount">0</div><div class="admin-stat-label" data-i18n="hidden">مخفي</div></div>
<div class="admin-stat"><div class="admin-stat-num" id="mapCitiesCount">0</div><div class="admin-stat-label" data-i18n="cities">مدينة</div></div>
</div>
<div class="center-marker" id="centerInfo"><strong>🎯 <span data-i18n="bestMeetingLocation">أفضل موقع للاجتماع</span>:</strong><br><span id="centerCoords"></span></div>
<div class="card" style="padding:10px;margin-top:15px;"><div id="map"></div></div>
<div class="card"><div class="card-title">📊 <span data-i18n="statistics">إحصائيات</span></div><div id="mapStats"></div></div>
</div>
<div class="page" id="pageRegister">
<div class="header"><h1>📝 <span data-i18n="registrationForm">استمارة الانتساب</span></h1><p data-i18n="joinUs">انضم إلى الجالية الفلسطينية في روغالاند</p></div>
<div class="reg-container">
<div class="reg-header">
<div class="reg-flag">🇵🇸</div>
<div class="reg-title" data-i18n="registrationForm">استمارة الانتساب</div>
<div class="reg-subtitle">الجالية الفلسطينية في روغالاند 🍉</div>
</div>
<div class="reg-form" id="regFormContainer">
<form id="registrationForm">
<div class="reg-section">
<div class="reg-section-title">👤 <span data-i18n="personalInfo">المعلومات الشخصية</span></div>
<div class="form-group"><label class="form-label"><span data-i18n="fullName">الاسم الكامل</span> *</label><input type="text" class="form-input" id="regName" required data-placeholder="enterFullName"></div>
<div class="reg-row">
<div class="form-group"><label class="form-label"><span data-i18n="phone">رقم الهاتف</span> *</label><input type="tel" class="form-input" id="regPhone" required placeholder="+47"></div>
<div class="form-group"><label class="form-label" data-i18n="email">البريد الإلكتروني</label><input type="email" class="form-input" id="regEmail" placeholder="example@email.com"></div>
</div>
</div>
<div class="reg-section">
<div class="reg-section-title">📍 <span data-i18n="residenceInfo">معلومات السكن</span></div>
<div class="form-group"><label class="form-label"><span data-i18n="city">المدينة / المنطقة</span> *</label><input type="text" class="form-input" id="regCity" required placeholder="Stavanger, Sandnes"></div>
<div class="form-group"><label class="form-label"><span data-i18n="fullAddress">العنوان الكامل</span> (<span data-i18n="optional">اختياري</span>)</label><input type="text" class="form-input" id="regAddress" data-placeholder="forMapDisplay"></div>
<div class="address-search"><button type="button" class="btn btn-gray" id="regSearchAddress">🔍 <span data-i18n="search">بحث</span></button><button type="button" class="btn btn-green" id="regGetLocation">📍 <span data-i18n="currentLocation">موقعي الحالي</span></button></div>
<div class="location-result" id="regLocationResult"><span id="regLocationText"></span></div>
<input type="hidden" id="regLat"><input type="hidden" id="regLng">
</div>
<div class="reg-section">
<div class="reg-section-title">🇵🇸 <span data-i18n="palestinianOrigin">الأصل الفلسطيني</span></div>
<div class="reg-row">
<div class="form-group"><label class="form-label" data-i18n="originCity">البلد الأصلي في فلسطين</label><input type="text" class="form-input" id="regOriginCity" data-placeholder="originCityExample"></div>
</div>
</div>
<div class="reg-section">
<div class="reg-section-title">👨‍👩‍👧‍👦 <span data-i18n="familyMembers">أفراد العائلة</span></div>
<div class="form-group"><label class="form-label" data-i18n="familySize">عدد أفراد الأسرة (بما فيهم أنت)</label><input type="number" class="form-input" id="regFamilySize" min="1" value="1"></div>
<div id="familyMembersContainer"></div>
<button type="button" class="btn btn-gold" id="addFamilyMember" style="width:100%;margin-top:10px;">➕ <span data-i18n="addFamilyMember">إضافة فرد من العائلة</span></button>
</div>
<div class="reg-section">
<div class="reg-section-title">📝 <span data-i18n="additionalNotes">ملاحظات إضافية</span></div>
<div class="form-group"><label class="form-label" data-i18n="anyNotes">هل لديك أي ملاحظات أو اقتراحات؟</label><textarea class="form-textarea" id="regNotes" data-placeholder="writeHere"></textarea></div>
</div>
<div class="reg-privacy">
<div class="reg-privacy-title">🔒 <span data-i18n="privacySettings">إعدادات الخصوصية</span></div>
<div class="checkbox-row"><input type="checkbox" id="regShowMap" checked><label for="regShowMap" data-i18n="showOnMap">إظهار موقعي على الخريطة</label></div>
<div class="checkbox-row"><input type="checkbox" id="regShowPhone"><label for="regShowPhone" data-i18n="showPhoneToMembers">إظهار رقم هاتفي للأعضاء</label></div>
<div class="checkbox-row"><input type="checkbox" id="regShowEmail"><label for="regShowEmail" data-i18n="showEmailToMembers">إظهار بريدي الإلكتروني للأعضاء</label></div>
</div>
<div class="checkbox-row" style="margin-bottom:15px;"><input type="checkbox" id="regAgree" required><label for="regAgree"><span data-i18n="agreeToJoin">أوافق على الانضمام للجالية الفلسطينية والالتزام بأهدافها</span> *</label></div>
<div class="checkbox-row" style="margin-bottom:15px;"><input type="checkbox" id="regPrivacy" required><label for="regPrivacy">أوافق على <a onclick="goTo('privacy')" style="color:var(--green);cursor:pointer;text-decoration:underline;">سياسة الخصوصية</a> ومعالجة بياناتي الشخصية *</label></div>
<button type="submit" class="reg-submit">🇵🇸 <span data-i18n="submitRequest">إرسال طلب الانتساب</span></button>
</form>
</div>
<div class="reg-success" id="regSuccess">
<div class="reg-success-icon">✅</div>
<div class="reg-success-title" data-i18n="requestSent">تم إرسال طلبك بنجاح!</div>
<div class="reg-success-text"><span data-i18n="thankYou">شكراً لانضمامك للملتقى الفلسطيني في روغالاند</span> 🇵🇸<br><span data-i18n="willContact">سيتم مراجعة طلبك والتواصل معك قريباً</span></div>
<button class="btn btn-green" onclick="resetRegForm()">📝 <span data-i18n="submitAnother">تقديم طلب آخر</span></button>
<button class="btn btn-gray" onclick="goTo('home')">🏠 <span data-i18n="backToHome">العودة للرئيسية</span></button>
</div>
</div>
</div>
<div class="page" id="pagePending">
<div class="header"><h1>📋 طلبات الانتساب</h1><p>مراجعة وإدارة طلبات الانتساب</p></div>
<div class="admin-stats">
<div class="admin-stat"><div class="admin-stat-num" id="pendingCount">0</div><div class="admin-stat-label">طلب معلق</div></div>
<div class="admin-stat"><div class="admin-stat-num" id="approvedCount">0</div><div class="admin-stat-label">عائلة مقبولة</div></div>
</div>
<div class="card">
<div class="card-title">📥 الطلبات المعلقة</div>
<div id="pendingList"></div>
</div>
<div class="card">
<div class="card-title">✅ العائلات المقبولة</div>
<div id="approvedList"></div>
</div>
</div>
<div class="page" id="pageRegistrationSheet">
<div class="header"><h1>📊 استمارة التسجيل</h1><p>تسجيل جميع أعضاء الجالية الفلسطينية</p></div>

<div class="sheet-controls">
<div class="sheet-controls-row">
<button class="sheet-btn sheet-btn-green" onclick="addSheetRow()">➕ إضافة صف</button>
<button class="sheet-btn sheet-btn-red" onclick="deleteLastRow()">➖ حذف صف</button>
<button class="sheet-btn sheet-btn-gold" onclick="saveSheetToArchive()">💾 حفظ للأرشيف</button>
<button class="sheet-btn sheet-btn-gray" onclick="downloadSheetPDF()">📥 تحميل PDF</button>
<button class="sheet-btn sheet-btn-gray" onclick="openPrintableFormEditor()">📄 استمارة للطباعة</button>
<button class="sheet-btn sheet-btn-red" onclick="clearSheet()">🗑️ مسح الكل</button>
</div>
<div class="sheet-stats-row">
<span>👥 الأعضاء: <strong id="sheetTotalMembers">0</strong></span>
<span>👨‍👩‍👧‍👦 العائلات: <strong id="sheetTotalFamilies">0</strong></span>
<span>✅ دفعوا: <strong id="sheetTotalPaid">0</strong></span>
<span>❌ لم يدفعوا: <strong id="sheetTotalUnpaid">0</strong></span>
<span>💰 المحصّل: <strong id="sheetTotalAmount">0 NOK</strong></span>
</div>
</div>

<div class="reg-sheet-container" id="regSheetContainer">
<div class="reg-sheet-header">
<div class="sheet-logo">🇵🇸</div>
<h2 contenteditable="true" id="sheetTitle">الجالية الفلسطينية في روغالاند</h2>
<p contenteditable="true" id="sheetSubtitle">Det palestinske samfunn i Rogaland - استمارة تسجيل الأعضاء</p>
<p class="sheet-year" contenteditable="true" id="sheetYear">2025</p>
</div>
<div class="reg-sheet-table-wrapper">
<table class="reg-sheet-table" id="regSheetTable">
<thead id="regSheetHead">
<tr>
<th>#</th>
<th contenteditable="true">الاسم الأول</th>
<th contenteditable="true">اسم العائلة</th>
<th contenteditable="true">عدد أفراد العائلة</th>
<th contenteditable="true">رقم الهاتف</th>
<th contenteditable="true">البريد الإلكتروني</th>
<th contenteditable="true">المدينة</th>
<th contenteditable="true">الرسوم (NOK)</th>
<th contenteditable="true">الدفع</th>
<th contenteditable="true">ملاحظات</th>
</tr>
</thead>
<tbody id="regSheetBody">
</tbody>
</table>
</div>
<div class="reg-sheet-footer-print">
<div class="footer-line"></div>
<p>🇵🇸 <span class="print-org-name" contenteditable="true">الجالية الفلسطينية في روغالاند</span> 🇵🇸</p>
</div>
</div>

<div class="archive-section">
<div class="card">
<div class="card-title">📁 أرشيف الاستمارات</div>
<div id="archiveList"></div>
</div>
</div>
</div>
<div class="page" id="pageInvitation">
<div class="header"><h1>📨 محرر الدعوات</h1></div>
<div class="editor-grid">
<div class="card">
<div class="form-group">
<label class="form-label">🖼️ شعار الدعوة</label>
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
<div class="upload-box" id="invLogoUpload" style="width:80px;height:80px;font-size:1.5rem;padding:10px;">📷</div>
<input type="file" id="invLogoFile" accept="image/*" style="display:none">
<button class="btn btn-gray btn-sm" onclick="clearInvLogo()">🗑️ حذف</button>
</div>
<p style="font-size:0.75rem;color:var(--muted);margin-top:5px;">اضغط لرفع شعارك الخاص</p>
</div>
<div class="form-group"><label class="form-label">العنوان</label><input class="form-input" id="iTitle" value="ملتقى فلسطيني" oninput="updateInv()"></div>
<div class="form-group"><label class="form-label">العنوان الفرعي</label><input class="form-input" id="iSub" value="تجمع أهلنا" oninput="updateInv()"></div>
<div class="form-group"><label class="form-label">النص</label><textarea class="form-textarea" id="iText" oninput="updateInv()">يسرنا دعوتكم</textarea></div>
<div class="form-group"><label class="form-label">التاريخ</label><input class="form-input" id="iDate" value="السبت 24 يناير" oninput="updateInv()"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
<div class="form-group"><label class="form-label">من</label><input class="form-input" id="iFrom" value="12:30" oninput="updateInv()"></div>
<div class="form-group"><label class="form-label">إلى</label><input class="form-input" id="iTo" value="15:30" oninput="updateInv()"></div>
</div>
<div class="form-group"><label class="form-label">المكان</label><input class="form-input" id="iLoc" value="Sunde Bydelshus" oninput="updateInv()"></div>
<div class="form-group"><label class="form-label">الترحيب</label><input class="form-input" id="iWelcome" value="أهلاً بالجميع" oninput="updateInv()"></div>
<button class="btn btn-green" id="btnDlImg">🖼️ صورة</button>
<button class="btn btn-red" id="btnDlPdf">📄 PDF</button>
</div>
<div>
<div class="inv-card" id="invCard">
<div class="flag-bar"><div class="bk"></div><div class="wh"></div><div class="gr"></div></div>
<div class="inv-content">
<div class="inv-logo" id="invLogo"></div>
<div class="inv-title" id="pTitle">ملتقى فلسطيني</div>
<div class="inv-sub" id="pSub">تجمع أهلنا</div>
<div class="inv-text" id="pText">يسرنا دعوتكم</div>
<div class="inv-details">
<div class="inv-row">📅 <span id="pDate">السبت 24 يناير</span></div>
<div class="inv-row">⏰ <span id="pFrom">12:30</span> - <span id="pTo">15:30</span></div>
<div class="inv-row">📍 <span id="pLoc">Sunde Bydelshus</span></div>
</div>
<div class="inv-welcome" id="pWelcome">أهلاً بالجميع</div>
</div>
<div class="flag-bar"><div class="bk"></div><div class="wh"></div><div class="gr"></div></div>
</div>
</div>
</div>
</div>

<!-- صفحة دعوة المؤتمر -->
<div class="page" id="pageConfInvite">
<div class="header"><h1>🏛️ محرر دعوة المؤتمر</h1><p>أنشئ دعوة احترافية بتصميم فلسطيني</p></div>
<div class="conf-grid">
<div class="card" style="max-height:80vh;overflow-y:auto;">
<div class="form-group"><label class="form-label">🖼️ شعار مخصص</label><div class="upload-box" id="confLogoUp">📷 رفع شعار</div><input type="file" id="confLogoF" accept="image/*" style="display:none">
<div id="logoControls" style="display:none;margin-top:10px;background:var(--dark);padding:12px;border-radius:10px;border:1px solid var(--border);">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;"><span style="font-size:0.8rem;color:var(--muted);width:60px;">الحجم:</span><input type="range" id="logoSize" min="30" max="150" value="80" oninput="updLogoStyle()" style="flex:1;accent-color:var(--green);"><span id="logoSizeVal" style="font-size:0.8rem;color:var(--gold);width:35px;">80px</span></div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;"><span style="font-size:0.8rem;color:var(--muted);width:60px;">أعلى↕أسفل:</span><input type="range" id="logoTop" min="15" max="75" value="42" oninput="updLogoStyle()" style="flex:1;accent-color:var(--green);"><span id="logoTopVal" style="font-size:0.8rem;color:var(--gold);width:35px;">42%</span></div>
<div style="display:flex;align-items:center;gap:10px;"><span style="font-size:0.8rem;color:var(--muted);width:60px;">يمين↔يسار:</span><input type="range" id="logoLeft" min="20" max="80" value="50" oninput="updLogoStyle()" style="flex:1;accent-color:var(--green);"><span id="logoLeftVal" style="font-size:0.8rem;color:var(--gold);width:35px;">50%</span></div>
</div>
</div>
<div class="form-group"><label class="form-label">🎨 الألوان</label><div style="display:flex;gap:10px;align-items:center;"><input type="color" id="confClrHead" value="#009639" style="width:50px;height:35px;border:none;cursor:pointer;"><input type="color" id="confClrTitle" value="#CE1126" style="width:50px;height:35px;border:none;cursor:pointer;"><span style="font-size:0.8rem;color:var(--muted);">الهيدر / العنوان</span></div></div>
<div class="form-group"><label class="form-label">اسم الجالية (عربي)</label><input class="form-input" id="confOrgAr" value="الجالية الفلسطينية في جنوب النرويج" oninput="updConfPrev()"></div>
<div class="form-group"><label class="form-label">اسم الجالية (إنجليزي)</label><input class="form-input" id="confOrgEn" value="Palestinske forening i Agder" oninput="updConfPrev()"></div>
<div class="form-group"><label class="form-label">الآية</label><textarea class="form-textarea" id="confVrs" rows="2" oninput="updConfPrev()">وَقُلِ اعْمَلُوا فَسَيَرَى اللَّهُ عَمَلَكُمْ وَرَسُولُهُ وَالْمُؤْمِنُونَ</textarea></div>
<div class="form-group"><label class="form-label">المرجع</label><input class="form-input" id="confVrsRef" value="سورة التوبة - آية 105" oninput="updConfPrev()"></div>
<div class="form-group"><label class="form-label">نص الدعوة</label><textarea class="form-textarea" id="confInvTxt" rows="2" oninput="updConfPrev()">تتشرف الهيئة الإدارية للجالية الفلسطينية في جنوب النرويج بدعوتكم لحضور المؤتمر الخامس عشر</textarea></div>
<div class="form-group"><label class="form-label">عنوان المؤتمر</label><input class="form-input" id="confTtl" value="مؤتمر الصمود" oninput="updConfPrev()"></div>
<div class="form-group"><label class="form-label">التاريخ</label><input class="form-input" id="confDt" value="18.01.2026" oninput="updConfPrev()"></div>
<div class="form-group"><label class="form-label">📋 جدول الأعمال</label><div id="confAgendaEd"></div><button type="button" class="btn btn-gold btn-sm" onclick="addConfAg()">+ إضافة بند</button></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><div class="form-group"><label class="form-label">وقت التسجيل</label><input class="form-input" id="confTmReg" value="16:00" oninput="updConfPrev()"></div><div class="form-group"><label class="form-label">وقت البدء</label><input class="form-input" id="confTmStr" value="17:00" oninput="updConfPrev()"></div></div>
<div class="form-group"><label class="form-label">العنوان</label><input class="form-input" id="confAddr" value="Songdalsvegen 48, Nodeland" oninput="updConfPrev()"></div>
<div class="form-group"><label class="form-label">نص الختام</label><textarea class="form-textarea" id="confFtr" rows="2" oninput="updConfPrev()">حضوركم يشرفنا ويدعم جهودنا في خدمة أبناء الجالية الفلسطينية</textarea></div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:15px;"><button class="btn btn-gray" onclick="printConfCard()">🖨️ طباعة</button><button class="btn btn-red" onclick="dlConfPDF()">📄 PDF</button><button class="btn btn-green" onclick="dlConfImg()">🖼️ صورة</button></div>
</div>
<div>
<div class="conf-card" id="confCardPrev">
<div class="conf-head" id="confHeadEl"><div class="conf-dome" style="position:relative;display:inline-block;"><svg viewBox="0 0 240 140" width="220" height="130"><ellipse cx="120" cy="95" rx="95" ry="70" fill="#C9A227"/><ellipse cx="120" cy="90" rx="82" ry="58" fill="#009639"/><rect x="115" y="12" width="10" height="28" fill="#C9A227"/><ellipse cx="120" cy="12" rx="8" ry="8" fill="#C9A227"/></svg><div id="confLogoPrev" style="position:absolute;top:42%;left:50%;transform:translate(-50%,-50%);width:80px;height:80px;border-radius:50%;overflow:hidden;display:none;border:3px solid #C9A227;background:white;"><img id="confLogoImg" src="" style="width:100%;height:100%;object-fit:cover;"></div></div><div class="conf-org-ar" id="confOrgArP">الجالية الفلسطينية في جنوب النرويج</div><div class="conf-org-en" id="confOrgEnP">Palestinske forening i Agder</div></div>
<div class="conf-verse-sec"><div class="conf-bism">بسم الله الرحمن الرحيم</div><div class="conf-verse" id="confVrsP">﴿وَقُلِ اعْمَلُوا فَسَيَرَى اللَّهُ عَمَلَكُمْ وَرَسُولُهُ وَالْمُؤْمِنُونَ﴾</div><div class="conf-verse-ref" id="confVrsRefP">سورة التوبة - آية 105</div></div>
<div class="conf-inv-txt" id="confInvTxtP">تتشرف الهيئة الإدارية للجالية الفلسطينية في جنوب النرويج بدعوتكم لحضور المؤتمر الخامس عشر</div>
<div class="conf-title-box" id="confTtlBox"><span id="confTtlP">(مؤتمر الصمود)</span></div>
<div class="conf-date" id="confDtP">18.01.2026</div>
<div class="conf-agenda-sec"><div class="conf-agenda-head">📋 جدول أعمال المؤتمر</div><div class="conf-agenda-list" id="confAgendaP"></div></div>
<div class="conf-details-sec" id="confDetEl"><div class="conf-det-row">🕐 يفتح باب التسجيل: الساعة <span id="confTmRegP">16:00</span></div><div class="conf-det-row">📅 موعد بدء المؤتمر: الساعة <span id="confTmStrP">17:00</span></div><div class="conf-det-row">📍 العنوان: <span id="confAddrP">Songdalsvegen 48, Nodeland</span></div></div>
<div class="conf-footer-txt" id="confFtrP">حضوركم يشرفنا ويدعم جهودنا في خدمة أبناء الجالية الفلسطينية</div>
<div class="conf-slogan">🇵🇸 فلسطين في قلوبنا PS</div>
<div class="conf-flag"><div class="conf-flag-bk"></div><div class="conf-flag-wh"></div><div class="conf-flag-gr"></div></div>
</div>
</div>
</div>
</div>

<!-- صفحة التقارير والإحصائيات -->
<div class="page" id="pageReports">
<div class="header"><h1>📊 التقارير والإحصائيات</h1><p>تقارير شاملة جاهزة للطباعة والتصدير</p></div>

<div class="report-tabs">
<button class="report-tab active" onclick="switchReport('members')">👥 الأعضاء</button>
<button class="report-tab" onclick="switchReport('finance')">💰 المالية</button>
<button class="report-tab" onclick="switchReport('voting')">🗳️ التصويت</button>
<button class="report-tab" onclick="switchReport('overview')">📋 نظرة عامة</button>
</div>

<!-- تقرير الأعضاء -->
<div class="report-panel active" id="reportMembers">
<div class="report-stats-grid">
<div class="report-stat"><div class="report-stat-num" id="rptTotalMembers">0</div><div class="report-stat-label">إجمالي الأعضاء</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptTotalFamilies">0</div><div class="report-stat-label">العائلات المسجلة</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptNewMembers">0</div><div class="report-stat-label">أعضاء جدد (هذا الشهر)</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptCities">0</div><div class="report-stat-label">مدن مختلفة</div></div>
</div>

<div class="chart-container">
<div class="chart-title">🏙️ توزيع الأعضاء حسب المدن</div>
<div id="rptCityChart"></div>
</div>

<div class="chart-container">
<div class="chart-title">👨‍👩‍👧‍👦 أكبر العائلات (حسب عدد الأفراد)</div>
<div id="rptFamilyChart"></div>
</div>

<div class="chart-container">
<div class="chart-title">📋 قائمة الأعضاء الكاملة</div>
<table class="report-table">
<thead><tr><th>#</th><th>الاسم</th><th>المدينة</th><th>الهاتف</th><th>تاريخ التسجيل</th></tr></thead>
<tbody id="rptMembersTable"></tbody>
</table>
</div>

<div class="report-actions">
<button class="btn btn-green" onclick="exportMembersPDF()">📄 تصدير PDF</button>
<button class="btn btn-gray" onclick="printReport('members')">🖨️ طباعة</button>
</div>
</div>

<!-- تقرير المالية -->
<div class="report-panel" id="reportFinance">
<div class="report-period">
<select id="rptFinPeriod" onchange="loadFinanceReport()">
<option value="all">كل الفترات</option>
<option value="month">هذا الشهر</option>
<option value="3months">آخر 3 أشهر</option>
<option value="year">هذه السنة</option>
</select>
</div>

<div class="report-stats-grid">
<div class="report-stat"><div class="report-stat-num" style="-webkit-text-fill-color:#00D26A" id="rptTotalIncome">0</div><div class="report-stat-label">إجمالي الإيرادات</div></div>
<div class="report-stat"><div class="report-stat-num" style="-webkit-text-fill-color:#E63946" id="rptTotalExpense">0</div><div class="report-stat-label">إجمالي المصروفات</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptBalance">0</div><div class="report-stat-label">الرصيد الحالي</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptTxCount">0</div><div class="report-stat-label">عدد المعاملات</div></div>
</div>

<div class="chart-container">
<div class="chart-title">📊 الإيرادات مقابل المصروفات</div>
<div id="rptFinBarChart"></div>
</div>

<div class="chart-container">
<div class="chart-title">📋 سجل المعاملات</div>
<table class="report-table">
<thead><tr><th>#</th><th>التاريخ</th><th>الوصف</th><th>النوع</th><th>المبلغ (NOK)</th></tr></thead>
<tbody id="rptFinTable"></tbody>
</table>
</div>

<div class="report-actions">
<button class="btn btn-green" onclick="exportFinancePDF()">📄 تصدير PDF</button>
<button class="btn btn-gray" onclick="printReport('finance')">🖨️ طباعة</button>
</div>
</div>

<!-- تقرير التصويت -->
<div class="report-panel" id="reportVoting">
<div class="report-stats-grid">
<div class="report-stat"><div class="report-stat-num" id="rptTotalVotes">0</div><div class="report-stat-label">إجمالي التصويتات</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptActiveVotes">0</div><div class="report-stat-label">نشطة حالياً</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptClosedVotes">0</div><div class="report-stat-label">مغلقة</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptAvgParticipation">0%</div><div class="report-stat-label">متوسط المشاركة</div></div>
</div>

<div id="rptVotingResults"></div>

<div class="report-actions">
<button class="btn btn-green" onclick="exportVotingPDF()">📄 تصدير PDF</button>
<button class="btn btn-gray" onclick="printReport('voting')">🖨️ طباعة</button>
</div>
</div>

<!-- نظرة عامة -->
<div class="report-panel" id="reportOverview">
<div class="report-stats-grid">
<div class="report-stat"><div class="report-stat-num" id="rptOvMembers">0</div><div class="report-stat-label">👥 الأعضاء</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptOvFamilies">0</div><div class="report-stat-label">👨‍👩‍👧‍👦 العائلات</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptOvNews">0</div><div class="report-stat-label">📰 الأخبار</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptOvBalance">0</div><div class="report-stat-label">💰 الرصيد (NOK)</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptOvVotes">0</div><div class="report-stat-label">🗳️ التصويتات</div></div>
<div class="report-stat"><div class="report-stat-num" id="rptOvCities">0</div><div class="report-stat-label">🏙️ المدن</div></div>
</div>

<div class="chart-container">
<div class="chart-title">📈 ملخص عام للمنظمة</div>
<div id="rptOverviewSummary" style="line-height:2;font-size:0.9rem;color:var(--muted)"></div>
</div>

<div class="report-actions">
<button class="btn btn-green" onclick="exportOverviewPDF()">📄 تصدير تقرير شامل PDF</button>
<button class="btn btn-gray" onclick="printReport('overview')">🖨️ طباعة</button>
</div>
</div>
</div>

<!-- صفحة التواصل معنا -->
<div class="page" id="pageContact">
<div class="header"><h1>✉️ <span data-i18n="contactUs">تواصل معنا</span></h1><p data-i18n="contactDescription">أرسل لنا رسالتك أو اقتراحك</p></div>
<div class="contact-form">
<div class="card">
<div id="contactFormContainer">
<div class="form-group">
<label class="form-label">👤 <span data-i18n="yourName">اسمك</span> <span style="color:var(--red);">*</span></label>
<input type="text" class="form-input" id="contactName" placeholder="أدخل اسمك">
</div>
<div class="form-group">
<label class="form-label">📱 <span data-i18n="phone">رقم الهاتف</span> <span style="color:var(--muted);font-size:0.8rem;">(<span data-i18n="optional">اختياري</span>)</span></label>
<input type="tel" class="form-input" id="contactPhone" placeholder="+47">
</div>
<div class="form-group">
<label class="form-label">📧 <span data-i18n="email">البريد الإلكتروني</span> <span style="color:var(--muted);font-size:0.8rem;">(<span data-i18n="optional">اختياري</span>)</span></label>
<input type="email" class="form-input" id="contactEmail" placeholder="example@email.com">
</div>
<div class="form-group">
<label class="form-label">📋 <span data-i18n="subject">الموضوع</span> <span style="color:var(--red);">*</span></label>
<select class="form-select" id="contactSubject">
<option value="">-- اختر الموضوع --</option>
<option value="اقتراح">💡 اقتراح</option>
<option value="استفسار">❓ استفسار</option>
<option value="شكوى">⚠️ شكوى</option>
<option value="طلب مساعدة">🤝 طلب مساعدة</option>
<option value="تطوع">🙋 تطوع</option>
<option value="أخرى">📝 أخرى</option>
</select>
</div>
<div class="form-group">
<label class="form-label">💬 <span data-i18n="message">الرسالة</span> <span style="color:var(--red);">*</span></label>
<textarea class="form-textarea" id="contactMessage" rows="5" placeholder="اكتب رسالتك هنا..."></textarea>
</div>
<button class="btn btn-green" style="width:100%;padding:15px;font-size:1rem;" onclick="sendMessage()">📤 <span data-i18n="sendMessage">إرسال الرسالة</span></button>
</div>
<div class="contact-success" id="contactSuccess">
<div class="contact-success-icon">✅</div>
<h3 style="color:var(--green);margin-bottom:10px;" data-i18n="messageSent">تم إرسال رسالتك بنجاح!</h3>
<p style="color:var(--muted);margin-bottom:20px;" data-i18n="messageThankYou">شكراً لتواصلك معنا. سنرد عليك في أقرب وقت.</p>
<button class="btn btn-gray" onclick="resetContactForm()">📝 <span data-i18n="sendAnother">إرسال رسالة أخرى</span></button>
</div>
</div>
</div>
</div>

<!-- صفحة صندوق الرسائل (للإدارة) -->
<div class="page" id="pageInbox">
<div class="header"><h1>📬 <span data-i18n="inbox">صندوق الرسائل</span></h1><p data-i18n="inboxDescription">إدارة رسائل الزوار والأعضاء</p></div>
<div class="inbox-stats">
<div class="inbox-stat"><div class="inbox-stat-num" id="totalMessages">0</div><div class="inbox-stat-label" data-i18n="totalMessages">إجمالي الرسائل</div></div>
<div class="inbox-stat"><div class="inbox-stat-num" id="unreadMessages" style="color:var(--green);">0</div><div class="inbox-stat-label" data-i18n="unreadMessages">غير مقروءة</div></div>
<div class="inbox-stat"><div class="inbox-stat-num" id="readMessages" style="color:var(--muted);">0</div><div class="inbox-stat-label" data-i18n="readMessages">مقروءة</div></div>
</div>
<div class="inbox-filters">
<button class="btn btn-green btn-sm" onclick="filterMessages('all')" id="filterAll">📋 الكل</button>
<button class="btn btn-gray btn-sm" onclick="filterMessages('unread')" id="filterUnread">🔔 غير مقروءة</button>
<button class="btn btn-gray btn-sm" onclick="filterMessages('read')" id="filterRead">✅ مقروءة</button>
<button class="btn btn-red btn-sm" onclick="markAllAsRead()">👁️ تحديد الكل كمقروء</button>
</div>
<div class="card">
<div class="card-title">📥 الرسائل الواردة</div>
<div id="messagesList"></div>
</div>
</div>

<!-- Modal لعرض تفاصيل الرسالة -->
<div class="modal-bg" id="messageModal">
<div class="modal" style="max-width:600px;">
<div class="modal-head">
<h3>📧 <span data-i18n="messageDetails">تفاصيل الرسالة</span></h3>
<button class="modal-close" onclick="closeMessageModal()">×</button>
</div>
<div class="modal-body" id="messageDetailContent"></div>
<div class="modal-foot">
<button class="btn btn-red btn-sm" onclick="deleteCurrentMessage()">🗑️ حذف</button>
<button class="btn btn-gray" onclick="closeMessageModal()">إغلاق</button>
</div>
</div>
</div>

<!-- صفحة البث المباشر للمشاهدين -->
<div class="page" id="pageLive">
<div class="header"><h1>🔴 <span data-i18n="liveStream">البث المباشر</span></h1><p id="liveEventTitle" data-i18n="watchLiveEvents">شاهد الفعاليات مباشرة وشارك بالتصويت</p></div>
<div class="live-container">
<div class="live-video-section">
<div class="live-header">
<div class="live-indicator"><div class="live-dot"></div><span data-i18n="liveNow">مباشر الآن</span></div>
<div class="live-title" id="liveStreamTitle">البث المباشر</div>
</div>
<div class="live-video-wrapper" id="liveVideoWrapper">
<div class="live-offline" id="liveOfflineMsg">
<div class="live-offline-icon">📺</div>
<div class="live-offline-text" data-i18n="noLiveStream">لا يوجد بث مباشر حالياً</div>
<p style="font-size:0.85rem;margin-top:10px;" data-i18n="checkBackLater">تابعنا للإعلان عن البث القادم</p>
</div>
<div id="liveVideoContainer" style="display:none;width:100%;height:100%;position:absolute;top:0;left:0;">
<iframe id="liveVideoFrame" style="width:100%;height:100%;border:none;" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
</div>
</div>
<div id="liveAlternativeOptions" style="display:none;padding:15px;background:var(--dark);border-radius:0 0 15px 15px;text-align:center;">
<p style="margin-bottom:10px;color:var(--muted);font-size:0.9rem;">⬆️ إذا لم يظهر الفيديو أعلاه:</p>
<button class="btn btn-green" onclick="openLiveInNewWindow()" style="margin:5px;">📺 فتح البث في نافذة جديدة</button>
<a id="liveDirectLink" href="#" target="_blank" class="btn btn-red" style="margin:5px;display:inline-block;">🔴 مشاهدة على YouTube</a>
</div>
</div>
<div class="live-voting-section">
<div class="live-voting-header">
<h3>🗳️ <span data-i18n="voteNow">صوّت الآن</span></h3>
<p data-i18n="voteWhileWatching">شارك بصوتك أثناء مشاهدة البث</p>
</div>
<div id="liveVotingList"></div>
<div class="live-no-votes" id="liveNoVotes">
<div style="font-size:2rem;margin-bottom:10px;">🗳️</div>
<p data-i18n="noActiveVotesNow">لا توجد تصويتات نشطة حالياً</p>
</div>
</div>
</div>
</div>

<!-- صفحة إدارة البث المباشر -->
<div class="page" id="pageManageLive">
<div class="header"><h1>🎬 <span data-i18n="manageLive">إدارة البث المباشر</span></h1><p data-i18n="setupLiveStream">إعداد وتشغيل البث المباشر</p></div>
<div class="live-admin-panel">
<h3 style="color:var(--gold);margin-bottom:15px;">📺 <span data-i18n="streamSettings">إعدادات البث</span></h3>
<div class="form-group">
<label class="form-label" data-i18n="streamTitle">عنوان البث</label>
<input class="form-input" id="adminLiveTitle" placeholder="مثال: انتخابات الهيئة الإدارية 2025">
</div>
<div class="form-group">
<label class="form-label">رابط البث (YouTube أو Facebook Live)</label>
<div class="live-url-input">
<input class="form-input" id="adminLiveUrl" placeholder="https://www.youtube.com/watch?v=XXXXX">
<button class="btn btn-gold" onclick="previewLiveStream()">👁️ معاينة</button>
</div>
<p style="font-size:0.8rem;color:var(--muted);margin-top:5px;">💡 انسخ رابط البث من YouTube أو Facebook - تأكد أن البث يسمح بالتضمين (embedding)</p>
</div>
<div class="form-group">
<label class="form-label" data-i18n="linkedVote">ربط تصويت بالبث (اختياري)</label>
<select class="form-select" id="adminLiveVote">
<option value="">-- بدون تصويت --</option>
</select>
</div>
<div class="form-group" style="margin-top:15px;">
<div class="checkbox-row" style="background:var(--dark);padding:15px;border-radius:10px;">
<input type="checkbox" id="adminLivePublic" checked>
<label for="adminLivePublic" style="font-size:0.95rem;">
<strong style="color:var(--gold);">👁️ إظهار للعامة</strong><br>
<span style="font-size:0.8rem;color:var(--muted);">السماح لجميع الزوار بمشاهدة البث (بدون الحاجة لتسجيل الدخول)</span>
</label>
</div>
</div>
<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:15px;">
<button class="btn btn-green" onclick="startLiveStream()">🔴 <span data-i18n="startStream">بدء البث</span></button>
<button class="btn btn-red" onclick="stopLiveStream()">⏹️ <span data-i18n="stopStream">إيقاف البث</span></button>
</div>
<div class="live-status inactive" id="liveStatusPanel">
<div style="font-size:2rem;">📺</div>
<div>
<strong id="liveStatusText" data-i18n="streamStopped">البث متوقف</strong>
<p style="margin:5px 0 0;font-size:0.85rem;color:var(--muted);" id="liveStatusInfo"></p>
</div>
</div>
</div>
<div class="card">
<div class="card-title">📋 <span data-i18n="streamGuide">دليل البث المباشر</span></div>
<div style="line-height:1.8;font-size:0.9rem;">
<p><strong>1. YouTube Live:</strong></p>
<ul style="margin:5px 0 15px 20px;color:var(--muted);">
<li>افتح YouTube Studio → "إنشاء" → "بث مباشر"</li>
<li>في إعدادات البث، تأكد من السماح بالتضمين</li>
<li>انسخ رابط البث والصقه هنا</li>
<li><strong style="color:var(--gold);">مهم:</strong> رابط البث المباشر يكون مثل: youtube.com/live/XXXXX</li>
</ul>
<p><strong>2. Facebook Live:</strong></p>
<ul style="margin:5px 0 15px 20px;color:var(--muted);">
<li>افتح صفحتك على Facebook</li>
<li>اضغط "بث مباشر"</li>
<li>انسخ رابط البث والصقه هنا</li>
</ul>
<p><strong style="color:var(--red);">⚠️ ملاحظة:</strong> <span style="color:var(--muted);">إذا ظهر خطأ، جرب فتح الرابط في نافذة جديدة للتأكد من أنه يعمل.</span></p>
</div>
</div>
</div>

<div class="page" id="pageAdmin">
<div class="header"><h1>⚙️ الإعدادات</h1></div>
<div class="grid">
<div class="card">
<div class="card-title">🏷️ اسم المنظمة</div>
<div class="form-group"><label class="form-label">الاسم بالعربي</label><input class="form-input" id="orgNameAr" placeholder="مثال: الجالية الفلسطينية في روغالاند"></div>
<div class="form-group"><label class="form-label">الاسم بالإنجليزي/النرويجي</label><input class="form-input" id="orgNameEn" placeholder="مثال: Det palestinske samfunn i Rogaland"></div>
<button class="btn btn-green" onclick="saveOrgName()">💾 حفظ الاسم</button>
</div>
<div class="card"><div class="card-title">🖼️ الشعار</div><div class="upload-box" id="logoUpload">📷 رفع شعار</div><input type="file" id="logoFile" accept="image/*" style="display:none"></div>
<div class="card"><div class="card-title">🔐 الأمان</div><button class="btn btn-gray" id="btnChangePass" style="width:100%;margin-bottom:8px;">🔑 تغيير كلمة المرور</button><button class="btn btn-red" id="btnLogout" style="width:100%;">🚪 خروج</button></div>

<div class="card">
<div class="card-title">💾 النسخ الاحتياطي</div>
<p style="color:var(--muted);font-size:0.85rem;margin-bottom:15px;">احفظ نسخة من كل بياناتك أو استعدها في أي وقت</p>
<div style="display:grid;gap:10px;">
<button class="btn btn-green" onclick="exportBackup()" style="width:100%;">📥 تصدير البيانات (تنزيل ملف)</button>
<button class="btn btn-gold" onclick="document.getElementById('importBackupFile').click()" style="width:100%;">📤 استيراد بيانات (من ملف)</button>
<input type="file" id="importBackupFile" accept=".json" style="display:none" onchange="importBackup(this)">
<button class="btn btn-gray" onclick="exportBackupCloud()" style="width:100%;">☁️ حفظ نسخة على السحابة</button>
</div>
<div id="backupStatus" style="margin-top:10px;font-size:0.8rem;color:var(--muted);"></div>
</div>
</div>

<!-- قسم تخصيص الصفحة الرئيسية -->
<div class="card">
<div class="card-title">🏠 تخصيص الصفحة الرئيسية</div>
<p style="color:var(--muted);font-size:0.85rem;margin-bottom:20px;">اختر العناصر التي تريد عرضها في الصفحة الرئيسية وخصص محتواها</p>

<div class="home-sections-grid">
<!-- 1. قسم الترحيب -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowHero" checked onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">🎉 قسم الترحيب (Hero)</span>
<button class="btn btn-sm btn-gray" onclick="toggleEditSection('heroEdit')">✏️</button>
</div>
<div class="home-section-edit" id="heroEdit" style="display:none;">
<div class="form-group"><label class="form-label">العنوان الرئيسي</label><input class="form-input" id="heroTitle" placeholder="مرحباً بكم في الجالية الفلسطينية" onchange="saveHomeSettings()"></div>
<div class="form-group"><label class="form-label">النص الفرعي</label><input class="form-input" id="heroSubtitle" placeholder="نجمع شملنا في روغالاند" onchange="saveHomeSettings()"></div>
<div class="form-group"><label class="form-label">نص الزر الأول</label><input class="form-input" id="heroBtn1Text" placeholder="انضم إلينا" onchange="saveHomeSettings()"></div>
<div class="form-group"><label class="form-label">نص الزر الثاني</label><input class="form-input" id="heroBtn2Text" placeholder="تواصل معنا" onchange="saveHomeSettings()"></div>
</div>
</div>

<!-- 2. الإحصائيات -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowStats" checked onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">📊 الإحصائيات</span>
</div>
</div>

<!-- 3. أزرار الوصول السريع -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowQuickActions" checked onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">⚡ أزرار الوصول السريع</span>
<button class="btn btn-sm btn-gray" onclick="toggleEditSection('quickActionsEdit')">✏️</button>
</div>
<div class="home-section-edit" id="quickActionsEdit" style="display:none;">
<p style="font-size:0.8rem;color:var(--muted);margin-bottom:10px;">اختر الأزرار التي تريد إظهارها:</p>
<div class="checkbox-row"><input type="checkbox" id="qaRegister" checked onchange="saveHomeSettings()"><label>📝 استمارة الانتساب</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaVoting" checked onchange="saveHomeSettings()"><label>🗳️ التصويت</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaLive" checked onchange="saveHomeSettings()"><label>📺 البث المباشر</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaMap" checked onchange="saveHomeSettings()"><label>🗺️ خارطة المنتسبين</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaNews" onchange="saveHomeSettings()"><label>📰 الأخبار</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaFinance" onchange="saveHomeSettings()"><label>💰 المالية</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaBylaws" onchange="saveHomeSettings()"><label>📜 النظام الداخلي</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaInvitation" onchange="saveHomeSettings()"><label>📨 محرر الدعوات</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaConfInvite" onchange="saveHomeSettings()"><label>🏛️ دعوة المؤتمر</label></div>
<div class="checkbox-row"><input type="checkbox" id="qaContact" onchange="saveHomeSettings()"><label>✉️ تواصل معنا</label></div>
</div>
</div>

<!-- 4. التصويت النشط -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowActiveVote" checked onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">🗳️ التصويت النشط</span>
</div>
</div>

<!-- 5. آخر الأخبار -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowNews" checked onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">📰 آخر الأخبار</span>
<button class="btn btn-sm btn-gray" onclick="toggleEditSection('newsEdit')">✏️</button>
</div>
<div class="home-section-edit" id="newsEdit" style="display:none;">
<div class="form-group"><label class="form-label">عدد الأخبار المعروضة</label><input type="number" class="form-input" id="homeNewsCount" value="3" min="1" max="10" onchange="saveHomeSettings()" style="width:100px;"></div>
</div>
</div>

<!-- 6. عن الجالية -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowAbout" checked onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">🏛️ عن الجالية</span>
<button class="btn btn-sm btn-gray" onclick="toggleEditSection('aboutEdit')">✏️</button>
</div>
<div class="home-section-edit" id="aboutEdit" style="display:none;">
<div class="form-group"><label class="form-label">نبذة عن الجالية</label><textarea class="form-textarea" id="homeAboutText" rows="4" placeholder="نحن مجموعة من أبناء فلسطين في روغالاند..." onchange="saveHomeSettings()"></textarea></div>
<div class="form-group"><label class="form-label">الرؤية</label><input class="form-input" id="homeVision" placeholder="جالية فلسطينية متماسكة..." onchange="saveHomeSettings()"></div>
<div class="form-group"><label class="form-label">الرسالة</label><input class="form-input" id="homeMission" placeholder="خدمة أبناء الجالية..." onchange="saveHomeSettings()"></div>
</div>
</div>

<!-- 7. الفعاليات القادمة -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowEvents" onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">📅 الفعاليات القادمة</span>
<button class="btn btn-sm btn-gray" onclick="toggleEditSection('eventsEdit')">✏️</button>
</div>
<div class="home-section-edit" id="eventsEdit" style="display:none;">
<div id="eventsList"></div>
<button class="btn btn-gold btn-sm" onclick="addEvent()" style="margin-top:10px;">➕ إضافة فعالية</button>
</div>
</div>

<!-- 8. روابط التواصل -->
<div class="home-section-item">
<div class="home-section-header">
<label class="toggle-switch"><input type="checkbox" id="homeShowSocial" onchange="saveHomeSettings()"><span class="toggle-slider"></span></label>
<span class="home-section-title">🔗 روابط التواصل الاجتماعي</span>
<button class="btn btn-sm btn-gray" onclick="toggleEditSection('socialEdit')">✏️</button>
</div>
<div class="home-section-edit" id="socialEdit" style="display:none;">
<div class="form-group"><label class="form-label">فيسبوك</label><input class="form-input" id="socialFacebook" placeholder="https://facebook.com/..." onchange="saveHomeSettings()"></div>
<div class="form-group"><label class="form-label">انستغرام</label><input class="form-input" id="socialInstagram" placeholder="https://instagram.com/..." onchange="saveHomeSettings()"></div>
<div class="form-group"><label class="form-label">واتساب (رقم المجموعة)</label><input class="form-input" id="socialWhatsapp" placeholder="https://chat.whatsapp.com/..." onchange="saveHomeSettings()"></div>
<div class="form-group"><label class="form-label">البريد الإلكتروني</label><input class="form-input" id="socialEmail" placeholder="info@example.com" onchange="saveHomeSettings()"></div>
</div>
</div>
</div>
</div>

<div class="card">
<div class="card-title">👁️ التحكم في ظهور الأقسام</div>
<div class="toggle-row"><span>📰 الأخبار</span><select class="visibility-select" id="visNews"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
<div class="toggle-row"><span>💰 المحاسبة</span><select class="visibility-select" id="visFinance"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
<div class="toggle-row"><span>🗺️ الخريطة</span><select class="visibility-select" id="visMap"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
<div class="toggle-row"><span>📨 محرر الدعوات</span><select class="visibility-select" id="visInvitation"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
<div class="toggle-row"><span>🏛️ دعوة المؤتمر</span><select class="visibility-select" id="visConfInvite"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
<div class="toggle-row"><span>📊 التقارير</span><select class="visibility-select" id="visReports"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
<div class="toggle-row"><span>📜 النظام الداخلي</span><select class="visibility-select" id="visBylaws"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
<div class="toggle-row"><span>🗳️ التصويت</span><select class="visibility-select" id="visVoting"><option value="all">للجميع</option><option value="admin">للمسؤول فقط</option><option value="hidden">مخفي</option></select></div>
</div>
</div>
<div class="page" id="pageMembers">
<div class="header"><h1>👥 إدارة الأعضاء</h1><p>إجمالي الأعضاء المسجلين: <span id="totalMembersCount" style="color:var(--gold);font-weight:bold;">0</span></p></div>
<div class="card">
<div class="card-title"><span>قائمة الأعضاء</span><div style="display:flex;gap:10px;"><button class="btn btn-gold btn-sm" onclick="regenerateAllCodes()">🔄 تغيير رموز التصويت</button><button class="btn btn-green btn-sm" id="btnAddMember">➕ إضافة</button></div></div>
<div class="form-group" style="margin-bottom:15px;"><input type="text" class="form-input" id="memberSearchInput" placeholder="🔍 ابحث بالاسم أو رقم الهاتف..." oninput="searchMembers()"></div>
<div id="membersList"></div>
</div>
</div>
<div class="page" id="pageManageTx">
<div class="header"><h1>💳 إدارة المعاملات</h1></div>
<div class="card">
<div class="card-title">إضافة معاملة جديدة</div>
<div class="form-group"><label class="form-label">النوع</label><select class="form-select" id="txType"><option value="income">إيراد</option><option value="expense">مصروف</option></select></div>
<div class="form-group"><label class="form-label">الوصف</label><input class="form-input" id="txDesc"></div>
<div class="form-group"><label class="form-label">المبلغ (NOK)</label><input type="number" class="form-input" id="txAmount"></div>
<div class="form-group"><label class="form-label">التاريخ</label><input type="date" class="form-input" id="txDate"></div>
<div class="form-group"><label class="form-label">صور الفواتير</label><div class="upload-box" id="txReceiptsUpload">📷 إضافة فواتير</div><input type="file" id="txReceiptsFile" accept="image/*" multiple style="display:none"><div class="receipts-preview" id="txReceiptsPreview"></div></div>
<button class="btn btn-green" id="btnSaveTx">💾 حفظ</button>
</div>
<div style="display:flex;align-items:center;gap:10px;margin:15px 0;flex-wrap:wrap;">
<label style="color:var(--muted);font-size:0.9rem;">📅 فلتر السنة:</label>
<select class="form-select" id="adminTxYearFilter" onchange="loadAdminTx()" style="width:auto;min-width:120px;">
</select>
</div>
<div class="card"><div class="card-title">📋 المعاملات</div><div id="adminTxList"></div></div>
</div>
<div class="page" id="pageManageNews">
<div class="header"><h1>📰 إدارة الأخبار</h1></div>
<div class="card">
<div class="card-title">إضافة خبر جديد</div>
<div class="form-group"><label class="form-label">العنوان</label><input class="form-input" id="newNewsTitle"></div>
<div class="form-group"><label class="form-label">المحتوى</label><textarea class="form-textarea" id="newNewsContent"></textarea></div>
<div class="form-group"><label class="form-label">صور الخبر</label><div class="upload-box" id="newsImgsUpload">📷 إضافة صور</div><input type="file" id="newsImgsFile" accept="image/*" multiple style="display:none"><div class="imgs-preview" id="newsImgsPreview"></div></div>
<button class="btn btn-green" id="btnPublishNews">📤 نشر</button>
</div>
<div class="card"><div class="card-title">📋 جميع الأخبار</div><div id="adminNewsList"></div></div>
</div>

<!-- صفحة معرض الصور -->
<div class="page" id="pageGallery">
<div class="header"><h1>🖼️ معرض الصور</h1><p>صور الفعاليات والمناسبات</p></div>
<div id="galleryContent">
<div class="gallery-grid" id="galleryGrid"></div>
</div>
<div id="galleryAlbumView" style="display:none;">
<button class="btn btn-gray" onclick="closeAlbumView()" style="margin-bottom:15px;">→ العودة للألبومات</button>
<h3 id="albumViewTitle" style="margin-bottom:15px;"></h3>
<div class="gallery-photos" id="albumPhotos"></div>
</div>
</div>

<!-- صفحة إدارة معرض الصور -->
<div class="page" id="pageManageGallery">
<div class="header"><h1>🖼️ إدارة معرض الصور</h1></div>
<div class="card">
<div class="card-title">إضافة ألبوم جديد</div>
<div class="form-group"><label class="form-label">اسم الألبوم</label><input class="form-input" id="albumTitle" placeholder="مثلاً: فعالية يوم الأرض 2026"></div>
<div class="form-group"><label class="form-label">الوصف</label><input class="form-input" id="albumDesc" placeholder="وصف قصير"></div>
<div class="form-group"><label class="form-label">الصور</label>
<div class="gallery-upload-area" id="albumUploadArea">📷 اضغط أو اسحب الصور هنا</div>
<input type="file" id="albumFiles" accept="image/*" multiple style="display:none">
<div class="gallery-thumbs" id="albumThumbs"></div>
</div>
<button class="btn btn-green" onclick="saveAlbum()">💾 حفظ الألبوم</button>
</div>
<div class="card"><div class="card-title">📋 الألبومات</div><div id="adminAlbumList"></div></div>
</div>

<!-- صفحة سياسة الخصوصية -->
<div class="page" id="pagePrivacy">
<div class="header"><h1>🔒 سياسة الخصوصية</h1><p>Personvernerklæring</p></div>
<div class="privacy-page">
<div class="privacy-tabs">
<button class="privacy-tab active" onclick="switchPrivacyLang('ar')">🇵🇸 العربية</button>
<button class="privacy-tab" onclick="switchPrivacyLang('no')">🇳🇴 Norsk</button>
</div>

<!-- العربية -->
<div class="privacy-lang active" id="privacyAr">
<div class="privacy-card">
<h2>🏛️ من نحن</h2>
<p>الجالية الفلسطينية في روغالاند هي منظمة تطوعية مسجلة في النرويج. نحن نلتزم بحماية خصوصية أعضائنا وزوار موقعنا وفقاً لقانون حماية البيانات الشخصية النرويجي (Personopplysningsloven) واللائحة العامة لحماية البيانات (GDPR).</p>
</div>

<div class="privacy-card">
<h2>📋 البيانات التي نجمعها</h2>
<h3>بيانات الأعضاء</h3>
<p>عند التسجيل كعضو، نجمع المعلومات التالية:</p>
<ul>
<li>الاسم الكامل</li>
<li>رقم الهاتف</li>
<li>عنوان السكن (المدينة)</li>
<li>معلومات العائلة (عدد أفراد الأسرة)</li>
</ul>
<h3>بيانات الزوار</h3>
<p>عند استخدام نموذج "تواصل معنا"، قد نجمع الاسم ورقم الهاتف والبريد الإلكتروني (اختياري).</p>
<h3>بيانات تقنية</h3>
<p>نستخدم التخزين المحلي (localStorage) في متصفحك لحفظ تفضيلاتك مثل اللغة والمظهر. لا نستخدم ملفات تعريف الارتباط (cookies) لتتبع الزوار.</p>
</div>

<div class="privacy-card">
<h2>🎯 لماذا نجمع هذه البيانات</h2>
<ul>
<li><strong>إدارة العضوية:</strong> تسجيل الأعضاء والتواصل معهم بشأن الفعاليات والأنشطة</li>
<li><strong>التواصل:</strong> الرد على استفساراتكم ورسائلكم</li>
<li><strong>التصويت:</strong> إدارة عمليات التصويت الداخلية</li>
<li><strong>الإحصائيات:</strong> فهم حجم الجالية وتحسين خدماتنا</li>
</ul>
<p>الأساس القانوني لمعالجة البيانات هو <strong>الموافقة</strong> (المادة 6(1)(أ) من GDPR) التي تقدمها عند التسجيل.</p>
</div>

<div class="privacy-card">
<h2>🔐 كيف نحمي بياناتكم</h2>
<ul>
<li>البيانات محفوظة بشكل مشفّر ومحمي</li>
<li>الوصول للبيانات مقتصر على المسؤولين المعتمدين فقط</li>
<li>لا نشارك بياناتكم مع أي طرف ثالث بدون إذنكم</li>
<li>لا نبيع أو نتاجر بالبيانات الشخصية أبداً</li>
</ul>
</div>

<div class="privacy-card">
<h2>⚖️ حقوقكم</h2>
<p>بموجب قانون GDPR، لديكم الحقوق التالية:</p>
<ul>
<li><strong>حق الوصول:</strong> طلب نسخة من بياناتكم الشخصية</li>
<li><strong>حق التصحيح:</strong> تعديل أي بيانات غير صحيحة</li>
<li><strong>حق الحذف:</strong> طلب حذف بياناتكم بالكامل</li>
<li><strong>حق سحب الموافقة:</strong> سحب موافقتكم على معالجة البيانات في أي وقت</li>
<li><strong>حق تقديم شكوى:</strong> تقديم شكوى لهيئة حماية البيانات النرويجية (Datatilsynet)</li>
</ul>
</div>

<div class="privacy-card">
<h2>📞 تواصل معنا</h2>
<p>لأي استفسار يتعلق بخصوصية بياناتكم أو لممارسة حقوقكم، يرجى التواصل معنا عبر صفحة "تواصل معنا" في الموقع.</p>
<p style="color:var(--muted);margin-top:15px;font-size:0.85rem;">آخر تحديث: فبراير 2026</p>
</div>
</div>

<!-- النرويجية -->
<div class="privacy-lang" id="privacyNo">
<div class="privacy-card">
<h2>🏛️ Hvem er vi</h2>
<p>Det palestinske samfunn i Rogaland er en frivillig organisasjon registrert i Norge. Vi forplikter oss til å beskytte personvernet til våre medlemmer og besøkende på vår nettside i samsvar med den norske personopplysningsloven og EUs personvernforordning (GDPR).</p>
</div>

<div class="privacy-card">
<h2>📋 Hvilke opplysninger samler vi inn</h2>
<h3>Medlemsdata</h3>
<p>Ved registrering som medlem samler vi inn følgende opplysninger:</p>
<ul>
<li>Fullt navn</li>
<li>Telefonnummer</li>
<li>Bostedsadresse (by)</li>
<li>Familieinformasjon (antall familiemedlemmer)</li>
</ul>
<h3>Besøksdata</h3>
<p>Ved bruk av «Kontakt oss»-skjemaet kan vi samle inn navn, telefonnummer og e-postadresse (valgfritt).</p>
<h3>Tekniske data</h3>
<p>Vi bruker lokal lagring (localStorage) i nettleseren din for å lagre dine preferanser som språk og tema. Vi bruker ikke informasjonskapsler (cookies) for å spore besøkende.</p>
</div>

<div class="privacy-card">
<h2>🎯 Hvorfor samler vi inn disse dataene</h2>
<ul>
<li><strong>Medlemsadministrasjon:</strong> Registrering av medlemmer og kommunikasjon om arrangementer og aktiviteter</li>
<li><strong>Kommunikasjon:</strong> Besvare henvendelser og meldinger</li>
<li><strong>Avstemning:</strong> Administrasjon av interne avstemninger</li>
<li><strong>Statistikk:</strong> Forstå størrelsen på samfunnet og forbedre våre tjenester</li>
</ul>
<p>Det rettslige grunnlaget for behandling av personopplysninger er <strong>samtykke</strong> (artikkel 6(1)(a) i GDPR) som du gir ved registrering.</p>
</div>

<div class="privacy-card">
<h2>🔐 Hvordan beskytter vi dine data</h2>
<ul>
<li>Data lagres kryptert og beskyttet</li>
<li>Tilgang til data er begrenset til autoriserte administratorer</li>
<li>Vi deler ikke dine data med tredjeparter uten ditt samtykke</li>
<li>Vi selger eller handler aldri med personopplysninger</li>
</ul>
</div>

<div class="privacy-card">
<h2>⚖️ Dine rettigheter</h2>
<p>I henhold til GDPR har du følgende rettigheter:</p>
<ul>
<li><strong>Rett til innsyn:</strong> Be om en kopi av dine personopplysninger</li>
<li><strong>Rett til retting:</strong> Korrigere eventuelle feilaktige opplysninger</li>
<li><strong>Rett til sletting:</strong> Be om fullstendig sletting av dine data</li>
<li><strong>Rett til å trekke samtykke:</strong> Trekke tilbake ditt samtykke til databehandling når som helst</li>
<li><strong>Rett til å klage:</strong> Sende klage til Datatilsynet</li>
</ul>
</div>

<div class="privacy-card">
<h2>📞 Kontakt oss</h2>
<p>For spørsmål om personvern eller for å utøve dine rettigheter, ta kontakt via «Kontakt oss»-siden på nettsiden vår.</p>
<p style="color:var(--muted);margin-top:15px;font-size:0.85rem;">Sist oppdatert: februar 2026</p>
</div>
</div>

</div>
</div>

</main>

<!-- Cookie Consent Banner -->
<div class="cookie-banner" id="cookieBanner" style="display:none;">
<div class="cookie-banner-text">
🔒 نستخدم التخزين المحلي لتحسين تجربتك. باستخدامك للموقع فإنك توافق على <a onclick="goTo('privacy')">سياسة الخصوصية</a>.
<br><small>Vi bruker lokal lagring for å forbedre opplevelsen din. Ved å bruke nettstedet godtar du vår <a onclick="goTo('privacy')">personvernerklæring</a>.</small>
</div>
<div class="cookie-banner-btns">
<button class="cookie-btn-accept" onclick="acceptCookies()">✅ موافق | Godta</button>
</div>
</div>
<button class="mobile-btn" id="mobileBtn">☰</button>
<button class="theme-toggle" id="themeToggle" title="تبديل الوضع">🌙</button>
<div class="modal-bg" id="loginModal"><div class="modal"><div class="modal-head"><h3>🔐 الدخول</h3><button class="modal-close" id="closeLogin">×</button></div><div class="modal-body"><div class="form-group"><label class="form-label">اسم المستخدم</label><input type="text" class="form-input" id="usernameInput" placeholder="admin"></div><div class="form-group"><label class="form-label">كلمة المرور</label><input type="password" class="form-input" id="passInput"></div></div><div class="modal-foot"><button class="btn btn-gray" id="cancelLogin">إلغاء</button><button class="btn btn-green" id="confirmLogin">دخول</button></div></div></div>
<div class="modal-bg" id="passModal"><div class="modal"><div class="modal-head"><h3>🔑 تغيير كلمة المرور</h3><button class="modal-close" id="closePass">×</button></div><div class="modal-body"><div class="form-group"><label class="form-label">الحالية</label><input type="password" class="form-input" id="oldPass"></div><div class="form-group"><label class="form-label">الجديدة</label><input type="password" class="form-input" id="newPass"></div><div class="form-group"><label class="form-label">تأكيد</label><input type="password" class="form-input" id="confirmPass"></div></div><div class="modal-foot"><button class="btn btn-gray" id="cancelPass">إلغاء</button><button class="btn btn-green" id="confirmPassBtn">حفظ</button></div></div></div>
<div class="modal-bg" id="memberModal"><div class="modal"><div class="modal-head"><h3 id="memberModalTitle">➕ إضافة عضو</h3><button class="modal-close" id="closeMember">×</button></div><div class="modal-body">
<input type="hidden" id="memberId">
<div class="form-group"><label class="form-label">الاسم *</label><input class="form-input" id="memberName"></div>
<div class="form-group"><label class="form-label">صورة العضو</label><div class="upload-box" id="memberImgUpload">📷 اختر صورة</div><input type="file" id="memberImgFile" accept="image/*" style="display:none"><img id="memberImgPreview" class="img-preview"></div>
<div class="form-group"><label class="form-label">الهاتف</label><input class="form-input" id="memberPhone"></div>
<div class="form-group"><label class="form-label">البريد</label><input class="form-input" id="memberEmail"></div>
<div class="form-group"><label class="form-label">ملاحظات</label><textarea class="form-textarea" id="memberNotes"></textarea></div>
<div class="form-group"><label class="form-label">📍 تحديد الموقع بالعنوان</label><div class="address-search"><input class="form-input" id="memberAddressSearch" placeholder="اكتب العنوان"><button class="btn btn-gold btn-sm" id="btnSearchAddress">🔍</button></div><div class="location-result" id="locationResult"><div id="locationText"></div></div></div>
<div class="form-group"><label class="form-label">أو الإحداثيات</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"><input class="form-input" id="memberLat" placeholder="Lat" type="number" step="any"><input class="form-input" id="memberLng" placeholder="Lng" type="number" step="any"></div><button class="btn btn-gray btn-sm" id="btnGetLoc" style="margin-top:8px;">📍 موقعي</button></div>
<div style="margin-top:15px;font-weight:600;">🔒 الخصوصية</div>
<div class="checkbox-row"><input type="checkbox" id="memberShowMap" checked><label>إظهار على الخريطة</label></div>
<div class="checkbox-row"><input type="checkbox" id="memberShowPhone"><label>إظهار الهاتف</label></div>
<div class="checkbox-row"><input type="checkbox" id="memberShowEmail"><label>إظهار البريد</label></div>
</div><div class="modal-foot"><button class="btn btn-gray" id="cancelMember">إلغاء</button><button class="btn btn-green" id="saveMember">💾 حفظ</button></div></div></div>
<div class="modal-bg" id="deleteModal"><div class="modal" style="max-width:350px;"><div class="modal-head"><h3>⚠️ تأكيد الحذف</h3><button class="modal-close" id="closeDelete">×</button></div><div class="modal-body"><p id="deleteMsg">هل تريد حذف؟</p></div><div class="modal-foot"><button class="btn btn-gray" id="cancelDelete">إلغاء</button><button class="btn btn-red" id="confirmDelete">🗑️ حذف</button></div></div></div>
<div class="modal-bg" id="editTxModal"><div class="modal"><div class="modal-head"><h3>✏️ تعديل المعاملة</h3><button class="modal-close" id="closeEditTx">×</button></div><div class="modal-body"><input type="hidden" id="editTxId"><div class="form-group"><label class="form-label">النوع</label><select class="form-select" id="editTxType"><option value="income">إيراد</option><option value="expense">مصروف</option></select></div><div class="form-group"><label class="form-label">الوصف</label><input class="form-input" id="editTxDesc"></div><div class="form-group"><label class="form-label">المبلغ</label><input type="number" class="form-input" id="editTxAmount"></div><div class="form-group"><label class="form-label">التاريخ</label><input type="date" class="form-input" id="editTxDate"></div><div class="form-group"><label class="form-label">فواتير</label><div class="upload-box" id="editTxReceiptsUpload">📷 إضافة</div><input type="file" id="editTxReceiptsFile" accept="image/*" multiple style="display:none"><div class="receipts-preview" id="editTxReceiptsPreview"></div></div></div><div class="modal-foot"><button class="btn btn-gray" id="cancelEditTx">إلغاء</button><button class="btn btn-green" id="saveEditTx">💾 حفظ</button></div></div></div>
<div class="modal-bg" id="editNewsModal"><div class="modal"><div class="modal-head"><h3>✏️ تعديل الخبر</h3><button class="modal-close" id="closeEditNews">×</button></div><div class="modal-body"><input type="hidden" id="editNewsId"><div class="form-group"><label class="form-label">العنوان</label><input class="form-input" id="editNewsTitle"></div><div class="form-group"><label class="form-label">المحتوى</label><textarea class="form-textarea" id="editNewsContent"></textarea></div><div class="form-group"><label class="form-label">صور</label><div class="upload-box" id="editNewsImgsUpload">📷 إضافة</div><input type="file" id="editNewsImgsFile" accept="image/*" multiple style="display:none"><div class="imgs-preview" id="editNewsImgsPreview"></div></div></div><div class="modal-foot"><button class="btn btn-gray" id="cancelEditNews">إلغاء</button><button class="btn btn-green" id="saveEditNews">💾 حفظ</button></div></div></div>
<div class="modal-bg" id="pendingModal"><div class="modal"><div class="modal-head"><span>📋 تفاصيل الطلب</span><button class="modal-close" id="closePending">×</button></div><div class="modal-body" id="pendingDetails"></div><div class="modal-foot"><button class="btn btn-gray" id="rejectPending">❌ رفض</button><button class="btn btn-green" id="approvePending">✅ قبول</button></div></div></div>
<div class="modal-bg" id="editFamilyModal"><div class="modal" style="max-width:500px;"><div class="modal-head"><span>✏️ تعديل بيانات العائلة</span><button class="modal-close" onclick="document.getElementById('editFamilyModal').classList.remove('show')">×</button></div><div class="modal-body">
<input type="hidden" id="editFamilyId">
<div class="form-group"><label class="form-label">الاسم</label><input class="form-input" id="editFamilyName"></div>
<div class="form-group"><label class="form-label">📱 الهاتف</label><input class="form-input" id="editFamilyPhone" type="tel"></div>
<div class="form-group"><label class="form-label">📧 البريد الإلكتروني</label><input class="form-input" id="editFamilyEmail" type="email"></div>
<div class="form-group"><label class="form-label">📍 المدينة</label><input class="form-input" id="editFamilyCity"></div>
<div class="form-group"><label class="form-label">🏠 العنوان التفصيلي</label><input class="form-input" id="editFamilyAddress"></div>
<div class="form-group"><label class="form-label">🇵🇸 البلد الأصلي</label><input class="form-input" id="editFamilyOrigin"></div>
<div class="form-group"><label class="form-label">📍 تحديد الموقع على الخارطة</label>
<div style="display:flex;gap:10px;margin-bottom:10px;">
<input class="form-input" id="editFamilyLat" placeholder="خط العرض" style="flex:1;">
<input class="form-input" id="editFamilyLng" placeholder="خط الطول" style="flex:1;">
</div>
<button class="btn btn-gray btn-sm" type="button" onclick="getCurrentLocationForEdit()">📍 تحديد موقعي الحالي</button>
</div>
<div class="form-group"><label class="form-label">🔒 إعدادات الخصوصية</label>
<div class="checkbox-group" style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
<label class="checkbox-label"><input type="checkbox" id="editFamilyShowMap"> الظهور على الخارطة</label>
<label class="checkbox-label"><input type="checkbox" id="editFamilyShowPhone"> إظهار رقم الهاتف للأعضاء</label>
<label class="checkbox-label"><input type="checkbox" id="editFamilyShowEmail"> إظهار البريد للأعضاء</label>
</div>
</div>
<div class="form-group"><label class="form-label">📝 ملاحظات</label><textarea class="form-textarea" id="editFamilyNotes" rows="2"></textarea></div>
</div><div class="modal-foot"><button class="btn btn-gray" onclick="document.getElementById('editFamilyModal').classList.remove('show')">إلغاء</button><button class="btn btn-green" onclick="saveFamilyEdit()">💾 حفظ التعديلات</button></div></div></div>

<!-- Modal محرر استمارة الطباعة -->
<div class="modal-bg" id="printFormModal">
<div class="modal" style="max-width:900px;max-height:90vh;overflow:hidden;">
<div class="modal-head">
<h3>📄 محرر استمارة الطباعة</h3>
<button class="modal-close" onclick="closePrintFormEditor()">×</button>
</div>
<div class="modal-body" style="padding:0;overflow:auto;max-height:calc(90vh - 140px);">
<div style="padding:15px;background:var(--dark);border-bottom:1px solid var(--border);">
<p style="color:var(--gold);margin-bottom:10px;">✏️ اضغط على أي نص لتعديله مباشرة</p>
<div style="display:flex;gap:10px;flex-wrap:wrap;">
<div class="form-group" style="margin:0;flex:1;min-width:150px;">
<label class="form-label" style="font-size:0.75rem;">عدد الصفوف</label>
<input type="number" class="form-input" id="printFormRows" value="20" min="5" max="50" style="padding:8px;" onchange="updatePrintFormPreview()">
</div>
<div class="form-group" style="margin:0;flex:1;min-width:150px;">
<label class="form-label" style="font-size:0.75rem;">السنة</label>
<input type="text" class="form-input" id="printFormYear" value="2025" style="padding:8px;" onchange="updatePrintFormPreview()">
</div>
</div>
</div>
<div id="printFormPreview" style="padding:20px;background:white;min-height:500px;"></div>
</div>
<div class="modal-foot">
<button class="btn btn-gray" onclick="closePrintFormEditor()">إغلاق</button>
<button class="btn btn-green" onclick="printEditableForm()">🖨️ طباعة</button>
<button class="btn btn-red" onclick="downloadEditableFormPDF()">📄 تحميل PDF</button>
</div>
</div>
</div>

<div class="lightbox" id="lightbox"><button class="lightbox-close" id="closeLightbox">×</button><img id="lightboxImg"></div>
<div class="toast" id="toast"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="api.js"></script>
<script>
(function(){
// ====== إعدادات الـ Backend API ======
var API_URL = 'http://localhost:5000/api';
var USE_BACKEND = true; // تفعيل الـ Backend

// ====== إعدادات قاعدة البيانات السحابية (احتياطي) ======
// ⚠️ أدخل مفاتيحك هنا بعد النشر - لا تشارك هذا الملف مع أحد
var JSONBIN_API_KEY = '';
var JSONBIN_BIN_ID = '';
var USE_CLOUD = false; // فعّل هذا وأدخل المفاتيح أعلاه للمزامنة السحابية

var isAdmin=false,adminPass="1234",myMap=null,markers=[],centerMarker=null,deleteId=null,deleteType=null,memberImg="",newsImgs=[],editNewsImgs=[],txReceipts=[],editTxReceipts=[],currentPendingId=null,currentUser=null;

// ====== دالة تحميل البيانات من الـ Backend ======
async function loadDataFromBackend(){
if(!USE_BACKEND || !window.API) return;

try{
// تحميل الأعضاء
var membersRes = await window.API.Members.getAll();
if(membersRes.success && membersRes.members){
appData.members = membersRes.members.map(function(m){
return {
id: m._id,
name: m.name,
phone: m.phone,
email: m.email,
city: m.city,
address: m.address,
originCity: m.originCity,
lat: m.lat,
lng: m.lng,
img: m.img,
notes: m.notes,
voteCode: m.voteCode,
familyMembers: m.familyMembers || [],
familySize: m.familySize || 1,
showMap: m.showMap,
showPhone: m.showPhone,
showEmail: m.showEmail
};
});
}

// تحميل الأخبار
var newsRes = await window.API.News.getAll();
if(newsRes.success && newsRes.news){
appData.news = newsRes.news.map(function(n){
return {
id: n._id,
title: n.title,
content: n.content,
imgs: n.images || [],
date: n.publishDate || n.createdAt
};
});
}

// تحميل المعاملات المالية
var txRes = await window.API.Transactions.getAll();
if(txRes.success && txRes.transactions){
appData.tx = txRes.transactions.map(function(t){
return {
id: t._id,
type: t.type,
desc: t.description,
amount: t.amount,
receipts: t.receipts || [],
date: t.date || t.createdAt
};
});
}

// تحميل التصويتات
var votesRes = await window.API.Votes.getAll();
if(votesRes.success && votesRes.votes){
appData.votes = votesRes.votes.map(function(v){
return {
id: v._id,
title: v.title,
question: v.question,
type: v.type,
options: v.options || [],
maxSelections: v.maxSelections || 1,
votes: v.votes || {yes:0,no:0},
voters: v.voters || [],
status: v.status
};
});
}

// تحميل الرسائل
if(isAdmin){
var msgsRes = await window.API.Messages.getAll();
if(msgsRes.success && msgsRes.messages){
// Get local deletions and read status
var deletedMsgs = JSON.parse(localStorage.getItem('deletedMessages') || '[]');
var readMsgs = JSON.parse(localStorage.getItem('readMessages') || '[]');

appData.messages = msgsRes.messages
.filter(function(m){ return deletedMsgs.indexOf(m._id) === -1; }) // Filter deleted
.map(function(m){
return {
id: m._id,
_id: m._id,
name: m.name,
phone: m.phone,
email: m.email,
subject: m.subject,
message: m.message,
read: m.read || readMsgs.indexOf(m._id) > -1, // Check local read status
date: m.createdAt
};
});
}

// تحميل طلبات الانتساب
var pendingRes = await window.API.Pending.getAll('pending');
if(pendingRes.success && pendingRes.requests){
appData.pending = pendingRes.requests.map(function(p){
return {
_id: p._id,
id: p._id,
name: p.name,
phone: p.phone,
email: p.email,
city: p.city,
address: p.address,
originCity: p.originCity,
lat: p.lat,
lng: p.lng,
familySize: p.familySize,
familyMembers: p.familyMembers || [],
notes: p.notes,
showMap: p.showMap,
showPhone: p.showPhone,
showEmail: p.showEmail,
date: p.createdAt
};
});
}
}

// تحديث العرض
loadNews();
loadFinance();
loadMembers();
loadMarkers();
loadCount();
loadVoting();
updateInboxBadge();
if(isAdmin){
loadAdminNews();
loadAdminTx();
loadPending();
}

console.log('✅ Data loaded from Backend');
}catch(e){
console.error('Error loading from backend:',e);
}
}

// ====== نظام تعدد اللغات ======
var currentLang = localStorage.getItem('appLang') || 'ar';
var translations = {
ar: {
// القائمة الرئيسية
publicPages: 'الصفحات العامة',
home: 'الرئيسية',
bylaws: 'النظام الداخلي',
voting: 'التصويت',
news: 'الأخبار',
finance: 'المحاسبة',
map: 'خارطة المنتسبين',
register: 'استمارة الانتساب',
invitations: 'محرر الدعوات',
adminPanel: 'لوحة الإدارة',
settings: 'الإعدادات',
manageMembers: 'إدارة الأعضاء',
pendingRequests: 'طلبات الانتساب',
registrationSheet: 'استمارة التسجيل',
manageTransactions: 'إدارة المعاملات',
manageNews: 'إدارة الأخبار',
manageVoting: 'إدارة التصويت',
adminLogin: 'دخول المسؤول',
logout: 'خروج',
visitors: 'الزوار',
// الصفحة الرئيسية
welcome: 'مرحباً بكم',
latestNews: 'آخر الأخبار',
budget: 'الميزانية',
members: 'الأعضاء',
noNews: 'لا توجد أخبار',
// المحاسبة
financialAccounting: 'المحاسبة المالية',
balance: 'الرصيد',
income: 'الإيرادات',
expenses: 'المصروفات',
transactions: 'المعاملات',
// التصويت
voteTitle: 'التصويت',
voteDescription: 'شارك برأيك في قرارات الجالية',
enterVoteCode: 'أدخل رمز التصويت',
confirmVote: 'تأكيد التصويت',
agree: 'موافق',
disagree: 'غير موافق',
totalVotes: 'إجمالي الأصوات',
membersCount: 'عدد الأعضاء',
noActiveVotes: 'لا توجد تصويتات نشطة حالياً',
open: 'مفتوح',
closed: 'مغلق',
// إدارة التصويت
createNewVote: 'إنشاء تصويت جديد',
voteType: 'نوع التصويت',
yesNo: 'موافق / غير موافق',
multipleChoice: 'خيارات متعددة (مرشحين / اختيارات)',
optionsCandidates: 'الخيارات / المرشحين (كل سطر خيار)',
maxSelectionsAllowed: 'عدد الأصوات المسموح لكل عضو',
createVote: 'إنشاء التصويت',
currentVotes: 'التصويتات الحالية',
closeVote: 'إغلاق التصويت',
reopenVote: 'إعادة فتح',
showCodes: 'عرض الرموز',
whoVoted: 'من صوّت',
delete: 'حذف',
// الخريطة
membersMap: 'خارطة المنتسبين',
all: 'الكل',
myLocation: 'موقعي',
bestMeetingLocation: 'أفضل موقع للاجتماع',
onMap: 'على الخريطة',
hidden: 'مخفي',
cities: 'مدينة',
statistics: 'إحصائيات',
// استمارة الانتساب
registrationForm: 'استمارة الانتساب',
joinUs: 'انضم إلى الجالية الفلسطينية في روغالاند',
personalInfo: 'المعلومات الشخصية',
fullName: 'الاسم الكامل',
phone: 'رقم الهاتف',
email: 'البريد الإلكتروني',
residenceInfo: 'معلومات السكن',
city: 'المدينة / المنطقة',
fullAddress: 'العنوان الكامل (اختياري)',
search: 'بحث',
currentLocation: 'موقعي الحالي',
palestinianOrigin: 'الأصل الفلسطيني',
originCity: 'البلد الأصلي في فلسطين',
familyMembers: 'أفراد العائلة',
familySize: 'عدد أفراد الأسرة (بما فيهم أنت)',
addFamilyMember: 'إضافة فرد من العائلة',
additionalNotes: 'ملاحظات إضافية',
anyNotes: 'هل لديك أي ملاحظات أو اقتراحات؟',
privacySettings: 'إعدادات الخصوصية',
showOnMap: 'إظهار موقعي على الخريطة',
showPhoneToMembers: 'إظهار رقم هاتفي للأعضاء',
showEmailToMembers: 'إظهار بريدي الإلكتروني للأعضاء',
agreeToJoin: 'أوافق على الانضمام للملتقى الفلسطيني والالتزام بأهدافه',
submitRequest: 'إرسال طلب الانتساب',
requestSent: 'تم إرسال طلبك بنجاح!',
thankYou: 'شكراً لانضمامك للملتقى الفلسطيني في روغالاند',
willContact: 'سيتم مراجعة طلبك والتواصل معك قريباً',
submitAnother: 'تقديم طلب آخر',
backToHome: 'العودة للرئيسية',
// النظام الداخلي
internalBylaws: 'النظام الداخلي للجالية الفلسطينية',
editBylaws: 'تعديل النظام',
goals: 'الأهداف',
membership: 'العضوية',
adminBoard: 'الهيئة الإدارية',
elections: 'الانتخابات',
conferences: 'المؤتمرات',
financeBylaws: 'المالية',
school: 'المدرسة',
penalties: 'العقوبات',
// عام
save: 'حفظ',
cancel: 'إلغاء',
edit: 'تعديل',
add: 'إضافة',
confirm: 'تأكيد',
yes: 'نعم',
no: 'لا',
pending: 'معلق',
approved: 'مقبول',
rejected: 'مرفوض',
accept: 'قبول',
reject: 'رفض',
required: 'مطلوب',
optional: 'اختياري',
// الرسائل
contactUs: 'تواصل معنا',
contactDescription: 'أرسل لنا رسالتك أو اقتراحك',
yourName: 'اسمك',
subject: 'الموضوع',
message: 'الرسالة',
sendMessage: 'إرسال الرسالة',
messageSent: 'تم إرسال رسالتك بنجاح!',
messageThankYou: 'شكراً لتواصلك معنا. سنرد عليك في أقرب وقت.',
sendAnother: 'إرسال رسالة أخرى',
inbox: 'صندوق الرسائل',
inboxDescription: 'إدارة رسائل الزوار والأعضاء',
totalMessages: 'إجمالي الرسائل',
unreadMessages: 'غير مقروءة',
readMessages: 'مقروءة',
messageDetails: 'تفاصيل الرسالة',
noMessages: 'لا توجد رسائل',
markAsRead: 'تحديد كمقروء',
suggestion: 'اقتراح',
inquiry: 'استفسار',
complaint: 'شكوى',
helpRequest: 'طلب مساعدة',
volunteer: 'تطوع',
other: 'أخرى',
// إضافات جديدة
createManageVotes: 'إنشاء وإدارة التصويتات',
questionDescription: 'السؤال / الوصف',
voteTitleLabel: 'عنوان التصويت',
maxSelectionsExample: 'مثال: 1 = صوت واحد فقط، 3 = يمكن اختيار 3 مرشحين',
enterFullName: 'أدخل اسمك الكامل',
forMapDisplay: 'للظهور على الخريطة',
originCityExample: 'مثال: غزة، نابلس، القدس',
writeHere: 'اكتب هنا...',
voteTitleExample: 'مثال: انتخاب أعضاء الهيئة الإدارية',
questionExample: 'مثال: اختر 3 مرشحين للهيئة الإدارية',
selections: 'اختيارات',
canSelect: 'يمكنك اختيار',
oneOption: 'خيار واحد',
twoOptions: 'خيارين',
options: 'خيارات',
currentResults: 'النتائج الحالية',
votersCount: 'عدد المصوتين',
voteCodes: 'رموز التصويت',
votersList: 'قائمة المصوتين',
voted: 'صوّت',
notVoted: 'لم يصوّت',
copyAllCodes: 'نسخ جميع الرموز',
noVotes: 'لا توجد تصويتات',
pendingRequest: 'طلب معلق',
approvedFamily: 'عائلة مقبولة',
pendingRequests: 'طلبات الانتساب',
reviewManageRequests: 'مراجعة وإدارة طلبات الانتساب',
incomingRequests: 'الطلبات المعلقة',
approvedFamilies: 'العائلات المقبولة',
noPendingRequests: 'لا توجد طلبات معلقة',
noApprovedFamilies: 'لا توجد عائلات مقبولة بعد',
date: 'التاريخ',
time: 'الوقت',
close: 'إغلاق',
atSameLocation: 'في نفس الموقع',
noData: 'لا توجد بيانات',
// أفراد العائلة
familyMember: 'فرد العائلة',
familyMemberName: 'اسم فرد العائلة',
relation: 'صلة القرابة',
choose: 'اختر',
spouse: 'زوج/زوجة',
son: 'ابن',
daughter: 'ابنة',
father: 'أب',
mother: 'أم',
brother: 'أخ',
sister: 'أخت',
fillRequiredFields: 'يرجى ملء الحقول المطلوبة',
requestSentSuccess: 'تم إرسال الطلب بنجاح!',
// البث المباشر
liveStream: 'البث المباشر',
manageLive: 'إدارة البث المباشر',
watchLiveEvents: 'شاهد الفعاليات مباشرة وشارك بالتصويت',
liveNow: 'مباشر الآن',
noLiveStream: 'لا يوجد بث مباشر حالياً',
checkBackLater: 'تابعنا للإعلان عن البث القادم',
voteNow: 'صوّت الآن',
voteWhileWatching: 'شارك بصوتك أثناء مشاهدة البث',
noActiveVotesNow: 'لا توجد تصويتات نشطة حالياً',
setupLiveStream: 'إعداد وتشغيل البث المباشر',
streamSettings: 'إعدادات البث',
streamTitle: 'عنوان البث',
linkedVote: 'ربط تصويت بالبث',
startStream: 'بدء البث',
stopStream: 'إيقاف البث',
streamStopped: 'البث متوقف',
streamActive: 'البث نشط',
streamGuide: 'دليل البث المباشر',
preview: 'معاينة',
chooseOption: 'اختر خياراً'
},
en: {
// Main menu
publicPages: 'Public Pages',
home: 'Home',
bylaws: 'Bylaws',
voting: 'Voting',
news: 'News',
finance: 'Finance',
map: 'Members Map',
register: 'Registration',
invitations: 'Invitations',
adminPanel: 'Admin Panel',
settings: 'Settings',
manageMembers: 'Manage Members',
pendingRequests: 'Pending Requests',
registrationSheet: 'Registration Sheet',
manageTransactions: 'Manage Transactions',
manageNews: 'Manage News',
manageVoting: 'Manage Voting',
adminLogin: 'Admin Login',
logout: 'Logout',
visitors: 'Visitors',
// Home page
welcome: 'Welcome',
latestNews: 'Latest News',
budget: 'Budget',
members: 'Members',
noNews: 'No news',
// Finance
financialAccounting: 'Financial Accounting',
balance: 'Balance',
income: 'Income',
expenses: 'Expenses',
transactions: 'Transactions',
// Voting
voteTitle: 'Voting',
voteDescription: 'Share your opinion on community decisions',
enterVoteCode: 'Enter vote code',
confirmVote: 'Confirm Vote',
agree: 'Agree',
disagree: 'Disagree',
totalVotes: 'Total Votes',
membersCount: 'Members Count',
noActiveVotes: 'No active votes currently',
open: 'Open',
closed: 'Closed',
// Voting management
createNewVote: 'Create New Vote',
voteType: 'Vote Type',
yesNo: 'Yes / No',
multipleChoice: 'Multiple Choice (candidates / options)',
optionsCandidates: 'Options / Candidates (one per line)',
maxSelectionsAllowed: 'Max selections allowed per member',
createVote: 'Create Vote',
currentVotes: 'Current Votes',
closeVote: 'Close Vote',
reopenVote: 'Reopen',
showCodes: 'Show Codes',
whoVoted: 'Who Voted',
delete: 'Delete',
// Map
membersMap: 'Members Map',
all: 'All',
myLocation: 'My Location',
bestMeetingLocation: 'Best Meeting Location',
onMap: 'On Map',
hidden: 'Hidden',
cities: 'Cities',
statistics: 'Statistics',
// Registration form
registrationForm: 'Registration Form',
joinUs: 'Join the Palestinian Community in Rogaland',
personalInfo: 'Personal Information',
fullName: 'Full Name',
phone: 'Phone Number',
email: 'Email',
residenceInfo: 'Residence Information',
city: 'City / Area',
fullAddress: 'Full Address (optional)',
search: 'Search',
currentLocation: 'Current Location',
palestinianOrigin: 'Palestinian Origin',
originCity: 'Original City in Palestine',
familyMembers: 'Family Members',
familySize: 'Number of family members (including you)',
addFamilyMember: 'Add Family Member',
additionalNotes: 'Additional Notes',
anyNotes: 'Do you have any notes or suggestions?',
privacySettings: 'Privacy Settings',
showOnMap: 'Show my location on the map',
showPhoneToMembers: 'Show my phone to members',
showEmailToMembers: 'Show my email to members',
agreeToJoin: 'I agree to join and commit to its goals',
submitRequest: 'Submit Registration',
requestSent: 'Your request has been sent!',
thankYou: 'Thank you for joining the Palestinian Community',
willContact: 'We will review your request and contact you soon',
submitAnother: 'Submit Another',
backToHome: 'Back to Home',
// Bylaws
internalBylaws: 'Internal Bylaws of the Palestinian Community',
editBylaws: 'Edit Bylaws',
goals: 'Goals',
membership: 'Membership',
adminBoard: 'Administrative Board',
elections: 'Elections',
conferences: 'Conferences',
financeBylaws: 'Finance',
school: 'School',
penalties: 'Penalties',
// General
save: 'Save',
cancel: 'Cancel',
edit: 'Edit',
add: 'Add',
confirm: 'Confirm',
yes: 'Yes',
no: 'No',
pending: 'Pending',
approved: 'Approved',
rejected: 'Rejected',
accept: 'Accept',
reject: 'Reject',
required: 'Required',
optional: 'Optional',
// Messages
contactUs: 'Contact Us',
contactDescription: 'Send us your message or suggestion',
yourName: 'Your Name',
subject: 'Subject',
message: 'Message',
sendMessage: 'Send Message',
messageSent: 'Your message has been sent!',
messageThankYou: 'Thank you for contacting us. We will reply soon.',
sendAnother: 'Send Another Message',
inbox: 'Inbox',
inboxDescription: 'Manage visitor and member messages',
totalMessages: 'Total Messages',
unreadMessages: 'Unread',
readMessages: 'Read',
messageDetails: 'Message Details',
noMessages: 'No messages',
markAsRead: 'Mark as Read',
suggestion: 'Suggestion',
inquiry: 'Inquiry',
complaint: 'Complaint',
helpRequest: 'Help Request',
volunteer: 'Volunteer',
other: 'Other',
// Additional
createManageVotes: 'Create and manage votes',
questionDescription: 'Question / Description',
voteTitleLabel: 'Vote Title',
maxSelectionsExample: 'Example: 1 = one vote only, 3 = can select 3 candidates',
enterFullName: 'Enter your full name',
forMapDisplay: 'To appear on the map',
originCityExample: 'Example: Gaza, Nablus, Jerusalem',
writeHere: 'Write here...',
voteTitleExample: 'Example: Election of board members',
questionExample: 'Example: Choose 3 candidates for the board',
selections: 'selections',
canSelect: 'You can select',
oneOption: 'one option',
twoOptions: 'two options',
options: 'options',
currentResults: 'Current Results',
votersCount: 'Voters Count',
voteCodes: 'Vote Codes',
votersList: 'Voters List',
voted: 'Voted',
notVoted: 'Not voted',
copyAllCodes: 'Copy all codes',
noVotes: 'No votes',
pendingRequest: 'Pending request',
approvedFamily: 'Approved family',
reviewManageRequests: 'Review and manage requests',
incomingRequests: 'Incoming Requests',
approvedFamilies: 'Approved Families',
noPendingRequests: 'No pending requests',
noApprovedFamilies: 'No approved families yet',
date: 'Date',
time: 'Time',
close: 'Close',
atSameLocation: 'at same location',
noData: 'No data',
// Family members
familyMember: 'Family Member',
familyMemberName: 'Family member name',
relation: 'Relationship',
choose: 'Choose',
spouse: 'Spouse',
son: 'Son',
daughter: 'Daughter',
father: 'Father',
mother: 'Mother',
brother: 'Brother',
sister: 'Sister',
fillRequiredFields: 'Please fill required fields',
requestSentSuccess: 'Request sent successfully!',
// Live Stream
liveStream: 'Live Stream',
manageLive: 'Manage Live Stream',
watchLiveEvents: 'Watch events live and participate in voting',
liveNow: 'Live Now',
noLiveStream: 'No live stream currently',
checkBackLater: 'Check back for upcoming broadcasts',
voteNow: 'Vote Now',
voteWhileWatching: 'Cast your vote while watching',
noActiveVotesNow: 'No active votes currently',
setupLiveStream: 'Setup and start live stream',
streamSettings: 'Stream Settings',
streamTitle: 'Stream Title',
linkedVote: 'Link vote to stream',
startStream: 'Start Stream',
stopStream: 'Stop Stream',
streamStopped: 'Stream stopped',
streamActive: 'Stream active',
streamGuide: 'Live Stream Guide',
preview: 'Preview',
chooseOption: 'Choose an option'
},
no: {
// Hovedmeny
publicPages: 'Offentlige Sider',
home: 'Hjem',
bylaws: 'Vedtekter',
voting: 'Avstemning',
news: 'Nyheter',
finance: 'Økonomi',
map: 'Medlemskart',
register: 'Registrering',
invitations: 'Invitasjoner',
adminPanel: 'Administrasjon',
settings: 'Innstillinger',
manageMembers: 'Administrer Medlemmer',
pendingRequests: 'Ventende Forespørsler',
registrationSheet: 'Registreringsskjema',
manageTransactions: 'Administrer Transaksjoner',
manageNews: 'Administrer Nyheter',
manageVoting: 'Administrer Avstemning',
adminLogin: 'Admin Logg Inn',
logout: 'Logg Ut',
visitors: 'Besøkende',
// Hjemmeside
welcome: 'Velkommen',
latestNews: 'Siste Nyheter',
budget: 'Budsjett',
members: 'Medlemmer',
noNews: 'Ingen nyheter',
// Økonomi
financialAccounting: 'Finansregnskap',
balance: 'Saldo',
income: 'Inntekter',
expenses: 'Utgifter',
transactions: 'Transaksjoner',
// Avstemning
voteTitle: 'Avstemning',
voteDescription: 'Del din mening om fellesskapsbeslutninger',
enterVoteCode: 'Skriv inn stemmekode',
confirmVote: 'Bekreft Stemme',
agree: 'Enig',
disagree: 'Uenig',
totalVotes: 'Totalt Stemmer',
membersCount: 'Antall Medlemmer',
noActiveVotes: 'Ingen aktive avstemninger for øyeblikket',
open: 'Åpen',
closed: 'Lukket',
// Avstemningsadministrasjon
createNewVote: 'Opprett Ny Avstemning',
voteType: 'Avstemningstype',
yesNo: 'Ja / Nei',
multipleChoice: 'Flervalg (kandidater / alternativer)',
optionsCandidates: 'Alternativer / Kandidater (én per linje)',
maxSelectionsAllowed: 'Maks valg tillatt per medlem',
createVote: 'Opprett Avstemning',
currentVotes: 'Gjeldende Avstemninger',
closeVote: 'Lukk Avstemning',
reopenVote: 'Gjenåpne',
showCodes: 'Vis Koder',
whoVoted: 'Hvem Stemte',
delete: 'Slett',
// Kart
membersMap: 'Medlemskart',
all: 'Alle',
myLocation: 'Min Posisjon',
bestMeetingLocation: 'Beste Møtested',
onMap: 'På Kartet',
hidden: 'Skjult',
cities: 'Byer',
statistics: 'Statistikk',
// Registreringsskjema
registrationForm: 'Registreringsskjema',
joinUs: 'Bli med i den Palestinske Forsamlingen i Rogaland',
personalInfo: 'Personlig Informasjon',
fullName: 'Fullt Navn',
phone: 'Telefonnummer',
email: 'E-post',
residenceInfo: 'Bostedinformasjon',
city: 'By / Område',
fullAddress: 'Full Adresse (valgfritt)',
search: 'Søk',
currentLocation: 'Nåværende Posisjon',
palestinianOrigin: 'Palestinsk Opprinnelse',
originCity: 'Opprinnelig By i Palestina',
familyMembers: 'Familiemedlemmer',
familySize: 'Antall familiemedlemmer (inkludert deg)',
addFamilyMember: 'Legg til Familiemedlem',
additionalNotes: 'Tilleggsinformasjon',
anyNotes: 'Har du noen notater eller forslag?',
privacySettings: 'Personverninnstillinger',
showOnMap: 'Vis min posisjon på kartet',
showPhoneToMembers: 'Vis mitt telefonnummer til medlemmer',
showEmailToMembers: 'Vis min e-post til medlemmer',
agreeToJoin: 'Jeg samtykker i å bli med og forplikte meg til målene',
submitRequest: 'Send Registrering',
requestSent: 'Din forespørsel er sendt!',
thankYou: 'Takk for at du ble med i den Palestinske Forsamlingen',
willContact: 'Vi vil gjennomgå forespørselen din og kontakte deg snart',
submitAnother: 'Send en Annen',
backToHome: 'Tilbake til Hjem',
// Vedtekter
internalBylaws: 'Interne Vedtekter for det Palestinske Samfunnet',
editBylaws: 'Rediger Vedtekter',
goals: 'Mål',
membership: 'Medlemskap',
adminBoard: 'Administrasjonsstyre',
elections: 'Valg',
conferences: 'Konferanser',
financeBylaws: 'Økonomi',
school: 'Skole',
penalties: 'Straffer',
// Generelt
save: 'Lagre',
cancel: 'Avbryt',
edit: 'Rediger',
add: 'Legg til',
confirm: 'Bekreft',
yes: 'Ja',
no: 'Nei',
pending: 'Venter',
approved: 'Godkjent',
rejected: 'Avvist',
accept: 'Godta',
reject: 'Avvis',
required: 'Påkrevd',
optional: 'Valgfritt',
// Meldinger
contactUs: 'Kontakt Oss',
contactDescription: 'Send oss din melding eller forslag',
yourName: 'Ditt Navn',
subject: 'Emne',
message: 'Melding',
sendMessage: 'Send Melding',
messageSent: 'Din melding er sendt!',
messageThankYou: 'Takk for at du kontaktet oss. Vi svarer snart.',
sendAnother: 'Send en Annen Melding',
inbox: 'Innboks',
inboxDescription: 'Administrer besøkende og medlemsmeldinger',
totalMessages: 'Totalt Meldinger',
unreadMessages: 'Uleste',
readMessages: 'Leste',
messageDetails: 'Meldingsdetaljer',
noMessages: 'Ingen meldinger',
markAsRead: 'Merk som Lest',
suggestion: 'Forslag',
inquiry: 'Forespørsel',
complaint: 'Klage',
helpRequest: 'Hjelpeforespørsel',
volunteer: 'Frivillig',
other: 'Annet',
// Tillegg
createManageVotes: 'Opprett og administrer avstemninger',
questionDescription: 'Spørsmål / Beskrivelse',
voteTitleLabel: 'Avstemningstitel',
maxSelectionsExample: 'Eksempel: 1 = én stemme, 3 = kan velge 3 kandidater',
enterFullName: 'Skriv inn ditt fulle navn',
forMapDisplay: 'For å vises på kartet',
originCityExample: 'Eksempel: Gaza, Nablus, Jerusalem',
writeHere: 'Skriv her...',
voteTitleExample: 'Eksempel: Valg av styremedlemmer',
questionExample: 'Eksempel: Velg 3 kandidater til styret',
selections: 'valg',
canSelect: 'Du kan velge',
oneOption: 'ett alternativ',
twoOptions: 'to alternativer',
options: 'alternativer',
currentResults: 'Nåværende Resultater',
votersCount: 'Antall Stemmere',
voteCodes: 'Stemmekoder',
votersList: 'Stemmeliste',
voted: 'Stemt',
notVoted: 'Ikke stemt',
copyAllCodes: 'Kopier alle koder',
noVotes: 'Ingen avstemninger',
pendingRequest: 'Ventende forespørsel',
approvedFamily: 'Godkjent familie',
reviewManageRequests: 'Gjennomgå og administrer forespørsler',
incomingRequests: 'Innkommende Forespørsler',
approvedFamilies: 'Godkjente Familier',
noPendingRequests: 'Ingen ventende forespørsler',
noApprovedFamilies: 'Ingen godkjente familier ennå',
date: 'Dato',
time: 'Tid',
close: 'Lukk',
atSameLocation: 'på samme sted',
noData: 'Ingen data',
// Familiemedlemmer
familyMember: 'Familiemedlem',
familyMemberName: 'Familiemedlemmets navn',
relation: 'Relasjon',
choose: 'Velg',
spouse: 'Ektefelle',
son: 'Sønn',
daughter: 'Datter',
father: 'Far',
mother: 'Mor',
brother: 'Bror',
sister: 'Søster',
fillRequiredFields: 'Vennligst fyll ut obligatoriske felt',
requestSentSuccess: 'Forespørsel sendt!',
// Direktesending
liveStream: 'Direktesending',
manageLive: 'Administrer Direktesending',
watchLiveEvents: 'Se arrangementer live og delta i avstemning',
liveNow: 'Direkte Nå',
noLiveStream: 'Ingen direktesending for øyeblikket',
checkBackLater: 'Kom tilbake for kommende sendinger',
voteNow: 'Stem Nå',
voteWhileWatching: 'Avgi din stemme mens du ser på',
noActiveVotesNow: 'Ingen aktive avstemninger for øyeblikket',
setupLiveStream: 'Sett opp og start direktesending',
streamSettings: 'Sendeinnstillinger',
streamTitle: 'Sendetittel',
linkedVote: 'Koble avstemning til sending',
startStream: 'Start Sending',
stopStream: 'Stopp Sending',
streamStopped: 'Sending stoppet',
streamActive: 'Sending aktiv',
streamGuide: 'Direktesendingsguide',
preview: 'Forhåndsvisning',
chooseOption: 'Velg et alternativ'
}
};

function t(key) {
return translations[currentLang][key] || translations['ar'][key] || key;
}

window.setLanguage = function(lang) {
currentLang = lang;
localStorage.setItem('appLang', lang);

// Update direction
var html = document.documentElement;
if(lang === 'ar') {
html.setAttribute('dir', 'rtl');
html.setAttribute('lang', 'ar');
} else {
html.setAttribute('dir', 'ltr');
html.setAttribute('lang', lang);
}

// Update language buttons
document.querySelectorAll('.lang-btn').forEach(function(btn) {
btn.classList.remove('active');
if(btn.getAttribute('data-lang') === lang) {
btn.classList.add('active');
}
});

// Translate all elements with data-i18n
document.querySelectorAll('[data-i18n]').forEach(function(el) {
var key = el.getAttribute('data-i18n');
if(translations[lang][key]) {
el.textContent = translations[lang][key];
}
});

// Translate placeholders
document.querySelectorAll('[data-placeholder]').forEach(function(el) {
var key = el.getAttribute('data-placeholder');
if(translations[lang][key]) {
el.placeholder = translations[lang][key];
}
});

// Translate select options
document.querySelectorAll('select option[data-i18n]').forEach(function(el) {
var key = el.getAttribute('data-i18n');
if(translations[lang][key]) {
el.textContent = translations[lang][key];
}
});

// Update page titles and headers
updatePageTitles();

// Refresh dynamic content
if(typeof loadVoting === 'function') loadVoting();
if(typeof loadAdminVoting === 'function') loadAdminVoting();
if(typeof loadMessages === 'function') loadMessages();
}

function updatePageTitles() {
// Update organization name in header
var orgName = appData.orgName ? appData.orgName.ar : 'الجالية الفلسطينية في روغالاند';
var orgNameEn = appData.orgName ? appData.orgName.en : 'Det palestinske samfunn i Rogaland';

if(currentLang === 'ar') {
document.querySelector('.org-name').textContent = orgName;
document.querySelector('.org-sub').textContent = orgNameEn;
} else if(currentLang === 'en') {
document.querySelector('.org-name').textContent = orgNameEn;
document.querySelector('.org-sub').textContent = orgName;
} else {
document.querySelector('.org-name').textContent = orgNameEn;
document.querySelector('.org-sub').textContent = orgName;
}

// Update page headers
var homeHeader = document.querySelector('#pageHome .header h1');
if(homeHeader) {
if(currentLang === 'ar') homeHeader.innerHTML = '🇵🇸 ' + orgName;
else homeHeader.innerHTML = '🇵🇸 ' + orgNameEn;
}

var homeP = document.querySelector('#pageHome .header p');
if(homeP) homeP.textContent = t('welcome');

// Finance page
var financeH1 = document.querySelector('#pageFinance .header h1');
if(financeH1) financeH1.textContent = '💰 ' + t('financialAccounting');

// Voting page
var votingH1 = document.querySelector('#pageVoting .header h1');
if(votingH1) votingH1.textContent = '🗳️ ' + t('voteTitle');
var votingP = document.querySelector('#pageVoting .header p');
if(votingP) votingP.textContent = t('voteDescription');

// Map page
var mapH1 = document.querySelector('#pageMap .header h1');
if(mapH1) mapH1.textContent = '🗺️ ' + t('membersMap');

// Bylaws page
var bylawsH1 = document.querySelector('#pageBylaws .header h1');
if(bylawsH1) bylawsH1.textContent = '📜 ' + t('bylaws');
var bylawsP = document.querySelector('#pageBylaws .header p');
if(bylawsP) bylawsP.textContent = t('internalBylaws');

// News page
var newsH1 = document.querySelector('#pageNews .header h1');
if(newsH1) newsH1.textContent = '📰 ' + t('news');

// Register page
var regH1 = document.querySelector('#pageRegister .header h1');
if(regH1) regH1.textContent = '📝 ' + t('registrationForm');
var regP = document.querySelector('#pageRegister .header p');
if(regP) regP.textContent = t('joinUs');

// Update login button
var loginBtn = document.getElementById('loginBtn');
if(loginBtn) {
var span = loginBtn.querySelector('span[data-i18n]');
if(span) span.textContent = isAdmin ? t('logout') : t('adminLogin');
}
}

function initLanguage() {
var savedLang = localStorage.getItem('appLang') || 'ar';
setLanguage(savedLang);
}

// ========== Home Page Functions - Early Definition ==========
window.toggleEditSection = function(id){
    var el = document.getElementById(id);
    if(el){
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
};

window.addEvent = function(){
    if(!appData.homeSettings) appData.homeSettings = {};
    if(!appData.homeSettings.events) appData.homeSettings.events = [];
    
    appData.homeSettings.events.push({
        date: new Date().toISOString().split('T')[0],
        title: 'فعالية جديدة',
        description: ''
    });
    
    localStorage.setItem('appData', JSON.stringify(appData));
    if(typeof renderEventsList === 'function') renderEventsList();
    if(typeof renderHomePage === 'function') renderHomePage();
};

window.updateEvent = function(index, field, value){
    if(appData.homeSettings && appData.homeSettings.events && appData.homeSettings.events[index]){
        appData.homeSettings.events[index][field] = value;
        localStorage.setItem('appData', JSON.stringify(appData));
        if(typeof renderHomePage === 'function') renderHomePage();
    }
};

window.removeEvent = function(index){
    if(appData.homeSettings && appData.homeSettings.events){
        appData.homeSettings.events.splice(index, 1);
        localStorage.setItem('appData', JSON.stringify(appData));
        if(typeof renderEventsList === 'function') renderEventsList();
        if(typeof renderHomePage === 'function') renderHomePage();
    }
};

var appData=JSON.parse(localStorage.getItem("appData"))||{news:[],tx:[],members:[],pending:[],approved:[],logo:null,visibility:{news:"all",finance:"all",map:"all",invitation:"all"},adminPass:"1234",votes:[],messages:[],homeSettings:{}};
if(!appData.visibility)appData.visibility={news:"all",finance:"all",map:"all",invitation:"all",bylaws:"all"};
if(!appData.pending)appData.pending=[];
if(!appData.approved)appData.approved=[];
if(!appData.sheet)appData.sheet=[];
if(!appData.orgName)appData.orgName={ar:"الجالية الفلسطينية في روغالاند",en:"Det palestinske samfunn i Rogaland"};
if(!appData.sheetArchive)appData.sheetArchive=[];
if(!appData.homeSettings){
  appData.homeSettings={
    showHero:true,
    showStats:true,
    showQuickActions:true,
    showActiveVote:true,
    showNews:true,
    showAbout:true,
    showEvents:false,
    showSocial:false,
    heroTitle:"مرحباً بكم في الجالية الفلسطينية",
    heroSubtitle:"نجمع شملنا في روغالاند - النرويج",
    heroBtn1:"📝 انضم إلينا",
    heroBtn2:"✉️ تواصل معنا",
    newsCount:3,
    aboutText:"نحن مجموعة من أبناء فلسطين في روغالاند - النرويج، نسعى للحفاظ على هويتنا وتراثنا الفلسطيني وتقوية الروابط بين أبناء الجالية.",
    vision:"جالية فلسطينية متماسكة ومؤثرة",
    mission:"خدمة أبناء الجالية والحفاظ على الهوية",
    events:[],
    socialFacebook:"",
    socialInstagram:"",
    socialWhatsapp:"",
    socialEmail:""
  };
}
if(!appData.bylaws)appData.bylaws={chapters:[
{id:1,title:"الأهداف",icon:"🎯",subtitle:"الباب الثاني - المادة 9",color:"#009639",sections:[
{title:"ترسيخ الهوية الوطنية",icon:"🏳️",items:["تعزيز القيم والمبادئ الوطنية الفلسطينية","الحفاظ على الهوية الفلسطينية في المهجر"]},
{title:"تعزيز الروابط الاجتماعية",icon:"🤝",items:["تقوية أواصر المحبة والأخوة والتضامن","تعزيز الشعور بالانتماء بين أعضاء الجالية"]},
{title:"دعم القضية الفلسطينية",icon:"🇵🇸",items:["تقديم الدعم الكامل لنضال الشعب الفلسطيني","بكافة أشكاله المشروعة وفق القوانين النرويجية"]},
{title:"التواصل مع المجتمع النرويجي",icon:"🌍",items:["بناء جسور الصداقة والتعاون","تعزيز التفاهم المتبادل مع المؤسسات النرويجية"]}
]},
{id:2,title:"العضوية",icon:"👥",subtitle:"الباب الثالث - المواد 10-16",color:"#CE1126",sections:[
{title:"فئات العضوية",icon:"📋",items:["العضو العامل: المسدد لاشتراكاته","العضو المراقب: غير المسدد أو من عمره 14-18","عضو الشرف: من قدم خدمات كبيرة للجالية"]},
{title:"حقوق الأعضاء",icon:"✅",items:["المشاركة في جميع الفعاليات والأنشطة","التعبير عن الرأي ديمقراطياً","حق التصويت والترشح (للعضو العامل)"]},
{title:"شروط العضوية",icon:"📝",items:["تعبئة نموذج طلب التسجيل","دفع رسوم التسجيل والاشتراك السنوي","إكمال 18 عاماً للترشح أو الانتخاب"]},
{title:"زوال العضوية",icon:"❌",items:["الإخلال بشروط العضوية","الانتقال خارج نطاق الجالية","تقديم طلب انسحاب","الوفاة"]}
]},
{id:3,title:"الهيئة الإدارية",icon:"⚙️",subtitle:"الباب السادس - المواد 36-47",color:"#F39C12",sections:[
{title:"تكوين الهيئة",icon:"👔",items:["1-50 عضو ← 5 أعضاء هيئة","51-150 عضو ← 7 أعضاء","151-250 عضو ← 9 أعضاء","أكثر من 250 ← 11 عضو"]},
{title:"المناصب",icon:"⭐",items:["الرئيس: يرأس الاجتماعات ويمثل الجالية","نائب الرئيس: ينوب عن الرئيس","أمين السر: المحاضر والوثائق","أمين الصندوق: الإشراف المالي","مسؤول العلاقات: التنسيق الرسمي","مسؤول الشؤون الاجتماعية","مسؤول الشؤون الثقافية"]},
{title:"سقوط العضوية",icon:"⚠️",items:["التغيب 3 اجتماعات بدون عذر","السفر أكثر من 3 أشهر","الإساءة لسمعة الجالية"]}
]},
{id:4,title:"الانتخابات",icon:"🗳️",subtitle:"الباب الرابع - المواد 17-20",color:"#3498DB",sections:[
{title:"إجراء الانتخابات",icon:"📊",items:["الاقتراع السري","فرز الأصوات علناً أمام الجميع","الفائزون بأعلى الأصوات"]},
{title:"شروط الترشح",icon:"📋",items:["مرور 6 شهور من تاريخ التسجيل","إتمام 18 عاماً يوم الانتخاب","تسديد الاشتراكات","إقامة قانونية للترشح"]}
]},
{id:5,title:"المؤتمرات",icon:"🏛️",subtitle:"الباب الخامس - المواد 21-35",color:"#9B59B6",sections:[
{title:"المؤتمر العام",icon:"🎤",items:["يعقد سنوياً بدعوة من الهيئة الإدارية","الإعلان قبل أسبوعين على الأقل","النصاب: ثلثي الأعضاء العاملين"]},
{title:"الجمعية العمومية",icon:"👥",items:["تنعقد مرة كل 6 شهور على الأقل","النصاب: النصف زائد واحد","الهيئة العليا للجالية عند انعقادها"]},
{title:"القرارات",icon:"✔️",items:["الأغلبية النسبية للتصويت العادي","ثلثي الأعضاء لتعديل النظام الداخلي"]}
]},
{id:6,title:"المالية",icon:"💰",subtitle:"الباب السابع",color:"#E74C3C",sections:[
{title:"الميزانية",icon:"💵",items:["رسوم الانتساب والاشتراك السنوي","المساعدات والتبرعات غير المشروطة","دخل النشاطات والفعاليات"]},
{title:"إدارة الأموال",icon:"🏦",items:["تودع في البنك باسم الجالية","الرئيس وأمين الصندوق مسؤولان","نظام محاسبي وفق القوانين النرويجية"]},
{title:"الرقابة",icon:"🔍",items:["مدقق حسابات قانوني معتمد","تقارير مالية دورية","الشفافية والمصداقية"]}
]},
{id:7,title:"المدرسة",icon:"🏫",subtitle:"المدرسة العربية",color:"#1ABC9C",sections:[
{title:"الأهداف",icon:"📚",items:["تعليم اللغة العربية","الحفاظ على التراث الفلسطيني","تعزيز الهوية الوطنية"]},
{title:"الإدارة",icon:"👨‍💼",items:["مجلس إدارة من الهيئة الإدارية","مدير معين من الهيئة","ممثل عن أولياء الأمور"]},
{title:"الأنشطة",icon:"🎭",items:["فرقة دبكة فلسطينية","فعاليات تراثية وثقافية","التوعية الوطنية"]}
]},
{id:8,title:"العقوبات",icon:"⚖️",subtitle:"الباب الثامن",color:"#F39C12",sections:[
{title:"أنواع العقوبات",icon:"📜",items:["التنبيه","اللوم","الإنذار","تجميد العضوية","الفصل من العضوية"]},
{title:"الضوابط",icon:"⚠️",items:["البحث والتحقق من الخلل","دعوة العضو للمراجعة","النقاش في اجتماع مغلق","إبلاغ العضو بالقرار خطياً"]}
]}
]};
function save(){
appData.adminPass=adminPass;
localStorage.setItem("appData",JSON.stringify(appData));
if(USE_CLOUD && JSONBIN_BIN_ID && JSONBIN_API_KEY.length > 20){
fetch("https://api.jsonbin.io/v3/b/"+JSONBIN_BIN_ID,{
method:"PUT",
headers:{"Content-Type":"application/json","X-Master-Key":JSONBIN_API_KEY},
body:JSON.stringify(appData)
}).catch(function(e){console.log("Cloud save error:",e);});
}
}
function loadFromCloud(callback){
if(USE_CLOUD && JSONBIN_BIN_ID && JSONBIN_API_KEY.length > 20){
fetch("https://api.jsonbin.io/v3/b/"+JSONBIN_BIN_ID+"/latest",{
headers:{"X-Master-Key":JSONBIN_API_KEY}
}).then(function(r){return r.json();}).then(function(data){
if(data.record){
appData=data.record;
if(appData.adminPass)adminPass=appData.adminPass;
localStorage.setItem("appData",JSON.stringify(appData));
if(callback)callback();
}
}).catch(function(e){console.log("Cloud load error:",e);if(callback)callback();});
}else{if(callback)callback();}
}
function toast(m,e){var t=document.getElementById("toast");t.textContent=m;t.className="toast show"+(e?" error":"");setTimeout(function(){t.className="toast";},3000);}
function fmtDate(d){var dt=new Date(d),ms=["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];return dt.getDate()+" "+ms[dt.getMonth()]+" "+dt.getFullYear();}

// ========== Home Page Customization Functions ==========
window.toggleEditSection = function(id){
    var el = document.getElementById(id);
    if(el){
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
};

window.saveHomeSettings = function(){
    var hs = appData.homeSettings;
    
    // Get toggle values
    hs.showHero = document.getElementById('homeShowHero')?.checked ?? true;
    hs.showStats = document.getElementById('homeShowStats')?.checked ?? true;
    hs.showQuickActions = document.getElementById('homeShowQuickActions')?.checked ?? true;
    hs.showActiveVote = document.getElementById('homeShowActiveVote')?.checked ?? true;
    hs.showNews = document.getElementById('homeShowNews')?.checked ?? true;
    hs.showAbout = document.getElementById('homeShowAbout')?.checked ?? true;
    hs.showEvents = document.getElementById('homeShowEvents')?.checked ?? false;
    hs.showSocial = document.getElementById('homeShowSocial')?.checked ?? false;
    
    // Get content values
    hs.heroTitle = document.getElementById('heroTitle')?.value || hs.heroTitle;
    hs.heroSubtitle = document.getElementById('heroSubtitle')?.value || hs.heroSubtitle;
    hs.heroBtn1 = document.getElementById('heroBtn1Text')?.value || hs.heroBtn1;
    hs.heroBtn2 = document.getElementById('heroBtn2Text')?.value || hs.heroBtn2;
    hs.newsCount = parseInt(document.getElementById('homeNewsCount')?.value) || 3;
    hs.aboutText = document.getElementById('homeAboutText')?.value || hs.aboutText;
    hs.vision = document.getElementById('homeVision')?.value || hs.vision;
    hs.mission = document.getElementById('homeMission')?.value || hs.mission;
    
    // Social links
    hs.socialFacebook = document.getElementById('socialFacebook')?.value || '';
    hs.socialInstagram = document.getElementById('socialInstagram')?.value || '';
    hs.socialWhatsapp = document.getElementById('socialWhatsapp')?.value || '';
    hs.socialEmail = document.getElementById('socialEmail')?.value || '';
    
    // Quick Access Buttons
    if(!hs.quickBtns) hs.quickBtns = {};
    var qaIds = ['qaRegister','qaVoting','qaLive','qaMap','qaNews','qaFinance','qaBylaws','qaInvitation','qaConfInvite','qaContact'];
    var qaKeys = ['register','voting','live','map','news','finance','bylaws','invitation','confInvite','contact'];
    for(var i=0; i<qaIds.length; i++){
        var el = document.getElementById(qaIds[i]);
        if(el) hs.quickBtns[qaKeys[i]] = el.checked;
    }
    
    save();
    renderHomePage();
    toast('تم حفظ إعدادات الرئيسية ✅');
};

window.loadHomeSettings = function(){
    var hs = appData.homeSettings || {};
    
    // Set toggle values
    if(document.getElementById('homeShowHero')) document.getElementById('homeShowHero').checked = hs.showHero !== false;
    if(document.getElementById('homeShowStats')) document.getElementById('homeShowStats').checked = hs.showStats !== false;
    if(document.getElementById('homeShowQuickActions')) document.getElementById('homeShowQuickActions').checked = hs.showQuickActions !== false;
    if(document.getElementById('homeShowActiveVote')) document.getElementById('homeShowActiveVote').checked = hs.showActiveVote !== false;
    if(document.getElementById('homeShowNews')) document.getElementById('homeShowNews').checked = hs.showNews !== false;
    if(document.getElementById('homeShowAbout')) document.getElementById('homeShowAbout').checked = hs.showAbout !== false;
    if(document.getElementById('homeShowEvents')) document.getElementById('homeShowEvents').checked = hs.showEvents === true;
    if(document.getElementById('homeShowSocial')) document.getElementById('homeShowSocial').checked = hs.showSocial === true;
    
    // Set content values
    if(document.getElementById('heroTitle')) document.getElementById('heroTitle').value = hs.heroTitle || '';
    if(document.getElementById('heroSubtitle')) document.getElementById('heroSubtitle').value = hs.heroSubtitle || '';
    if(document.getElementById('heroBtn1Text')) document.getElementById('heroBtn1Text').value = hs.heroBtn1 || '';
    if(document.getElementById('heroBtn2Text')) document.getElementById('heroBtn2Text').value = hs.heroBtn2 || '';
    if(document.getElementById('homeNewsCount')) document.getElementById('homeNewsCount').value = hs.newsCount || 3;
    if(document.getElementById('homeAboutText')) document.getElementById('homeAboutText').value = hs.aboutText || '';
    if(document.getElementById('homeVision')) document.getElementById('homeVision').value = hs.vision || '';
    if(document.getElementById('homeMission')) document.getElementById('homeMission').value = hs.mission || '';
    
    // Social links
    if(document.getElementById('socialFacebook')) document.getElementById('socialFacebook').value = hs.socialFacebook || '';
    if(document.getElementById('socialInstagram')) document.getElementById('socialInstagram').value = hs.socialInstagram || '';
    if(document.getElementById('socialWhatsapp')) document.getElementById('socialWhatsapp').value = hs.socialWhatsapp || '';
    if(document.getElementById('socialEmail')) document.getElementById('socialEmail').value = hs.socialEmail || '';
    
    // Quick Access Buttons
    var qb = hs.quickBtns || {};
    if(document.getElementById('qaRegister')) document.getElementById('qaRegister').checked = qb.register !== false;
    if(document.getElementById('qaVoting')) document.getElementById('qaVoting').checked = qb.voting !== false;
    if(document.getElementById('qaLive')) document.getElementById('qaLive').checked = qb.live !== false;
    if(document.getElementById('qaMap')) document.getElementById('qaMap').checked = qb.map !== false;
    if(document.getElementById('qaNews')) document.getElementById('qaNews').checked = qb.news === true;
    if(document.getElementById('qaFinance')) document.getElementById('qaFinance').checked = qb.finance === true;
    if(document.getElementById('qaBylaws')) document.getElementById('qaBylaws').checked = qb.bylaws === true;
    if(document.getElementById('qaInvitation')) document.getElementById('qaInvitation').checked = qb.invitation === true;
    if(document.getElementById('qaConfInvite')) document.getElementById('qaConfInvite').checked = qb.confInvite === true;
    if(document.getElementById('qaContact')) document.getElementById('qaContact').checked = qb.contact === true;
    
    renderEventsList();
};

window.renderHomePage = function(){
    var hs = appData.homeSettings || {};
    
    // Show/Hide sections
    var heroSection = document.getElementById('heroSection');
    var statsSection = document.getElementById('statsSection');
    var quickActionsSection = document.getElementById('quickActionsSection');
    var activeVoteSection = document.getElementById('activeVoteSection');
    var newsSection = document.getElementById('newsSection');
    var aboutSection = document.getElementById('aboutSection');
    var eventsSection = document.getElementById('eventsSection');
    var socialSection = document.getElementById('socialSection');
    
    if(heroSection) heroSection.style.display = hs.showHero !== false ? 'block' : 'none';
    if(statsSection) statsSection.style.display = hs.showStats !== false ? 'block' : 'none';
    if(quickActionsSection) quickActionsSection.style.display = hs.showQuickActions !== false ? 'block' : 'none';
    if(newsSection) newsSection.style.display = hs.showNews !== false ? 'block' : 'none';
    if(aboutSection) aboutSection.style.display = hs.showAbout !== false ? 'block' : 'none';
    if(eventsSection) eventsSection.style.display = hs.showEvents === true ? 'block' : 'none';
    if(socialSection) socialSection.style.display = hs.showSocial === true ? 'block' : 'none';
    
    // Update Hero content
    if(document.getElementById('heroTitleDisplay')) document.getElementById('heroTitleDisplay').textContent = hs.heroTitle || 'مرحباً بكم في الجالية الفلسطينية';
    if(document.getElementById('heroSubtitleDisplay')) document.getElementById('heroSubtitleDisplay').textContent = hs.heroSubtitle || 'نجمع شملنا في روغالاند - النرويج';
    if(document.getElementById('heroBtn1Display')) document.getElementById('heroBtn1Display').textContent = hs.heroBtn1 || '📝 انضم إلينا';
    if(document.getElementById('heroBtn2Display')) document.getElementById('heroBtn2Display').textContent = hs.heroBtn2 || '✉️ تواصل معنا';
    
    // Update About content
    if(document.getElementById('aboutTextDisplay')) document.getElementById('aboutTextDisplay').textContent = hs.aboutText || '';
    if(document.getElementById('visionDisplay')) document.getElementById('visionDisplay').textContent = hs.vision || '';
    if(document.getElementById('missionDisplay')) document.getElementById('missionDisplay').textContent = hs.mission || '';
    
    // Update stats
    updateHomeStats();
    
    // Check for active votes
    checkActiveVotes();
    
    // Render news
    renderHomeNews();
    
    // Render quick access buttons
    renderQuickAccessBtns();
    
    // Render events
    renderHomeEvents();
    
    // Render social links
    renderSocialLinks();
};

window.renderQuickAccessBtns = function(){
    var grid = document.getElementById('quickActionsGrid');
    if(!grid) return;
    var hs = appData.homeSettings || {};
    var qb = hs.quickBtns || {};
    var allBtns = [
        {id:'register', icon:'📝', label:'استمارة الانتساب', def:true},
        {id:'voting', icon:'🗳️', label:'التصويت', def:true},
        {id:'live', icon:'📺', label:'البث المباشر', def:true},
        {id:'map', icon:'🗺️', label:'خارطة المنتسبين', def:true},
        {id:'news', icon:'📰', label:'الأخبار', def:false},
        {id:'finance', icon:'💰', label:'المالية', def:false},
        {id:'bylaws', icon:'📜', label:'النظام الداخلي', def:false},
        {id:'invitation', icon:'📨', label:'محرر الدعوات', def:false},
        {id:'confInvite', icon:'🏛️', label:'دعوة المؤتمر', def:false},
        {id:'contact', icon:'✉️', label:'تواصل معنا', def:false}
    ];
    var h = '';
    allBtns.forEach(function(b){
        var show = qb[b.id] !== undefined ? qb[b.id] : b.def;
        if(show){
            h += '<button class="quick-action-btn" onclick="goTo(\''+b.id+'\')">';
            h += '<span class="quick-icon">'+b.icon+'</span>';
            h += '<span class="quick-label">'+b.label+'</span>';
            h += '</button>';
        }
    });
    grid.innerHTML = h;
};

window.updateHomeStats = function(){
    var membersCount = appData.members ? appData.members.length : 0;
    var familiesCount = appData.approved ? appData.approved.length : 0;
    var newsCount = appData.news ? appData.news.length : 0;
    var activeVotes = appData.votes ? appData.votes.filter(function(v){return v.active;}).length : 0;
    
    if(document.getElementById('statMembersHome')) document.getElementById('statMembersHome').textContent = membersCount;
    if(document.getElementById('statFamiliesHome')) document.getElementById('statFamiliesHome').textContent = familiesCount;
    if(document.getElementById('statNewsHome')) document.getElementById('statNewsHome').textContent = newsCount;
    if(document.getElementById('statVotesHome')) document.getElementById('statVotesHome').textContent = activeVotes;
};

window.checkActiveVotes = function(){
    var activeVoteSection = document.getElementById('activeVoteSection');
    var hs = appData.homeSettings || {};
    
    if(!activeVoteSection || hs.showActiveVote === false) return;
    
    var activeVotes = appData.votes ? appData.votes.filter(function(v){return v.active;}) : [];
    
    if(activeVotes.length > 0){
        activeVoteSection.style.display = 'block';
        var vote = activeVotes[0];
        if(document.getElementById('activeVoteTitle')) document.getElementById('activeVoteTitle').textContent = vote.title || 'تصويت نشط';
        if(document.getElementById('activeVoteDesc')) document.getElementById('activeVoteDesc').textContent = vote.question || 'شارك في التصويت الآن';
    } else {
        activeVoteSection.style.display = 'none';
    }
};

window.renderHomeNews = function(){
    var container = document.getElementById('homeNewsGrid');
    if(!container) return;
    
    var hs = appData.homeSettings || {};
    var count = hs.newsCount || 3;
    var news = appData.news ? appData.news.slice(0, count) : [];
    
    if(news.length === 0){
        container.innerHTML = '<div class="empty-home-news"><p style="color:var(--muted);text-align:center;padding:40px;">لا توجد أخبار حالياً</p></div>';
        return;
    }
    
    var html = '';
    news.forEach(function(n){
        var img = n.images && n.images.length > 0 ? '<img src="'+n.images[0]+'" class="news-card-home-img">' : '<div class="news-card-home-img">📰</div>';
        html += '<div class="news-card-home" onclick="goTo(\'news\')">';
        html += img;
        html += '<div class="news-card-home-body">';
        html += '<div class="news-card-home-date">'+fmtDate(n.date)+'</div>';
        html += '<div class="news-card-home-title">'+n.title+'</div>';
        html += '</div></div>';
    });
    
    container.innerHTML = html;
};

window.renderHomeEvents = function(){
    var container = document.getElementById('homeEventsList');
    if(!container) return;
    
    var hs = appData.homeSettings || {};
    var events = hs.events || [];
    
    if(events.length === 0){
        container.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px;">لا توجد فعاليات قادمة</p>';
        return;
    }
    
    // Sort by date ascending
    var sorted = events.slice().sort(function(a,b){return new Date(a.date)-new Date(b.date);});
    var today = new Date();
    today.setHours(0,0,0,0);
    
    var months = ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'];
    
    var html = '';
    sorted.forEach(function(ev){
        var date = new Date(ev.date);
        var day = date.getDate();
        var month = months[date.getMonth()];
        
        // Countdown
        var diff = Math.ceil((date - today) / (1000*60*60*24));
        var countdown = '';
        if(diff === 0) countdown = '🔴 اليوم!';
        else if(diff === 1) countdown = 'غداً';
        else if(diff > 0 && diff <= 30) countdown = 'بعد ' + diff + ' يوم';
        else if(diff > 30) countdown = month;
        else countdown = 'انتهت';
        
        if(diff < 0) return; // Skip past events
        
        html += '<div class="upcoming-event">';
        html += '<div class="upcoming-event-date"><div class="upcoming-event-day">'+day+'</div><div class="upcoming-event-month">'+month+'</div></div>';
        html += '<div class="upcoming-event-info"><div class="upcoming-event-title">'+ev.title+'</div><div class="upcoming-event-desc">'+(ev.description || '')+'</div></div>';
        html += '<div class="upcoming-event-countdown">'+countdown+'</div>';
        html += '</div>';
    });
    
    container.innerHTML = html || '<p style="color:var(--muted);text-align:center;padding:20px;">لا توجد فعاليات قادمة</p>';
};

window.renderSocialLinks = function(){
    var container = document.getElementById('socialLinksDisplay');
    if(!container) return;
    
    var hs = appData.homeSettings || {};
    var html = '';
    
    if(hs.socialFacebook){
        html += '<a href="'+hs.socialFacebook+'" target="_blank" class="social-link"><span class="social-link-icon">📘</span><span>فيسبوك</span></a>';
    }
    if(hs.socialInstagram){
        html += '<a href="'+hs.socialInstagram+'" target="_blank" class="social-link"><span class="social-link-icon">📷</span><span>انستغرام</span></a>';
    }
    if(hs.socialWhatsapp){
        html += '<a href="'+hs.socialWhatsapp+'" target="_blank" class="social-link"><span class="social-link-icon">💬</span><span>واتساب</span></a>';
    }
    if(hs.socialEmail){
        html += '<a href="mailto:'+hs.socialEmail+'" class="social-link"><span class="social-link-icon">📧</span><span>البريد</span></a>';
    }
    
    container.innerHTML = html || '<p style="color:var(--muted);">لم يتم إضافة روابط</p>';
}

// Events Management
window.renderEventsList = function(){
    var container = document.getElementById('eventsList');
    if(!container) return;
    
    var hs = appData.homeSettings || {};
    var events = hs.events || [];
    
    var html = '';
    events.forEach(function(ev, index){
        html += '<div class="event-item">';
        html += '<input type="date" class="form-input event-date" value="'+ev.date+'" onchange="updateEvent('+index+', \'date\', this.value)">';
        html += '<input type="text" class="form-input" value="'+ev.title+'" placeholder="عنوان الفعالية" onchange="updateEvent('+index+', \'title\', this.value)">';
        html += '<button class="btn btn-red btn-sm" onclick="removeEvent('+index+')">🗑️</button>';
        html += '</div>';
    });
    
    container.innerHTML = html;
}

window.addEvent = function(){
    var hs = appData.homeSettings;
    if(!hs.events) hs.events = [];
    
    hs.events.push({
        date: new Date().toISOString().split('T')[0],
        title: 'فعالية جديدة',
        description: ''
    });
    
    save();
    renderEventsList();
    renderHomePage();
}

window.updateEvent = function(index, field, value){
    var hs = appData.homeSettings;
    if(hs.events && hs.events[index]){
        hs.events[index][field] = value;
        save();
        renderHomePage();
    }
}

window.removeEvent = function(index){
    var hs = appData.homeSettings;
    if(hs.events){
        hs.events.splice(index, 1);
        save();
        renderEventsList();
        renderHomePage();
    }
}

function updateVisibility(){
var sections={news:"btnNews",finance:"btnFinance",map:"btnMap",invitation:"btnInvitation",confInvite:"btnConfInvite",reports:"btnReports",bylaws:"btnBylaws",voting:"btnVoting"};
for(var key in sections){var btn=document.getElementById(sections[key]);var vis=appData.visibility[key]||"all";if(vis==="hidden")btn.classList.add("hidden");else if(vis==="admin"){if(isAdmin)btn.classList.remove("hidden");else btn.classList.add("hidden");}else btn.classList.remove("hidden");}
document.getElementById("visNews").value=appData.visibility.news||"all";document.getElementById("visFinance").value=appData.visibility.finance||"all";document.getElementById("visMap").value=appData.visibility.map||"all";document.getElementById("visInvitation").value=appData.visibility.invitation||"all";document.getElementById("visConfInvite").value=appData.visibility.confInvite||"all";document.getElementById("visReports").value=appData.visibility.reports||"all";document.getElementById("visBylaws").value=appData.visibility.bylaws||"all";document.getElementById("visVoting").value=appData.visibility.voting||"all";
if(isAdmin){document.getElementById("btnFindCenter").classList.remove("hidden");document.getElementById("mapAdminStats").classList.remove("hidden");document.getElementById("btnEditBylaws").classList.remove("hidden");}else{document.getElementById("btnFindCenter").classList.add("hidden");document.getElementById("mapAdminStats").classList.add("hidden");document.getElementById("centerInfo").classList.remove("show");document.getElementById("btnEditBylaws").classList.add("hidden");}
}
window.goTo=function(p){var bs=document.querySelectorAll(".nav-btn");for(var i=0;i<bs.length;i++)bs[i].classList.remove("active");var b=document.getElementById("btn"+p.charAt(0).toUpperCase()+p.slice(1));if(b)b.classList.add("active");var ps=document.querySelectorAll(".page");for(var j=0;j<ps.length;j++)ps[j].classList.remove("active");var pg=document.getElementById("page"+p.charAt(0).toUpperCase()+p.slice(1));if(pg)pg.classList.add("active");if(p==="map"&&!myMap)setTimeout(initMap,300);if(p==="members")loadMembers();if(p==="manageTx")loadAdminTx();if(p==="manageNews")loadAdminNews();document.getElementById("sidebar").classList.remove("open");}
function loadLogo(){if(appData.logo){document.getElementById("logoContainer").innerHTML='<img src="'+appData.logo+'">';document.getElementById("invLogo").innerHTML='<img src="'+appData.logo+'">';}}
function loadNews(){var g=document.getElementById("newsGrid");if(!g)return;g.innerHTML="";for(var i=0;i<appData.news.length;i++){var n=appData.news[i];var imgs=n.imgs||[];if(n.img&&imgs.length===0)imgs=[n.img];var galleryHtml='';if(imgs.length>0){var sliderId='newsSlider_'+i;galleryHtml='<div class="news-gallery-wrapper">';galleryHtml+='<div class="news-gallery-slider" id="'+sliderId+'">';for(var k=0;k<imgs.length;k++){galleryHtml+='<div class="news-gallery-slide"><img src="'+imgs[k]+'" onclick="showLightbox(\''+imgs[k]+'\')"></div>';}galleryHtml+='</div>';if(imgs.length>1){galleryHtml+='<button class="news-gallery-btn news-gallery-prev" onclick="slideNews(\''+sliderId+'\',-1)">❯</button>';galleryHtml+='<button class="news-gallery-btn news-gallery-next" onclick="slideNews(\''+sliderId+'\',1)">❮</button>';galleryHtml+='<div class="news-gallery-counter" id="'+sliderId+'_counter">'+imgs.length+' / 1</div>';galleryHtml+='<div class="news-gallery-dots" id="'+sliderId+'_dots">';for(var d=0;d<imgs.length;d++){galleryHtml+='<button class="news-gallery-dot'+(d===0?' active':'')+'" onclick="goToSlide(\''+sliderId+'\','+d+')"></button>';}galleryHtml+='</div>';}galleryHtml+='</div>';}g.innerHTML+='<div class="news-card"><div class="news-card-body"><div class="news-card-date">'+fmtDate(n.date)+'</div><div class="news-card-title">'+n.title+'</div><div class="news-card-text">'+n.content+'</div></div>'+galleryHtml+'</div>';}renderHomeNews();}
function loadAdminNews(){var l=document.getElementById("adminNewsList");l.innerHTML="";if(appData.news.length===0){l.innerHTML='<p style="color:var(--muted);text-align:center;">لا توجد أخبار</p>';return;}for(var i=0;i<appData.news.length;i++){var n=appData.news[i];var newsId=n.id||n._id;l.innerHTML+='<div class="member-item" data-newsid="'+newsId+'"><div class="member-info"><div class="member-name">'+n.title+'</div><div class="member-city">'+fmtDate(n.date)+'</div></div><div class="news-actions"><button class="btn btn-gray btn-sm news-edit-btn" data-newsid="'+newsId+'">✏️</button><button class="btn btn-red btn-sm news-delete-btn" data-newsid="'+newsId+'">🗑️</button></div></div>';}attachNewsListeners();}
function populateYearFilter(selectId){
var sel=document.getElementById(selectId);if(!sel)return;
var years={};for(var i=0;i<appData.tx.length;i++){var d=appData.tx[i].date;if(d){var y=new Date(d).getFullYear();if(!isNaN(y))years[y]=true;}}
var currentYear=new Date().getFullYear();years[currentYear]=true;
var sortedYears=Object.keys(years).sort(function(a,b){return b-a;});
var currentVal=sel.value;
sel.innerHTML='<option value="all">📊 الكل</option>';
for(var j=0;j<sortedYears.length;j++){sel.innerHTML+='<option value="'+sortedYears[j]+'">📅 '+sortedYears[j]+'</option>';}
if(!currentVal||currentVal===''){sel.value=String(currentYear);}else{sel.value=currentVal;}
}
function getFilteredTx(selectId){
var sel=document.getElementById(selectId);
var year=sel?sel.value:'all';
if(year==='all')return appData.tx.slice();
return appData.tx.filter(function(t){return t.date&&new Date(t.date).getFullYear()===parseInt(year);});
}
function loadFinance(){populateYearFilter('financeYearFilter');var filtered=getFilteredTx('financeYearFilter');var inc=0,exp=0;for(var i=0;i<filtered.length;i++){if(filtered[i].type==="income")inc+=filtered[i].amount;else exp+=filtered[i].amount;}var bal=inc-exp;var statBal=document.getElementById("statBalance");var statInc=document.getElementById("statIncome");var statExp=document.getElementById("statExpense");if(statBal)statBal.textContent=bal.toLocaleString()+" NOK";if(statInc)statInc.textContent=inc.toLocaleString()+" NOK";if(statExp)statExp.textContent=exp.toLocaleString()+" NOK";var sel=document.getElementById('financeYearFilter');var yearLabel=sel&&sel.value!=='all'?' ('+sel.value+')':'';var lbl1=document.getElementById('finBalanceLabel');var lbl2=document.getElementById('finIncomeLabel');var lbl3=document.getElementById('finExpenseLabel');if(lbl1)lbl1.textContent='الرصيد'+yearLabel;if(lbl2)lbl2.textContent='الإيرادات'+yearLabel;if(lbl3)lbl3.textContent='المصروفات'+yearLabel;var list=document.getElementById("txList");if(list){list.innerHTML="";if(filtered.length===0){list.innerHTML='<p style="color:var(--muted);text-align:center;padding:20px;">لا توجد معاملات</p>';return;}for(var j=0;j<filtered.length;j++){var t=filtered[j];var rh="";if(t.receipts&&t.receipts.length>0){rh='<div class="tx-receipts">';for(var k=0;k<t.receipts.length;k++)rh+='<img src="'+t.receipts[k]+'" class="tx-receipt-img" onclick="showLightbox(\''+t.receipts[k]+'\')">';rh+='</div>';}list.innerHTML+='<div class="tx-item"><div class="tx-icon '+(t.type==="income"?"inc":"exp")+'">'+(t.type==="income"?"📥":"📤")+'</div><div class="tx-info"><div class="tx-title">'+t.desc+'</div><div class="tx-date">'+fmtDate(t.date)+'</div></div><div class="tx-amount '+(t.type==="income"?"inc":"exp")+'">'+(t.type==="income"?"+":"-")+t.amount.toLocaleString()+' NOK</div>'+rh+'</div>';}}}
function loadAdminTx(){populateYearFilter('adminTxYearFilter');var filtered=getFilteredTx('adminTxYearFilter');var list=document.getElementById("adminTxList");list.innerHTML="";if(filtered.length===0){list.innerHTML='<p style="color:var(--muted);text-align:center;">لا توجد معاملات</p>';return;}for(var j=0;j<filtered.length;j++){var t=filtered[j];var txId=t.id||t._id;var rh="";if(t.receipts&&t.receipts.length>0){rh='<div class="tx-receipts">';for(var k=0;k<t.receipts.length;k++)rh+='<img src="'+t.receipts[k]+'" class="tx-receipt-img" onclick="showLightbox(\''+t.receipts[k]+'\')">';rh+='</div>';}list.innerHTML+='<div class="tx-item" data-txid="'+txId+'"><div class="tx-icon '+(t.type==="income"?"inc":"exp")+'">'+(t.type==="income"?"📥":"📤")+'</div><div class="tx-info"><div class="tx-title">'+t.desc+'</div><div class="tx-date">'+fmtDate(t.date)+'</div></div><div class="tx-amount '+(t.type==="income"?"inc":"exp")+'">'+(t.type==="income"?"+":"-")+t.amount.toLocaleString()+' NOK</div><div class="tx-actions"><button class="btn btn-gray btn-sm tx-edit-btn" data-txid="'+txId+'">✏️</button><button class="btn btn-red btn-sm tx-delete-btn" data-txid="'+txId+'">🗑️</button></div>'+rh+'</div>';}attachTxListeners();}
function loadCount(){updateHomeStats();}
function loadMembers(filter){
var l=document.getElementById("membersList");
var countEl=document.getElementById("totalMembersCount");
l.innerHTML="";

var totalCount=appData.members?appData.members.length:0;
if(countEl)countEl.textContent=totalCount;

if(!appData.members||appData.members.length===0){l.innerHTML='<p style="text-align:center;color:var(--muted);">لا يوجد أعضاء</p>';return;}

var filtered=appData.members;
if(filter&&filter.trim()){
var search=filter.trim().toLowerCase();
filtered=appData.members.filter(function(m){
return (m.name&&m.name.toLowerCase().indexOf(search)>-1)||
(m.phone&&m.phone.indexOf(search)>-1)||
(m.voteCode&&m.voteCode.toLowerCase().indexOf(search)>-1);
});
}

if(filtered.length===0){l.innerHTML='<p style="text-align:center;color:var(--muted);">لا توجد نتائج للبحث</p>';return;}

for(var i=0;i<filtered.length;i++){
var m=filtered[i];
var memberId = m.id || m._id;
if(!m.voteCode){m.voteCode=generateMemberCode();save();}
var bg=m.showMap?'<span class="badge badge-green">📍</span>':'<span class="badge badge-red">📍</span>';
var av=m.img?'<img src="'+m.img+'">':'👤';
var phoneDisplay=m.phone?'<div class="member-phone">📱 '+m.phone+'</div>':'';
l.innerHTML+='<div class="member-item" data-memberid="'+memberId+'"><div class="member-avatar">'+av+'</div><div class="member-info"><div class="member-name">'+m.name+' '+bg+'</div><div class="member-city">'+(m.addressText||"")+'</div>'+phoneDisplay+'<div class="member-code">🔑 رمز التصويت: <span style="font-family:monospace;color:var(--gold);font-weight:bold;letter-spacing:2px;">'+m.voteCode+'</span></div></div><div class="member-actions"><button class="btn btn-gray btn-sm member-edit-btn" data-memberid="'+memberId+'">✏️ تعديل</button><button class="btn btn-red btn-sm member-delete-btn" data-memberid="'+memberId+'">🗑️ حذف</button></div></div>';
}

// Attach event listeners
attachMemberListeners();
}

function attachMemberListeners(){
// Edit member
document.querySelectorAll('.member-edit-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var memberId = this.getAttribute('data-memberid');
editM(memberId);
};
});

// Delete member
document.querySelectorAll('.member-delete-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var memberId = this.getAttribute('data-memberid');
delM(memberId);
};
});
}

window.searchMembers=function(){
var query=document.getElementById("memberSearchInput").value;
loadMembers(query);
}
var markerClusterGroup=null;
function initMap(){if(myMap)return;try{myMap=L.map("map").setView([58.97,5.73],9);L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(myMap);loadMarkers();}catch(e){}}
function loadMarkers(){
if(!myMap)return;

// Remove old cluster group if exists
if(markerClusterGroup){
myMap.removeLayer(markerClusterGroup);
}
markers=[];

// Create new cluster group with custom options
markerClusterGroup=L.markerClusterGroup({
maxClusterRadius:50,
spiderfyOnMaxZoom:true,
showCoverageOnHover:false,
zoomToBoundsOnClick:true,
disableClusteringAtZoom:16,
iconCreateFunction:function(cluster){
var count=cluster.getChildCount();
var size='small';
var cssClass='marker-cluster-small';
if(count>10){size='medium';cssClass='marker-cluster-medium';}
if(count>30){size='large';cssClass='marker-cluster-large';}
return L.divIcon({
html:'<div><span>'+count+'</span></div>',
className:'marker-cluster '+cssClass,
iconSize:L.point(40,40)
});
}
});

var cities={},onMap=0,hidden=0;
var gi=L.divIcon({className:'',html:'<div style="background:#009639;width:24px;height:24px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',iconSize:[24,24],iconAnchor:[12,12]});

// Group members by exact location
var locationGroups={};
for(var j=0;j<appData.members.length;j++){
var m=appData.members[j];
if(m.showMap&&m.lat&&m.lng){
var locKey=m.lat.toFixed(5)+','+m.lng.toFixed(5);
if(!locationGroups[locKey])locationGroups[locKey]=[];
locationGroups[locKey].push(m);
var ck=m.addressText||"غير محدد";
cities[ck]=(cities[ck]||0)+1;
onMap++;
}else{
hidden++;
}
}

// Create markers
for(var locKey in locationGroups){
var membersAtLoc=locationGroups[locKey];
var firstMember=membersAtLoc[0];

if(membersAtLoc.length===1){
// Single member at location
var pc='<div style="text-align:center;min-width:150px;">';
if(firstMember.img)pc+='<img src="'+firstMember.img+'" style="width:60px;height:60px;border-radius:50%;object-fit:cover;margin-bottom:8px;border:3px solid var(--green);">';
pc+='<strong style="font-size:1rem;">'+firstMember.name+'</strong>';
if(firstMember.addressText)pc+='<br><span style="color:#666;font-size:0.85rem;">📍 '+firstMember.addressText+'</span>';
if(firstMember.showPhone&&firstMember.phone)pc+='<br><a href="tel:'+firstMember.phone+'" style="color:#009639;">📱 '+firstMember.phone+'</a>';
if(firstMember.showEmail&&firstMember.email)pc+='<br><a href="mailto:'+firstMember.email+'" style="color:#009639;">📧 '+firstMember.email+'</a>';
pc+='</div>';
var mk=L.marker([firstMember.lat,firstMember.lng],{icon:gi}).bindPopup(pc);
markerClusterGroup.addLayer(mk);
markers.push(mk);
}else{
// Multiple members at same location - create special marker with count
var multiIcon=L.divIcon({
className:'',
html:'<div style="background:linear-gradient(135deg,#009639,#CE1126);width:32px;height:32px;border-radius:50%;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px;">'+membersAtLoc.length+'</div>',
iconSize:[32,32],
iconAnchor:[16,16]
});

// Create popup with list of members
var popupContent='<div class="spiderfy-popup" style="min-width:200px;"><div style="text-align:center;padding-bottom:10px;border-bottom:2px solid var(--green);margin-bottom:10px;"><strong style="color:#009639;">👥 '+membersAtLoc.length+' '+t('members')+' '+t('atSameLocation')+'</strong></div>';
for(var k=0;k<membersAtLoc.length;k++){
var mem=membersAtLoc[k];
popupContent+='<div class="member-item" onclick="showMemberDetail('+mem.id+')">';
if(mem.img)popupContent+='<img src="'+mem.img+'" style="width:35px;height:35px;border-radius:50%;object-fit:cover;float:right;margin-left:10px;border:2px solid #009639;">';
popupContent+='<strong>'+mem.name+'</strong>';
if(mem.showPhone&&mem.phone)popupContent+='<br><span style="font-size:0.8rem;color:#666;">📱 '+mem.phone+'</span>';
popupContent+='<div style="clear:both;"></div></div>';
}
popupContent+='</div>';

var mk=L.marker([firstMember.lat,firstMember.lng],{icon:multiIcon}).bindPopup(popupContent,{maxWidth:300,maxHeight:300});
markerClusterGroup.addLayer(mk);
markers.push(mk);
}
}

myMap.addLayer(markerClusterGroup);

var st=document.getElementById("mapStats"),h='';
for(var c in cities)h+='<span style="background:var(--dark);padding:5px 10px;border-radius:5px;margin:3px;display:inline-block;">'+c+': '+cities[c]+'</span>';
st.innerHTML=h||t('noData');
document.getElementById("mapMembersCount").textContent=onMap;
document.getElementById("mapHiddenCount").textContent=hidden;
document.getElementById("mapCitiesCount").textContent=Object.keys(cities).length;
}

window.showMemberDetail=function(memberId){
var member=appData.members.find(function(m){return m.id===memberId;});
if(!member)return;
var pc='<div style="text-align:center;min-width:180px;">';
if(member.img)pc+='<img src="'+member.img+'" style="width:70px;height:70px;border-radius:50%;object-fit:cover;margin-bottom:10px;border:3px solid var(--green);">';
pc+='<h3 style="margin:0 0 5px;color:#009639;">'+member.name+'</h3>';
if(member.addressText)pc+='<p style="margin:5px 0;color:#666;font-size:0.85rem;">📍 '+member.addressText+'</p>';
if(member.showPhone&&member.phone)pc+='<p style="margin:5px 0;"><a href="tel:'+member.phone+'" style="color:#009639;text-decoration:none;">📱 '+member.phone+'</a></p>';
if(member.showEmail&&member.email)pc+='<p style="margin:5px 0;"><a href="mailto:'+member.email+'" style="color:#009639;text-decoration:none;">📧 '+member.email+'</a></p>';
pc+='</div>';
showModal('👤 '+member.name,pc);
}
function findCenter(){var lats=[],lngs=[];for(var i=0;i<appData.members.length;i++){var m=appData.members[i];if(m.showMap&&m.lat&&m.lng){lats.push(m.lat);lngs.push(m.lng);}}if(lats.length<2){toast("يجب وجود عضوين",true);return;}var avgLat=lats.reduce(function(a,b){return a+b;},0)/lats.length;var avgLng=lngs.reduce(function(a,b){return a+b;},0)/lngs.length;if(centerMarker)myMap.removeLayer(centerMarker);var gdi=L.divIcon({className:'',html:'<div style="background:#C9A227;width:30px;height:30px;border-radius:50%;border:3px solid #fff;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 10px rgba(0,0,0,0.3);">🎯</div>',iconSize:[30,30],iconAnchor:[15,15]});centerMarker=L.marker([avgLat,avgLng],{icon:gdi}).addTo(myMap).bindPopup('<strong>🎯 أفضل موقع</strong>').openPopup();myMap.setView([avgLat,avgLng],11);document.getElementById("centerCoords").textContent="Lat: "+avgLat.toFixed(4)+", Lng: "+avgLng.toFixed(4);document.getElementById("centerInfo").classList.add("show");toast("تم");}
function searchAddress(a,cb){fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(a)).then(function(r){return r.json();}).then(function(d){if(d&&d.length>0)cb(null,{lat:parseFloat(d[0].lat),lng:parseFloat(d[0].lon),display:d[0].display_name});else cb("لم يتم العثور",null);}).catch(function(){cb("خطأ",null);});}
function updateInv(){document.getElementById("pTitle").textContent=document.getElementById("iTitle").value;document.getElementById("pSub").textContent=document.getElementById("iSub").value;document.getElementById("pText").textContent=document.getElementById("iText").value;document.getElementById("pDate").textContent=document.getElementById("iDate").value;document.getElementById("pFrom").textContent=document.getElementById("iFrom").value;document.getElementById("pTo").textContent=document.getElementById("iTo").value;document.getElementById("pLoc").textContent=document.getElementById("iLoc").value;document.getElementById("pWelcome").textContent=document.getElementById("iWelcome").value;}

// === Conference Invitation ===
var confAg=['افتتاح المؤتمر بتلاوة آيات من الذكر الحكيم','النشيد الوطني الفلسطيني','تقديم التقرير الإداري','تقديم التقرير المالي','استقالة الهيئة الإدارية الحالية','انتخاب رئاسة المؤتمر','مناقشة التعديلات على النظام الداخلي','فتح باب الترشح للهيئة الإدارية الجديدة','إجراء الانتخابات'];
function initConfInv(){renderConfAgEd();updConfPrev();var up=document.getElementById('confLogoUp'),f=document.getElementById('confLogoF');if(up&&f){up.onclick=function(){f.click();};f.onchange=function(){if(this.files&&this.files[0]){var r=new FileReader();r.onload=function(e){up.innerHTML='<img src="'+e.target.result+'" style="max-width:100%;max-height:50px;border-radius:8px;">';var prev=document.getElementById('confLogoPrev');var img=document.getElementById('confLogoImg');if(prev&&img){img.src=e.target.result;prev.style.display='block';}var ctrl=document.getElementById('logoControls');if(ctrl)ctrl.style.display='block';window.updLogoStyle();};r.readAsDataURL(this.files[0]);}};}document.getElementById('confClrHead').onchange=updConfPrev;document.getElementById('confClrTitle').onchange=updConfPrev;}
window.updLogoStyle=function(){var prev=document.getElementById('confLogoPrev');if(!prev)return;var sz=document.getElementById('logoSize'),tp=document.getElementById('logoTop'),lf=document.getElementById('logoLeft');var size=sz?sz.value:80,top=tp?tp.value:42,left=lf?lf.value:50;prev.style.width=size+'px';prev.style.height=size+'px';prev.style.top=top+'%';prev.style.left=left+'%';if(document.getElementById('logoSizeVal'))document.getElementById('logoSizeVal').textContent=size+'px';if(document.getElementById('logoTopVal'))document.getElementById('logoTopVal').textContent=top+'%';if(document.getElementById('logoLeftVal'))document.getElementById('logoLeftVal').textContent=left+'%';};
function renderConfAgEd(){var c=document.getElementById('confAgendaEd');if(!c)return;var h='';confAg.forEach(function(t,i){h+='<div class="conf-edit-item"><button type="button" class="btn btn-red btn-sm" onclick="remConfAg('+i+')" style="padding:4px 8px;">✕</button><span class="conf-edit-num">'+(i+1)+'</span><input type="text" class="form-input" value="'+t+'" onchange="updConfAgI('+i+',this.value)"></div>';});c.innerHTML=h;}
function updConfPrev(){var e;e=document.getElementById('confOrgAr');if(e)document.getElementById('confOrgArP').textContent=e.value;e=document.getElementById('confOrgEn');if(e)document.getElementById('confOrgEnP').textContent=e.value;e=document.getElementById('confVrs');if(e)document.getElementById('confVrsP').textContent='﴿'+e.value+'﴾';e=document.getElementById('confVrsRef');if(e)document.getElementById('confVrsRefP').textContent=e.value;e=document.getElementById('confInvTxt');if(e)document.getElementById('confInvTxtP').textContent=e.value;e=document.getElementById('confTtl');if(e)document.getElementById('confTtlP').textContent='('+e.value+')';e=document.getElementById('confDt');if(e)document.getElementById('confDtP').textContent=e.value;e=document.getElementById('confTmReg');if(e)document.getElementById('confTmRegP').textContent=e.value;e=document.getElementById('confTmStr');if(e)document.getElementById('confTmStrP').textContent=e.value;e=document.getElementById('confAddr');if(e)document.getElementById('confAddrP').textContent=e.value;e=document.getElementById('confFtr');if(e)document.getElementById('confFtrP').textContent=e.value;var hc=document.getElementById('confClrHead')?.value||'#009639',tc=document.getElementById('confClrTitle')?.value||'#CE1126';var hEl=document.getElementById('confHeadEl'),dEl=document.getElementById('confDetEl'),tBox=document.getElementById('confTtlBox');if(hEl)hEl.style.background='linear-gradient(135deg,'+hc+','+drkClr(hc,20)+')';if(dEl)dEl.style.background='linear-gradient(135deg,'+hc+','+drkClr(hc,20)+')';if(tBox)tBox.style.background=tc;var domeSvg=document.querySelector('.conf-dome svg');if(domeSvg){var ellipses=domeSvg.querySelectorAll('ellipse');if(ellipses[1])ellipses[1].setAttribute('fill',hc);}renderConfAgPrev();}
function drkClr(c,p){var n=parseInt(c.replace('#',''),16),a=Math.round(2.55*p),R=(n>>16)-a,G=(n>>8&0xFF)-a,B=(n&0xFF)-a;if(R<0)R=0;if(G<0)G=0;if(B<0)B=0;return'#'+(0x1000000+R*0x10000+G*0x100+B).toString(16).slice(1);}
function renderConfAgPrev(){var c=document.getElementById('confAgendaP');if(!c)return;var ac=document.getElementById('confClrHead')?.value||'#009639',h='';confAg.forEach(function(t,i){h+='<div class="conf-agenda-row"><span class="conf-agenda-n" style="background:'+ac+';">'+(i+1)+'</span><span class="conf-agenda-t">'+t+'</span></div>';});c.innerHTML=h;}
function addConfAg(){confAg.push('بند جديد');renderConfAgEd();renderConfAgPrev();}
function remConfAg(i){confAg.splice(i,1);renderConfAgEd();renderConfAgPrev();}
function updConfAgI(i,v){confAg[i]=v;renderConfAgPrev();}
function printConfCard(){var p=document.getElementById('confCardPrev');if(!p)return;var w=window.open('','_blank');w.document.write('<html dir="rtl"><head><title>دعوة المؤتمر</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box;font-family:"Tajawal",sans-serif}body{padding:20px}</style></head><body>'+p.outerHTML+'</body></html>');w.document.close();w.onload=function(){w.print();};}
function dlConfImg(){var p=document.getElementById('confCardPrev');if(!p)return;if(typeof html2canvas==='undefined'){toast('جاري تحميل...');var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';s.onload=function(){dlConfImg();};document.head.appendChild(s);return;}html2canvas(p,{scale:2,useCORS:true,backgroundColor:'#fff'}).then(function(c){var a=document.createElement('a');a.download='conference-invitation.png';a.href=c.toDataURL('image/png');a.click();toast('تم تحميل الصورة ✅');});}
function dlConfPDF(){var p=document.getElementById('confCardPrev');if(!p)return;if(typeof html2canvas==='undefined'||typeof jspdf==='undefined'){toast('جاري تحميل...');var s1=document.createElement('script');s1.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';s1.onload=function(){var s2=document.createElement('script');s2.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';s2.onload=function(){dlConfPDF();};document.head.appendChild(s2);};document.head.appendChild(s1);return;}html2canvas(p,{scale:2,useCORS:true,backgroundColor:'#fff'}).then(function(c){var img=c.toDataURL('image/png'),pdf=new jspdf.jsPDF('p','mm','a4'),w=190,h=(c.height*w)/c.width;pdf.addImage(img,'PNG',10,10,w,h);pdf.save('conference-invitation.pdf');toast('تم تحميل PDF ✅');});}
function showAdmin(){var el;el=document.getElementById("visitorBox");if(el)el.classList.remove("hidden");el=document.getElementById("adminTitle");if(el)el.classList.remove("hidden");el=document.getElementById("btnAdmin");if(el)el.classList.remove("hidden");el=document.getElementById("btnMembers");if(el)el.classList.remove("hidden");el=document.getElementById("btnPending");if(el)el.classList.remove("hidden");el=document.getElementById("btnRegistrationSheet");if(el)el.classList.remove("hidden");el=document.getElementById("btnManageTx");if(el)el.classList.remove("hidden");el=document.getElementById("btnManageNews");if(el)el.classList.remove("hidden");el=document.getElementById("btnManageVoting");if(el)el.classList.remove("hidden");el=document.getElementById("btnInbox");if(el)el.classList.remove("hidden");el=document.getElementById("btnManageLive");if(el)el.classList.remove("hidden");el=document.getElementById("btnManageGallery");if(el)el.classList.remove("hidden");el=document.getElementById("btnLive");if(el)el.classList.remove("hidden");el=document.getElementById("btnEditBylaws");if(el)el.classList.remove("hidden");el=document.getElementById("loginBtn");if(el){el.textContent="🚪 خروج";el.classList.add("logout");}updateVisibility();}
function hideAdmin(){var el;el=document.getElementById("visitorBox");if(el)el.classList.add("hidden");el=document.getElementById("adminTitle");if(el)el.classList.add("hidden");el=document.getElementById("btnAdmin");if(el)el.classList.add("hidden");el=document.getElementById("btnMembers");if(el)el.classList.add("hidden");el=document.getElementById("btnPending");if(el)el.classList.add("hidden");el=document.getElementById("btnRegistrationSheet");if(el)el.classList.add("hidden");el=document.getElementById("btnManageTx");if(el)el.classList.add("hidden");el=document.getElementById("btnManageNews");if(el)el.classList.add("hidden");el=document.getElementById("btnManageVoting");if(el)el.classList.add("hidden");el=document.getElementById("btnInbox");if(el)el.classList.add("hidden");el=document.getElementById("btnManageLive");if(el)el.classList.add("hidden");el=document.getElementById("btnManageGallery");if(el)el.classList.add("hidden");el=document.getElementById("btnEditBylaws");if(el)el.classList.add("hidden");el=document.getElementById("bylawsEditSection");if(el)el.classList.remove("show");el=document.getElementById("loginBtn");if(el){el.textContent="🔐 دخول المسؤول";el.classList.remove("logout");}updateVisibility();loadLiveStreamStatus();}
function openMemberModal(m){document.getElementById("memberModalTitle").textContent=m?"✏️ تعديل":"➕ إضافة";document.getElementById("memberId").value=m?m.id:"";document.getElementById("memberName").value=m?m.name:"";document.getElementById("memberPhone").value=m?m.phone||"":"";document.getElementById("memberEmail").value=m?m.email||"":"";document.getElementById("memberNotes").value=m?m.notes||"":"";document.getElementById("memberLat").value=m?m.lat||"":"";document.getElementById("memberLng").value=m?m.lng||"":"";document.getElementById("memberAddressSearch").value=m?m.addressText||"":"";document.getElementById("memberShowMap").checked=m?m.showMap:true;document.getElementById("memberShowPhone").checked=m?m.showPhone:false;document.getElementById("memberShowEmail").checked=m?m.showEmail:false;memberImg=m?m.img||"":"";if(memberImg){document.getElementById("memberImgPreview").src=memberImg;document.getElementById("memberImgPreview").style.display="block";}else{document.getElementById("memberImgPreview").style.display="none";}document.getElementById("locationResult").classList.remove("show");document.getElementById("memberModal").classList.add("show");}
async function saveMemberData(){
var nm=document.getElementById("memberName").value.trim();
if(!nm){toast("أدخل الاسم",true);return;}

var id=document.getElementById("memberId").value;
var d={
name:nm,
img:memberImg,
addressText:document.getElementById("memberAddressSearch").value.trim(),
phone:document.getElementById("memberPhone").value.trim(),
email:document.getElementById("memberEmail").value.trim(),
notes:document.getElementById("memberNotes").value.trim(),
lat:parseFloat(document.getElementById("memberLat").value)||null,
lng:parseFloat(document.getElementById("memberLng").value)||null,
showMap:document.getElementById("memberShowMap").checked,
showPhone:document.getElementById("memberShowPhone").checked,
showEmail:document.getElementById("memberShowEmail").checked
};

if(USE_BACKEND && window.API){
try{
toast("جاري الحفظ...");
var result;
if(id){
result = await window.API.Members.update(id, d);
}else{
result = await window.API.Members.create(d);
}
if(result.success){
toast(id?"تم التحديث ✅":"تم الإضافة ✅");
await loadDataFromBackend();
}else{
toast(result.message||"حدث خطأ",true);
}
}catch(err){
console.error(err);
toast(err.message||"خطأ في الاتصال",true);
}
}else{
d.id=id?parseInt(id):Date.now();
if(id){
for(var i=0;i<appData.members.length;i++)
if(appData.members[i].id===parseInt(id)){appData.members[i]=d;break;}
toast("تم التحديث");
}else{
appData.members.push(d);
toast("تم الإضافة");
}
save();
loadMembers();
loadCount();
loadMarkers();
}

memberImg="";
document.getElementById("memberModal").classList.remove("show");
}
function renderNewsImgs(){var p=document.getElementById("newsImgsPreview");p.innerHTML="";for(var i=0;i<newsImgs.length;i++)p.innerHTML+='<div class="imgs-preview-item"><img src="'+newsImgs[i]+'"><button class="remove-img" onclick="removeNewsImg('+i+')">×</button></div>';}
function renderEditNewsImgs(){var p=document.getElementById("editNewsImgsPreview");p.innerHTML="";for(var i=0;i<editNewsImgs.length;i++)p.innerHTML+='<div class="imgs-preview-item"><img src="'+editNewsImgs[i]+'"><button class="remove-img" onclick="removeEditNewsImg('+i+')">×</button></div>';}
function renderTxReceipts(){var p=document.getElementById("txReceiptsPreview");p.innerHTML="";for(var i=0;i<txReceipts.length;i++)p.innerHTML+='<div class="receipt-preview-item"><img src="'+txReceipts[i]+'"><button class="remove-receipt" onclick="removeTxReceipt('+i+')">×</button></div>';}
function renderEditTxReceipts(){var p=document.getElementById("editTxReceiptsPreview");p.innerHTML="";for(var i=0;i<editTxReceipts.length;i++)p.innerHTML+='<div class="receipt-preview-item"><img src="'+editTxReceipts[i]+'"><button class="remove-receipt" onclick="removeEditTxReceipt('+i+')">×</button></div>';}
window.removeNewsImg=function(i){newsImgs.splice(i,1);renderNewsImgs();};window.removeEditNewsImg=function(i){editNewsImgs.splice(i,1);renderEditNewsImgs();};window.removeTxReceipt=function(i){txReceipts.splice(i,1);renderTxReceipts();};window.removeEditTxReceipt=function(i){editTxReceipts.splice(i,1);renderEditTxReceipts();};
window.showLightbox=function(s){document.getElementById("lightboxImg").src=s;document.getElementById("lightbox").classList.add("show");};

// News Gallery Slider
var newsSliderStates={};
window.slideNews=function(sliderId,dir){
var slider=document.getElementById(sliderId);if(!slider)return;
var total=slider.children.length;
if(!newsSliderStates[sliderId])newsSliderStates[sliderId]=0;
newsSliderStates[sliderId]+=dir;
if(newsSliderStates[sliderId]<0)newsSliderStates[sliderId]=total-1;
if(newsSliderStates[sliderId]>=total)newsSliderStates[sliderId]=0;
var idx=newsSliderStates[sliderId];
slider.style.transform='translateX('+(-idx*100)+'%)';
var counter=document.getElementById(sliderId+'_counter');
if(counter)counter.textContent=total+' / '+(idx+1);
var dots=document.querySelectorAll('#'+sliderId+'_dots .news-gallery-dot');
for(var i=0;i<dots.length;i++){dots[i].classList.toggle('active',i===idx);}
};
window.goToSlide=function(sliderId,idx){
var slider=document.getElementById(sliderId);if(!slider)return;
var total=slider.children.length;
newsSliderStates[sliderId]=idx;
slider.style.transform='translateX('+(-idx*100)+'%)';
var counter=document.getElementById(sliderId+'_counter');
if(counter)counter.textContent=total+' / '+(idx+1);
var dots=document.querySelectorAll('#'+sliderId+'_dots .news-gallery-dot');
for(var i=0;i<dots.length;i++){dots[i].classList.toggle('active',i===idx);}
};

// Touch swipe support for news gallery
document.addEventListener('touchstart',function(e){
var wrapper=e.target.closest('.news-gallery-wrapper');
if(!wrapper)return;
wrapper._touchStartX=e.touches[0].clientX;
},{passive:true});
document.addEventListener('touchend',function(e){
var wrapper=e.target.closest('.news-gallery-wrapper');
if(!wrapper||!wrapper._touchStartX)return;
var diff=wrapper._touchStartX-e.changedTouches[0].clientX;
var slider=wrapper.querySelector('.news-gallery-slider');
if(!slider)return;
var sliderId=slider.id;
if(Math.abs(diff)>50){
slideNews(sliderId,diff>0?1:-1);
}
wrapper._touchStartX=null;
},{passive:true});
window.editM=function(id){
id = String(id);
var m = appData.members.find(function(x){return String(x.id||x._id)===id;});
if(m) openMemberModal(m);
};
window.delM=function(id){
id = String(id);
deleteId=id;
deleteType="member";
document.getElementById("deleteMsg").textContent="هل تريد حذف هذا العضو؟";
document.getElementById("deleteModal").classList.add("show");
};
window.editTx=function(id){
id = String(id);
var t = appData.tx.find(function(x){return String(x.id||x._id)===id;});
if(!t)return;
document.getElementById("editTxId").value=id;
document.getElementById("editTxType").value=t.type;
document.getElementById("editTxDesc").value=t.desc;
document.getElementById("editTxAmount").value=t.amount;
document.getElementById("editTxDate").value=t.date||"";
editTxReceipts=t.receipts?t.receipts.slice():[];
renderEditTxReceipts();
document.getElementById("editTxModal").classList.add("show");
};

function attachTxListeners(){
document.querySelectorAll('.tx-edit-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var txId = this.getAttribute('data-txid');
editTx(txId);
};
});
document.querySelectorAll('.tx-delete-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var txId = this.getAttribute('data-txid');
delTx(txId);
};
});
}

window.delTx=function(id){deleteId=String(id);deleteType="tx";document.getElementById("deleteMsg").textContent="هل تريد حذف هذه المعاملة؟";document.getElementById("deleteModal").classList.add("show");};

window.editNews=function(id){
id = String(id);
var n = appData.news.find(function(x){return String(x.id||x._id)===id;});
if(!n)return;
document.getElementById("editNewsId").value=id;
document.getElementById("editNewsTitle").value=n.title;
document.getElementById("editNewsContent").value=n.content;
editNewsImgs=n.imgs?n.imgs.slice():(n.img?[n.img]:[]);
renderEditNewsImgs();
document.getElementById("editNewsModal").classList.add("show");
};

function attachNewsListeners(){
document.querySelectorAll('.news-edit-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var newsId = this.getAttribute('data-newsid');
editNews(newsId);
};
});
document.querySelectorAll('.news-delete-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var newsId = this.getAttribute('data-newsid');
delNews(newsId);
};
});
}

window.delNews=function(id){deleteId=String(id);deleteType="news";document.getElementById("deleteMsg").textContent="هل تريد حذف هذا الخبر؟";document.getElementById("deleteModal").classList.add("show");};
function loadPending(){
var pl=document.getElementById("pendingList");
var al=document.getElementById("approvedList");
if(!pl)return;
document.getElementById("pendingCount").textContent=appData.pending.length;
document.getElementById("approvedCount").textContent=appData.approved.length;
pl.innerHTML="";
if(appData.pending.length===0){
pl.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px;">لا توجد طلبات معلقة 🎉</p>';
}else{
for(var i=0;i<appData.pending.length;i++){
var p=appData.pending[i];
var familyHtml='';
if(p.familyMembers&&p.familyMembers.length>0){
familyHtml='<div class="pending-family-section"><div class="pending-family-title">👨‍👩‍👧‍👦 '+t('familyMembers')+' ('+p.familyMembers.length+')</div>';
for(var f=0;f<p.familyMembers.length;f++){
var fm=p.familyMembers[f];
familyHtml+='<div class="pending-family-member"><strong>'+fm.name+'</strong>';
if(fm.relation)familyHtml+=' <span style="color:var(--muted);font-size:0.8rem;">('+fm.relation+')</span>';
if(fm.phone)familyHtml+='<br><span style="font-size:0.85rem;">📱 '+fm.phone+'</span>';
if(fm.email)familyHtml+='<br><span style="font-size:0.85rem;">📧 '+fm.email+'</span>';
// عرض إعدادات الخصوصية لفرد العائلة
familyHtml+='<div style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;font-size:0.75rem;">';
familyHtml+='<span style="color:var(--gold);">🔒 '+t('privacySettings')+':</span> ';
familyHtml+=(fm.showMap?'✅':'❌')+' '+t('map')+' | ';
familyHtml+=(fm.showPhone?'✅':'❌')+' '+t('phone')+' | ';
familyHtml+=(fm.showEmail?'✅':'❌')+' '+t('email');
familyHtml+='</div>';
familyHtml+='</div>';
}
familyHtml+='</div>';
}
pl.innerHTML+='<div class="pending-card"><div class="pending-card-header"><div class="pending-card-info"><h3>🇵🇸 '+p.name+'</h3><p>📅 '+(p.date||p.createdAt||'')+'</p></div><div class="pending-card-badge">معلق</div></div><div class="pending-card-details"><div class="pending-detail-item"><label>📱 الهاتف</label><span>'+p.phone+'</span></div>'+(p.email?'<div class="pending-detail-item"><label>📧 البريد</label><span>'+p.email+'</span></div>':'')+'<div class="pending-detail-item"><label>📍 المدينة</label><span>'+p.city+'</span></div>'+(p.originCity?'<div class="pending-detail-item"><label>🇵🇸 البلد الأصلي</label><span>'+p.originCity+'</span></div>':'')+'</div><div class="pending-privacy-options"><div class="pending-privacy-title">🔒 إعدادات الخصوصية المختارة:</div><div class="pending-privacy-item">'+(p.showMap?'✅':'❌')+' الظهور على الخارطة</div><div class="pending-privacy-item">'+(p.showPhone?'✅':'❌')+' إظهار رقم الهاتف</div><div class="pending-privacy-item">'+(p.showEmail?'✅':'❌')+' إظهار البريد الإلكتروني</div></div>'+familyHtml+(p.notes?'<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-bottom:15px;"><label style="font-size:0.7rem;color:var(--muted);">📝 ملاحظات</label><p style="margin:5px 0 0;font-size:0.9rem;">'+p.notes+'</p></div>':'')+'<div class="pending-card-actions"><button class="btn btn-red" onclick="rejectPendingDirect(\''+(p._id||p.id)+'\')">❌ رفض</button><button class="btn btn-green" onclick="approvePendingDirect(\''+(p._id||p.id)+'\')">✅ قبول وإضافة للأعضاء</button></div></div>';
}
}
if(al){
al.innerHTML="";
if(appData.approved.length===0){
al.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px;">لا توجد عائلات مقبولة بعد</p>';
}else{
for(var j=0;j<appData.approved.length;j++){
var fam=appData.approved[j];
var famId = fam.id || fam._id;
var totalMembers=1+(fam.familyMembers?fam.familyMembers.length:0);
var membersHtml='<div class="family-member-row head"><div class="family-member-avatar">👤</div><div class="family-member-info"><h4>'+fam.name+'</h4><p>📱 '+(fam.phone||'')+(fam.email?' | 📧 '+fam.email:'')+'</p></div><div class="family-member-badge">رب الأسرة</div></div>';
if(fam.familyMembers&&fam.familyMembers.length>0){
for(var k=0;k<fam.familyMembers.length;k++){
var member=fam.familyMembers[k];
membersHtml+='<div class="family-member-row"><div class="family-member-avatar">👤</div><div class="family-member-info"><h4>'+member.name+'</h4><p>'+(member.relation?member.relation:'')+(member.phone?' | 📱 '+member.phone:'')+'</p></div></div>';
}
}
al.innerHTML+='<div class="family-card" id="family_'+famId+'" data-famid="'+famId+'"><div class="family-card-header" data-famid="'+famId+'"><h3>🏠 عائلة '+fam.name+' <span class="family-count">'+totalMembers+' أفراد</span></h3><div><span class="family-date">📅 '+(fam.approvedDate||'')+'</span> <span class="expand-icon">▼</span></div></div><div class="family-card-body"><div style="margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.03);border-radius:8px;"><span style="color:var(--muted);font-size:0.85rem;">📍 '+(fam.city||'')+(fam.originCity?' | 🇵🇸 '+fam.originCity:'')+'</span></div>'+membersHtml+'<div class="family-actions"><button class="btn btn-gray btn-sm family-edit-btn" data-famid="'+famId+'">✏️ تعديل</button><button class="btn btn-red btn-sm family-delete-btn" data-famid="'+famId+'">🗑️ حذف</button></div></div></div>';
}
// Attach family event listeners
attachFamilyListeners();
}
}
}

function attachFamilyListeners(){
// Toggle family card
document.querySelectorAll('.family-card-header').forEach(function(header){
header.onclick = function(){
var famId = this.getAttribute('data-famid');
toggleFamily(famId);
};
});
// Edit family
document.querySelectorAll('.family-edit-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var famId = this.getAttribute('data-famid');
editFamily(famId);
};
});
// Delete family
document.querySelectorAll('.family-delete-btn').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var famId = this.getAttribute('data-famid');
deleteFamily(famId);
};
});
}

window.toggleFamily=function(id){
id = String(id);
var card=document.getElementById("family_"+id);
if(card)card.classList.toggle("open");
};

window.editFamily=function(id){
id = String(id);
var fam=appData.approved.find(function(f){return String(f.id||f._id)===id;});
if(!fam)return;

document.getElementById("editFamilyId").value=id;
document.getElementById("editFamilyName").value=fam.name||"";
document.getElementById("editFamilyPhone").value=fam.phone||"";
document.getElementById("editFamilyEmail").value=fam.email||"";
document.getElementById("editFamilyCity").value=fam.city||"";
document.getElementById("editFamilyAddress").value=fam.address||"";
document.getElementById("editFamilyOrigin").value=fam.originCity||"";
document.getElementById("editFamilyLat").value=fam.lat||"";
document.getElementById("editFamilyLng").value=fam.lng||"";
document.getElementById("editFamilyShowMap").checked=fam.showMap||false;
document.getElementById("editFamilyShowPhone").checked=fam.showPhone||false;
document.getElementById("editFamilyShowEmail").checked=fam.showEmail||false;
document.getElementById("editFamilyNotes").value=fam.notes||"";

document.getElementById("editFamilyModal").classList.add("show");
};

window.getCurrentLocationForEdit=function(){
if(navigator.geolocation){
toast("جاري تحديد الموقع...");
navigator.geolocation.getCurrentPosition(function(pos){
document.getElementById("editFamilyLat").value=pos.coords.latitude;
document.getElementById("editFamilyLng").value=pos.coords.longitude;
toast("تم تحديد الموقع ✅");
},function(){toast("فشل تحديد الموقع",true);});
}else{toast("الموقع غير مدعوم",true);}
};

window.saveFamilyEdit=function(){
var id=String(document.getElementById("editFamilyId").value);
var fam=appData.approved.find(function(f){return String(f.id||f._id)===id;});
if(!fam)return;

var oldName=fam.name;
var newName=document.getElementById("editFamilyName").value.trim();
var newPhone=document.getElementById("editFamilyPhone").value.trim();
var newEmail=document.getElementById("editFamilyEmail").value.trim();
var newCity=document.getElementById("editFamilyCity").value.trim();
var newAddress=document.getElementById("editFamilyAddress").value.trim();
var newOrigin=document.getElementById("editFamilyOrigin").value.trim();
var newLat=parseFloat(document.getElementById("editFamilyLat").value)||null;
var newLng=parseFloat(document.getElementById("editFamilyLng").value)||null;
var newShowMap=document.getElementById("editFamilyShowMap").checked;
var newShowPhone=document.getElementById("editFamilyShowPhone").checked;
var newShowEmail=document.getElementById("editFamilyShowEmail").checked;
var newNotes=document.getElementById("editFamilyNotes").value.trim();

// تحديث بيانات العائلة
fam.name=newName;
fam.phone=newPhone;
fam.email=newEmail;
fam.city=newCity;
fam.address=newAddress;
fam.originCity=newOrigin;
fam.lat=newLat;
fam.lng=newLng;
fam.showMap=newShowMap;
fam.showPhone=newShowPhone;
fam.showEmail=newShowEmail;
fam.notes=newNotes;

// تحديث العضو في إدارة الأعضاء (بناءً على الاسم القديم أو الهاتف)
var member=appData.members.find(function(m){
return m.name===oldName || (m.phone && m.phone===newPhone);
});
if(member){
member.name=newName;
member.phone=newPhone;
member.email=newEmail;
member.addressText=newCity+(newAddress?" - "+newAddress:"");
member.lat=newLat;
member.lng=newLng;
member.showMap=newShowMap;
member.showPhone=newShowPhone;
member.showEmail=newShowEmail;
member.notes=newNotes;
}

save();
loadPending();
loadMembers();
loadMarkers();
document.getElementById("editFamilyModal").classList.remove("show");
toast("تم حفظ التعديلات ✅");
};
window.deleteFamily=function(id){
id=String(id);
if(confirm("هل تريد حذف هذه العائلة؟")){
appData.approved=appData.approved.filter(function(f){return String(f.id||f._id)!==id;});
save();
loadPending();
toast("تم الحذف");
}
};
window.toggleApproved=function(){var al=document.getElementById("approvedList");al.style.display=al.style.display==="none"?"block":"none";};
window.viewPending=function(id){for(var i=0;i<appData.pending.length;i++){if(appData.pending[i].id===id){var p=appData.pending[i];currentPendingId=id;var html='<div style="text-align:center;margin-bottom:20px;"><div style="font-size:2rem;">🇵🇸</div><div style="font-weight:700;font-size:1.1rem;">'+p.name+'</div></div>';html+='<div style="background:var(--dark);padding:15px;border-radius:10px;margin-bottom:15px;">';html+='<div style="margin-bottom:8px;"><strong>📱 الهاتف:</strong> '+p.phone+'</div>';if(p.email)html+='<div style="margin-bottom:8px;"><strong>📧 البريد:</strong> '+p.email+'</div>';html+='<div style="margin-bottom:8px;"><strong>📍 المدينة:</strong> '+p.city+'</div>';if(p.address)html+='<div style="margin-bottom:8px;"><strong>🏠 العنوان:</strong> '+p.address+'</div>';if(p.originCity)html+='<div style="margin-bottom:8px;"><strong>🇵🇸 البلد الأصلي:</strong> '+p.originCity+'</div>';if(p.familySize)html+='<div style="margin-bottom:8px;"><strong>👨‍👩‍👧‍👦 عدد الأسرة:</strong> '+p.familySize+'</div>';if(p.notes)html+='<div style="margin-bottom:8px;"><strong>📝 ملاحظات:</strong> '+p.notes+'</div>';html+='</div>';document.getElementById("pendingDetails").innerHTML=html;document.getElementById("pendingModal").classList.add("show");break;}}};
window.approvePendingDirect=async function(id){
id = String(id);
// احفظ بيانات الطلب قبل الحذف
var p=appData.pending.find(function(x){return String(x.id||x._id)===id;});
if(!p){
toast("لم يتم العثور على الطلب",true);
return;
}

// احفظ نسخة من بيانات الطلب
var pendingCopy = JSON.parse(JSON.stringify(p));

if(USE_BACKEND && window.API){
try{
toast("جاري قبول الطلب...");
var result = await window.API.Pending.approve(id);
if(result.success){
// أولاً: تحميل البيانات من Backend
await loadDataFromBackend();
// ثانياً: إضافة للعائلات المقبولة والأعضاء محلياً
addAllFamilyMembers(pendingCopy);
toast("تم قبول العائلة وإضافتهم للأعضاء ✅");
}else{
toast(result.message||"حدث خطأ",true);
}
}catch(err){
console.error(err);
// Fallback to local
approveLocalPending(pendingCopy);
toast("تم قبول العائلة محلياً ✅");
}
}else{
approveLocalPending(p);
toast("تم قبول العائلة وإضافتهم للأعضاء ✅");
}
};

// دالة إضافة كل أفراد العائلة للعائلات المقبولة والأعضاء
function addAllFamilyMembers(p){
var id = p.id || p._id;

// إضافة للعائلات المقبولة (إذا مش موجودة)
var familyExists = appData.approved.find(function(f){return String(f.id||f._id)===String(id) || f.name===p.name;});
if(!familyExists){
var approvedFamily={
id:id,
name:p.name,
phone:p.phone,
email:p.email||"",
city:p.city,
address:p.address||"",
originCity:p.originCity||"",
lat:p.lat||null,
lng:p.lng||null,
showMap:p.showMap||false,
showPhone:p.showPhone||false,
showEmail:p.showEmail||false,
notes:p.notes||"",
familyMembers:p.familyMembers||[],
approvedDate:new Date().toISOString().split("T")[0]
};
appData.approved.push(approvedFamily);
}

// إضافة رب الأسرة للأعضاء (إذا مش موجود)
var headExists = appData.members.find(function(m){return m.name===p.name;});
if(!headExists){
var newMember={
id:Date.now(),
name:p.name,
phone:p.phone||"",
email:p.email||"",
addressText:p.city+(p.address?" - "+p.address:""),
lat:p.lat||null,
lng:p.lng||null,
showMap:p.showMap||false,
showPhone:p.showPhone||false,
showEmail:p.showEmail||false,
notes:"رب الأسرة",
img:"",
voteCode:generateMemberCode(),
familyId:id
};
appData.members.push(newMember);
}

// إضافة كل أفراد العائلة للأعضاء
if(p.familyMembers&&p.familyMembers.length>0){
for(var f=0;f<p.familyMembers.length;f++){
var fm=p.familyMembers[f];
var memberExists = appData.members.find(function(m){return m.name===fm.name;});
if(!memberExists){
var familyMember={
id:Date.now()+f+100,
name:fm.name,
phone:fm.phone||"",
email:fm.email||"",
addressText:p.city+(p.address?" - "+p.address:""),
lat:p.lat||null,
lng:p.lng||null,
showMap:fm.showMap||false,
showPhone:fm.showPhone||false,
showEmail:fm.showEmail||false,
notes:fm.relation||"",
img:"",
voteCode:generateMemberCode(),
familyId:id
};
appData.members.push(familyMember);
}
}
}

save();
loadPending();
loadMembers();
loadCount();
}

// تأكد إن العائلة موجودة بعد تحميل البيانات
function ensureApprovedFamily(p){
var id = p.id || p._id;
var exists = appData.approved.find(function(f){return String(f.id||f._id)===String(id) || f.name===p.name;});
if(!exists){
addAllFamilyMembers(p);
}
loadPending();
}

function approveLocalPending(p){
var id = p.id || p._id;
// إضافة للعائلات المقبولة
var approvedFamily={id:id,name:p.name,phone:p.phone,email:p.email||"",city:p.city,address:p.address||"",originCity:p.originCity||"",lat:p.lat||null,lng:p.lng||null,showMap:p.showMap||false,showPhone:p.showPhone||false,showEmail:p.showEmail||false,notes:p.notes||"",familyMembers:p.familyMembers||[],approvedDate:new Date().toISOString().split("T")[0]};
appData.approved.push(approvedFamily);

// إضافة رب الأسرة لإدارة الأعضاء
var newMember={
id:Date.now(),
name:p.name,
phone:p.phone||"",
email:p.email||"",
addressText:p.city+(p.address?" - "+p.address:""),
lat:p.lat||null,
lng:p.lng||null,
showMap:p.showMap||false,
showPhone:p.showPhone||false,
showEmail:p.showEmail||false,
notes:p.notes||"",
img:"",
voteCode:generateMemberCode()
};
appData.members.push(newMember);

// إضافة أفراد العائلة أيضاً
if(p.familyMembers&&p.familyMembers.length>0){
for(var f=0;f<p.familyMembers.length;f++){
var fm=p.familyMembers[f];
var familyMember={
id:Date.now()+f+1,
name:fm.name,
phone:fm.phone||"",
email:"",
addressText:p.city+(p.address?" - "+p.address:""),
lat:p.lat||null,
lng:p.lng||null,
showMap:p.showMap||false,
showPhone:false,
showEmail:false,
notes:fm.relation?"("+fm.relation+")":"",
img:"",
voteCode:generateMemberCode()
};
appData.members.push(familyMember);
}
}

appData.pending=appData.pending.filter(function(x){return String(x.id||x._id)!==String(id);});
save();
loadPending();
loadCount();
}

window.rejectPendingDirect=async function(id){
id = String(id);
if(USE_BACKEND && window.API){
try{
toast("جاري رفض الطلب...");
var result = await window.API.Pending.reject(id);
if(result.success){
toast("تم رفض الطلب");
await loadDataFromBackend();
}else{
toast(result.message||"حدث خطأ",true);
}
}catch(err){
console.error(err);
// Fallback to local
appData.pending=appData.pending.filter(function(x){return String(x.id||x._id)!==id;});
save();
loadPending();
toast("تم رفض الطلب محلياً");
}
}else{
appData.pending=appData.pending.filter(function(x){return String(x.id||x._id)!==id;});
save();
loadPending();
toast("تم رفض الطلب");
}
};
window.resetRegForm=function(){document.getElementById("registrationForm").reset();document.getElementById("regSuccess").classList.remove("show");document.getElementById("regFormContainer").querySelector("form").style.display="block";document.getElementById("regLocationResult").classList.remove("show");document.getElementById("regLat").value="";document.getElementById("regLng").value="";};
var v=parseInt(localStorage.getItem("visitors")||"0"),ld=localStorage.getItem("lastDay"),td=new Date().toDateString();if(ld!==td){v++;localStorage.setItem("visitors",v.toString());localStorage.setItem("lastDay",td);}document.getElementById("visitors").textContent=v;

// تحميل البيانات من Backend أو Cloud
if(USE_BACKEND && window.API && window.API.Auth.isLoggedIn()){
loadDataFromBackend().then(function(){
loadLogo();loadOrgName();
});
}else{
loadFromCloud(function(){
// ========== النسخ الاحتياطي ==========
window.exportBackup=function(){
  var data=JSON.parse(JSON.stringify(appData));
  data._backupDate=new Date().toISOString();
  data._backupVersion='1.0';
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  var date=new Date().toISOString().split('T')[0];
  a.download='backup-palestinske-'+date+'.json';
  a.click();
  URL.revokeObjectURL(a.href);
  var st=document.getElementById('backupStatus');
  if(st)st.innerHTML='✅ تم تصدير النسخة الاحتياطية بنجاح - '+new Date().toLocaleString('ar-SA');
  toast('تم تصدير البيانات ✅');
};

window.importBackup=function(input){
  if(!input.files||!input.files[0])return;
  var file=input.files[0];
  if(!file.name.endsWith('.json')){toast('❌ يرجى اختيار ملف JSON');return;}
  
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var data=JSON.parse(e.target.result);
      if(!data.members&&!data.news&&!data.transactions&&!data.votes){
        toast('❌ الملف لا يحتوي على بيانات صالحة');return;
      }
      if(!confirm('⚠️ هل أنت متأكد؟\n\nسيتم استبدال جميع البيانات الحالية بالبيانات من النسخة الاحتياطية.\n\nتاريخ النسخة: '+(data._backupDate||'غير معروف'))){
        return;
      }
      // حفظ نسخة من الحالي قبل الاستبدال
      localStorage.setItem('appData_before_import',JSON.stringify(appData));
      
      delete data._backupDate;
      delete data._backupVersion;
      appData=data;
      localStorage.setItem('appData',JSON.stringify(appData));
      
      var st=document.getElementById('backupStatus');
      if(st)st.innerHTML='✅ تم استيراد البيانات بنجاح! جاري إعادة تحميل...';
      toast('تم استيراد البيانات ✅');
      setTimeout(function(){location.reload();},1500);
    }catch(err){
      toast('❌ خطأ في قراءة الملف');
    }
  };
  reader.readAsText(file);
  input.value='';
};

window.exportBackupCloud=function(){
  if(!appData.jsonBinId){toast('❌ لا يوجد اتصال بالسحابة');return;}
  saveToCloud();
  var st=document.getElementById('backupStatus');
  if(st)st.innerHTML='☁️ تم حفظ نسخة على السحابة - '+new Date().toLocaleString('ar-SA');
  toast('تم حفظ نسخة احتياطية على السحابة ✅');
};

// ========== التقارير والإحصائيات ==========
window.switchReport=function(tab){
  document.querySelectorAll('.report-tab').forEach(function(t){t.classList.remove('active');});
  document.querySelectorAll('.report-panel').forEach(function(p){p.classList.remove('active');});
  event.target.classList.add('active');
  var panelId={members:'reportMembers',finance:'reportFinance',voting:'reportVoting',overview:'reportOverview'};
  var panel=document.getElementById(panelId[tab]);
  if(panel)panel.classList.add('active');
  if(tab==='members')loadMembersReport();
  if(tab==='finance')loadFinanceReport();
  if(tab==='voting')loadVotingReport();
  if(tab==='overview')loadOverviewReport();
};

window.initReports=function(){loadMembersReport();};

window.loadMembersReport=function(){
  var members=appData.members||[];
  var approved=appData.approved||[];
  
  document.getElementById('rptTotalMembers').textContent=members.length;
  document.getElementById('rptTotalFamilies').textContent=approved.length;
  
  // أعضاء جدد هذا الشهر
  var now=new Date();var thisMonth=now.getFullYear()+'-'+(now.getMonth()+1<10?'0':'')+(now.getMonth()+1);
  var newCount=members.filter(function(m){return m.date&&m.date.startsWith(thisMonth);}).length;
  document.getElementById('rptNewMembers').textContent=newCount;
  
  // التوزيع حسب المدن
  var cities={};
  members.forEach(function(m){
    var city=m.city||m.kommune||'غير محدد';
    cities[city]=(cities[city]||0)+1;
  });
  var cityArr=Object.keys(cities).map(function(c){return{name:c,count:cities[c]};}).sort(function(a,b){return b.count-a.count;});
  document.getElementById('rptCities').textContent=cityArr.length;
  
  // رسم بياني للمدن
  var maxCity=cityArr.length>0?cityArr[0].count:1;
  var colors=['chart-bar-green','chart-bar-blue','chart-bar-gold','chart-bar-red'];
  var cityHtml='';
  cityArr.slice(0,10).forEach(function(c,i){
    var pct=Math.round((c.count/maxCity)*100);
    cityHtml+='<div class="chart-bar-row"><div class="chart-bar-label">'+c.name+'</div><div class="chart-bar-track"><div class="chart-bar-fill '+colors[i%4]+'" style="width:'+pct+'%">'+c.count+'</div></div></div>';
  });
  document.getElementById('rptCityChart').innerHTML=cityHtml||'<p style="color:var(--muted)">لا توجد بيانات</p>';
  
  // أكبر العائلات
  var famArr=approved.map(function(f){
    var count=members.filter(function(m){return m.familyId===f.id;}).length;
    return{name:f.name||f.father||'عائلة',count:count};
  }).sort(function(a,b){return b.count-a.count;});
  var maxFam=famArr.length>0?famArr[0].count:1;
  var famHtml='';
  famArr.slice(0,8).forEach(function(f,i){
    var pct=maxFam>0?Math.round((f.count/maxFam)*100):0;
    famHtml+='<div class="chart-bar-row"><div class="chart-bar-label">'+f.name+'</div><div class="chart-bar-track"><div class="chart-bar-fill '+colors[i%4]+'" style="width:'+Math.max(pct,5)+'%">'+f.count+'</div></div></div>';
  });
  document.getElementById('rptFamilyChart').innerHTML=famHtml||'<p style="color:var(--muted)">لا توجد بيانات</p>';
  
  // جدول الأعضاء
  var tableHtml='';
  members.forEach(function(m,i){
    tableHtml+='<tr><td>'+(i+1)+'</td><td>'+((m.firstName||'')+' '+(m.lastName||m.name||''))+'</td><td>'+(m.city||m.kommune||'-')+'</td><td dir="ltr">'+(m.phone||'-')+'</td><td>'+(m.date||'-')+'</td></tr>';
  });
  document.getElementById('rptMembersTable').innerHTML=tableHtml||'<tr><td colspan="5" style="text-align:center;color:var(--muted)">لا توجد بيانات</td></tr>';
};

window.loadFinanceReport=function(){
  var tx=appData.transactions||[];
  var period=document.getElementById('rptFinPeriod')?document.getElementById('rptFinPeriod').value:'all';
  
  // فلترة حسب الفترة
  var now=new Date();
  var filtered=tx.filter(function(t){
    if(period==='all')return true;
    if(!t.date)return false;
    var d=new Date(t.date);
    if(period==='month')return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear();
    if(period==='3months'){var m3=new Date();m3.setMonth(m3.getMonth()-3);return d>=m3;}
    if(period==='year')return d.getFullYear()===now.getFullYear();
    return true;
  });
  
  var income=0,expense=0;
  filtered.forEach(function(t){
    var amt=parseFloat(t.amount)||0;
    if(t.type==='income')income+=amt;else expense+=amt;
  });
  
  document.getElementById('rptTotalIncome').textContent=income.toLocaleString();
  document.getElementById('rptTotalExpense').textContent=expense.toLocaleString();
  document.getElementById('rptBalance').textContent=(income-expense).toLocaleString();
  document.getElementById('rptTxCount').textContent=filtered.length;
  
  // رسم بياني
  var maxVal=Math.max(income,expense,1);
  var finHtml='<div class="chart-bar-row"><div class="chart-bar-label">الإيرادات</div><div class="chart-bar-track"><div class="chart-bar-fill chart-bar-green" style="width:'+Math.round((income/maxVal)*100)+'%">'+income.toLocaleString()+' NOK</div></div></div>';
  finHtml+='<div class="chart-bar-row"><div class="chart-bar-label">المصروفات</div><div class="chart-bar-track"><div class="chart-bar-fill chart-bar-red" style="width:'+Math.round((expense/maxVal)*100)+'%">'+expense.toLocaleString()+' NOK</div></div></div>';
  finHtml+='<div class="chart-bar-row"><div class="chart-bar-label">الرصيد</div><div class="chart-bar-track"><div class="chart-bar-fill '+(income>=expense?'chart-bar-gold':'chart-bar-red')+'" style="width:'+Math.round((Math.abs(income-expense)/maxVal)*100)+'%">'+(income-expense).toLocaleString()+' NOK</div></div></div>';
  document.getElementById('rptFinBarChart').innerHTML=finHtml;
  
  // جدول المعاملات
  var tblHtml='';
  filtered.sort(function(a,b){return(b.date||'').localeCompare(a.date||'');}).forEach(function(t,i){
    var cls=t.type==='income'?'color:#00D26A':'color:#E63946';
    var typeLabel=t.type==='income'?'إيراد':'مصروف';
    tblHtml+='<tr><td>'+(i+1)+'</td><td>'+(t.date||'-')+'</td><td>'+(t.description||t.desc||'-')+'</td><td><span style="'+cls+';font-weight:700">'+typeLabel+'</span></td><td style="'+cls+';font-weight:700">'+(parseFloat(t.amount)||0).toLocaleString()+'</td></tr>';
  });
  document.getElementById('rptFinTable').innerHTML=tblHtml||'<tr><td colspan="5" style="text-align:center;color:var(--muted)">لا توجد معاملات</td></tr>';
};

window.loadVotingReport=function(){
  var votes=appData.votes||[];
  var active=votes.filter(function(v){return v.active;});
  var closed=votes.filter(function(v){return!v.active;});
  
  document.getElementById('rptTotalVotes').textContent=votes.length;
  document.getElementById('rptActiveVotes').textContent=active.length;
  document.getElementById('rptClosedVotes').textContent=closed.length;
  
  // متوسط المشاركة
  var totalPart=0,totalVoters=0;
  var totalMembers=appData.members?appData.members.length:0;
  votes.forEach(function(v){
    if(v.options){
      var voteCount=0;
      v.options.forEach(function(o){voteCount+=(o.votes||0);});
      totalPart+=voteCount;
      totalVoters++;
    }
  });
  var avgPart=totalVoters>0&&totalMembers>0?Math.round((totalPart/totalVoters/totalMembers)*100):0;
  document.getElementById('rptAvgParticipation').textContent=avgPart+'%';
  
  // نتائج كل تصويت
  var resHtml='';
  votes.forEach(function(v,vi){
    resHtml+='<div class="chart-container"><div class="chart-title">'+(v.active?'🟢':'🔴')+' '+(v.title||'تصويت '+(vi+1))+'</div>';
    if(v.question)resHtml+='<p style="color:var(--muted);font-size:0.85rem;margin-bottom:12px">'+v.question+'</p>';
    
    var totalV=0;
    if(v.options)v.options.forEach(function(o){totalV+=(o.votes||0);});
    var maxV=0;
    if(v.options)v.options.forEach(function(o){if((o.votes||0)>maxV)maxV=o.votes||0;});
    
    var colors=['chart-bar-green','chart-bar-blue','chart-bar-gold','chart-bar-red'];
    if(v.options){
      v.options.forEach(function(o,oi){
        var pct=totalV>0?Math.round(((o.votes||0)/totalV)*100):0;
        var barW=maxV>0?Math.round(((o.votes||0)/maxV)*100):0;
        var winner=(o.votes||0)===maxV&&maxV>0?' ⭐':'';
        resHtml+='<div class="chart-bar-row"><div class="chart-bar-label">'+(o.text||o.name||'خيار '+(oi+1))+'</div><div class="chart-bar-track"><div class="chart-bar-fill '+colors[oi%4]+'" style="width:'+Math.max(barW,5)+'%">'+(o.votes||0)+' ('+pct+'%)'+winner+'</div></div></div>';
      });
    }
    resHtml+='<p style="color:var(--muted);font-size:0.8rem;margin-top:8px">إجمالي الأصوات: '+totalV+'</p></div>';
  });
  document.getElementById('rptVotingResults').innerHTML=resHtml||'<div class="chart-container"><p style="color:var(--muted);text-align:center">لا توجد تصويتات</p></div>';
};

window.loadOverviewReport=function(){
  var members=appData.members||[];
  var approved=appData.approved||[];
  var tx=appData.transactions||[];
  var news=appData.news||[];
  var votes=appData.votes||[];
  
  var income=0,expense=0;
  tx.forEach(function(t){var a=parseFloat(t.amount)||0;if(t.type==='income')income+=a;else expense+=a;});
  
  var cities={};
  members.forEach(function(m){var c=m.city||m.kommune||'غير محدد';cities[c]=(cities[c]||0)+1;});
  
  document.getElementById('rptOvMembers').textContent=members.length;
  document.getElementById('rptOvFamilies').textContent=approved.length;
  document.getElementById('rptOvNews').textContent=news.length;
  document.getElementById('rptOvBalance').textContent=(income-expense).toLocaleString();
  document.getElementById('rptOvVotes').textContent=votes.length;
  document.getElementById('rptOvCities').textContent=Object.keys(cities).length;
  
  var summaryHtml='<p>📅 <strong>تاريخ التقرير:</strong> '+new Date().toLocaleDateString('ar-SA')+'</p>';
  summaryHtml+='<p>👥 <strong>الأعضاء:</strong> '+members.length+' عضو في '+Object.keys(cities).length+' مدن مختلفة</p>';
  summaryHtml+='<p>👨‍👩‍👧‍👦 <strong>العائلات:</strong> '+approved.length+' عائلة مسجلة</p>';
  summaryHtml+='<p>💰 <strong>المالية:</strong> إيرادات '+income.toLocaleString()+' NOK | مصروفات '+expense.toLocaleString()+' NOK | رصيد '+(income-expense).toLocaleString()+' NOK</p>';
  summaryHtml+='<p>🗳️ <strong>التصويتات:</strong> '+votes.length+' تصويت ('+votes.filter(function(v){return v.active;}).length+' نشط)</p>';
  summaryHtml+='<p>📰 <strong>الأخبار:</strong> '+news.length+' خبر منشور</p>';
  
  if(Object.keys(cities).length>0){
    summaryHtml+='<p>🏙️ <strong>أكبر تجمع:</strong> '+Object.keys(cities).sort(function(a,b){return cities[b]-cities[a];})[0]+' ('+cities[Object.keys(cities).sort(function(a,b){return cities[b]-cities[a];})[0]]+' أعضاء)</p>';
  }
  document.getElementById('rptOverviewSummary').innerHTML=summaryHtml;
};

// طباعة تقرير
window.printReport=function(type){
  var panelId={members:'reportMembers',finance:'reportFinance',voting:'reportVoting',overview:'reportOverview'};
  var panel=document.getElementById(panelId[type]);
  if(!panel)return;
  var w=window.open('','_blank');
  w.document.write('<html dir="rtl"><head><title>تقرير</title><link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet"><style>*{margin:0;padding:0;box-sizing:border-box;font-family:"Tajawal",sans-serif}body{padding:30px;color:#1a1a2e}.report-stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}.report-stat{border:2px solid #009639;border-radius:10px;padding:15px;text-align:center}.report-stat-num{font-size:1.8rem;font-weight:800;color:#009639}.report-stat-label{font-size:0.8rem;color:#666}.chart-container{border:1px solid #ddd;border-radius:10px;padding:20px;margin-bottom:15px}.chart-title{font-weight:700;margin-bottom:15px;color:#009639}.chart-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}.chart-bar-label{width:100px;font-size:0.8rem}.chart-bar-track{flex:1;height:25px;background:#f0f0f0;border-radius:12px;overflow:hidden}.chart-bar-fill{height:100%;border-radius:12px;color:#fff;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;font-size:0.75rem;font-weight:700}.chart-bar-green{background:#009639}.chart-bar-red{background:#CE1126}.chart-bar-gold{background:#DAA520}.chart-bar-blue{background:#4A90D9}.report-table{width:100%;border-collapse:collapse}.report-table th{background:#009639;color:#fff;padding:8px;text-align:right}.report-table td{padding:8px;border-bottom:1px solid #ddd}.report-actions{display:none}h1{text-align:center;color:#009639;margin-bottom:5px}p.sub{text-align:center;color:#666;margin-bottom:20px}</style></head><body>');
  w.document.write('<h1>📊 '+{members:'تقرير الأعضاء',finance:'التقرير المالي',voting:'تقرير التصويت',overview:'تقرير شامل'}[type]+'</h1>');
  w.document.write('<p class="sub">'+new Date().toLocaleDateString('ar-SA')+'</p>');
  w.document.write(panel.innerHTML);
  w.document.write('</body></html>');
  w.document.close();
  w.onload=function(){w.print();};
};

// تصدير PDF
window.exportMembersPDF=function(){generatePDF('members');};
window.exportFinancePDF=function(){generatePDF('finance');};
window.exportVotingPDF=function(){generatePDF('voting');};
window.exportOverviewPDF=function(){generatePDF('overview');};

window.generatePDF=function(type){
  var panelId={members:'reportMembers',finance:'reportFinance',voting:'reportVoting',overview:'reportOverview'};
  var panel=document.getElementById(panelId[type]);
  if(!panel)return;
  if(typeof html2canvas==='undefined'){
    toast('جاري تحميل...');
    var s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    s.onload=function(){var s2=document.createElement('script');s2.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';s2.onload=function(){generatePDF(type);};document.head.appendChild(s2);};
    document.head.appendChild(s);return;
  }
  html2canvas(panel,{scale:2,useCORS:true,backgroundColor:document.body.classList.contains('light-mode')?'#fff':'#0d1117'}).then(function(canvas){
    var img=canvas.toDataURL('image/png');
    var pdf=new jspdf.jsPDF('p','mm','a4');
    var w=190,h=(canvas.height*w)/canvas.width;
    if(h>270){h=270;w=(canvas.width*h)/canvas.height;}
    pdf.addImage(img,'PNG',10,10,w,h);
    pdf.save('report-'+type+'-'+new Date().toISOString().split('T')[0]+'.pdf');
    toast('تم تصدير التقرير ✅');
  });
};

// Theme Toggle - Dark/Light Mode
window.toggleTheme=function(){
  var body=document.body;
  var btn=document.getElementById('themeToggle');
  var isLight=!body.classList.contains('light-mode');
  body.classList.toggle('light-mode');
  if(btn) btn.textContent=isLight?'☀️':'🌙';
  localStorage.setItem('appTheme',isLight?'light':'dark');
  // Smooth transition
  body.style.transition='background 0.5s ease, color 0.3s ease';
  setTimeout(function(){body.style.transition='';},600);
};
document.getElementById('themeToggle').addEventListener('click',toggleTheme);
// Load saved theme
(function(){
  var t=localStorage.getItem('appTheme');
  if(t==='light'){
    document.body.classList.add('light-mode');
    var btn=document.getElementById('themeToggle');
    if(btn) btn.textContent='☀️';
  }
})();

loadLogo();loadNews();loadFinance();loadCount();updateVisibility();loadOrgName();renderHomePage();
});
}
document.getElementById("btnHome").addEventListener("click",function(){goTo("home");renderHomePage();});document.getElementById("btnNews").addEventListener("click",function(){goTo("news");});
document.getElementById("btnAdmin").addEventListener("click",function(){goTo("admin");loadHomeSettings();});document.getElementById("btnBylaws").addEventListener("click",function(){goTo("bylaws");loadBylaws();});document.getElementById("btnVoting").addEventListener("click",function(){goTo("voting");loadFromCloud(loadVoting);});document.getElementById("btnFinance").addEventListener("click",function(){goTo("finance");});document.getElementById("btnMap").addEventListener("click",function(){goTo("map");});document.getElementById("btnRegister").addEventListener("click",function(){goTo("register");});document.getElementById("btnInvitation").addEventListener("click",function(){goTo("invitation");});document.getElementById("btnConfInvite").addEventListener("click",function(){goTo("confInvite");initConfInv();});document.getElementById("btnReports").addEventListener("click",function(){goTo("reports");initReports();});document.getElementById("btnContact").addEventListener("click",function(){goTo("contact");});document.getElementById("btnLive").addEventListener("click",function(){goTo("live");loadFromCloud(function(){loadLiveStreamStatus();loadLiveVotingList();});});document.getElementById("btnMembers").addEventListener("click",function(){goTo("members");});document.getElementById("btnPending").addEventListener("click",function(){goTo("pending");loadPending();});document.getElementById("btnRegistrationSheet").addEventListener("click",function(){goTo("registrationSheet");loadSheet();});document.getElementById("btnManageTx").addEventListener("click",function(){goTo("manageTx");document.getElementById("txDate").value=new Date().toISOString().split("T")[0];loadAdminTx();});document.getElementById("btnManageNews").addEventListener("click",function(){goTo("manageNews");});document.getElementById("btnManageVoting").addEventListener("click",function(){goTo("manageVoting");loadFromCloud(loadAdminVoting);});document.getElementById("btnInbox").addEventListener("click",function(){goTo("inbox");loadFromCloud(loadMessages);});document.getElementById("btnManageLive").addEventListener("click",function(){goTo("manageLive");loadFromCloud(function(){loadAdminLiveVotes();loadLiveStreamStatus();});});
document.getElementById("mobileBtn").addEventListener("click",function(){document.getElementById("sidebar").classList.toggle("open");});
document.getElementById("loginBtn").addEventListener("click",function(){if(isAdmin){isAdmin=false;hideAdmin();goTo("home");toast("تم الخروج");}else{document.getElementById("passInput").value="";document.getElementById("loginModal").classList.add("show");}});
document.getElementById("closeLogin").addEventListener("click",function(){document.getElementById("loginModal").classList.remove("show");});document.getElementById("cancelLogin").addEventListener("click",function(){document.getElementById("loginModal").classList.remove("show");});document.getElementById("loginModal").addEventListener("click",function(e){if(e.target.id==="loginModal")this.classList.remove("show");});
document.getElementById("confirmLogin").addEventListener("click",async function(){
var username=document.getElementById("usernameInput").value.trim();
var password=document.getElementById("passInput").value;

if(!password){
toast("أدخل كلمة المرور",true);
return;
}

if(USE_BACKEND && window.API){
try{
toast("جاري تسجيل الدخول...");
var result=await window.API.Auth.login(username||'admin',password);
if(result.success){
isAdmin=true;
currentUser=result.user;
document.getElementById("loginModal").classList.remove("show");
document.getElementById("usernameInput").value="";
document.getElementById("passInput").value="";
showAdmin();
showBgSwitcher();
loadDataFromBackend();
toast("مرحباً "+result.user.name+" ✅");
}else{
// لو فشل Backend جرب المحلي
var currentPass=appData.adminPass||adminPass||'1234';
if(password===currentPass){
isAdmin=true;adminPass=currentPass;
document.getElementById("loginModal").classList.remove("show");
showAdmin();showBgSwitcher();
toast("تم الدخول (محلي)");
}else{
toast(result.message||"كلمة مرور خاطئة",true);
}
}
}catch(e){
console.error(e);
// لو السيرفر ما رد - جرب المحلي
var currentPass=appData.adminPass||adminPass||'1234';
if(password===currentPass){
isAdmin=true;adminPass=currentPass;
document.getElementById("loginModal").classList.remove("show");
showAdmin();showBgSwitcher();
toast("تم الدخول (محلي)");
}else{
toast("كلمة مرور خاطئة",true);
}
}
}else{
// Local password
var currentPass=appData.adminPass||adminPass||'1234';
if(password===currentPass){
isAdmin=true;adminPass=currentPass;
document.getElementById("loginModal").classList.remove("show");
showAdmin();showBgSwitcher();
toast("تم الدخول");
}else{
toast("كلمة مرور خاطئة",true);
}
}
});
document.getElementById("passInput").addEventListener("keypress",function(e){if(e.key==="Enter")document.getElementById("confirmLogin").click();});
document.getElementById("btnChangePass").addEventListener("click",function(){document.getElementById("oldPass").value="";document.getElementById("newPass").value="";document.getElementById("confirmPass").value="";document.getElementById("passModal").classList.add("show");});document.getElementById("closePass").addEventListener("click",function(){document.getElementById("passModal").classList.remove("show");});document.getElementById("cancelPass").addEventListener("click",function(){document.getElementById("passModal").classList.remove("show");});document.getElementById("passModal").addEventListener("click",function(e){if(e.target.id==="passModal")this.classList.remove("show");});
document.getElementById("confirmPassBtn").addEventListener("click",function(){var o=document.getElementById("oldPass").value,n=document.getElementById("newPass").value,c=document.getElementById("confirmPass").value;var currentPass=appData.adminPass||adminPass||"";if(o!==currentPass){toast("كلمة مرور خاطئة",true);return;}if(n.length<4){toast("4 أحرف على الأقل",true);return;}if(n!==c){toast("غير متطابقة",true);return;}adminPass=n;appData.adminPass=n;save();document.getElementById("passModal").classList.remove("show");toast("تم تغيير كلمة السر ✅");});
document.getElementById("btnLogout").addEventListener("click",function(){isAdmin=false;hideAdmin();hideBgSwitcher();goTo("home");toast("تم الخروج");});
document.getElementById("logoUpload").addEventListener("click",function(){document.getElementById("logoFile").click();});document.getElementById("logoFile").addEventListener("change",function(e){var f=e.target.files[0];if(f){var r=new FileReader();r.onload=function(ev){appData.logo=ev.target.result;save();loadLogo();toast("تم");};r.readAsDataURL(f);}});
document.getElementById("visNews").addEventListener("change",function(){appData.visibility.news=this.value;save();updateVisibility();toast("تم");});document.getElementById("visFinance").addEventListener("change",function(){appData.visibility.finance=this.value;save();updateVisibility();toast("تم");});document.getElementById("visMap").addEventListener("change",function(){appData.visibility.map=this.value;save();updateVisibility();toast("تم");});document.getElementById("visInvitation").addEventListener("change",function(){appData.visibility.invitation=this.value;save();updateVisibility();toast("تم");});document.getElementById("visConfInvite").addEventListener("change",function(){appData.visibility.confInvite=this.value;save();updateVisibility();toast("تم");});document.getElementById("visReports").addEventListener("change",function(){appData.visibility.reports=this.value;save();updateVisibility();toast("تم");});document.getElementById("visBylaws").addEventListener("change",function(){appData.visibility.bylaws=this.value;save();updateVisibility();toast("تم");});document.getElementById("visVoting").addEventListener("change",function(){appData.visibility.voting=this.value;save();updateVisibility();toast("تم");});
document.getElementById("newsImgsUpload").addEventListener("click",function(){document.getElementById("newsImgsFile").click();});document.getElementById("newsImgsFile").addEventListener("change",function(e){var files=e.target.files;for(var i=0;i<files.length;i++){(function(file){var r=new FileReader();r.onload=function(ev){newsImgs.push(ev.target.result);renderNewsImgs();};r.readAsDataURL(file);})(files[i]);}});
document.getElementById("btnPublishNews").addEventListener("click",async function(){
var t=document.getElementById("newNewsTitle").value.trim();
var c=document.getElementById("newNewsContent").value.trim();

if(!t||!c){toast("املأ الحقول",true);return;}

if(USE_BACKEND && window.API){
try{
toast("جاري النشر...");
var result = await window.API.News.create({
title: t,
content: c,
images: newsImgs.slice()
});
if(result.success){
toast("تم النشر ✅");
document.getElementById("newNewsTitle").value="";
document.getElementById("newNewsContent").value="";
newsImgs=[];
renderNewsImgs();
await loadDataFromBackend();
}else{
toast(result.message||"حدث خطأ",true);
}
}catch(err){
console.error(err);
toast(err.message||"خطأ في الاتصال",true);
}
}else{
appData.news.unshift({id:Date.now(),title:t,content:c,date:new Date().toISOString().split("T")[0],imgs:newsImgs.slice()});
save();
loadNews();
loadAdminNews();
document.getElementById("newNewsTitle").value="";
document.getElementById("newNewsContent").value="";
newsImgs=[];
renderNewsImgs();
toast("تم النشر");
sendLocalNotification('📰 خبر جديد - الجالية الفلسطينية', t);
}
});
document.getElementById("txReceiptsUpload").addEventListener("click",function(){document.getElementById("txReceiptsFile").click();});document.getElementById("txReceiptsFile").addEventListener("change",function(e){var files=e.target.files;for(var i=0;i<files.length;i++){(function(file){var r=new FileReader();r.onload=function(ev){txReceipts.push(ev.target.result);renderTxReceipts();};r.readAsDataURL(file);})(files[i]);}});
document.getElementById("btnSaveTx").addEventListener("click",async function(){
var tp=document.getElementById("txType").value;
var ds=document.getElementById("txDesc").value.trim();
var am=parseFloat(document.getElementById("txAmount").value);

if(!ds||!am){toast("املأ الحقول",true);return;}

if(USE_BACKEND && window.API){
try{
toast("جاري الحفظ...");
var result = await window.API.Transactions.create({
type: tp,
description: ds,
amount: am,
receipts: txReceipts.slice()
});
if(result.success){
toast("تم الحفظ ✅");
document.getElementById("txDesc").value="";
document.getElementById("txAmount").value="";
txReceipts=[];
renderTxReceipts();
await loadDataFromBackend();
}else{
toast(result.message||"حدث خطأ",true);
}
}catch(err){
console.error(err);
toast(err.message||"خطأ في الاتصال",true);
}
}else{
appData.tx.unshift({id:Date.now(),type:tp,desc:ds,amount:am,date:document.getElementById("txDate").value||new Date().toISOString().split("T")[0],receipts:txReceipts.slice()});
save();
loadFinance();
loadAdminTx();
document.getElementById("txDesc").value="";
document.getElementById("txAmount").value="";
document.getElementById("txDate").value="";
txReceipts=[];
renderTxReceipts();
toast("تم الحفظ");
}
});
document.getElementById("editTxReceiptsUpload").addEventListener("click",function(){document.getElementById("editTxReceiptsFile").click();});document.getElementById("editTxReceiptsFile").addEventListener("change",function(e){var files=e.target.files;for(var i=0;i<files.length;i++){(function(file){var r=new FileReader();r.onload=function(ev){editTxReceipts.push(ev.target.result);renderEditTxReceipts();};r.readAsDataURL(file);})(files[i]);}});
document.getElementById("closeEditTx").addEventListener("click",function(){document.getElementById("editTxModal").classList.remove("show");});document.getElementById("cancelEditTx").addEventListener("click",function(){document.getElementById("editTxModal").classList.remove("show");});document.getElementById("editTxModal").addEventListener("click",function(e){if(e.target.id==="editTxModal")this.classList.remove("show");});
document.getElementById("saveEditTx").addEventListener("click",function(){var id=String(document.getElementById("editTxId").value);var tp=document.getElementById("editTxType").value;var ds=document.getElementById("editTxDesc").value;var am=parseFloat(document.getElementById("editTxAmount").value);var dt=document.getElementById("editTxDate").value;if(!ds||!am){toast("املأ الحقول",true);return;}var t=appData.tx.find(function(x){return String(x.id||x._id)===id;});if(t){t.type=tp;t.desc=ds;t.amount=am;if(dt)t.date=dt;t.receipts=editTxReceipts.slice();}save();loadFinance();loadAdminTx();document.getElementById("editTxModal").classList.remove("show");toast("تم حفظ التعديلات ✅");});
document.getElementById("editNewsImgsUpload").addEventListener("click",function(){document.getElementById("editNewsImgsFile").click();});document.getElementById("editNewsImgsFile").addEventListener("change",function(e){var files=e.target.files;for(var i=0;i<files.length;i++){(function(file){var r=new FileReader();r.onload=function(ev){editNewsImgs.push(ev.target.result);renderEditNewsImgs();};r.readAsDataURL(file);})(files[i]);}});
document.getElementById("closeEditNews").addEventListener("click",function(){document.getElementById("editNewsModal").classList.remove("show");});document.getElementById("cancelEditNews").addEventListener("click",function(){document.getElementById("editNewsModal").classList.remove("show");});document.getElementById("editNewsModal").addEventListener("click",function(e){if(e.target.id==="editNewsModal")this.classList.remove("show");});
document.getElementById("saveEditNews").addEventListener("click",function(){var id=String(document.getElementById("editNewsId").value);var t=document.getElementById("editNewsTitle").value;var c=document.getElementById("editNewsContent").value;if(!t||!c){toast("املأ الحقول",true);return;}var n=appData.news.find(function(x){return String(x.id||x._id)===id;});if(n){n.title=t;n.content=c;n.imgs=editNewsImgs.slice();}save();loadNews();loadAdminNews();document.getElementById("editNewsModal").classList.remove("show");toast("تم حفظ التعديلات ✅");});
document.getElementById("memberImgUpload").addEventListener("click",function(){document.getElementById("memberImgFile").click();});document.getElementById("memberImgFile").addEventListener("change",function(e){var f=e.target.files[0];if(f){var r=new FileReader();r.onload=function(ev){memberImg=ev.target.result;document.getElementById("memberImgPreview").src=memberImg;document.getElementById("memberImgPreview").style.display="block";};r.readAsDataURL(f);}});
document.getElementById("btnSearchAddress").addEventListener("click",function(){var a=document.getElementById("memberAddressSearch").value.trim();if(!a){toast("أدخل عنوان",true);return;}toast("جاري البحث...");searchAddress(a,function(err,r){if(err){toast(err,true);return;}document.getElementById("memberLat").value=r.lat.toFixed(6);document.getElementById("memberLng").value=r.lng.toFixed(6);document.getElementById("locationText").innerHTML="✅ "+r.display;document.getElementById("locationResult").classList.add("show");toast("تم");});});
document.getElementById("btnResetMap").addEventListener("click",function(){if(myMap)myMap.setView([58.97,5.73],9);});document.getElementById("btnMyLoc").addEventListener("click",function(){if(navigator.geolocation&&myMap){navigator.geolocation.getCurrentPosition(function(p){myMap.setView([p.coords.latitude,p.coords.longitude],14);L.marker([p.coords.latitude,p.coords.longitude]).addTo(myMap).bindPopup("📍 موقعك").openPopup();},function(){toast("تعذر",true);});}});
document.getElementById("btnFindCenter").addEventListener("click",findCenter);document.getElementById("btnAddMember").addEventListener("click",function(){openMemberModal(null);});document.getElementById("closeMember").addEventListener("click",function(){document.getElementById("memberModal").classList.remove("show");});document.getElementById("cancelMember").addEventListener("click",function(){document.getElementById("memberModal").classList.remove("show");});document.getElementById("memberModal").addEventListener("click",function(e){if(e.target.id==="memberModal")this.classList.remove("show");});document.getElementById("saveMember").addEventListener("click",saveMemberData);document.getElementById("btnGetLoc").addEventListener("click",function(){if(navigator.geolocation){navigator.geolocation.getCurrentPosition(function(p){document.getElementById("memberLat").value=p.coords.latitude.toFixed(6);document.getElementById("memberLng").value=p.coords.longitude.toFixed(6);toast("تم");},function(){toast("تعذر",true);});}});
document.getElementById("closeDelete").addEventListener("click",function(){document.getElementById("deleteModal").classList.remove("show");});document.getElementById("cancelDelete").addEventListener("click",function(){document.getElementById("deleteModal").classList.remove("show");});document.getElementById("deleteModal").addEventListener("click",function(e){if(e.target.id==="deleteModal")this.classList.remove("show");});
document.getElementById("confirmDelete").addEventListener("click",async function(){
var id = String(deleteId);
if(USE_BACKEND && window.API){
try{
toast("جاري الحذف...");
var result;
if(deleteType==="member"){
result = await window.API.Members.delete(id);
}else if(deleteType==="tx"){
result = await window.API.Transactions.delete(id);
}else if(deleteType==="news"){
result = await window.API.News.delete(id);
}
if(result && result.success){
toast("تم الحذف ✅");
await loadDataFromBackend();
}else{
// Fallback to local delete
deleteLocally(id, deleteType);
toast("تم الحذف محلياً ✅");
}
}catch(err){
console.error(err);
// Fallback to local delete
deleteLocally(id, deleteType);
toast("تم الحذف محلياً ✅");
}
}else{
deleteLocally(id, deleteType);
toast("تم الحذف");
}
document.getElementById("deleteModal").classList.remove("show");
});

function deleteLocally(id, type){
id = String(id);
if(type==="member"){
appData.members=appData.members.filter(function(m){return String(m.id||m._id)!==id;});
loadMembers();loadCount();loadMarkers();
}else if(type==="tx"){
appData.tx=appData.tx.filter(function(t){return String(t.id||t._id)!==id;});
loadFinance();loadAdminTx();
}else if(type==="news"){
appData.news=appData.news.filter(function(n){return String(n.id||n._id)!==id;});
loadNews();loadAdminNews();
}
save();
}
document.getElementById("closeLightbox").addEventListener("click",function(){document.getElementById("lightbox").classList.remove("show");});document.getElementById("lightbox").addEventListener("click",function(e){if(e.target.id==="lightbox")this.classList.remove("show");});
document.getElementById("iTitle").addEventListener("input",updateInv);document.getElementById("iSub").addEventListener("input",updateInv);document.getElementById("iText").addEventListener("input",updateInv);document.getElementById("iDate").addEventListener("input",updateInv);document.getElementById("iFrom").addEventListener("input",updateInv);document.getElementById("iTo").addEventListener("input",updateInv);document.getElementById("iLoc").addEventListener("input",updateInv);document.getElementById("iWelcome").addEventListener("input",updateInv);

// رفع شعار الدعوة
document.getElementById("invLogoUpload").addEventListener("click",function(){document.getElementById("invLogoFile").click();});
document.getElementById("invLogoFile").addEventListener("change",function(e){
var f=e.target.files[0];
if(f){
var r=new FileReader();
r.onload=function(ev){
appData.invLogo=ev.target.result;
document.getElementById("invLogo").innerHTML='<img src="'+ev.target.result+'" style="max-width:100%;max-height:100%;object-fit:contain;">';
document.getElementById("invLogoUpload").innerHTML='<img src="'+ev.target.result+'" style="width:100%;height:100%;object-fit:cover;border-radius:5px;">';
save();
toast("تم رفع الشعار ✅");
};
r.readAsDataURL(f);
}
});

window.clearInvLogo=function(){
appData.invLogo=null;
document.getElementById("invLogo").innerHTML='';
document.getElementById("invLogoUpload").innerHTML='📷';
save();
toast("تم حذف الشعار");
}

// تحميل شعار الدعوة عند بدء التطبيق
function loadInvLogo(){
if(appData.invLogo){
document.getElementById("invLogo").innerHTML='<img src="'+appData.invLogo+'" style="max-width:100%;max-height:100%;object-fit:contain;">';
document.getElementById("invLogoUpload").innerHTML='<img src="'+appData.invLogo+'" style="width:100%;height:100%;object-fit:cover;border-radius:5px;">';
}
}

document.getElementById("btnDlImg").addEventListener("click",function(){if(typeof html2canvas!=="undefined"){html2canvas(document.getElementById("invCard"),{scale:2,useCORS:true,backgroundColor:"#fff"}).then(function(c){var a=document.createElement("a");a.download="invitation.png";a.href=c.toDataURL("image/png");a.click();toast("تم");});}});
document.getElementById("btnDlPdf").addEventListener("click",function(){if(typeof html2canvas!=="undefined"&&typeof window.jspdf!=="undefined"){html2canvas(document.getElementById("invCard"),{scale:2,useCORS:true,backgroundColor:"#fff"}).then(function(c){var j=window.jspdf.jsPDF,w=210,h=(c.height*w)/c.width,p=new j({orientation:h>w?"portrait":"landscape",unit:"mm",format:[w,h]});p.addImage(c.toDataURL("image/png"),"PNG",0,0,w,h);p.save("invitation.pdf");toast("تم");});}});
document.getElementById("registrationForm").addEventListener("submit",async function(e){
e.preventDefault();
var name=document.getElementById("regName").value.trim();
var phone=document.getElementById("regPhone").value.trim();
var email=document.getElementById("regEmail").value.trim();
var city=document.getElementById("regCity").value.trim();
var address=document.getElementById("regAddress").value.trim();
var originCity=document.getElementById("regOriginCity").value.trim();
var familySize=document.getElementById("regFamilySize").value;
var notes=document.getElementById("regNotes").value.trim();
var showMap=document.getElementById("regShowMap").checked;
var showPhone=document.getElementById("regShowPhone").checked;
var showEmail=document.getElementById("regShowEmail").checked;
var lat=parseFloat(document.getElementById("regLat").value)||null;
var lng=parseFloat(document.getElementById("regLng").value)||null;

if(!name||!phone||!city){toast(t('fillRequiredFields'),true);return;}
var privacyCheck=document.getElementById("regPrivacy");
if(privacyCheck&&!privacyCheck.checked){toast('يرجى الموافقة على سياسة الخصوصية',true);return;}

var familyMembers=[];
var fmCards=document.querySelectorAll(".family-member-card");
fmCards.forEach(function(card,idx){
var fn=card.querySelector('input[name="fm_name_'+idx+'"]');
var fp=card.querySelector('input[name="fm_phone_'+idx+'"]');
var fe=card.querySelector('input[name="fm_email_'+idx+'"]');
var fr=card.querySelector('select[name="fm_relation_'+idx+'"]');
var fShowMap=card.querySelector('input[name="fm_showMap_'+idx+'"]');
var fShowPhone=card.querySelector('input[name="fm_showPhone_'+idx+'"]');
var fShowEmail=card.querySelector('input[name="fm_showEmail_'+idx+'"]');

if(fn&&fn.value.trim()){
familyMembers.push({
name:fn.value.trim(),
phone:fp?fp.value.trim():"",
email:fe?fe.value.trim():"",
relation:fr?fr.value:"",
showMap:fShowMap?fShowMap.checked:true,
showPhone:fShowPhone?fShowPhone.checked:false,
showEmail:fShowEmail?fShowEmail.checked:false
});
}
});

var newPending={
name:name,
phone:phone,
email:email,
city:city,
address:address,
originCity:originCity,
familySize:parseInt(familySize)||1,
familyMembers:familyMembers,
notes:notes,
showMap:showMap,
showPhone:showPhone,
showEmail:showEmail,
lat:lat,
lng:lng
};

// إرسال للـ Backend
if(USE_BACKEND && window.API){
try{
toast("جاري إرسال الطلب...");
var result = await window.API.Pending.submit(newPending);
if(result.success){
document.getElementById("regFormContainer").querySelector("form").style.display="none";
document.getElementById("regSuccess").classList.add("show");
toast(t('requestSentSuccess'));
}else{
toast(result.message||"حدث خطأ",true);
}
}catch(err){
console.error(err);
toast(err.message||"خطأ في الاتصال",true);
}
}else{
// حفظ محلي
newPending.id=Date.now();
newPending.date=new Date().toISOString().split("T")[0];
appData.pending.push(newPending);
save();
document.getElementById("regFormContainer").querySelector("form").style.display="none";
document.getElementById("regSuccess").classList.add("show");
toast(t('requestSentSuccess'));
}
});
document.getElementById("regSearchAddress").addEventListener("click",function(){var addr=document.getElementById("regAddress").value.trim()||document.getElementById("regCity").value.trim();if(!addr){toast("أدخل عنوان أو مدينة",true);return;}toast("جاري البحث...");searchAddress(addr,function(err,r){if(err){toast(err,true);return;}document.getElementById("regLat").value=r.lat.toFixed(6);document.getElementById("regLng").value=r.lng.toFixed(6);document.getElementById("regLocationText").innerHTML="✅ "+r.display;document.getElementById("regLocationResult").classList.add("show");toast("تم العثور على الموقع");});});
document.getElementById("regGetLocation").addEventListener("click",function(){if(navigator.geolocation){toast("جاري تحديد الموقع...");navigator.geolocation.getCurrentPosition(function(pos){document.getElementById("regLat").value=pos.coords.latitude.toFixed(6);document.getElementById("regLng").value=pos.coords.longitude.toFixed(6);document.getElementById("regLocationText").innerHTML="✅ تم تحديد موقعك";document.getElementById("regLocationResult").classList.add("show");toast("تم تحديد الموقع");},function(){toast("تعذر تحديد الموقع",true);});}else{toast("المتصفح لا يدعم تحديد الموقع",true);}});
document.getElementById("closePending").addEventListener("click",function(){document.getElementById("pendingModal").classList.remove("show");});
document.getElementById("pendingModal").addEventListener("click",function(e){if(e.target.id==="pendingModal")this.classList.remove("show");});
document.getElementById("approvePending").addEventListener("click",function(){if(currentPendingId)approvePendingDirect(currentPendingId);document.getElementById("pendingModal").classList.remove("show");});
document.getElementById("rejectPending").addEventListener("click",function(){if(currentPendingId)rejectPendingDirect(currentPendingId);document.getElementById("pendingModal").classList.remove("show");});
var familyMemberCount=0;
document.getElementById("addFamilyMember").addEventListener("click",function(){
var container=document.getElementById("familyMembersContainer");
var idx=familyMemberCount++;
var card=document.createElement("div");
card.className="family-member-card";
card.innerHTML='<button type="button" class="remove-family" onclick="this.parentElement.remove()">×</button>'+
'<div class="family-member-title">👤 '+t('familyMember')+' '+(idx+1)+'</div>'+
'<div class="form-group"><label class="form-label">'+t('fullName')+' *</label><input type="text" class="form-input" name="fm_name_'+idx+'" placeholder="'+t('familyMemberName')+'"></div>'+
'<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">'+
'<div class="form-group"><label class="form-label">'+t('relation')+'</label><select class="form-select" name="fm_relation_'+idx+'"><option value="">'+t('choose')+'...</option><option value="زوج/زوجة">'+t('spouse')+'</option><option value="ابن">'+t('son')+'</option><option value="ابنة">'+t('daughter')+'</option><option value="أب">'+t('father')+'</option><option value="أم">'+t('mother')+'</option><option value="أخ">'+t('brother')+'</option><option value="أخت">'+t('sister')+'</option><option value="آخر">'+t('other')+'</option></select></div>'+
'<div class="form-group"><label class="form-label">'+t('phone')+'</label><input type="tel" class="form-input" name="fm_phone_'+idx+'" placeholder="+47"></div>'+
'</div>'+
'<div class="form-group"><label class="form-label">'+t('email')+'</label><input type="email" class="form-input" name="fm_email_'+idx+'" placeholder="example@email.com"></div>'+
'<div style="margin-top:10px;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;">'+
'<div style="font-size:0.85rem;color:var(--gold);margin-bottom:8px;">🔒 '+t('privacySettings')+'</div>'+
'<div class="checkbox-row" style="margin-bottom:5px;"><input type="checkbox" name="fm_showMap_'+idx+'" id="fm_showMap_'+idx+'" checked><label for="fm_showMap_'+idx+'" style="font-size:0.85rem;">'+t('showOnMap')+'</label></div>'+
'<div class="checkbox-row" style="margin-bottom:5px;"><input type="checkbox" name="fm_showPhone_'+idx+'" id="fm_showPhone_'+idx+'"><label for="fm_showPhone_'+idx+'" style="font-size:0.85rem;">'+t('showPhoneToMembers')+'</label></div>'+
'<div class="checkbox-row"><input type="checkbox" name="fm_showEmail_'+idx+'" id="fm_showEmail_'+idx+'"><label for="fm_showEmail_'+idx+'" style="font-size:0.85rem;">'+t('showEmailToMembers')+'</label></div>'+
'</div>';
container.appendChild(card);
});
if(!appData.sheet)appData.sheet=[];
function loadSheet(){
var tbody=document.getElementById("regSheetBody");
tbody.innerHTML="";
var totalMembers=0,totalPaid=0,totalUnpaid=0,totalAmount=0;
if(appData.sheet.length===0){for(var i=0;i<20;i++){appData.sheet.push({id:i+1,firstName:"",lastName:"",familyCount:"",phone:"",email:"",city:"",fee:"",paid:"",notes:""});}}
for(var j=0;j<appData.sheet.length;j++){
var row=appData.sheet[j];
tbody.innerHTML+='<tr><td class="row-num">'+(j+1)+'</td><td><input type="text" value="'+escapeHtml(row.firstName)+'" onchange="updateSheetCell('+j+',\'firstName\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.lastName)+'" onchange="updateSheetCell('+j+',\'lastName\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.familyCount)+'" onchange="updateSheetCell('+j+',\'familyCount\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.phone)+'" onchange="updateSheetCell('+j+',\'phone\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.email)+'" onchange="updateSheetCell('+j+',\'email\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.city)+'" onchange="updateSheetCell('+j+',\'city\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.fee)+'" onchange="updateSheetCell('+j+',\'fee\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.paid)+'" onchange="updateSheetCell('+j+',\'paid\',this.value)"></td><td><input type="text" value="'+escapeHtml(row.notes)+'" onchange="updateSheetCell('+j+',\'notes\',this.value)"></td></tr>';
if(row.firstName){totalMembers++;var p=row.paid?row.paid.trim().toLowerCase():"";if(p==="نعم"||p==="yes"||p==="1"||p==="✓"||p==="✔"){totalPaid++;totalAmount+=parseFloat(row.fee)||0;}else if(p){totalUnpaid++;}}
}
document.getElementById("sheetTotalMembers").textContent=totalMembers;
document.getElementById("sheetTotalFamilies").textContent=appData.sheet.filter(function(r){return r.firstName;}).length;
document.getElementById("sheetTotalPaid").textContent=totalPaid;
document.getElementById("sheetTotalUnpaid").textContent=totalUnpaid;
document.getElementById("sheetTotalAmount").textContent=totalAmount+" NOK";
loadArchive();
}
function escapeHtml(str){if(!str)return"";return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
window.updateSheetCell=function(idx,field,value){appData.sheet[idx][field]=value;save();};
window.addSheetRow=function(){appData.sheet.push({id:appData.sheet.length+1,firstName:"",lastName:"",familyCount:"",phone:"",email:"",city:"",fee:"",paid:"",notes:""});save();loadSheet();toast("تم إضافة صف جديد");};
window.deleteLastRow=function(){if(appData.sheet.length>1){appData.sheet.pop();save();loadSheet();toast("تم حذف الصف");}else{toast("لا يمكن حذف آخر صف",true);}};
window.saveSheetToArchive=function(){
var year=document.getElementById("sheetYear").textContent.trim()||new Date().getFullYear();
var title=document.getElementById("sheetTitle").textContent.trim();
var filledRows=appData.sheet.filter(function(r){return r.firstName;});
if(filledRows.length===0){toast("الاستمارة فارغة!",true);return;}
var archiveItem={id:Date.now(),year:year,title:title,date:new Date().toISOString().split("T")[0],membersCount:filledRows.length,data:JSON.parse(JSON.stringify(appData.sheet))};
var existingIdx=-1;
for(var i=0;i<appData.sheetArchive.length;i++){if(appData.sheetArchive[i].year===year){existingIdx=i;break;}}
if(existingIdx>=0){if(confirm("يوجد أرشيف لسنة "+year+" هل تريد استبداله؟")){appData.sheetArchive[existingIdx]=archiveItem;}else{return;}}else{appData.sheetArchive.unshift(archiveItem);}
save();loadArchive();toast("تم الحفظ في الأرشيف ✅");
};
function loadArchive(){
var list=document.getElementById("archiveList");
if(!list)return;
list.innerHTML="";
if(!appData.sheetArchive||appData.sheetArchive.length===0){list.innerHTML='<p style="text-align:center;color:var(--muted);padding:20px;">لا يوجد أرشيف</p>';return;}
for(var i=0;i<appData.sheetArchive.length;i++){
var item=appData.sheetArchive[i];
list.innerHTML+='<div class="archive-item"><div class="archive-item-info"><h4>📅 استمارة '+item.year+'</h4><p>'+item.membersCount+' عضو | تاريخ الحفظ: '+item.date+'</p></div><div class="archive-item-actions"><button class="btn btn-gray btn-sm" onclick="loadFromArchive('+item.id+')">📂 فتح</button><button class="btn btn-gold btn-sm" onclick="downloadArchivePDF('+item.id+')">📥 PDF</button><button class="btn btn-red btn-sm" onclick="deleteArchive('+item.id+')">🗑️</button></div></div>';
}
}
window.loadFromArchive=function(id){
for(var i=0;i<appData.sheetArchive.length;i++){
if(appData.sheetArchive[i].id===id){
if(confirm("هل تريد تحميل أرشيف "+appData.sheetArchive[i].year+"؟ سيتم استبدال البيانات الحالية.")){
appData.sheet=JSON.parse(JSON.stringify(appData.sheetArchive[i].data));
document.getElementById("sheetYear").textContent=appData.sheetArchive[i].year;
save();loadSheet();toast("تم تحميل الأرشيف");
}
break;
}
}
};
window.deleteArchive=function(id){
if(confirm("هل تريد حذف هذا الأرشيف؟")){
appData.sheetArchive=appData.sheetArchive.filter(function(a){return a.id!==id;});
save();loadArchive();toast("تم الحذف");
}
};
window.downloadArchivePDF=function(id){
for(var i=0;i<appData.sheetArchive.length;i++){
if(appData.sheetArchive[i].id===id){
var oldSheet=appData.sheet;
appData.sheet=appData.sheetArchive[i].data;
loadSheet();
setTimeout(function(){downloadSheetPDF();appData.sheet=oldSheet;loadSheet();},500);
break;
}
}
};
// محرر استمارة الطباعة
window.openPrintableFormEditor=function(){
var orgNameAr=appData.orgName?appData.orgName.ar:"الجالية الفلسطينية في روغالاند";
var orgNameEn=appData.orgName?appData.orgName.en:"Det palestinske samfunn i Rogaland";

document.getElementById("printFormYear").value=document.getElementById("sheetYear")?document.getElementById("sheetYear").textContent.trim():"2025";

updatePrintFormPreview();
document.getElementById("printFormModal").classList.add("show");
}

window.updatePrintFormPreview=function(){
var orgNameAr=appData.orgName?appData.orgName.ar:"الجالية الفلسطينية في روغالاند";
var orgNameEn=appData.orgName?appData.orgName.en:"Det palestinske samfunn i Rogaland";
var year=document.getElementById("printFormYear").value||"2025";
var rows=parseInt(document.getElementById("printFormRows").value)||20;

var html='<div id="printableFormContent" style="font-family:Tajawal,Arial,sans-serif;direction:rtl;padding:15px;border:2px solid #009639;border-top:6px solid #CE1126;border-bottom:6px solid #000;">';

// Header
html+='<div style="text-align:center;margin-bottom:15px;">';
html+='<div contenteditable="true" style="color:#009639;font-size:14px;margin-bottom:5px;">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>';
html+='<div style="color:#009639;font-size:11px;margin:5px 0;">◆ ────────── ◆</div>';
html+='<div contenteditable="true" style="font-size:18px;color:#009639;margin:5px 0;">🌿 PS 🌿</div>';
html+='<div contenteditable="true" style="font-size:24px;font-weight:700;color:#CE1126;margin:5px 0;">'+orgNameAr+'</div>';
html+='<div contenteditable="true" style="font-size:12px;color:#333;margin-bottom:8px;">'+orgNameEn.toUpperCase()+'</div>';
html+='<div style="color:#009639;font-size:11px;margin:5px 0;">◇◇◇◇◇◇◇◇◇◇◇◇</div>';
html+='<div contenteditable="true" style="font-size:18px;color:#009639;margin:8px 0;">◆ نموذج تسجيل عضوية ◆</div>';
html+='<div contenteditable="true" style="font-size:16px;font-weight:700;color:#CE1126;">للعام '+year+'</div>';
html+='</div>';

// Table
html+='<table style="width:100%;border-collapse:collapse;margin:15px 0;">';
html+='<thead><tr style="background:#009639;color:white;">';
html+='<th style="padding:8px;border:1px solid #009639;width:30px;">م</th>';
html+='<th contenteditable="true" style="padding:8px;border:1px solid #009639;">الاسم الأول</th>';
html+='<th contenteditable="true" style="padding:8px;border:1px solid #009639;">اسم العائلة</th>';
html+='<th contenteditable="true" style="padding:8px;border:1px solid #009639;">رقم الهاتف</th>';
html+='<th contenteditable="true" style="padding:8px;border:1px solid #009639;">المدينة</th>';
html+='<th contenteditable="true" style="padding:8px;border:1px solid #009639;width:50px;">الدفع</th>';
html+='<th contenteditable="true" style="padding:8px;border:1px solid #009639;width:60px;">الرسوم</th>';
html+='<th contenteditable="true" style="padding:8px;border:1px solid #009639;">التوقيع</th>';
html+='</tr></thead><tbody>';

for(var i=1;i<=rows;i++){
var bg=i%2===0?'#f0fff0':'white';
html+='<tr style="background:'+bg+';">';
html+='<td style="padding:10px;border:1px solid #009639;text-align:center;font-weight:700;background:#f5f5f5;">'+i+'</td>';
html+='<td contenteditable="true" style="padding:10px;border:1px solid #009639;min-height:25px;"></td>';
html+='<td contenteditable="true" style="padding:10px;border:1px solid #009639;"></td>';
html+='<td contenteditable="true" style="padding:10px;border:1px solid #009639;"></td>';
html+='<td contenteditable="true" style="padding:10px;border:1px solid #009639;"></td>';
html+='<td contenteditable="true" style="padding:10px;border:1px solid #009639;"></td>';
html+='<td contenteditable="true" style="padding:10px;border:1px solid #009639;"></td>';
html+='<td contenteditable="true" style="padding:10px;border:1px solid #009639;"></td>';
html+='</tr>';
}

html+='</tbody></table>';

// Footer
html+='<div style="text-align:center;margin-top:15px;padding-top:10px;border-top:1px solid #009639;">';
html+='<div style="color:#009639;font-size:11px;margin:5px 0;">◇◇◇◇◇◇◇◇◇◇◇◇</div>';
html+='<div contenteditable="true" style="color:#CE1126;font-size:14px;">◆ فلسطين في القلب ◆</div>';
html+='</div>';

html+='</div>';

document.getElementById("printFormPreview").innerHTML=html;
}

window.closePrintFormEditor=function(){
document.getElementById("printFormModal").classList.remove("show");
}

window.printEditableForm=function(){
var content=document.getElementById("printableFormContent").outerHTML;
var printWindow=window.open("","_blank");
printWindow.document.write('<!DOCTYPE html><html dir="rtl"><head><meta charset="UTF-8"><title>استمارة تسجيل</title>');
printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">');
printWindow.document.write('<style>@page{size:A4 portrait;margin:10mm}body{margin:0;padding:10mm}[contenteditable]{outline:none}</style>');
printWindow.document.write('</head><body>');
printWindow.document.write(content);
printWindow.document.write('</body></html>');
printWindow.document.close();
setTimeout(function(){printWindow.print();},500);
}

window.downloadEditableFormPDF=function(){
toast("جاري إنشاء PDF...");
var element=document.getElementById("printableFormContent");
html2canvas(element,{scale:2,useCORS:true,backgroundColor:'#ffffff'}).then(function(canvas){
var imgData=canvas.toDataURL("image/png");
var pdf=new jspdf.jsPDF("p","mm","a4");
var pdfWidth=pdf.internal.pageSize.getWidth();
var pdfHeight=(canvas.height*pdfWidth)/canvas.width;
pdf.addImage(imgData,"PNG",0,0,pdfWidth,pdfHeight);
pdf.save("استمارة_التسجيل.pdf");
toast("تم تحميل PDF ✅");
closePrintFormEditor();
});
}

window.downloadEmptySheet=function(){
openPrintableFormEditor();
}

window.clearSheet=function(){if(confirm("هل تريد مسح جميع البيانات؟")){appData.sheet=[];save();loadSheet();toast("تم المسح");}};
window.downloadSheetPDF=function(){
var container=document.getElementById("regSheetContainer");
if(typeof html2canvas!=="undefined"&&typeof window.jspdf!=="undefined"){
toast("جاري إنشاء PDF...");
html2canvas(container,{scale:2,useCORS:true,backgroundColor:"#fff",scrollX:0,scrollY:0,width:container.scrollWidth,height:container.scrollHeight}).then(function(canvas){
var imgData=canvas.toDataURL("image/png");
var pdf=new window.jspdf.jsPDF({orientation:"landscape",unit:"mm",format:"a4"});
var pdfWidth=pdf.internal.pageSize.getWidth();
var pdfHeight=(canvas.height*pdfWidth)/canvas.width;
pdf.addImage(imgData,"PNG",0,0,pdfWidth,pdfHeight);
var year=document.getElementById("sheetYear")?document.getElementById("sheetYear").textContent:"";
pdf.save("استمارة_التسجيل_"+year+".pdf");
toast("تم تحميل PDF ✅");
});
}else{toast("خطأ في تحميل المكتبات",true);}
};
window.saveOrgName=function(){
var nameAr=document.getElementById("orgNameAr").value.trim();
var nameEn=document.getElementById("orgNameEn").value.trim();
if(!nameAr){toast("أدخل الاسم بالعربي",true);return;}
appData.orgName={ar:nameAr,en:nameEn};
save();
loadOrgName();
toast("تم حفظ اسم المنظمة ✅");
};
var bylawsData={
goals:{icon:"🎯",title:"الأهداف",subtitle:"الباب الثاني - المادة 9",color:"node-green",sections:[
{title:"ترسيخ الهوية",icon:"🏳️",items:[
{icon:"🇵🇸",text:"تعزيز القيم والمبادئ الوطنية",detail:"العمل على تعزيز القيم والمبادئ الوطنية المنصوص عليها في النظام الداخلي للجالية والحفاظ على الهوية الفلسطينية."},
{icon:"❤️",text:"الحفاظ على الهوية الفلسطينية في المهجر",detail:"تعزيز الشعور بالانتماء للوطن والحفاظ على التراث والثقافة الفلسطينية للأجيال القادمة."}
]},
{title:"الروابط الاجتماعية",icon:"🤝",items:[
{icon:"💪",text:"تقوية أواصر المحبة والأخوة",detail:"بناء علاقات قوية بين أفراد الجالية وتعزيز روح التعاون والتضامن."},
{icon:"🏠",text:"تعزيز الشعور بالانتماء",detail:"خلق بيئة داعمة تشعر كل فلسطيني بأنه جزء من عائلة كبيرة."}
]},
{title:"دعم القضية",icon:"✊",items:[
{icon:"📢",text:"الدعم الكامل لنضال الشعب الفلسطيني",detail:"تقديم الدعم المعنوي والمادي للشعب الفلسطيني في الوطن بكافة الوسائل المشروعة."},
{icon:"⚖️",text:"بكافة أشكاله المشروعة",detail:"وفقاً للقوانين النرويجية والدولية مع الحفاظ على سمعة الجالية."}
]}
]},
membership:{icon:"👥",title:"العضوية",subtitle:"الباب الثالث - المواد 10-16",color:"node-red",sections:[
{title:"فئات العضوية",icon:"📋",items:[
{icon:"✅",text:"العضو العامل: المسدد لاشتراكاته",detail:"هو العضو الذي تنطبق عليه شروط العضوية والمسدد لكافة اشتراكاته. يتمتع بحق التصويت والترشح للهيئة الإدارية بعد مرور 6 شهور من تاريخ تسجيله."},
{icon:"👁️",text:"العضو المراقب: غير المسدد أو من عمره 14-18",detail:"هو العضو الذي لم يسدد اشتراكاته السنوية، أو أبناء الجالية الذين تتراوح أعمارهم بين 14 و18 عاماً. يشارك في الفعاليات لكن بدون حق التصويت أو الترشح."},
{icon:"⭐",text:"عضو الشرف: من قدم خدمات كبيرة",detail:"كل شخص من أصل فلسطيني أو غير فلسطيني قدم خدمات كبيرة أو مواقف داعمة للجالية والقضية الفلسطينية. يحدد من قبل الهيئة الإدارية."}
]},
{title:"حقوق الأعضاء",icon:"✨",items:[
{icon:"🗳️",text:"حق التصويت والترشح",detail:"للعضو العامل الحق في التصويت والترشح للهيئة الإدارية بشرط مرور 6 شهور من تاريخ تسجيله وأن يكون قد أتم 18 عاماً."},
{icon:"🎤",text:"التعبير عن الرأي ديمقراطياً",detail:"ضمن الأطر الشرعية في المؤتمرات والجمعيات العمومية واجتماعات الهيئة الإدارية."},
{icon:"🎉",text:"المشاركة في جميع الفعاليات",detail:"حق المشاركة في جميع فعاليات وأنشطة وبرامج الجالية."}
]},
{title:"شروط العضوية",icon:"📝",items:[
{icon:"📄",text:"تعبئة نموذج طلب التسجيل",detail:"تقديم نموذج طلب تسجيل العضو للهيئة الإدارية لدراسته والموافقة عليه."},
{icon:"💳",text:"دفع رسوم التسجيل والاشتراك السنوي",detail:"دفع رسوم التسجيل التي تحددها الجمعية العامة، والالتزام بتسديد الاشتراك السنوي."},
{icon:"🔞",text:"إكمال 18 عاماً للترشح أو الانتخاب",detail:"يجب أن يكون العضو قد أكمل 18 عاماً للترشح للهيئة الإدارية أو للتصويت في الانتخابات."},
{icon:"📍",text:"الإقامة في منطقة الجالية",detail:"أن يقيم العضو في منطقة روغالاند في النرويج."}
]},
{title:"زوال العضوية",icon:"❌",items:[
{icon:"⚠️",text:"الإخلال بشروط العضوية",detail:"تزول العضوية في حال إخلال العضو بشرط من شروط العضوية، ويحق للهيئة الإدارية إبلاغه بذلك خطياً."},
{icon:"🚚",text:"الانتقال خارج النطاق",detail:"تزول العضوية في حال انتقال العضو وإقامته خارج نطاق الجالية (روغالاند)."},
{icon:"📤",text:"تقديم طلب انسحاب",detail:"يكون الانسحاب بكتاب شخصي موقع عليه أو عبر البريد الإلكتروني الرسمي للجالية."}
]}
]},
admin:{icon:"⚙️",title:"الهيئة الإدارية",subtitle:"الباب السادس - المواد 36-47",color:"node-orange",sections:[
{title:"تكوين الهيئة",icon:"👔",items:[
{icon:"5️⃣",text:"1-50 عضو ← 5 أعضاء هيئة",detail:"إذا كان عدد الأعضاء العاملين من 1 إلى 50 عضو، تتكون الهيئة الإدارية من 5 أعضاء."},
{icon:"7️⃣",text:"51-150 عضو ← 7 أعضاء",detail:"إذا كان عدد الأعضاء العاملين من 51 إلى 150 عضو، تتكون الهيئة الإدارية من 7 أعضاء."},
{icon:"9️⃣",text:"151-250 عضو ← 9 أعضاء",detail:"إذا كان عدد الأعضاء العاملين من 151 إلى 250 عضو، تتكون الهيئة الإدارية من 9 أعضاء."},
{icon:"🔟",text:"أكثر من 250 ← 11 عضو",detail:"إذا كان عدد الأعضاء العاملين أكثر من 250 عضو، تتكون الهيئة الإدارية من 11 عضواً."}
]},
{title:"المناصب",icon:"⭐",items:[
{icon:"👑",text:"الرئيس: يرأس الاجتماعات ويمثل الجالية",detail:"يرأس اجتماعات الهيئة الإدارية ويوقع على كافة مستنداتها. يمثل الجالية في كافة النشاطات والاتصالات الرسمية. يدعو إلى الاجتماعات الطارئة ويوقع أمر الصرف."},
{icon:"🤝",text:"نائب الرئيس: ينوب عن الرئيس",detail:"يقوم بمهام الرئيس في حالة غيابه ويقوم بما يسند إليه من الرئيس أو الهيئة الإدارية."},
{icon:"📝",text:"أمين السر: المحاضر والوثائق",detail:"الدعوة إلى اجتماعات الهيئة الإدارية والتنسيق بين أعضائها. الاحتفاظ بختم ومستندات الجالية وكتابة محاضر الجلسات."},
{icon:"💰",text:"أمين الصندوق: الإشراف المالي",detail:"الإشراف التام على كافة الأمور المالية. جمع الاشتراكات والواردات وتقديم التقارير المالية بشكل دوري."}
]},
{title:"سقوط العضوية",icon:"⚠️",items:[
{icon:"❌",text:"التغيب 3 اجتماعات بدون عذر",detail:"تسقط العضوية عن عضو الهيئة الإدارية في حال التغيب بدون عذر مقبول عن ثلاث اجتماعات متتالية."},
{icon:"✈️",text:"السفر أكثر من 3 أشهر",detail:"تسقط العضوية في حال السفر خارج منطقة الجالية لمدة ثلاثة أشهر متواصلة."},
{icon:"🚫",text:"الإساءة لسمعة الجالية",detail:"تسقط العضوية إذا ثبت أن العضو أساء إلى سمعة الجالية أو قصّر في أداء مهامه."}
]}
]},
elections:{icon:"🗳️",title:"الانتخابات",subtitle:"الباب الرابع - المواد 17-20",color:"node-blue",sections:[
{title:"إجراء الانتخابات",icon:"📊",items:[
{icon:"🔒",text:"الاقتراع السري",detail:"تُجرى الانتخابات بطريقة الاقتراع السري لضمان حرية الاختيار وسرية التصويت."},
{icon:"👁️",text:"فرز الأصوات علناً",detail:"يتم فرز الأصوات علناً أمام الجميع لضمان الشفافية والنزاهة."},
{icon:"🏆",text:"الفائزون بأعلى الأصوات",detail:"تتكون الهيئة الإدارية من المرشحين الحاصلين على أعلى الأصوات تدريجياً."}
]},
{title:"شروط الترشح",icon:"📋",items:[
{icon:"⏰",text:"مرور 6 شهور من التسجيل",detail:"لكل عضو فاعل الحق في الانتخاب والترشح للهيئة الإدارية بشرط أن يكون قد مر 6 شهور من تاريخ تسجيله."},
{icon:"🔞",text:"إتمام 18 عاماً",detail:"يجب أن يكون كل من الناخب والمرشح قد أتم 18 عاماً عند يوم الانتخاب."},
{icon:"✅",text:"تسديد الاشتراكات",detail:"يجب أن تنطبق بنود شروط العضوية على كل من الناخب والمرشح بما فيها تسديد الاشتراكات."}
]}
]},
conferences:{icon:"🏛️",title:"المؤتمرات",subtitle:"الباب الخامس - المواد 21-35",color:"node-purple",sections:[
{title:"المؤتمر العام",icon:"🎤",items:[
{icon:"📅",text:"يعقد سنوياً بدعوة من الهيئة",detail:"يتألف المؤتمر العام من جميع أعضاء الجالية، ويُعقد بناءً على رسالة موجهة من الهيئة الإدارية قبل موعد الانعقاد بأسبوعين على الأقل."},
{icon:"📢",text:"الإعلان قبل أسبوعين",detail:"تتضمن الرسالة جدول أعمال المؤتمر ومكان وزمان الانعقاد."},
{icon:"👥",text:"النصاب: ثلثي الأعضاء العاملين",detail:"يعتبر انعقاد المؤتمر قانونياً إذا حضره ثلثا الأعضاء العاملين، وإذا تعذر ذلك يعقد بالنصف زائد واحد."}
]},
{title:"الجمعية العمومية",icon:"🏠",items:[
{icon:"📆",text:"تنعقد كل 6 شهور",detail:"تنعقد الجمعية العمومية مرة كل 6 شهور على الأقل، وتتألف من جميع الأعضاء المسددين لاشتراكاتهم."},
{icon:"✅",text:"النصاب: النصف زائد واحد",detail:"يعتبر الاجتماع قانونياً إذا حضره النصف زائد واحد من الأعضاء العاملين، وإذا تعذر ذلك يعقد بثلث الأعضاء."}
]},
{title:"القرارات",icon:"✔️",items:[
{icon:"📊",text:"الأغلبية النسبية للتصويت العادي",detail:"تُتخذ قرارات المؤتمر بالأغلبية النسبية للأعضاء الحاضرين العاملين فيما يخص التصويت على التقارير والاقتراحات."},
{icon:"⚖️",text:"ثلثي الأعضاء لتعديل النظام",detail:"تُتخذ القرارات بأغلبية ثلثي الأعضاء الحاضرين العاملين فيما يتعلق بتعديل النظام الداخلي أو نقض قرار مؤتمر سابق."}
]}
]},
finance:{icon:"💰",title:"المالية",subtitle:"الباب السابع",color:"node-teal",sections:[
{title:"الميزانية",icon:"💵",items:[
{icon:"💳",text:"رسوم الانتساب والاشتراك",detail:"تتكون ميزانية الجالية من رسوم الانتساب والاشتراك السنوي الذي تحدده الجمعية العامة."},
{icon:"🎁",text:"التبرعات غير المشروطة",detail:"المساعدات والتبرعات غير المشروطة من الأفراد والمؤسسات الداعمة."},
{icon:"🎪",text:"دخل النشاطات",detail:"دخل النشاطات والفعاليات التي تقوم بها الجالية."}
]},
{title:"إدارة الأموال",icon:"🏦",items:[
{icon:"🏛️",text:"تودع في البنك باسم الجالية",detail:"تودع أموال الجالية في البنك باسم الجالية وتخضع للقوانين والأنظمة المحاسبية النرويجية."},
{icon:"👔",text:"الرئيس وأمين الصندوق مسؤولان",detail:"يكون رئيس الهيئة الإدارية وأمين الصندوق هما المسؤولين عن إدارة الحسابات البنكية."}
]},
{title:"الرقابة",icon:"🔍",items:[
{icon:"✅",text:"مدقق حسابات قانوني معتمد",detail:"تلتزم الهيئة الإدارية بتقديم توصية بترشيح مدقق حسابات قانوني معتمد من الدولة."},
{icon:"📋",text:"تدقيق قبل عرضها على المؤتمر",detail:"يقوم المدقق بتدقيق الحسابات المالية للسنة المالية المنتهية قبل عرضها على المؤتمر العام."}
]}
]},
school:{icon:"📚",title:"المدرسة العربية",subtitle:"المادة 39",color:"node-teal",sections:[
{title:"أقسام المدرسة",icon:"🏫",items:[
{icon:"📖",text:"القسم الأكاديمي: تعليم اللغة العربية",detail:"توفير تعليم أكاديمي شامل لتطوير مهارات القراءة والكتابة والاستماع والتحدث باللغة العربية."},
{icon:"🎭",text:"قسم التراث: الحفاظ على التراث",detail:"الحفاظ على التراث الفلسطيني ونقله إلى الأجيال الجديدة من خلال الأنشطة الثقافية والتراثية."}
]},
{title:"الأهداف",icon:"🎯",items:[
{icon:"✍️",text:"تعليم القراءة والكتابة",detail:"تعليم اللغة العربية بأساليب مبتكرة مع إدماج الثقافة العربية في المناهج الدراسية."},
{icon:"🇵🇸",text:"تعزيز الارتباط بالوطن",detail:"تعريف الطلاب بالثقافة الفلسطينية وتراثها وتعزيز ارتباطهم بوطنهم."},
{icon:"❤️",text:"غرس القيم الوطنية",detail:"غرس القيم الوطنية وتعزيز الوعي بالقضية الفلسطينية لدى الأجيال الجديدة."}
]},
{title:"الأنشطة",icon:"🎨",items:[
{icon:"💃",text:"فرقة دبكة فلسطينية",detail:"فرقة دبكة تضم مجموعتين (شبان وشابات) مع مراعاة القيم والعادات الفلسطينية."},
{icon:"👗",text:"عروض الأزياء التقليدية",detail:"تنظيم فعاليات مثل عروض الأزياء التقليدية والمهرجانات الثقافية."},
{icon:"🎵",text:"الحرف اليدوية والموسيقى",detail:"تعليم الحرف اليدوية والموسيقى الفلسطينية التقليدية."}
]}
]},
penalties:{icon:"⚖️",title:"نظام العقوبات",subtitle:"الباب الثامن - المواد 54-56",color:"node-gold",sections:[
{title:"درجات العقوبات",icon:"📊",items:[
{icon:"1️⃣",text:"التنبيه",detail:"أول درجة من العقوبات، تنبيه شفهي أو كتابي للعضو المخالف."},
{icon:"2️⃣",text:"اللوم",detail:"توجيه لوم رسمي للعضو وتسجيله في محاضر الاجتماعات."},
{icon:"3️⃣",text:"الإنذار",detail:"إنذار رسمي كتابي يُعلم العضو بخطورة المخالفة وعواقب تكرارها."},
{icon:"4️⃣",text:"تجميد العضوية",detail:"تجميد عضوية العضو لفترة زمنية محددة يفقد خلالها كل حقوقه."},
{icon:"5️⃣",text:"الفصل (بثلثي الأصوات)",detail:"فصل العضو نهائياً من الجالية بقرار يصوت عليه ثلثي أعضاء الهيئة الإدارية."}
]},
{title:"ضوابط التطبيق",icon:"📋",items:[
{icon:"🔍",text:"التحقق من الخلل أولاً",detail:"قبل إقرار أي عقوبة، يجب على الهيئة الإدارية أن تبحث في الخلل الحاصل وتتحقق منه."},
{icon:"📞",text:"دعوة العضو للمراجعة",detail:"دعوة العضو المعني لمراجعة الهيئة الإدارية بشأن العقوبة والاستماع لدفاعه."},
{icon:"🚪",text:"نقاش في اجتماع مغلق",detail:"يتم نقاش أي عقوبة في إطار اجتماع مغلق للهيئة الإدارية."},
{icon:"📧",text:"إبلاغ العضو بالقرار خطياً",detail:"استدعاء العضو المعني واطلاعه على العقوبة، وإذا رفض يتم إعلامه بالقرار برسالة مكتوبة."}
]}
]}
};
var nodeAngles=[{key:'goals',angle:0},{key:'membership',angle:45},{key:'admin',angle:90},{key:'elections',angle:135},{key:'conferences',angle:180},{key:'finance',angle:225},{key:'school',angle:270},{key:'penalties',angle:315}];
var expandedBylawNode=null;
function loadBylaws(){positionBylawNodes();if(isAdmin){document.getElementById("btnEditBylaws").classList.remove("hidden");}else{document.getElementById("btnEditBylaws").classList.add("hidden");}}
function positionBylawNodes(){
var container=document.getElementById("bylawsContainer");
if(!container)return;
var rect=container.getBoundingClientRect();
var centerX=rect.width/2;
var centerY=rect.height/2;
var radius=Math.min(rect.width,rect.height)*0.35;
var svg=document.getElementById("bylawsSvg");
var defs=svg.querySelector("defs");
svg.innerHTML="";
svg.appendChild(defs);
nodeAngles.forEach(function(item,index){
var node=document.getElementById("node-"+item.key);
if(!node)return;
var angleRad=(item.angle-90)*Math.PI/180;
var x=centerX+radius*Math.cos(angleRad);
var y=centerY+radius*Math.sin(angleRad);
node.style.left=(x-50)+"px";
node.style.top=(y-50)+"px";
var line=document.createElementNS("http://www.w3.org/2000/svg","line");
line.setAttribute("x1",centerX);
line.setAttribute("y1",centerY);
line.setAttribute("x2",x);
line.setAttribute("y2",y);
line.setAttribute("stroke","url(#grad"+(index+1)+")");
line.setAttribute("class","connection-line");
line.setAttribute("id","line-"+item.key);
svg.appendChild(line);
});
}
window.expandBylawNode=function(key){
console.log("expandBylawNode called with key:",key);
if(expandedBylawNode===key)return;
expandedBylawNode=key;
var data=bylawsData[key];
console.log("data:",data);
if(!data){console.log("No data for key:",key);return;}
document.getElementById("panelIcon").textContent=data.icon;
document.getElementById("panelTitle").textContent=data.title;
document.getElementById("panelSubtitle").textContent=data.subtitle;
var panel=document.getElementById("bylawsPanel");
var nodeColors={"node-green":"linear-gradient(135deg,#009736,#006d28)","node-red":"linear-gradient(135deg,#ce1126,#9a0d1e)","node-orange":"linear-gradient(135deg,#e67e22,#d35400)","node-blue":"linear-gradient(135deg,#3498db,#2980b9)","node-purple":"linear-gradient(135deg,#9b59b6,#7d3c98)","node-teal":"linear-gradient(135deg,#1abc9c,#16a085)","node-gold":"linear-gradient(135deg,#f39c12,#d68910)"};
panel.style.background=nodeColors[data.color]||nodeColors["node-orange"];
var contentHTML="";
data.sections.forEach(function(section){
contentHTML+='<div class="bylaws-section"><h4><span>'+section.icon+'</span> '+section.title+'</h4><ul class="bylaws-list">';
section.items.forEach(function(item){
var detailHtml=item.detail?'<div class="bylaws-item-detail">'+item.detail+'</div>':'';
var arrowHtml=item.detail?'<span class="bylaws-item-arrow">▼</span>':'';
contentHTML+='<li onclick="this.classList.toggle(\'expanded\')"><div class="bylaws-item-header"><span class="item-icon">'+item.icon+'</span><span class="item-text">'+item.text+'</span>'+arrowHtml+'</div>'+detailHtml+'</li>';
});
contentHTML+='</ul></div>';
});
document.getElementById("panelContent").innerHTML=contentHTML;
document.getElementById("bylawsOverlay").classList.add("show");
panel.classList.add("show");
document.getElementById("bylawsCenter").classList.add("shrink");
nodeAngles.forEach(function(item){
var node=document.getElementById("node-"+item.key);
var line=document.getElementById("line-"+item.key);
if(item.key!==key){if(node)node.classList.add("shrink");if(line)line.classList.add("faded");}
});
};
window.closeBylawPanel=function(){
if(!expandedBylawNode)return;
expandedBylawNode=null;
document.getElementById("bylawsOverlay").classList.remove("show");
document.getElementById("bylawsPanel").classList.remove("show");
document.getElementById("bylawsCenter").classList.remove("shrink");
nodeAngles.forEach(function(item){
var node=document.getElementById("node-"+item.key);
var line=document.getElementById("line-"+item.key);
if(node)node.classList.remove("shrink");
if(line)line.classList.remove("faded");
});
}
window.toggleBylawsEdit=function(){
document.getElementById("bylawsEditSection").classList.toggle("show");
loadBylawChaptersSelect();
}
function loadBylawChaptersSelect(){
var select=document.getElementById("editBylawChapter");
if(!select)return;
select.innerHTML="<option value=''>اختر الباب...</option>";
var keys=Object.keys(bylawsData);
keys.forEach(function(key){
var ch=bylawsData[key];
select.innerHTML+="<option value='"+key+"'>"+ch.icon+" "+ch.title+"</option>";
});
}
window.loadBylawSections=function(){
var chKey=document.getElementById("editBylawChapter").value;
var select=document.getElementById("editBylawSection");
select.innerHTML="<option value=''>اختر القسم...</option>";
document.getElementById("editBylawSectionTitle").value="";
document.getElementById("editBylawContent").value="";
if(!chKey||!bylawsData[chKey])return;
var chapter=bylawsData[chKey];
chapter.sections.forEach(function(s,idx){
select.innerHTML+="<option value='"+idx+"'>"+s.icon+" "+s.title+"</option>";
});
}
window.loadBylawContent=function(){
var chKey=document.getElementById("editBylawChapter").value;
var sIdx=document.getElementById("editBylawSection").value;
if(!chKey||sIdx===""||!bylawsData[chKey])return;
var section=bylawsData[chKey].sections[parseInt(sIdx)];
if(!section)return;
document.getElementById("editBylawSectionTitle").value=section.title;
var itemsText=section.items.map(function(item){
return item.text+(item.detail?" | "+item.detail:"");
}).join("\n");
document.getElementById("editBylawContent").value=itemsText;
}
window.saveBylawEdit=function(){
var chKey=document.getElementById("editBylawChapter").value;
var sIdx=document.getElementById("editBylawSection").value;
var title=document.getElementById("editBylawSectionTitle").value.trim();
var content=document.getElementById("editBylawContent").value.trim();
if(!chKey||sIdx===""||!title||!content){toast("أكمل جميع الحقول",true);return;}
var section=bylawsData[chKey].sections[parseInt(sIdx)];
if(!section)return;
section.title=title;
section.items=content.split("\n").filter(function(line){return line.trim();}).map(function(line){
var parts=line.split("|");
return {icon:"📌",text:parts[0].trim(),detail:parts[1]?parts[1].trim():""};
});
toast("تم الحفظ ✅");
}
window.addNewBylawSection=function(){
var chKey=document.getElementById("editBylawChapter").value;
var title=document.getElementById("editBylawSectionTitle").value.trim();
var content=document.getElementById("editBylawContent").value.trim();
if(!chKey){toast("اختر الباب أولاً",true);return;}
if(!title){toast("أدخل عنوان القسم",true);return;}
bylawsData[chKey].sections.push({
title:title,
icon:"📌",
items:content?content.split("\n").filter(function(line){return line.trim();}).map(function(line){
var parts=line.split("|");
return {icon:"📌",text:parts[0].trim(),detail:parts[1]?parts[1].trim():""};
}):[]
});
loadBylawSections();
toast("تم إضافة القسم ✅");
}
window.deleteBylawSection=function(){
var chKey=document.getElementById("editBylawChapter").value;
var sIdx=document.getElementById("editBylawSection").value;
if(!chKey||sIdx===""){toast("اختر الباب والقسم",true);return;}
if(!confirm("هل تريد حذف هذا القسم؟"))return;
bylawsData[chKey].sections.splice(parseInt(sIdx),1);
loadBylawSections();
document.getElementById("editBylawSectionTitle").value="";
document.getElementById("editBylawContent").value="";
toast("تم الحذف");
}
function loadOrgName(){
var nameAr=appData.orgName?appData.orgName.ar:"الجالية الفلسطينية في روغالاند";
var nameEn=appData.orgName?appData.orgName.en:"Det palestinske samfunn i Rogaland";
document.querySelector(".org-name").textContent=nameAr;
document.querySelector(".org-sub").textContent=nameEn;
document.getElementById("orgNameAr").value=nameAr;
document.getElementById("orgNameEn").value=nameEn;
var headerH1=document.querySelector("#pageHome .header h1");
if(headerH1)headerH1.innerHTML="🇵🇸 "+nameAr;
var sheetTitle=document.getElementById("sheetTitle");
if(sheetTitle)sheetTitle.textContent=nameAr;
var sheetSubtitle=document.getElementById("sheetSubtitle");
if(sheetSubtitle)sheetSubtitle.textContent=nameEn+" - استمارة تسجيل الأعضاء";
var invTitle=document.querySelector(".inv-title");
if(invTitle&&!invTitle.dataset.edited)invTitle.textContent=nameAr;
document.title=nameAr;
}
window.clearSheet=function(){if(confirm("هل تريد مسح جميع البيانات؟")){appData.sheet=[];save();loadSheet();toast("تم المسح");}};
window.downloadSheetPDF=function(){
var container=document.getElementById("regSheetContainer");
if(typeof html2canvas!=="undefined"&&typeof window.jspdf!=="undefined"){
toast("جاري إنشاء PDF...");
html2canvas(container,{scale:2,useCORS:true,backgroundColor:"#fff",scrollX:0,scrollY:0,width:container.scrollWidth,height:container.scrollHeight}).then(function(canvas){
var imgData=canvas.toDataURL("image/png");
var pdf=new window.jspdf.jsPDF({orientation:"landscape",unit:"mm",format:"a3"});
var pdfWidth=pdf.internal.pageSize.getWidth();
var pdfHeight=(canvas.height*pdfWidth)/canvas.width;
pdf.addImage(imgData,"PNG",0,0,pdfWidth,pdfHeight);
pdf.save("استمارة_التسجيل_الجالية_الفلسطينية.pdf");
toast("تم تحميل PDF ✅");
});
}else{toast("خطأ في تحميل المكتبات",true);}
};
// ========== نظام التصويت ==========
function initVotes(){if(!appData.votes)appData.votes=[];}
initVotes();

// Toggle vote type options
window.toggleVoteTypeOptions=function(){
var voteType=document.getElementById("newVoteType").value;
var multiSection=document.getElementById("multipleOptionsSection");
if(voteType==="multiple"){
multiSection.style.display="block";
}else{
multiSection.style.display="none";
}
}

function generateMemberCode(){
var chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
var code="";
for(var i=0;i<6;i++)code+=chars.charAt(Math.floor(Math.random()*chars.length));
return code;
}

function ensureMemberCodes(){
if(!appData.members||appData.members.length===0)return;
var changed=false;
appData.members.forEach(function(m){
if(!m.voteCode){m.voteCode=generateMemberCode();changed=true;}
});
if(changed)save();
}

window.regenerateAllCodes=function(){
if(!appData.members||appData.members.length===0){toast("لا يوجد أعضاء",true);return;}
if(!confirm("هل تريد تغيير رموز التصويت لجميع الأعضاء؟\n\nسيتم إنشاء رموز جديدة ويجب إرسالها للأعضاء."))return;

appData.members.forEach(function(m){
m.voteCode=generateMemberCode();
});
save();
loadMembers();
toast("تم تغيير جميع الرموز ✅");

// عرض الرموز الجديدة
var html='<div style="max-height:400px;overflow-y:auto;">';
html+='<p style="color:var(--gold);margin-bottom:15px;">📋 الرموز الجديدة - انسخها وأرسلها للأعضاء:</p>';
html+='<table style="width:100%;border-collapse:collapse;">';
html+='<tr style="background:var(--green);color:white;"><th style="padding:10px;text-align:right;">العضو</th><th style="padding:10px;text-align:center;">الرمز الجديد</th></tr>';
appData.members.forEach(function(m){
html+='<tr style="border-bottom:1px solid var(--border);"><td style="padding:10px;">'+m.name+'</td><td style="padding:10px;text-align:center;font-family:monospace;font-size:1.1rem;color:var(--gold);letter-spacing:2px;">'+m.voteCode+'</td></tr>';
});
html+='</table></div>';
html+='<button class="btn btn-gold" style="margin-top:15px;width:100%;" onclick="copyAllMemberCodes()">📋 نسخ جميع الرموز</button>';
showModal("🔄 رموز التصويت الجديدة",html);
}

window.copyAllMemberCodes=function(){
var text="رموز التصويت الجديدة\n";
text+="========================\n\n";
appData.members.forEach(function(m){
text+=m.name+": "+m.voteCode+"\n";
});
navigator.clipboard.writeText(text).then(function(){toast("تم نسخ الرموز ✅");});
}

// Toggle vote type options
document.addEventListener('DOMContentLoaded', function(){
    var sel = document.getElementById('newVoteType');
    if(sel) sel.onchange = function(){
        var div = document.getElementById('multiOptionsDiv');
        if(div) div.style.display = this.value === 'multiple' ? 'block' : 'none';
    };
    
    // تبديل الخلفيات
    var bgSwitcher = document.getElementById('bgSwitcher');
    if(bgSwitcher){
        var bgBtns = bgSwitcher.querySelectorAll('.bg-btn');
        bgBtns.forEach(function(btn){
            btn.addEventListener('click', function(){
                var bgNum = this.getAttribute('data-bg');
                switchBackground(bgNum);
                
                // تحديث الأزرار
                bgBtns.forEach(function(b){b.classList.remove('active');});
                this.classList.add('active');
                
                // حفظ الاختيار
                localStorage.setItem('selectedBg', bgNum);
            });
        });
        
        // تحميل الاختيار المحفوظ
        var savedBg = localStorage.getItem('selectedBg');
        if(savedBg){
            switchBackground(savedBg);
            bgBtns.forEach(function(b){
                b.classList.remove('active');
                if(b.getAttribute('data-bg') === savedBg) b.classList.add('active');
            });
        }
    }
});

function switchBackground(num){
    var bgs = ['bgAqsa', 'bgPoetry', 'bgDove'];
    bgs.forEach(function(id, index){
        var el = document.getElementById(id);
        if(el){
            if((index + 1) == num){
                el.classList.add('active');
                el.style.display = 'block';
                if(id === 'bgPoetry') startRandomPoetry();
            }else{
                el.classList.remove('active');
                el.style.display = 'none';
            }
        }
    });
}

// إظهار أزرار الخلفية للمسؤول
function showBgSwitcher(){
    var switcher = document.getElementById('bgSwitcher');
    if(switcher) switcher.style.display = 'flex';
}

// إخفاء أزرار الخلفية
function hideBgSwitcher(){
    var switcher = document.getElementById('bgSwitcher');
    if(switcher) switcher.style.display = 'none';
}

// أبيات الشعر الفلسطينية
var poetryLines = [
    {text: '🇵🇸 موطني موطني .. الجلال والجمال والسناء والبهاء في رباك', color: 'rgba(201,162,39,0.25)'},
    {text: '❤️ سجّل أنا عربي .. ورقم بطاقتي خمسون ألف .. وأطفالي ثمانية وتاسعهم سيأتي بعد صيف', color: 'rgba(206,17,38,0.2)'},
    {text: '🌿 على هذه الأرض ما يستحق الحياة .. على هذه الأرض سيدة الأرض أم البدايات', color: 'rgba(0,150,57,0.2)'},
    {text: '🕊️ سنرجع يوماً إلى حيّنا .. ونغرق في دافئات المنى .. سنرجع مهما يمر الزمن', color: 'rgba(255,255,255,0.18)'},
    {text: '⭐ إذا الشعب يوماً أراد الحياة .. فلا بدّ أن يستجيب القدر', color: 'rgba(201,162,39,0.22)'},
    {text: '🏠 وطني يا خيمة بلا عامود .. أحميك بالدم وأنا موجود', color: 'rgba(206,17,38,0.18)'},
    {text: '🌳 أنا من هناك .. أنا من فلسطين .. ولي أم تدعى فلسطين', color: 'rgba(0,150,57,0.22)'},
    {text: '💚 بلادي وإن جارت عليّ عزيزة .. وأهلي وإن ضنّوا عليّ كرام', color: 'rgba(0,150,57,0.2)'},
    {text: '🔑 مفتاح بيتي لا يزال بجيبي .. ومازلت أحفظ رقم داري في يافا', color: 'rgba(201,162,39,0.2)'},
    {text: '🕌 القدس عروس عروبتكم .. فلماذا أدخلتم كل زناة الليل إلى حجرتها', color: 'rgba(201,162,39,0.25)'},
    {text: '🇵🇸 فلسطين ليست قضية لاجئين .. فلسطين قضية شعب يريد أرضه', color: 'rgba(206,17,38,0.2)'},
    {text: '✊ لن نرحل عن أرضنا .. هنا ولدنا وهنا سنموت .. وهنا سنبني ونبني', color: 'rgba(255,255,255,0.2)'},
    {text: '🫒 زيتوننا لا يموت .. وأرضنا لا تنام .. ونحن هنا باقون', color: 'rgba(0,150,57,0.22)'},
    {text: '❤️ في القدس بائع خضار من اللد يرمم صورة والده .. في القدس ما يستحق الحياة', color: 'rgba(206,17,38,0.18)'},
    {text: '🗝️ لنا في كل زاوية ذكرى .. ولنا في كل شارع حكاية .. فلسطين وطننا الأبدي', color: 'rgba(201,162,39,0.2)'},
    {text: '🌅 سنعود إلى بيارات البرتقال .. إلى شوارع يافا وأزقة عكا', color: 'rgba(255,165,0,0.2)'},
    {text: '💪 نحن باقون هنا .. ما بقي الزعتر والزيتون .. ما بقيت السماء زرقاء', color: 'rgba(0,150,57,0.2)'},
    {text: '🌙 يا قدس يا مدينة الصلاة أصلي .. أبكي وأقرع باب دارنا القديمة', color: 'rgba(201,162,39,0.22)'},
    {text: '🏡 من يافا أنا .. ومن حيفا أنا .. ومن القدس ومن غزة .. أنا فلسطيني', color: 'rgba(206,17,38,0.2)'},
    {text: '🌾 أرضي ليست حقيبة .. وأنا لست مسافر .. أنا العاشق والأرض حبيبة', color: 'rgba(0,150,57,0.18)'}
];

var poetryInterval = null;

function startRandomPoetry(){
    var container = document.querySelector('#bgPoetry .poetry-container');
    if(!container) return;
    container.innerHTML = '';
    
    if(poetryInterval) clearInterval(poetryInterval);
    
    // أظهر بيت فوراً
    showRandomPoetryLine(container);
    
    // ثم أظهر أبيات كل 4-8 ثواني بشكل عشوائي
    poetryInterval = setInterval(function(){
        showRandomPoetryLine(container);
    }, 3000 + Math.random() * 4000);
}

function showRandomPoetryLine(container){
    // اختر بيت عشوائي
    var poetry = poetryLines[Math.floor(Math.random() * poetryLines.length)];
    
    // موقع عشوائي (من 5% إلى 85% من ارتفاع الشاشة)
    var topPos = 5 + Math.random() * 80;
    
    // حجم خط عشوائي
    var fontSize = 1.2 + Math.random() * 0.8;
    
    // سرعة عشوائية
    var duration = 20 + Math.random() * 15;
    
    var line = document.createElement('div');
    line.className = 'poetry-line';
    line.textContent = poetry.text;
    line.style.top = topPos + '%';
    line.style.fontSize = fontSize + 'rem';
    line.style.color = poetry.color;
    line.style.animationDuration = duration + 's';
    line.style.opacity = '1';
    line.style.left = '-100%';
    
    container.appendChild(line);
    
    // احذف البيت بعد انتهاء الحركة
    setTimeout(function(){
        if(line.parentNode) line.parentNode.removeChild(line);
    }, duration * 1000);
    
    // حافظ على عدد معقول من الأبيات
    var lines = container.querySelectorAll('.poetry-line');
    if(lines.length > 6){
        lines[0].parentNode.removeChild(lines[0]);
    }
}

window.createNewVote=async function(){
console.log("createNewVote called");
initVotes();
var title=document.getElementById("newVoteTitle").value.trim();
var question=document.getElementById("newVoteQuestion").value.trim();
var voteType=document.getElementById("newVoteType").value;

if(!title||!question){toast("أدخل العنوان والسؤال",true);return;}

var vote={
    title: title,
    question: question,
    type: voteType,
    status: "open",
    voters: [],
    createdAt: new Date().toISOString()
};

if(voteType === "multiple"){
    var optText = document.getElementById("newVoteOptions").value.trim();
    var maxSel = parseInt(document.getElementById("newVoteMaxSel").value) || 1;
    if(!optText){toast("أدخل الخيارات/المرشحين",true);return;}
    var lines = optText.split("\n").map(function(x){return x.trim();}).filter(function(x){return x.length > 0;});
    if(lines.length < 2){toast("أدخل خيارين على الأقل",true);return;}
    vote.options = lines.map(function(name, i){return {id:i, name:name, votes:0};});
    vote.maxSelections = maxSel;
} else {
    vote.votes = {yes:0, no:0};
    vote.maxSelections = 1;
}

if(USE_BACKEND && window.API){
    try{
        toast("جاري إنشاء التصويت...");
        var result = await window.API.Votes.create(vote);
        if(result.success){
            toast("تم إنشاء التصويت ✅");
            document.getElementById("newVoteTitle").value="";
            document.getElementById("newVoteQuestion").value="";
            if(document.getElementById("newVoteOptions")) document.getElementById("newVoteOptions").value="";
            if(document.getElementById("newVoteMaxSel")) document.getElementById("newVoteMaxSel").value="1";
            document.getElementById("newVoteType").value="yesno";
            document.getElementById("multiOptionsDiv").style.display="none";
            await loadDataFromBackend();
        }else{
            toast(result.message||"حدث خطأ",true);
        }
    }catch(err){
        console.error(err);
        toast(err.message||"خطأ في الاتصال",true);
    }
}else{
    if(!appData.members||appData.members.length===0){toast("لا يوجد أعضاء مسجلين",true);return;}
    ensureMemberCodes();
    vote.id=Date.now();
    appData.votes.push(vote);
    save();
    document.getElementById("newVoteTitle").value="";
    document.getElementById("newVoteQuestion").value="";
    if(document.getElementById("newVoteOptions")) document.getElementById("newVoteOptions").value="";
    if(document.getElementById("newVoteMaxSel")) document.getElementById("newVoteMaxSel").value="1";
    document.getElementById("newVoteType").value="yesno";
    document.getElementById("multiOptionsDiv").style.display="none";
    loadAdminVoting();
    toast("تم إنشاء التصويت ✅");
}
}

function loadVoting(){
if(!appData.votes)appData.votes=[];
var list=document.getElementById("votingList");
var noMsg=document.getElementById("noVotingMsg");
list.innerHTML="";

var activeVotes=appData.votes.filter(function(v){return v.status==="open";});

if(activeVotes.length===0){
noMsg.classList.remove("hidden");
return;
}
noMsg.classList.add("hidden");

var totalMembers=appData.members?appData.members.length:0;

activeVotes.forEach(function(vote){
var vid = String(vote.id || vote._id);
var voters = vote.voters || [];

var html='<div class="voting-card active-vote" data-voteid="'+vid+'">';
html+='<div class="voting-header"><div class="voting-title">'+vote.title+'</div><span class="voting-status open">مفتوح</span></div>';
html+='<div class="voting-question">'+vote.question+'</div>';
html+='<div class="voting-code-input"><input type="text" class="vote-code-input" data-vid="'+vid+'" placeholder="أدخل رمز التصويت" maxlength="6" style="text-transform:uppercase;"></div>';

if(vote.type==="multiple" && vote.options && vote.options.length > 0){
// ===== تصويت متعدد الخيارات =====
var maxSel = vote.maxSelections || 1;
html+='<div style="background:rgba(201,162,39,0.15);border:1px solid #c9a227;border-radius:8px;padding:10px 15px;margin-bottom:15px;">';
html+='<span>الاختيارات: <strong class="multi-count" data-vid="'+vid+'">0</strong> / '+maxSel+'</span>';
html+='<span style="float:left;color:#888;">اختر '+maxSel+' كحد أقصى</span>';
html+='</div>';

html+='<div class="multi-options-container" data-vid="'+vid+'" data-max="'+maxSel+'">';
for(var i=0; i<vote.options.length; i++){
    var opt = vote.options[i];
    var optName = opt.name || opt;
    html+='<div class="multi-opt-row" data-vid="'+vid+'" data-idx="'+i+'">';
    html+='<div class="multi-opt-check"></div>';
    html+='<span class="multi-opt-name">'+optName+'</span>';
    html+='</div>';
}
html+='</div>';
html+='<button class="voting-submit multi-submit-btn" data-vid="'+vid+'">🗳️ تأكيد التصويت</button>';

// حساب الأصوات من voters
var optionVotes = {};
vote.options.forEach(function(opt, idx){
var optId = opt.id || opt._id || idx;
optionVotes[optId] = 0;
optionVotes[idx] = 0;
});
voters.forEach(function(voter){
if(voter.selections && voter.selections.length > 0){
voter.selections.forEach(function(sel){
if(optionVotes[sel] !== undefined) optionVotes[sel]++;
else {
vote.options.forEach(function(opt, idx){
var optId = opt.id || opt._id || idx;
if(String(sel) === String(optId) || sel === idx) optionVotes[optId]++;
});
}
});
}
});

var optionsWithVotes = vote.options.map(function(opt, idx){
var optId = opt.id || opt._id || idx;
var calcVotes = optionVotes[optId] || optionVotes[idx] || 0;
return {name: opt.name || opt, votes: Math.max(opt.votes || 0, calcVotes), id: optId};
});

var totalMultiVotes = optionsWithVotes.reduce(function(sum, o){ return sum + (o.votes||0); }, 0);
var sortedOpts = optionsWithVotes.slice().sort(function(a,b){ return (b.votes||0) - (a.votes||0); });

// النتائج - النسبة فقط بدون عدد الأصوات
html+='<div class="voting-results" style="margin-top:20px;"><h4 style="color:var(--gold);margin-bottom:15px;">📊 النتائج الحالية</h4>';
sortedOpts.forEach(function(opt, idx){
    var votes = opt.votes || 0;
    var percent = totalMultiVotes > 0 ? Math.round((votes/totalMultiVotes)*100) : 0;
    var isLeader = idx === 0 && votes > 0;
    html+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;padding:12px;background:var(--dark);border-radius:10px;'+(isLeader?'border:2px solid var(--green);':'border:1px solid var(--border);')+'">';
    html+='<span style="width:30px;height:30px;background:'+(isLeader?'var(--green)':'var(--border)')+';border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:'+(isLeader?'white':'var(--muted)')+';">'+(idx+1)+'</span>';
    html+='<span style="flex:1;font-weight:'+(isLeader?'700':'500')+';color:'+(isLeader?'var(--green)':'var(--text)')+';">'+(opt.name||opt)+'</span>';
    html+='<div style="flex:1;max-width:150px;height:24px;background:var(--border);border-radius:12px;overflow:hidden;"><div style="height:100%;width:'+(percent||3)+'%;background:linear-gradient(90deg,var(--green),#007a2f);border-radius:12px;"></div></div>';
    html+='<span style="min-width:50px;text-align:center;font-weight:700;font-size:1.1rem;color:'+(isLeader?'var(--green)':'var(--text)')+';">'+percent+'%</span>';
    html+='</div>';
});
html+='</div>';

} else {
// ===== موافق / غير موافق =====
// حساب من voters
var yesVotes = 0, noVotes = 0;
voters.forEach(function(voter){
if(voter.vote === 'yes') yesVotes++;
else if(voter.vote === 'no') noVotes++;
});
if(vote.votes){
yesVotes = Math.max(vote.votes.yes || 0, yesVotes);
noVotes = Math.max(vote.votes.no || 0, noVotes);
}

var totalVotes = yesVotes + noVotes;
var yesPercent = totalVotes > 0 ? Math.round((yesVotes/totalVotes)*100) : 0;
var noPercent = totalVotes > 0 ? Math.round((noVotes/totalVotes)*100) : 0;

html+='<div class="yesno-options" data-vid="'+vid+'">';
html+='<div class="yesno-opt" data-vid="'+vid+'" data-val="yes"><div class="yesno-radio"></div><span>✅ موافق</span></div>';
html+='<div class="yesno-opt" data-vid="'+vid+'" data-val="no"><div class="yesno-radio"></div><span>❌ غير موافق</span></div>';
html+='</div>';
html+='<button class="voting-submit yesno-submit-btn" data-vid="'+vid+'">🗳️ تأكيد التصويت</button>';

// النتائج - النسبة فقط بدون عدد الأصوات
html+='<div class="voting-results" style="margin-top:20px;"><h4 style="color:var(--gold);margin-bottom:15px;">📊 النتائج الحالية</h4>';
html+='<div class="voting-result-bar"><div class="voting-result-label"><span>✅ موافق</span><span style="font-weight:700;font-size:1.1rem;color:var(--green);">'+yesPercent+'%</span></div><div class="voting-result-progress"><div class="voting-result-fill yes" style="width:'+(yesPercent||5)+'%"></div></div></div>';
html+='<div class="voting-result-bar"><div class="voting-result-label"><span>❌ غير موافق</span><span style="font-weight:700;font-size:1.1rem;color:var(--red);">'+noPercent+'%</span></div><div class="voting-result-progress"><div class="voting-result-fill no" style="width:'+(noPercent||5)+'%"></div></div></div>';
html+='</div>';
}

html+='</div>';
list.innerHTML+=html;
});

// Attach event listeners after rendering
attachVotingListeners();
}

var multiSelections = {};
var yesnoSelections = {};

function attachVotingListeners(){
// Multi-option click
document.querySelectorAll('.multi-opt-row').forEach(function(row){
    row.onclick = function(){
        var vid = this.getAttribute('data-vid');
        var idx = parseInt(this.getAttribute('data-idx'));
        var container = document.querySelector('.multi-options-container[data-vid="'+vid+'"]');
        var maxSel = parseInt(container.getAttribute('data-max')) || 1;
        
        if(!multiSelections[vid]) multiSelections[vid] = [];
        var sel = multiSelections[vid];
        var pos = sel.indexOf(idx);
        
        if(pos !== -1){
            // Deselect
            sel.splice(pos, 1);
            this.classList.remove('selected');
        } else {
            // Select
            if(sel.length >= maxSel){
                // Remove oldest
                var oldIdx = sel.shift();
                var oldRow = document.querySelector('.multi-opt-row[data-vid="'+vid+'"][data-idx="'+oldIdx+'"]');
                if(oldRow) oldRow.classList.remove('selected');
            }
            sel.push(idx);
            this.classList.add('selected');
        }
        
        // Update count
        var countEl = document.querySelector('.multi-count[data-vid="'+vid+'"]');
        if(countEl) countEl.textContent = sel.length;
    };
});

// Yes/No click
document.querySelectorAll('.yesno-opt').forEach(function(opt){
    opt.onclick = function(){
        var vid = this.getAttribute('data-vid');
        var val = this.getAttribute('data-val');
        yesnoSelections[vid] = val;
        
        // Update UI
        document.querySelectorAll('.yesno-opt[data-vid="'+vid+'"]').forEach(function(o){
            o.classList.remove('selected');
        });
        this.classList.add('selected');
    };
});

// Multi submit
document.querySelectorAll('.multi-submit-btn').forEach(function(btn){
    btn.onclick = function(){ submitMultiVote(this.getAttribute('data-vid')); };
});

// Yes/No submit
document.querySelectorAll('.yesno-submit-btn').forEach(function(btn){
    btn.onclick = function(){ submitYesNoVote(this.getAttribute('data-vid')); };
});
}

async function submitYesNoVote(vid){
var codeInput = document.querySelector('.vote-code-input[data-vid="'+vid+'"]');
var code = codeInput ? codeInput.value.trim().toUpperCase() : '';
var option = yesnoSelections[vid];

if(!code){ toast('أدخل رمز التصويت', true); return; }
if(!option){ toast('اختر موافق أو غير موافق', true); return; }

if(USE_BACKEND && window.API){
    try{
        toast('جاري تسجيل صوتك...');
        var result = await window.API.Votes.submitVote(vid, code, option);
        if(result.success){
            toast('تم تسجيل صوتك بنجاح ✅');
            codeInput.value = '';
            yesnoSelections[vid] = null;
            await loadDataFromBackend();
        } else {
            toast(result.message || 'حدث خطأ', true);
        }
    } catch(err){
        toast(err.message || 'خطأ في الاتصال', true);
    }
} else {
    var vote = appData.votes.find(function(v){ return String(v.id||v._id) === vid; });
    if(!vote){ toast('التصويت غير موجود', true); return; }
    
    var member = appData.members.find(function(m){ return m.voteCode === code; });
    if(!member){ toast('رمز التصويت غير صحيح', true); return; }
    
    if(!vote.voters) vote.voters = [];
    var already = vote.voters.find(function(v){ return v.memberId === member.id; });
    if(already){ toast('لقد صوّتت مسبقاً', true); return; }
    
    if(!vote.votes) vote.votes = {yes:0, no:0};
    vote.votes[option]++;
    vote.voters.push({memberId: member.id, memberName: member.name, vote: option, time: new Date().toISOString()});
    
    save();
    codeInput.value = '';
    yesnoSelections[vid] = null;
    loadVoting();
    toast('تم تسجيل صوتك بنجاح ✅');
}
}

async function submitMultiVote(vid){
var codeInput = document.querySelector('.vote-code-input[data-vid="'+vid+'"]');
var code = codeInput ? codeInput.value.trim().toUpperCase() : '';
var sel = multiSelections[vid] || [];

if(!code){ toast('أدخل رمز التصويت', true); return; }
if(sel.length === 0){ toast('اختر خياراً واحداً على الأقل', true); return; }

if(USE_BACKEND && window.API){
    try{
        toast('جاري تسجيل صوتك...');
        var result = await window.API.Votes.submitVote(vid, code, null, sel);
        if(result.success){
            toast('تم تسجيل صوتك بنجاح ✅');
            codeInput.value = '';
            multiSelections[vid] = [];
            await loadDataFromBackend();
        } else {
            toast(result.message || 'حدث خطأ', true);
        }
    } catch(err){
        toast(err.message || 'خطأ في الاتصال', true);
    }
} else {
    var vote = appData.votes.find(function(v){ return String(v.id||v._id) === vid; });
    if(!vote){ toast('التصويت غير موجود', true); return; }
    
    var member = appData.members.find(function(m){ return m.voteCode === code; });
    if(!member){ toast('رمز التصويت غير صحيح', true); return; }
    
    if(!vote.voters) vote.voters = [];
    var already = vote.voters.find(function(v){ return v.memberId === member.id; });
    if(already){ toast('لقد صوّتت مسبقاً', true); return; }
    
    sel.forEach(function(idx){
        if(vote.options && vote.options[idx]){
            vote.options[idx].votes = (vote.options[idx].votes || 0) + 1;
        }
    });
    
    vote.voters.push({memberId: member.id, memberName: member.name, selections: sel, time: new Date().toISOString()});
    
    save();
    codeInput.value = '';
    multiSelections[vid] = [];
    loadVoting();
    toast('تم تسجيل صوتك بنجاح ✅');
}
}

var selectedVotes={};
var multiSelectedOptions={};

// Old functions removed - using new voting system above


function loadAdminVoting(){
var list=document.getElementById("adminVotingList");
list.innerHTML="";

if(!appData.votes||appData.votes.length===0){
list.innerHTML='<div class="voting-empty"><div class="voting-empty-icon">🗳️</div><p>لا توجد تصويتات</p></div>';
return;
}

appData.votes.forEach(function(vote){
var voters = vote.voters || [];
var votedCount = voters.length;
var totalMembers=appData.members?appData.members.length:0;
var isMultiple=vote.type==="multiple"&&vote.options;

var html='<div class="voting-card '+(vote.status==="open"?"active-vote":"closed-vote")+'">';
html+='<div class="voting-header"><div class="voting-title">'+vote.title+'</div><span class="voting-status '+(vote.status==="open"?"open":"closed")+'">'+(vote.status==="open"?"مفتوح":"مغلق")+'</span></div>';
html+='<div class="voting-question">'+vote.question+'</div>';

if(isMultiple){
html+='<div style="margin:10px 0;padding:10px;background:rgba(201,162,39,0.1);border-radius:8px;"><span style="color:var(--gold);font-weight:600;">📋 '+vote.options.length+' خيارات</span> | <span style="color:var(--muted);">مسموح '+vote.maxSelections+' '+(vote.maxSelections===1?'صوت':'أصوات')+' لكل عضو</span></div>';

// حساب الأصوات لكل خيار من voters
var optionVotes = {};
vote.options.forEach(function(opt, idx){
var optId = opt.id || opt._id || idx;
optionVotes[optId] = 0;
optionVotes[idx] = 0; // Also track by index
});

// Count votes from voters array
voters.forEach(function(voter){
if(voter.selections && voter.selections.length > 0){
voter.selections.forEach(function(sel){
if(optionVotes[sel] !== undefined){
optionVotes[sel]++;
} else {
// Try to match by index or string
vote.options.forEach(function(opt, idx){
var optId = opt.id || opt._id || idx;
if(String(sel) === String(optId) || sel === idx){
optionVotes[optId] = (optionVotes[optId] || 0) + 1;
}
});
}
});
}
});

// Build options with calculated votes
var optionsWithVotes = vote.options.map(function(opt, idx){
var optId = opt.id || opt._id || idx;
var calculatedVotes = optionVotes[optId] || optionVotes[idx] || 0;
// Use stored votes if available and greater
var finalVotes = Math.max(opt.votes || 0, calculatedVotes);
return {name: opt.name, votes: finalVotes, id: optId};
});

// Show results for multiple choice
html+='<div style="margin:15px 0;">';
var sortedOptions=optionsWithVotes.slice().sort(function(a,b){return (b.votes||0)-(a.votes||0);});
var totalVotesMulti = sortedOptions.reduce(function(sum, o){ return sum + (o.votes||0); }, 0);
sortedOptions.forEach(function(opt,idx){
var votes = opt.votes || 0;
var percent=totalVotesMulti>0?Math.round((votes/totalVotesMulti)*100):0;
html+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;padding:12px;background:var(--dark);border-radius:8px;'+(idx===0&&votes>0?'border:2px solid var(--green);':'')+'">';
html+='<span style="width:30px;height:30px;background:'+(idx===0&&votes>0?'var(--green)':'var(--border)')+';border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:'+(idx===0&&votes>0?'white':'var(--muted)')+';">'+(idx+1)+'</span>';
html+='<span style="flex:1;font-weight:600;color:'+(idx===0&&votes>0?'var(--green)':'var(--text)')+';">'+opt.name+'</span>';
html+='<div style="width:120px;height:24px;background:var(--border);border-radius:12px;overflow:hidden;"><div style="height:100%;width:'+(percent||3)+'%;background:linear-gradient(90deg,var(--green),#007a2f);border-radius:12px;"></div></div>';
html+='<span style="min-width:80px;text-align:left;font-weight:700;color:'+(idx===0&&votes>0?'var(--green)':'var(--text)')+';">'+votes+' <small style="color:var(--muted);">('+percent+'%)</small></span>';
html+='</div>';
});
html+='<div style="margin-top:15px;padding:12px;background:rgba(201,162,39,0.15);border-radius:8px;text-align:center;border:1px solid var(--gold);"><span style="color:var(--muted);">📊 إجمالي الأصوات: </span><span style="font-size:1.2rem;font-weight:700;color:var(--gold);">'+totalVotesMulti+'</span></div>';
html+='</div>';
}else{
// Yes/No results - حساب من voters
var yesVotes = 0;
var noVotes = 0;

voters.forEach(function(voter){
if(voter.vote === 'yes') yesVotes++;
else if(voter.vote === 'no') noVotes++;
});

// Use stored votes if available and greater
if(vote.votes){
yesVotes = Math.max(vote.votes.yes || 0, yesVotes);
noVotes = Math.max(vote.votes.no || 0, noVotes);
}

var totalVotes=yesVotes+noVotes;
var yesPercent=totalVotes>0?Math.round((yesVotes/totalVotes)*100):0;
var noPercent=totalVotes>0?Math.round((noVotes/totalVotes)*100):0;

html+='<div class="voting-results">';
html+='<div class="voting-result-bar"><div class="voting-result-label"><span>✅ موافق</span><span style="font-weight:700;color:var(--green);">'+yesVotes+' ('+yesPercent+'%)</span></div><div class="voting-result-progress"><div class="voting-result-fill yes" style="width:'+(yesPercent||3)+'%">'+yesVotes+'</div></div></div>';
html+='<div class="voting-result-bar"><div class="voting-result-label"><span>❌ غير موافق</span><span style="font-weight:700;color:var(--red);">'+noVotes+' ('+noPercent+'%)</span></div><div class="voting-result-progress"><div class="voting-result-fill no" style="width:'+(noPercent||3)+'%">'+noVotes+'</div></div></div>';
html+='<div style="margin-top:15px;padding:12px;background:rgba(201,162,39,0.15);border-radius:8px;text-align:center;border:1px solid var(--gold);"><span style="color:var(--muted);">📊 إجمالي الأصوات: </span><span style="font-size:1.2rem;font-weight:700;color:var(--gold);">'+totalVotes+'</span></div>';
html+='</div>';
}

html+='<div class="voting-stats"><div class="voting-stat"><div class="voting-stat-value" style="color:var(--green);">'+votedCount+'<span style="color:var(--muted);">/'+totalMembers+'</span></div><div class="voting-stat-label">صوتوا</div></div></div>';

var adminVoteId=vote.id||vote._id;
html+='<div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;">';
if(vote.status==="open"){
html+='<button class="btn btn-red btn-sm" onclick="closeVote(\''+adminVoteId+'\')">🔒 إغلاق التصويت</button>';
}else{
html+='<button class="btn btn-green btn-sm" onclick="reopenVote(\''+adminVoteId+'\')">🔓 إعادة فتح</button>';
}
html+='<button class="btn btn-gold btn-sm" onclick="showVoteCodes(\''+adminVoteId+'\')">🔑 عرض الرموز</button>';
html+='<button class="btn btn-gray btn-sm" onclick="showVotersList(\''+adminVoteId+'\')">👥 من صوّت</button>';
html+='<button class="btn btn-red btn-sm" onclick="deleteVote(\''+adminVoteId+'\')">🗑️ حذف</button>';
html+='</div></div>';

list.innerHTML+=html;
});
}

window.closeVote=async function(voteId){
if(USE_BACKEND && window.API){
try{
var result=await window.API.Votes.changeStatus(voteId,'closed');
if(result.success){toast("تم إغلاق التصويت");await loadDataFromBackend();}
else{toast(result.message||"خطأ",true);}
}catch(e){toast(e.message||"خطأ",true);}
}else{
var vote=appData.votes.find(function(v){return v.id===voteId||v.id==voteId;});
if(vote){vote.status="closed";save();loadAdminVoting();toast("تم إغلاق التصويت");}
}
}

window.reopenVote=async function(voteId){
if(USE_BACKEND && window.API){
try{
var result=await window.API.Votes.changeStatus(voteId,'open');
if(result.success){toast("تم إعادة فتح التصويت");await loadDataFromBackend();}
else{toast(result.message||"خطأ",true);}
}catch(e){toast(e.message||"خطأ",true);}
}else{
var vote=appData.votes.find(function(v){return v.id===voteId||v.id==voteId;});
if(vote){vote.status="open";save();loadAdminVoting();toast("تم إعادة فتح التصويت");}
}
}

window.deleteVote=async function(voteId){
if(!confirm("هل تريد حذف هذا التصويت؟"))return;
if(USE_BACKEND && window.API){
try{
var result=await window.API.Votes.delete(voteId);
if(result.success){toast("تم الحذف");await loadDataFromBackend();}
else{toast(result.message||"خطأ",true);}
}catch(e){toast(e.message||"خطأ",true);}
}else{
appData.votes=appData.votes.filter(function(v){return v.id!==voteId&&v.id!=voteId;});
save();loadAdminVoting();toast("تم الحذف");
}
}

window.showVoteCodes=function(voteId){
var vote=appData.votes.find(function(v){return v.id===voteId||v.id==voteId;});
if(!vote)return;

ensureMemberCodes();

var html='<div style="max-height:400px;overflow-y:auto;">';
html+='<table style="width:100%;border-collapse:collapse;">';
html+='<tr style="background:var(--green);color:white;"><th style="padding:10px;text-align:right;">العضو</th><th style="padding:10px;text-align:center;">الرمز</th><th style="padding:10px;text-align:center;">الحالة</th></tr>';

appData.members.forEach(function(m){
var voted=vote.voters.find(function(v){return v.memberId===m.id;});
var statusText=voted?"✅ صوّت":"⏳ لم يصوت";
html+='<tr style="border-bottom:1px solid var(--border);'+(voted?"opacity:0.6;":"")+'"><td style="padding:10px;">'+m.name+'</td><td style="padding:10px;text-align:center;font-family:monospace;font-size:1.1rem;color:var(--gold);letter-spacing:2px;">'+m.voteCode+'</td><td style="padding:10px;text-align:center;">'+statusText+'</td></tr>';
});

html+='</table></div>';
html+='<button class="btn btn-gold" style="margin-top:15px;width:100%;" onclick="copyAllCodes('+voteId+')">📋 نسخ جميع الرموز</button>';

showModal("🔑 رموز التصويت: "+vote.title,html);
}

window.copyAllCodes=function(voteId){
var vote=appData.votes.find(function(v){return v.id===voteId;});
if(!vote)return;

ensureMemberCodes();

var text="رموز التصويت: "+vote.title+"\n";
text+="========================\n\n";
appData.members.forEach(function(m){
var voted=vote.voters.find(function(v){return v.memberId===m.id;});
text+=m.name+": "+m.voteCode+(voted?" (صوّت)":"")+"\n";
});

navigator.clipboard.writeText(text).then(function(){toast("تم نسخ الرموز ✅");});
}

window.showVotersList=function(voteId){
var vote=appData.votes.find(function(v){return v.id===voteId||v.id==voteId;});
if(!vote)return;

var isMultiple=vote.type==="multiple"&&vote.options;

var html='<div style="max-height:400px;overflow-y:auto;">';
if(!vote.voters||vote.voters.length===0){
html+='<p style="text-align:center;color:var(--muted);padding:20px;">لم يصوت أحد بعد</p>';
}else{
html+='<table style="width:100%;border-collapse:collapse;">';
html+='<tr style="background:var(--green);color:white;"><th style="padding:10px;text-align:right;">العضو</th><th style="padding:10px;text-align:center;">'+(isMultiple?'الاختيارات':'التصويت')+'</th></tr>';
vote.voters.forEach(function(v){
var voteText;
if(isMultiple){
voteText=v.selectionNames?v.selectionNames.join('، '):'--';
}else{
voteText=v.vote==="yes"?"✅ موافق":"❌ غير موافق";
}
html+='<tr style="border-bottom:1px solid var(--border);"><td style="padding:10px;">'+(v.memberName||'مجهول')+'</td><td style="padding:10px;text-align:center;'+(isMultiple?'font-size:0.85rem;':'')+'">'+voteText+'</td></tr>';
});
html+='</table>';
}
html+='</div>';

showModal("👥 قائمة المصوتين: "+vote.title,html);
}

function showModal(title,content){
var modal=document.createElement("div");
modal.style.cssText="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;";
modal.innerHTML='<div style="background:var(--card);border-radius:15px;max-width:600px;width:100%;max-height:90vh;overflow:hidden;"><div style="padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;"><h3 style="color:var(--gold);">'+title+'</h3><button onclick="this.closest(\'div\').parentElement.parentElement.remove()" style="background:none;border:none;color:var(--text);font-size:1.5rem;cursor:pointer;">✕</button></div><div style="padding:20px;">'+content+'</div></div>';
document.body.appendChild(modal);
}

// ========== نظام الرسائل ==========
if(!appData.messages)appData.messages=[];
var currentMessageId=null;
var messageFilter='all';

window.sendMessage=async function(){
var name=document.getElementById("contactName").value.trim();
var phone=document.getElementById("contactPhone").value.trim();
var email=document.getElementById("contactEmail").value.trim();
var subject=document.getElementById("contactSubject").value;
var message=document.getElementById("contactMessage").value.trim();

if(!name){toast("أدخل اسمك",true);return;}
if(!subject){toast("اختر الموضوع",true);return;}
if(!message){toast("اكتب رسالتك",true);return;}

// إرسال للـ Backend
if(USE_BACKEND && window.API){
try{
toast("جاري إرسال الرسالة...");
var result = await window.API.Messages.send({name,phone,email,subject,message});
if(result.success){
document.getElementById("contactFormContainer").style.display="none";
document.getElementById("contactSuccess").classList.add("show");
toast("تم إرسال رسالتك بنجاح ✅");
}else{
toast(result.message||"حدث خطأ",true);
}
}catch(err){
console.error(err);
toast(err.message||"خطأ في الاتصال",true);
}
}else{
// حفظ محلي
if(!appData.messages)appData.messages=[];
var now=new Date();
var newMessage={
id:Date.now(),
name:name,
phone:phone||null,
email:email||null,
subject:subject,
message:message,
date:now.toISOString().split('T')[0],
time:now.toTimeString().split(' ')[0].substring(0,5),
timestamp:now.toISOString(),
read:false
};
appData.messages.unshift(newMessage);
save();
updateInboxBadge();
document.getElementById("contactFormContainer").style.display="none";
document.getElementById("contactSuccess").classList.add("show");
toast("تم إرسال رسالتك بنجاح ✅");
}
}

window.resetContactForm=function(){
document.getElementById("contactName").value="";
document.getElementById("contactPhone").value="";
document.getElementById("contactEmail").value="";
document.getElementById("contactSubject").value="";
document.getElementById("contactMessage").value="";
document.getElementById("contactFormContainer").style.display="block";
document.getElementById("contactSuccess").classList.remove("show");
}

function loadMessages(){
var list=document.getElementById("messagesList");
if(!list)return;

var messages=appData.messages||[];
var filtered=messages;

if(messageFilter==='unread'){
filtered=messages.filter(function(m){return !m.read;});
}else if(messageFilter==='read'){
filtered=messages.filter(function(m){return m.read;});
}

// Update stats
var total=messages.length;
var unread=messages.filter(function(m){return !m.read;}).length;
var read=total-unread;

document.getElementById("totalMessages").textContent=total;
document.getElementById("unreadMessages").textContent=unread;
document.getElementById("readMessages").textContent=read;

if(filtered.length===0){
list.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted);"><div style="font-size:3rem;margin-bottom:15px;">📭</div><p>'+t('noMessages')+'</p></div>';
return;
}

var html='';
filtered.forEach(function(msg){
var msgId = msg.id || msg._id;
var statusClass=msg.read?'read':'unread';
var cardClass=msg.read?'':'unread';
var preview=msg.message?msg.message.substring(0,80)+(msg.message.length>80?'...':''):'';

html+='<div class="message-card '+cardClass+'" data-msgid="'+msgId+'">';
html+='<div class="message-header">';
html+='<div class="message-sender">'+msg.name+'</div>';
html+='<div><span class="message-status '+statusClass+'">'+(msg.read?'✅ مقروءة':'🔔 غير مقروءة')+'</span></div>';
html+='</div>';
html+='<div class="message-subject">'+getSubjectIcon(msg.subject)+' '+msg.subject+'</div>';
html+='<div class="message-preview">'+preview+'</div>';
html+='<div class="message-date">📅 '+(msg.date||'')+(msg.time?' | ⏰ '+msg.time:'')+'</div>';
html+='<div class="message-actions" style="margin-top:10px;display:flex;gap:8px;">';
if(!msg.read){
html+='<button class="btn btn-green btn-sm msg-mark-read" data-msgid="'+msgId+'">✅ تحديد كمقروءة</button>';
}
html+='<button class="btn btn-gray btn-sm msg-view" data-msgid="'+msgId+'">👁️ عرض</button>';
html+='<button class="btn btn-red btn-sm msg-delete" data-msgid="'+msgId+'">🗑️ حذف</button>';
html+='</div>';
html+='</div>';
});

list.innerHTML=html;

// Attach event listeners
attachMessageListeners();
}

function attachMessageListeners(){
// View message
document.querySelectorAll('.msg-view').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var msgId = this.getAttribute('data-msgid');
openMessage(msgId);
};
});

// Mark as read
document.querySelectorAll('.msg-mark-read').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var msgId = this.getAttribute('data-msgid');
markMessageAsRead(msgId);
};
});

// Delete message
document.querySelectorAll('.msg-delete').forEach(function(btn){
btn.onclick = function(e){
e.stopPropagation();
var msgId = this.getAttribute('data-msgid');
deleteMessage(msgId);
};
});

// Click on card to view
document.querySelectorAll('.message-card').forEach(function(card){
card.onclick = function(){
var msgId = this.getAttribute('data-msgid');
openMessage(msgId);
};
});
}

window.markMessageAsRead=async function(id){
id = String(id);
var msg=appData.messages.find(function(m){return String(m.id||m._id)===id;});
if(!msg)return;

// Update locally first
msg.read=true;

// Store in localStorage to persist across backend reloads
var readMsgs = JSON.parse(localStorage.getItem('readMessages') || '[]');
if(readMsgs.indexOf(id) === -1) readMsgs.push(id);
localStorage.setItem('readMessages', JSON.stringify(readMsgs));

loadMessages();
updateInboxBadge();
toast("تم تحديد الرسالة كمقروءة ✅");

// Then update backend
if(USE_BACKEND && window.API && window.API.Messages && window.API.Messages.markAsRead){
try{
await window.API.Messages.markAsRead(id);
}catch(err){
console.log('Backend update failed, saved locally');
}
}
save();
}

window.deleteMessage=async function(id){
id = String(id);
if(!confirm("هل تريد حذف هذه الرسالة؟"))return;

// Delete locally first
appData.messages=appData.messages.filter(function(m){return String(m.id||m._id)!==id;});

// Store deletion in localStorage to persist across backend reloads
var deletedMsgs = JSON.parse(localStorage.getItem('deletedMessages') || '[]');
if(deletedMsgs.indexOf(id) === -1) deletedMsgs.push(id);
localStorage.setItem('deletedMessages', JSON.stringify(deletedMsgs));

loadMessages();
updateInboxBadge();
toast("تم حذف الرسالة");

// Then delete from backend
if(USE_BACKEND && window.API && window.API.Messages && window.API.Messages.delete){
try{
await window.API.Messages.delete(id);
// If backend delete successful, remove from local tracking
deletedMsgs = deletedMsgs.filter(function(x){return x !== id;});
localStorage.setItem('deletedMessages', JSON.stringify(deletedMsgs));
}catch(err){
console.log('Backend delete failed, deleted locally');
}
}
save();
}

function getSubjectIcon(subject){
var icons={'اقتراح':'💡','استفسار':'❓','شكوى':'⚠️','طلب مساعدة':'🤝','تطوع':'🙋','أخرى':'📝'};
return icons[subject]||'📋';
}

window.openMessage=async function(id){
id = String(id);
var msg=appData.messages.find(function(m){return String(m.id||m._id)===id;});
if(!msg)return;

// Mark as read
if(!msg.read){
msg.read=true;

// Store in localStorage
var readMsgs = JSON.parse(localStorage.getItem('readMessages') || '[]');
if(readMsgs.indexOf(id) === -1) readMsgs.push(id);
localStorage.setItem('readMessages', JSON.stringify(readMsgs));

loadMessages();
updateInboxBadge();

// Update backend
if(USE_BACKEND && window.API && window.API.Messages && window.API.Messages.markAsRead){
try{
await window.API.Messages.markAsRead(id);
}catch(err){
console.log('Backend update failed, saved locally');
}
}
save();
}

currentMessageId=id;

var html='<div class="message-detail-header">';
html+='<div class="message-detail-sender"><h3>'+msg.name+'</h3><p>'+getSubjectIcon(msg.subject)+' '+msg.subject+'</p></div>';
html+='<span class="message-status read">✅ مقروءة</span>';
html+='</div>';

html+='<div class="message-detail-info">';
html+='<div class="message-info-item"><label>📅 التاريخ</label><span>'+(msg.date||'غير محدد')+'</span></div>';
html+='<div class="message-info-item"><label>⏰ الوقت</label><span>'+(msg.time||'غير محدد')+'</span></div>';
if(msg.phone){
html+='<div class="message-info-item"><label>📱 الهاتف</label><a href="tel:'+msg.phone+'">'+msg.phone+'</a></div>';
}
if(msg.email){
html+='<div class="message-info-item"><label>📧 البريد</label><a href="mailto:'+msg.email+'">'+msg.email+'</a></div>';
}
html+='</div>';

html+='<div class="message-body">'+(msg.message||'')+'</div>';

document.getElementById("messageDetailContent").innerHTML=html;
document.getElementById("messageModal").classList.add("show");
}

window.closeMessageModal=function(){
document.getElementById("messageModal").classList.remove("show");
currentMessageId=null;
}

window.deleteCurrentMessage=async function(){
if(!currentMessageId)return;
if(!confirm("هل تريد حذف هذه الرسالة؟"))return;

var id = String(currentMessageId);

// Delete locally first
appData.messages=appData.messages.filter(function(m){return String(m.id||m._id)!==id;});

// Store deletion in localStorage
var deletedMsgs = JSON.parse(localStorage.getItem('deletedMessages') || '[]');
if(deletedMsgs.indexOf(id) === -1) deletedMsgs.push(id);
localStorage.setItem('deletedMessages', JSON.stringify(deletedMsgs));

closeMessageModal();
loadMessages();
updateInboxBadge();
toast("تم حذف الرسالة");

// Then delete from backend
if(USE_BACKEND && window.API && window.API.Messages && window.API.Messages.delete){
try{
await window.API.Messages.delete(id);
}catch(err){
console.log('Backend delete failed, deleted locally');
}
}
save();
}

window.filterMessages=function(filter){
messageFilter=filter;
document.querySelectorAll('.inbox-filters .btn').forEach(function(btn){
btn.classList.remove('btn-green');
btn.classList.add('btn-gray');
});
document.getElementById('filter'+filter.charAt(0).toUpperCase()+filter.slice(1)).classList.remove('btn-gray');
document.getElementById('filter'+filter.charAt(0).toUpperCase()+filter.slice(1)).classList.add('btn-green');
loadMessages();
}

window.markAllAsRead=async function(){
if(!appData.messages||appData.messages.length===0)return;
var unreadCount=appData.messages.filter(function(m){return !m.read;}).length;
if(unreadCount===0){toast("جميع الرسائل مقروءة بالفعل");return;}
if(!confirm("هل تريد تحديد "+unreadCount+" رسالة كمقروءة؟"))return;

// Update locally first
var readMsgs = JSON.parse(localStorage.getItem('readMessages') || '[]');
appData.messages.forEach(function(m){
m.read=true;
var msgId = String(m.id || m._id);
if(readMsgs.indexOf(msgId) === -1) readMsgs.push(msgId);
});
localStorage.setItem('readMessages', JSON.stringify(readMsgs));

loadMessages();
updateInboxBadge();
toast("تم تحديد جميع الرسائل كمقروءة ✅");

// Then update backend
if(USE_BACKEND && window.API && window.API.Messages && window.API.Messages.markAllAsRead){
try{
await window.API.Messages.markAllAsRead();
}catch(err){
console.log('Backend update failed, saved locally');
}
}
save();
}

function updateInboxBadge(){
var badge=document.getElementById("inboxBadge");
if(!badge)return;
var unread=appData.messages?appData.messages.filter(function(m){return !m.read;}).length:0;
badge.textContent=unread;
if(unread>0){
badge.classList.remove("hidden");
}else{
badge.classList.add("hidden");
}
}

// ========== نظام البث المباشر ==========
if(!appData.liveStream)appData.liveStream={active:false,title:'',url:'',linkedVoteId:null};

function initLiveStream(){
loadLiveStreamStatus();
loadLiveVotingList();
loadAdminLiveVotes();
}

function loadLiveStreamStatus(){
var live=appData.liveStream;
var videoContainer=document.getElementById('liveVideoContainer');
var videoFrame=document.getElementById('liveVideoFrame');
var offlineMsg=document.getElementById('liveOfflineMsg');
var alternativeOptions=document.getElementById('liveAlternativeOptions');
var liveBtn=document.getElementById('btnLive');
var directLink=document.getElementById('liveDirectLink');

// Check if live is active and (public OR user is admin)
var canView=live&&live.active&&live.url&&(live.isPublic||isAdmin);

if(canView){
// Show live stream
var embedUrl=convertToEmbedUrl(live.url);
if(videoFrame&&videoContainer){
videoFrame.src=embedUrl;
videoContainer.style.display='block';
}
if(offlineMsg)offlineMsg.style.display='none';
if(alternativeOptions)alternativeOptions.style.display='block';
if(directLink)directLink.href=live.url;
if(liveBtn)liveBtn.classList.remove('hidden');

var titleEl=document.getElementById('liveStreamTitle');
if(titleEl&&live.title)titleEl.textContent=live.title;

var eventTitle=document.getElementById('liveEventTitle');
if(eventTitle&&live.title)eventTitle.textContent=live.title;
}else{
// Hide live stream
if(videoContainer)videoContainer.style.display='none';
if(videoFrame)videoFrame.src='';
if(offlineMsg)offlineMsg.style.display='flex';
if(alternativeOptions)alternativeOptions.style.display='none';
// Show button only for admin or if stream is public and active
if(liveBtn){
if(isAdmin||(live&&live.active&&live.isPublic)){
liveBtn.classList.remove('hidden');
}else{
liveBtn.classList.add('hidden');
}
}
}

// Update admin panel status
var statusPanel=document.getElementById('liveStatusPanel');
var statusText=document.getElementById('liveStatusText');
var statusInfo=document.getElementById('liveStatusInfo');
if(statusPanel&&statusText){
if(live&&live.active){
statusPanel.classList.remove('inactive');
statusPanel.classList.add('active');
var publicText=live.isPublic?' (عام)':' (للأعضاء فقط)';
statusText.textContent=t('streamActive')+' 🔴'+publicText;
if(statusInfo)statusInfo.textContent=live.title||'';
}else{
statusPanel.classList.remove('active');
statusPanel.classList.add('inactive');
statusText.textContent=t('streamStopped');
if(statusInfo)statusInfo.textContent='';
}
}

// Load saved checkbox state
var publicCheckbox=document.getElementById('adminLivePublic');
if(publicCheckbox&&live){
publicCheckbox.checked=live.isPublic!==false;
}
}

window.openLiveInNewWindow=function(){
var live=appData.liveStream;
if(live&&live.url){
window.open(live.url,'_blank');
}
}

function convertToEmbedUrl(url){
if(!url)return'';

// YouTube - multiple formats
// youtube.com/watch?v=ID
// youtu.be/ID
// youtube.com/live/ID
// youtube.com/embed/ID
var ytMatch=url.match(/(?:youtube\.com\/(?:watch\?v=|live\/|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]+)/);
if(ytMatch){
return'https://www.youtube.com/embed/'+ytMatch[1]+'?autoplay=1&rel=0';
}

// If it's already an embed URL, return as is
if(url.indexOf('youtube.com/embed/')>-1){
return url+(url.indexOf('?')>-1?'&':'?')+'autoplay=1';
}

// Facebook
if(url.indexOf('facebook.com')>-1){
return'https://www.facebook.com/plugins/video.php?href='+encodeURIComponent(url)+'&autoplay=true&show_text=false';
}

// If nothing matches, return the URL as is (might be a direct video URL)
return url;
}

function loadLiveVotingList(){
var list=document.getElementById('liveVotingList');
var noVotes=document.getElementById('liveNoVotes');
if(!list)return;

var live=appData.liveStream;
var linkedVoteId=live?live.linkedVoteId:null;

// Get open votes (either linked vote or all open votes)
var openVotes=appData.votes.filter(function(v){
var vid = v.id || v._id;
if(linkedVoteId)return vid===linkedVoteId&&v.status==='open';
return v.status==='open';
});

if(openVotes.length===0){
list.innerHTML='';
if(noVotes)noVotes.style.display='block';
return;
}

if(noVotes)noVotes.style.display='none';
list.innerHTML='';

openVotes.forEach(function(vote){
var voteId = vote.id || vote._id;
var html='<div class="live-vote-card">';
html+='<div class="live-vote-title">'+vote.title+'</div>';
if(vote.question)html+='<p style="font-size:0.85rem;color:var(--muted);margin-bottom:10px;">'+vote.question+'</p>';

html+='<div class="form-group"><input type="text" class="form-input live-vote-code-input" data-voteid="'+voteId+'" placeholder="'+t('enterVoteCode')+'" style="text-align:center;letter-spacing:2px;text-transform:uppercase;"></div>';

if(vote.type==='yesno'||!vote.options){
html+='<div class="live-vote-options" id="liveVoteOptions'+voteId+'">';
html+='<div class="live-vote-option live-yesno-option" data-voteid="'+voteId+'" data-option="yes"><div class="radio"></div><span>✅ '+t('agree')+'</span></div>';
html+='<div class="live-vote-option live-yesno-option" data-voteid="'+voteId+'" data-option="no"><div class="radio"></div><span>❌ '+t('disagree')+'</span></div>';
html+='</div>';
html+='<button class="btn btn-green live-submit-yesno" data-voteid="'+voteId+'" style="width:100%;">🗳️ '+t('confirmVote')+'</button>';

// إضافة النتائج الحالية للتصويت نعم/لا
html+=buildLiveVoteResults(vote);

}else{
var maxSel=vote.maxSelections||1;
html+='<p style="font-size:0.8rem;color:var(--gold);margin-bottom:10px;">'+t('canSelect')+' '+maxSel+' '+t('options')+'</p>';
html+='<div class="live-vote-options" id="liveVoteOptions'+voteId+'">';
vote.options.forEach(function(opt){
var optId = opt.id || opt._id;
html+='<div class="live-vote-option live-multi-option" data-voteid="'+voteId+'" data-optid="'+optId+'" data-maxsel="'+maxSel+'"><div class="radio"></div><span>'+opt.name+'</span></div>';
});
html+='</div>';
html+='<button class="btn btn-green live-submit-multi" data-voteid="'+voteId+'" style="width:100%;">🗳️ '+t('confirmVote')+'</button>';

// إضافة النتائج الحالية للتصويت متعدد الخيارات
html+=buildLiveVoteResults(vote);
}

html+='</div>';
list.innerHTML+=html;
});

// Attach event listeners after rendering
attachLiveVotingListeners();
}

// دالة بناء عرض النتائج الحالية
function buildLiveVoteResults(vote){
var voters = vote.voters || [];
var totalVotes = voters.length;

var html='<div class="live-results-section" style="margin-top:20px;padding-top:15px;border-top:1px solid var(--border);">';
html+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
html+='<span style="font-size:0.9rem;font-weight:600;color:var(--gold);">📊 النتائج الحالية</span>';
html+='<span style="font-size:0.8rem;color:var(--muted);">👥 '+totalVotes+' مصوّت</span>';
html+='</div>';

if(vote.type==='yesno'||!vote.options){
// حساب أصوات نعم/لا من voters
var yesVotes = 0, noVotes = 0;
voters.forEach(function(v){
if(v.vote === 'yes') yesVotes++;
else if(v.vote === 'no') noVotes++;
});

var yesPercent = totalVotes > 0 ? Math.round((yesVotes/totalVotes)*100) : 0;
var noPercent = totalVotes > 0 ? Math.round((noVotes/totalVotes)*100) : 0;

// شريط نعم
html+='<div style="margin-bottom:10px;">';
html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px;">';
html+='<span style="font-size:0.85rem;">✅ موافق</span>';
html+='<span style="font-size:0.85rem;font-weight:600;color:var(--green);">'+yesPercent+'%</span>';
html+='</div>';
html+='<div style="background:var(--border);border-radius:10px;height:8px;overflow:hidden;">';
html+='<div style="background:var(--green);height:100%;width:'+yesPercent+'%;transition:width 0.5s;"></div>';
html+='</div>';
html+='</div>';

// شريط لا
html+='<div style="margin-bottom:5px;">';
html+='<div style="display:flex;justify-content:space-between;margin-bottom:4px;">';
html+='<span style="font-size:0.85rem;">❌ غير موافق</span>';
html+='<span style="font-size:0.85rem;font-weight:600;color:var(--red);">'+noPercent+'%</span>';
html+='</div>';
html+='<div style="background:var(--border);border-radius:10px;height:8px;overflow:hidden;">';
html+='<div style="background:var(--red);height:100%;width:'+noPercent+'%;transition:width 0.5s;"></div>';
html+='</div>';
html+='</div>';

}else{
// تصويت متعدد الخيارات
var optionVotes = {};
vote.options.forEach(function(opt){
var optId = String(opt.id || opt._id);
optionVotes[optId] = 0;
});

// حساب الأصوات من voters
voters.forEach(function(v){
if(v.selections && v.selections.length > 0){
v.selections.forEach(function(sel){
var selId = String(sel);
if(optionVotes[selId] !== undefined) optionVotes[selId]++;
});
}
});

// ترتيب الخيارات حسب الأصوات
var sortedOptions = vote.options.slice().sort(function(a,b){
var aId = String(a.id || a._id);
var bId = String(b.id || b._id);
return (optionVotes[bId]||0) - (optionVotes[aId]||0);
});

var maxVotes = 0;
sortedOptions.forEach(function(opt){
var optId = String(opt.id || opt._id);
if(optionVotes[optId] > maxVotes) maxVotes = optionVotes[optId];
});

sortedOptions.forEach(function(opt, idx){
var optId = String(opt.id || opt._id);
var votes = optionVotes[optId] || 0;
var percent = totalVotes > 0 ? Math.round((votes/totalVotes)*100) : 0;
var isWinner = votes > 0 && votes === maxVotes;
var barColor = isWinner ? 'var(--green)' : 'var(--gold)';

html+='<div style="margin-bottom:8px;">';
html+='<div style="display:flex;justify-content:space-between;margin-bottom:3px;">';
html+='<span style="font-size:0.8rem;'+(isWinner?'color:var(--green);font-weight:600;':'')+'">'+opt.name+(isWinner?' 🏆':'')+'</span>';
html+='<span style="font-size:0.8rem;font-weight:600;">'+percent+'%</span>';
html+='</div>';
html+='<div style="background:var(--border);border-radius:8px;height:6px;overflow:hidden;">';
html+='<div style="background:'+barColor+';height:100%;width:'+percent+'%;transition:width 0.5s;"></div>';
html+='</div>';
html+='</div>';
});
}

html+='</div>';
return html;
}

function attachLiveVotingListeners(){
// Yes/No option click
document.querySelectorAll('.live-yesno-option').forEach(function(opt){
opt.onclick = function(){
var voteId = this.getAttribute('data-voteid');
var option = this.getAttribute('data-option');
selectLiveVoteOption(voteId, option);
};
});

// Multi option click
document.querySelectorAll('.live-multi-option').forEach(function(opt){
opt.onclick = function(){
var voteId = this.getAttribute('data-voteid');
var optId = this.getAttribute('data-optid');
var maxSel = parseInt(this.getAttribute('data-maxsel')) || 1;
toggleLiveMultiOption(voteId, optId, maxSel);
};
});

// Yes/No submit
document.querySelectorAll('.live-submit-yesno').forEach(function(btn){
btn.onclick = function(){
var voteId = this.getAttribute('data-voteid');
submitLiveVote(voteId);
};
});

// Multi submit
document.querySelectorAll('.live-submit-multi').forEach(function(btn){
btn.onclick = function(){
var voteId = this.getAttribute('data-voteid');
submitLiveMultiVote(voteId);
};
});
}

var liveSelectedVotes={};
var liveMultiSelectedOptions={};

window.selectLiveVoteOption=function(voteId,option){
voteId = String(voteId);
liveSelectedVotes[voteId]=option;
var container=document.getElementById('liveVoteOptions'+voteId);
if(!container){
// Try to find by querying
container = document.querySelector('[id="liveVoteOptions'+voteId+'"]');
}
if(!container)return;
var options=container.querySelectorAll('.live-vote-option');
options.forEach(function(opt){opt.classList.remove('selected');});
if(option==='yes' && options[0]) options[0].classList.add('selected');
else if(option==='no' && options[1]) options[1].classList.add('selected');
}

window.toggleLiveMultiOption=function(voteId,optId,maxSelections){
voteId = String(voteId);
optId = String(optId);
if(!liveMultiSelectedOptions[voteId])liveMultiSelectedOptions[voteId]=[];
var selected=liveMultiSelectedOptions[voteId];
var idx=selected.indexOf(optId);

if(idx>-1){
selected.splice(idx,1);
}else{
if(selected.length>=maxSelections){
toast(t('canSelect')+' '+maxSelections+' '+t('options'),true);
return;
}
selected.push(optId);
}

var container=document.getElementById('liveVoteOptions'+voteId);
if(!container){
container = document.querySelector('[id="liveVoteOptions'+voteId+'"]');
}
if(!container)return;
var options=container.querySelectorAll('.live-vote-option');
options.forEach(function(opt){
var oid=opt.getAttribute('data-optid');
if(selected.indexOf(oid)>-1 || selected.indexOf(String(oid))>-1){
opt.classList.add('selected');
}else{
opt.classList.remove('selected');
}
});
}

window.submitLiveVote=async function(voteId){
voteId = String(voteId);
var codeInput=document.querySelector('.live-vote-code-input[data-voteid="'+voteId+'"]');
var code=codeInput?codeInput.value.trim().toUpperCase():'';
var option=liveSelectedVotes[voteId];

if(!code){toast(t('enterVoteCode'),true);return;}
if(!option){toast(t('chooseOption'),true);return;}

// Find vote and member first (needed for both backend and local)
var vote=appData.votes.find(function(v){return String(v.id||v._id)===voteId;});
if(!vote){toast('التصويت غير موجود',true);return;}
if(vote.status!=='open'){toast(t('closed'),true);return;}

var member=appData.members.find(function(m){return m.voteCode===code;});
if(!member){toast('رمز التصويت غير صحيح',true);return;}

if(!vote.voters)vote.voters=[];
var alreadyVoted=vote.voters.find(function(v){return String(v.memberId)===String(member.id||member._id);});
if(alreadyVoted){toast('لقد صوّتت مسبقاً',true);return;}

if(USE_BACKEND && window.API){
try{
toast('جاري تسجيل صوتك...');
var result = await window.API.Votes.submitVote(voteId, code, option);
if(result.success){
toast('تم تسجيل صوتك بنجاح ✅');
liveSelectedVotes[voteId]=null;
await loadDataFromBackend();
loadLiveVotingList();
} else {
toast(result.message || 'حدث خطأ', true);
}
} catch(err){
// Fallback to local storage if backend fails
console.log('Backend failed, saving locally:', err);
if(!vote.votes)vote.votes={yes:0,no:0};
vote.votes[option]++;
vote.voters.push({memberId:member.id||member._id,memberName:member.name,vote:option,time:new Date().toISOString()});
save();
loadLiveVotingList();
liveSelectedVotes[voteId]=null;
toast('تم تسجيل صوتك محلياً ✅');
}
} else {
if(!vote.votes)vote.votes={yes:0,no:0};
vote.votes[option]++;
vote.voters.push({memberId:member.id||member._id,memberName:member.name,vote:option,time:new Date().toISOString()});

save();
loadLiveVotingList();
liveSelectedVotes[voteId]=null;
toast('تم تسجيل صوتك بنجاح ✅');
}
}

window.submitLiveMultiVote=async function(voteId){
voteId = String(voteId);
var codeInput=document.querySelector('.live-vote-code-input[data-voteid="'+voteId+'"]');
var code=codeInput?codeInput.value.trim().toUpperCase():'';
var selected=liveMultiSelectedOptions[voteId]||[];

if(!code){toast(t('enterVoteCode'),true);return;}

var vote=appData.votes.find(function(v){return String(v.id||v._id)===voteId;});
if(!vote){toast('التصويت غير موجود',true);return;}
if(vote.status!=='open'){toast(t('closed'),true);return;}

var maxSel=vote.maxSelections||1;
if(selected.length===0||selected.length>maxSel){
toast(t('canSelect')+' '+maxSel+' '+t('options'),true);
return;
}

var member=appData.members.find(function(m){return m.voteCode===code;});
if(!member){toast('رمز التصويت غير صحيح',true);return;}

if(!vote.voters)vote.voters=[];
var alreadyVoted=vote.voters.find(function(v){return String(v.memberId)===String(member.id||member._id);});
if(alreadyVoted){toast('لقد صوّتت مسبقاً',true);return;}

// Helper function to save vote locally
function saveVoteLocally(){
var selectionNames=[];
selected.forEach(function(optId){
var opt=vote.options.find(function(o){return String(o.id||o._id)===String(optId);});
if(opt){
opt.votes=(opt.votes||0)+1;
selectionNames.push(opt.name);
}
});

vote.voters.push({
memberId:member.id||member._id,
memberName:member.name,
selections:selected,
selectionNames:selectionNames,
time:new Date().toISOString()
});

save();
loadLiveVotingList();
liveMultiSelectedOptions[voteId]=[];
}

if(USE_BACKEND && window.API){
try{
toast('جاري تسجيل صوتك...');
var result = await window.API.Votes.submitVote(voteId, code, null, selected);
if(result.success){
toast('تم تسجيل صوتك بنجاح ✅');
liveMultiSelectedOptions[voteId]=[];
await loadDataFromBackend();
loadLiveVotingList();
} else {
toast(result.message || 'حدث خطأ', true);
}
} catch(err){
// Fallback to local storage if backend fails
console.log('Backend failed, saving locally:', err);
saveVoteLocally();
toast('تم تسجيل صوتك محلياً ✅');
}
} else {
saveVoteLocally();
toast('تم تسجيل صوتك بنجاح ✅');
}
}

function loadAdminLiveVotes(){
var select=document.getElementById('adminLiveVote');
if(!select)return;
select.innerHTML='<option value="">-- '+t('noVotes')+' --</option>';
var openVotes=appData.votes.filter(function(v){return v.status==='open';});
openVotes.forEach(function(v){
var selected=appData.liveStream&&appData.liveStream.linkedVoteId===v.id?'selected':'';
select.innerHTML+='<option value="'+v.id+'" '+selected+'>'+v.title+'</option>';
});

// Load saved values
if(appData.liveStream){
var titleInput=document.getElementById('adminLiveTitle');
var urlInput=document.getElementById('adminLiveUrl');
if(titleInput&&appData.liveStream.title)titleInput.value=appData.liveStream.title;
if(urlInput&&appData.liveStream.url)urlInput.value=appData.liveStream.url;
}
}

window.previewLiveStream=function(){
var url=document.getElementById('adminLiveUrl').value.trim();
if(!url){toast('أدخل رابط البث',true);return;}
var embedUrl=convertToEmbedUrl(url);
if(embedUrl){
window.open(embedUrl,'_blank');
}else{
toast('رابط غير صالح',true);
}
}

window.startLiveStream=function(){
var title=document.getElementById('adminLiveTitle').value.trim();
var url=document.getElementById('adminLiveUrl').value.trim();
var linkedVoteId=document.getElementById('adminLiveVote').value;
var isPublic=document.getElementById('adminLivePublic').checked;

if(!url){toast('أدخل رابط البث',true);return;}

appData.liveStream={
active:true,
title:title||t('liveStream'),
url:url,
linkedVoteId:linkedVoteId?parseInt(linkedVoteId):null,
isPublic:isPublic,
startedAt:new Date().toISOString()
};

save();
loadLiveStreamStatus();
loadLiveVotingList();
document.getElementById('btnLive').classList.remove('hidden');
toast('تم بدء البث المباشر 🔴');
}

window.stopLiveStream=function(){
if(!appData.liveStream||!appData.liveStream.active){
toast('لا يوجد بث نشط',true);
return;
}

appData.liveStream.active=false;
save();
loadLiveStreamStatus();
if(!isAdmin)document.getElementById('btnLive').classList.add('hidden');
toast('تم إيقاف البث');
}

window.addEventListener("resize",function(){if(!expandedBylawNode)positionBylawNodes();});
document.addEventListener("keydown",function(e){if(e.key==="Escape"&&expandedBylawNode)closeBylawPanel();});
hideAdmin();
initLanguage();
updateInboxBadge();
initLiveStream();
loadInvLogo();

// Cookie Consent Banner
if(!localStorage.getItem('cookieConsent')){
    var cb = document.getElementById('cookieBanner');
    if(cb) cb.style.display = 'flex';
}

// Privacy page language switcher
window.switchPrivacyLang = function(lang){
    var tabs = document.querySelectorAll('.privacy-tab');
    for(var i=0;i<tabs.length;i++) tabs[i].classList.remove('active');
    event.target.classList.add('active');
    var langs = document.querySelectorAll('.privacy-lang');
    for(var j=0;j<langs.length;j++) langs[j].classList.remove('active');
    var target = document.getElementById(lang === 'no' ? 'privacyNo' : 'privacyAr');
    if(target) target.classList.add('active');
};

// Accept cookies
window.acceptCookies = function(){
    localStorage.setItem('cookieConsent', 'accepted');
    var cb = document.getElementById('cookieBanner');
    if(cb) cb.style.display = 'none';
};

// ========== Photo Gallery ==========
if(!appData.gallery) appData.gallery = [];

window.saveAlbum = function(){
    var title = document.getElementById('albumTitle').value.trim();
    var desc = document.getElementById('albumDesc').value.trim();
    if(!title){toast('أدخل اسم الألبوم',true);return;}
    if(albumPhotos.length===0){toast('أضف صورة واحدة على الأقل',true);return;}
    appData.gallery.unshift({
        id:Date.now(), title:title, desc:desc,
        photos:albumPhotos.slice(),
        date:new Date().toISOString().split('T')[0]
    });
    save();
    document.getElementById('albumTitle').value='';
    document.getElementById('albumDesc').value='';
    albumPhotos=[];
    document.getElementById('albumThumbs').innerHTML='';
    loadGallery();loadAdminGallery();
    toast('تم حفظ الألبوم ✅');
};

var albumPhotos=[];
document.getElementById('albumUploadArea').addEventListener('click',function(){
    document.getElementById('albumFiles').click();
});
document.getElementById('albumFiles').addEventListener('change',function(e){
    var files=e.target.files;
    for(var i=0;i<files.length;i++){
        (function(file){
            var r=new FileReader();
            r.onload=function(ev){
                albumPhotos.push(ev.target.result);
                renderAlbumThumbs();
            };
            r.readAsDataURL(file);
        })(files[i]);
    }
});

function renderAlbumThumbs(){
    var c=document.getElementById('albumThumbs');c.innerHTML='';
    for(var i=0;i<albumPhotos.length;i++){
        c.innerHTML+='<div class="gallery-thumb-wrap"><img src="'+albumPhotos[i]+'" class="gallery-thumb"><button class="gallery-thumb-remove" onclick="removeAlbumPhoto('+i+')">×</button></div>';
    }
}
window.removeAlbumPhoto=function(i){albumPhotos.splice(i,1);renderAlbumThumbs();};

function loadGallery(){
    var g=document.getElementById('galleryGrid');if(!g)return;
    g.innerHTML='';
    if(!appData.gallery||appData.gallery.length===0){
        g.innerHTML='<p style="color:var(--muted);text-align:center;padding:40px;grid-column:1/-1;">لا توجد ألبومات بعد</p>';
        return;
    }
    for(var i=0;i<appData.gallery.length;i++){
        var a=appData.gallery[i];
        var cover=a.photos&&a.photos.length>0?'<img src="'+a.photos[0]+'" class="gallery-album-cover">':'<div class="gallery-album-cover" style="display:flex;align-items:center;justify-content:center;font-size:3rem;">📷</div>';
        g.innerHTML+='<div class="gallery-album" onclick="openAlbum('+i+')">'+cover+'<div class="gallery-album-info"><div class="gallery-album-title">'+a.title+'</div><div class="gallery-album-count">📷 '+(a.photos?a.photos.length:0)+' صورة</div><div class="gallery-album-date">'+fmtDate(a.date)+'</div></div></div>';
    }
}

window.openAlbum=function(idx){
    var a=appData.gallery[idx];if(!a)return;
    document.getElementById('galleryContent').style.display='none';
    document.getElementById('galleryAlbumView').style.display='block';
    document.getElementById('albumViewTitle').textContent='🖼️ '+a.title+' ('+a.photos.length+' صورة)';
    var c=document.getElementById('albumPhotos');c.innerHTML='';
    for(var i=0;i<a.photos.length;i++){
        c.innerHTML+='<img src="'+a.photos[i]+'" class="gallery-photo" onclick="showLightbox(\''+a.photos[i]+'\')">';
    }
};

window.closeAlbumView=function(){
    document.getElementById('galleryContent').style.display='block';
    document.getElementById('galleryAlbumView').style.display='none';
};

function loadAdminGallery(){
    var c=document.getElementById('adminAlbumList');if(!c)return;
    c.innerHTML='';
    if(!appData.gallery||appData.gallery.length===0){
        c.innerHTML='<p style="color:var(--muted);text-align:center;">لا توجد ألبومات</p>';return;
    }
    for(var i=0;i<appData.gallery.length;i++){
        var a=appData.gallery[i];
        c.innerHTML+='<div class="tx-item"><div class="tx-icon inc">🖼️</div><div class="tx-info"><div class="tx-title">'+a.title+'</div><div class="tx-date">'+fmtDate(a.date)+' | 📷 '+(a.photos?a.photos.length:0)+' صورة</div></div><div class="tx-actions"><button class="btn btn-red btn-sm" onclick="deleteAlbum('+i+')">🗑️</button></div></div>';
    }
}

window.deleteAlbum=function(idx){
    if(!confirm('حذف هذا الألبوم؟'))return;
    appData.gallery.splice(idx,1);
    save();loadGallery();loadAdminGallery();
    toast('تم حذف الألبوم');
};

// Gallery nav button
document.getElementById('btnGallery').addEventListener('click',function(){goTo('gallery');loadGallery();});
document.getElementById('btnManageGallery').addEventListener('click',function(){goTo('manageGallery');loadAdminGallery();});

// Gallery nav button
window.enablePushNotifications=function(){
    if(!('Notification' in window)){
        toast('متصفحك لا يدعم الإشعارات',true);return;
    }
    if(Notification.permission==='granted'){
        toast('الإشعارات مفعّلة بالفعل ✅');return;
    }
    if(Notification.permission==='denied'){
        toast('الإشعارات محظورة. فعّلها من إعدادات المتصفح',true);return;
    }
    Notification.requestPermission().then(function(p){
        if(p==='granted'){
            localStorage.setItem('pushEnabled','true');
            toast('تم تفعيل الإشعارات ✅');
            new Notification('الجالية الفلسطينية 🇵🇸',{body:'تم تفعيل الإشعارات بنجاح!',icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🇵🇸</text></svg>'});
        }else{
            toast('لم يتم تفعيل الإشعارات',true);
        }
    });
};

function sendLocalNotification(title,body){
    if(Notification.permission==='granted' && localStorage.getItem('pushEnabled')==='true'){
        new Notification(title,{body:body,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🇵🇸</text></svg>'});
    }
}

// Show admin buttons for gallery
var origShowAdmin = window.showAdmin;
if(typeof showAdmin === 'function'){
    var _origShow = showAdmin;
    showAdmin = function(){
        _origShow();
        document.getElementById('btnManageGallery').classList.remove('hidden');
    };
}

// Update hideAdmin to hide gallery button
var origHideAdmin = window.hideAdmin;
if(typeof hideAdmin === 'function'){
    var _origHide = hideAdmin;
    hideAdmin = function(){
        _origHide();
        document.getElementById('btnManageGallery').classList.add('hidden');
    };
}

// Hide push button if already enabled
if(localStorage.getItem('pushEnabled')==='true'){
    var pb=document.getElementById('pushNotifBtn');
    if(pb)pb.style.display='none';
}

})();
</script>
</body>
</html>
